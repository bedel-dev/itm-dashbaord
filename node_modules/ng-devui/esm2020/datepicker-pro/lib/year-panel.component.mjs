import { CdkVirtualScrollViewport } from '@angular/cdk/scrolling';
import { ChangeDetectionStrategy, ChangeDetectorRef, Component, Input, ViewChild } from '@angular/core';
import { chunk } from 'lodash-es';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { DatepickerProService } from '../datepicker-pro.service';
import * as i0 from "@angular/core";
import * as i1 from "../datepicker-pro.service";
import * as i2 from "@angular/cdk/scrolling";
import * as i3 from "@angular/common";
export class YearPanelComponent {
    constructor(cdr, pickerSrv) {
        this.cdr = cdr;
        this.pickerSrv = pickerSrv;
        this.isRangeType = false;
        this.yearList = [];
        this.unsubscribe$ = new Subject();
    }
    get curHoverDate() {
        return this.pickerSrv.curHoverDate;
    }
    set curHoverDate(value) {
        this.pickerSrv.curHoverDate = value;
    }
    get currentDate() {
        if (this.isRangeType) {
            if (this.pickerSrv.currentActiveInput === 'start') {
                return this.pickerSrv.curRangeDate[0];
            }
            else if (this.pickerSrv.currentActiveInput === 'end') {
                return this.pickerSrv.curRangeDate[1];
            }
        }
        else {
            return this.pickerSrv.curDate;
        }
    }
    set currentDate(value) {
        if (this.isRangeType) {
            if (this.pickerSrv.currentActiveInput === 'start') {
                this.pickerSrv.curRangeDate[0] = value;
            }
            else if (this.pickerSrv.currentActiveInput === 'end') {
                this.pickerSrv.curRangeDate[1] = value;
            }
        }
        else {
            this.pickerSrv.curDate = value;
        }
    }
    ngOnInit() {
        this.initYearList();
        this.initObservable();
    }
    initObservable() {
        this.pickerSrv.toggleEvent.subscribe(isOpen => {
            if (isOpen) {
                setTimeout(() => {
                    this.goToYear(this.currentDate || new Date());
                });
            }
        });
        this.pickerSrv.updateDateValue.pipe(takeUntil(this.unsubscribe$)).subscribe(res => {
            if (res.type === 'range') {
                this.pickerSrv.curRangeDate = res.value;
            }
            else {
                this.pickerSrv.curDate = res.value;
            }
            this.goToYear(this.currentDate || new Date());
        });
        this.pickerSrv.activeInputChange.pipe(takeUntil(this.unsubscribe$)).subscribe(type => {
            if (type === 'start') {
                this.goToYear(this.pickerSrv.curRangeDate[0] || this.pickerSrv.curRangeDate[1] || new Date());
            }
            else {
                this.goToYear(this.pickerSrv.curRangeDate[1] || this.pickerSrv.curRangeDate[0] || new Date());
            }
        });
    }
    initYearList() {
        const list = new Array(this.pickerSrv.calendarRange[1] - this.pickerSrv.calendarRange[0] + 1).fill(1).map((t, i) => {
            return i + this.pickerSrv.calendarRange[0];
        });
        this.yearList = chunk(list, 3);
    }
    goToYear(date) {
        if (date) {
            const index = Math.floor((date.getFullYear() - this.pickerSrv.calendarRange[0]) / 3);
            this.scrollListCmp.scrollToIndex(index - 1);
        }
        this.cdr.detectChanges();
    }
    isThisYear(yearIndex) {
        return yearIndex === new Date().getFullYear();
    }
    isActiveYear(yearIndex) {
        return this.pickerSrv.isYearActive(yearIndex);
    }
    isStartDate(yearIndex) {
        if (!this.isRangeType) {
            return false;
        }
        const date = new Date(yearIndex, 0, 1);
        return this.pickerSrv.isStartDate(date);
    }
    isEndDate(yearIndex) {
        if (!this.isRangeType) {
            return false;
        }
        const date = new Date(yearIndex, 0, 1);
        return this.pickerSrv.isEndDate(date);
    }
    isDateAbandon(yearIndex) {
        if (!this.isRangeType || (!this.pickerSrv.curRangeDate[0] || !this.pickerSrv.curRangeDate[1])) {
            return false;
        }
        const date = new Date(yearIndex, 0, 1);
        return this.pickerSrv.isDateAbandon(date);
    }
    isActiveTypeDate(yearIndex) {
        if (!this.isRangeType) {
            return false;
        }
        const date = new Date(yearIndex, 0, 1);
        return this.pickerSrv.isActiveInputTypeDate(date);
    }
    isDateInRange(yearIndex) {
        const date = new Date(yearIndex, 0, 1);
        return this.pickerSrv.isDateInRange(date);
    }
    isDateInSelectRange(yearIndex) {
        if (!this.isRangeType) {
            return false;
        }
        const date = new Date(yearIndex, 0, 1);
        return this.pickerSrv.isDateInSelectRange(date);
    }
    selectYear(yearIndex) {
        if (this.isDisable(yearIndex)) {
            return;
        }
        this.currentDate = new Date(yearIndex, 0, 1);
        if (this.isRangeType) {
            this.pickerSrv.fixRangeDate();
        }
        // 非时间模式下选完开始日期跳转到结束日期
        if (this.isRangeType) {
            if (this.pickerSrv.currentActiveInput === 'start') {
                this.pickerSrv.currentActiveInput = 'end';
            }
            else if (this.pickerSrv.currentActiveInput === 'end' && !this.pickerSrv.curRangeDate[0]) {
                this.pickerSrv.currentActiveInput = 'start';
            }
            else {
                this.pickerSrv.closeDropdownEvent.next();
            }
        }
        this.pickerSrv.selectedDateChange.next({
            type: this.isRangeType ? 'range' : 'single',
            value: this.isRangeType ? this.pickerSrv.curRangeDate : this.currentDate
        });
        if (this.pickerSrv.closeAfterSelected) {
            this.pickerSrv.closeDropdownEvent.next();
        }
    }
    isDisable(yearIndex) {
        const date = new Date(yearIndex, 0, 1);
        return this.pickerSrv.maxDate.getTime() < date.getTime() || this.pickerSrv.minDate.getTime() > date.getTime();
    }
    setHoverTarget(yearIndex) {
        const date = new Date(yearIndex, 0, 1);
        if (this.isRangeType && !this.isDisable(yearIndex)) {
            this.curHoverDate = date;
        }
    }
    ngOnDestroy() {
        this.unsubscribe$.next();
        this.unsubscribe$.complete();
    }
}
YearPanelComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: YearPanelComponent, deps: [{ token: i0.ChangeDetectorRef }, { token: i1.DatepickerProService }], target: i0.ɵɵFactoryTarget.Component });
YearPanelComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.1.3", type: YearPanelComponent, selector: "d-year-panel", inputs: { isRangeType: "isRangeType" }, viewQueries: [{ propertyName: "scrollListCmp", first: true, predicate: ["scrollList"], descendants: true }], ngImport: i0, template: "<div class=\"year-list-panel\" (mouseleave)=\"curHoverDate = null\">\n  <cdk-virtual-scroll-viewport #scrollList [itemSize]=\"48\" class=\"devui-year-list\" minBufferPx=\"400\" maxBufferPx=\"600\">\n    <div class=\"devui-year-list-item\" *cdkVirtualFor=\"let years of yearList; let index = index\">\n      <p\n        class=\"devui-year-title\"\n        [ngClass]=\"{\n          'devui-this-year': isThisYear(year),\n          'devui-active-year': isActiveYear(year),\n          'devui-disabled': isDisable(year),\n          'devui-table-date-inrange': isDateInRange(year),\n          'devui-table-date-start': isStartDate(year),\n          'devui-table-date-end': isEndDate(year),\n          'devui-table-date-abandon-selected': isDateAbandon(year),\n          'devui-table-date-in-selected-range': isDateInSelectRange(year),\n          'devui-table-date-active-type': isActiveTypeDate(year)\n        }\"\n        (click)=\"selectYear(year)\"\n        (mouseenter)=\"setHoverTarget(year)\"\n        *ngFor=\"let year of years\"\n      >\n        {{ year }}\n      </p>\n    </div>\n  </cdk-virtual-scroll-viewport>\n</div>\n", styles: [".year-list-panel{width:204px;height:200px;padding:8px 12px}.year-list-panel .devui-year-list{width:184px;height:186px;scrollbar-width:none}.year-list-panel .devui-year-list::-webkit-scrollbar{width:0}.year-list-panel .devui-year-list:hover{overflow-y:overlay;scrollbar-width:thin}.year-list-panel .devui-year-list:hover::-webkit-scrollbar{width:4px}.year-list-panel .devui-year-list .devui-year-list-item{padding:4px 0;height:48px}.year-list-panel .devui-year-list .devui-year-title{width:60px;height:40px;float:left;font-size:12px;display:block;text-align:center;line-height:40px;cursor:pointer;border-radius:4px;border-radius:var(--devui-border-radius-feedback, 4px)}.year-list-panel .devui-year-list .devui-year-title:hover:not(.devui-active-year):not(.devui-disabled){background-color:#f2f2f3;background-color:var(--devui-list-item-hover-bg, #f2f2f3)}.year-list-panel .devui-year-list .devui-year-title.devui-this-year{color:#5e7ce0;color:var(--devui-brand, #5e7ce0)}.year-list-panel .devui-year-list .devui-year-title.devui-active-year{background:#f2f5fc;background:var(--devui-list-item-active-bg, #f2f5fc);color:#252b3a;color:var(--devui-list-item-active-text, #252b3a)}.year-list-panel .devui-year-list .devui-year-title.devui-active-year.devui-table-date-abandon-selected{background:#beccfa;background:var(--devui-primary-disabled, #beccfa)}.year-list-panel .devui-year-list .devui-year-title.devui-table-date-inrange:not(.devui-active-year){background-color:#f2f2f3;background-color:var(--devui-list-item-hover-bg, #f2f2f3);border-radius:0}.year-list-panel .devui-year-list .devui-year-title.devui-table-date-start:not(.devui-table-date-end){border-radius:4px 0 0 4px;border-radius:var(--devui-border-radius-feedback, 4px) 0 0 var(--devui-border-radius-feedback, 4px)}.year-list-panel .devui-year-list .devui-year-title.devui-table-date-end:not(.devui-table-date-start){border-radius:0 4px 4px 0;border-radius:0 var(--devui-border-radius-feedback, 4px) var(--devui-border-radius-feedback, 4px) 0}.year-list-panel .devui-year-list .devui-year-title.devui-table-date-in-selected-range:not(.devui-table-date-inrange):not(:hover){background-color:#f5f5f5;background-color:var(--devui-disabled-bg, #f5f5f5);border-radius:0}.year-list-panel .devui-year-list .devui-year-title.devui-table-date-active-type:not(.devui-table-date-abandon-selected){-webkit-animation:2s ease 0s infinite normal both breath-animation;animation:2s ease 0s infinite normal both breath-animation}@-webkit-keyframes breath-animation{0%{box-shadow:0 0 #f2f5fc;box-shadow:0 0 0 var(--devui-list-item-active-bg, #f2f5fc)}50%{box-shadow:0 0 8px #f2f5fc;box-shadow:0 0 8px var(--devui-list-item-active-bg, #f2f5fc)}to{box-shadow:0 0 #f2f5fc;box-shadow:0 0 0 var(--devui-list-item-active-bg, #f2f5fc)}}@keyframes breath-animation{0%{box-shadow:0 0 #f2f5fc;box-shadow:0 0 0 var(--devui-list-item-active-bg, #f2f5fc)}50%{box-shadow:0 0 8px #f2f5fc;box-shadow:0 0 8px var(--devui-list-item-active-bg, #f2f5fc)}to{box-shadow:0 0 #f2f5fc;box-shadow:0 0 0 var(--devui-list-item-active-bg, #f2f5fc)}}.year-list-panel .devui-year-list .devui-year-title.devui-disabled{border-radius:0;cursor:not-allowed}.year-list-panel .devui-year-list .devui-year-title.devui-disabled:first-of-type{border-radius:4px 0 0 4px;border-radius:var(--devui-border-radius-feedback, 4px) 0 0 var(--devui-border-radius-feedback, 4px)}.year-list-panel .devui-year-list .devui-year-title.devui-disabled:last-of-type{border-radius:0 4px 4px 0;border-radius:0 var(--devui-border-radius-feedback, 4px) var(--devui-border-radius-feedback, 4px) 0}\n"], components: [{ type: i2.CdkVirtualScrollViewport, selector: "cdk-virtual-scroll-viewport", inputs: ["orientation", "appendOnly"], outputs: ["scrolledIndexChange"] }], directives: [{ type: i2.CdkFixedSizeVirtualScroll, selector: "cdk-virtual-scroll-viewport[itemSize]", inputs: ["itemSize", "minBufferPx", "maxBufferPx"] }, { type: i2.CdkVirtualForOf, selector: "[cdkVirtualFor][cdkVirtualForOf]", inputs: ["cdkVirtualForOf", "cdkVirtualForTrackBy", "cdkVirtualForTemplate", "cdkVirtualForTemplateCacheSize"] }, { type: i3.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i3.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: YearPanelComponent, decorators: [{
            type: Component,
            args: [{ selector: 'd-year-panel', preserveWhitespaces: false, changeDetection: ChangeDetectionStrategy.OnPush, template: "<div class=\"year-list-panel\" (mouseleave)=\"curHoverDate = null\">\n  <cdk-virtual-scroll-viewport #scrollList [itemSize]=\"48\" class=\"devui-year-list\" minBufferPx=\"400\" maxBufferPx=\"600\">\n    <div class=\"devui-year-list-item\" *cdkVirtualFor=\"let years of yearList; let index = index\">\n      <p\n        class=\"devui-year-title\"\n        [ngClass]=\"{\n          'devui-this-year': isThisYear(year),\n          'devui-active-year': isActiveYear(year),\n          'devui-disabled': isDisable(year),\n          'devui-table-date-inrange': isDateInRange(year),\n          'devui-table-date-start': isStartDate(year),\n          'devui-table-date-end': isEndDate(year),\n          'devui-table-date-abandon-selected': isDateAbandon(year),\n          'devui-table-date-in-selected-range': isDateInSelectRange(year),\n          'devui-table-date-active-type': isActiveTypeDate(year)\n        }\"\n        (click)=\"selectYear(year)\"\n        (mouseenter)=\"setHoverTarget(year)\"\n        *ngFor=\"let year of years\"\n      >\n        {{ year }}\n      </p>\n    </div>\n  </cdk-virtual-scroll-viewport>\n</div>\n", styles: [".year-list-panel{width:204px;height:200px;padding:8px 12px}.year-list-panel .devui-year-list{width:184px;height:186px;scrollbar-width:none}.year-list-panel .devui-year-list::-webkit-scrollbar{width:0}.year-list-panel .devui-year-list:hover{overflow-y:overlay;scrollbar-width:thin}.year-list-panel .devui-year-list:hover::-webkit-scrollbar{width:4px}.year-list-panel .devui-year-list .devui-year-list-item{padding:4px 0;height:48px}.year-list-panel .devui-year-list .devui-year-title{width:60px;height:40px;float:left;font-size:12px;display:block;text-align:center;line-height:40px;cursor:pointer;border-radius:4px;border-radius:var(--devui-border-radius-feedback, 4px)}.year-list-panel .devui-year-list .devui-year-title:hover:not(.devui-active-year):not(.devui-disabled){background-color:#f2f2f3;background-color:var(--devui-list-item-hover-bg, #f2f2f3)}.year-list-panel .devui-year-list .devui-year-title.devui-this-year{color:#5e7ce0;color:var(--devui-brand, #5e7ce0)}.year-list-panel .devui-year-list .devui-year-title.devui-active-year{background:#f2f5fc;background:var(--devui-list-item-active-bg, #f2f5fc);color:#252b3a;color:var(--devui-list-item-active-text, #252b3a)}.year-list-panel .devui-year-list .devui-year-title.devui-active-year.devui-table-date-abandon-selected{background:#beccfa;background:var(--devui-primary-disabled, #beccfa)}.year-list-panel .devui-year-list .devui-year-title.devui-table-date-inrange:not(.devui-active-year){background-color:#f2f2f3;background-color:var(--devui-list-item-hover-bg, #f2f2f3);border-radius:0}.year-list-panel .devui-year-list .devui-year-title.devui-table-date-start:not(.devui-table-date-end){border-radius:4px 0 0 4px;border-radius:var(--devui-border-radius-feedback, 4px) 0 0 var(--devui-border-radius-feedback, 4px)}.year-list-panel .devui-year-list .devui-year-title.devui-table-date-end:not(.devui-table-date-start){border-radius:0 4px 4px 0;border-radius:0 var(--devui-border-radius-feedback, 4px) var(--devui-border-radius-feedback, 4px) 0}.year-list-panel .devui-year-list .devui-year-title.devui-table-date-in-selected-range:not(.devui-table-date-inrange):not(:hover){background-color:#f5f5f5;background-color:var(--devui-disabled-bg, #f5f5f5);border-radius:0}.year-list-panel .devui-year-list .devui-year-title.devui-table-date-active-type:not(.devui-table-date-abandon-selected){-webkit-animation:2s ease 0s infinite normal both breath-animation;animation:2s ease 0s infinite normal both breath-animation}@-webkit-keyframes breath-animation{0%{box-shadow:0 0 #f2f5fc;box-shadow:0 0 0 var(--devui-list-item-active-bg, #f2f5fc)}50%{box-shadow:0 0 8px #f2f5fc;box-shadow:0 0 8px var(--devui-list-item-active-bg, #f2f5fc)}to{box-shadow:0 0 #f2f5fc;box-shadow:0 0 0 var(--devui-list-item-active-bg, #f2f5fc)}}@keyframes breath-animation{0%{box-shadow:0 0 #f2f5fc;box-shadow:0 0 0 var(--devui-list-item-active-bg, #f2f5fc)}50%{box-shadow:0 0 8px #f2f5fc;box-shadow:0 0 8px var(--devui-list-item-active-bg, #f2f5fc)}to{box-shadow:0 0 #f2f5fc;box-shadow:0 0 0 var(--devui-list-item-active-bg, #f2f5fc)}}.year-list-panel .devui-year-list .devui-year-title.devui-disabled{border-radius:0;cursor:not-allowed}.year-list-panel .devui-year-list .devui-year-title.devui-disabled:first-of-type{border-radius:4px 0 0 4px;border-radius:var(--devui-border-radius-feedback, 4px) 0 0 var(--devui-border-radius-feedback, 4px)}.year-list-panel .devui-year-list .devui-year-title.devui-disabled:last-of-type{border-radius:0 4px 4px 0;border-radius:0 var(--devui-border-radius-feedback, 4px) var(--devui-border-radius-feedback, 4px) 0}\n"] }]
        }], ctorParameters: function () { return [{ type: i0.ChangeDetectorRef }, { type: i1.DatepickerProService }]; }, propDecorators: { scrollListCmp: [{
                type: ViewChild,
                args: ['scrollList']
            }], isRangeType: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieWVhci1wYW5lbC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9kZXZ1aS9kYXRlcGlja2VyLXByby9saWIveWVhci1wYW5lbC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi9kZXZ1aS9kYXRlcGlja2VyLXByby9saWIveWVhci1wYW5lbC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNsRSxPQUFPLEVBQ0wsdUJBQXVCLEVBRXZCLGlCQUFpQixFQUVqQixTQUFTLEVBQ1QsS0FBSyxFQUdMLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDOzs7OztBQVNqRSxNQUFNLE9BQU8sa0JBQWtCO0lBd0M3QixZQUNVLEdBQXNCLEVBQ3RCLFNBQStCO1FBRC9CLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQ3RCLGNBQVMsR0FBVCxTQUFTLENBQXNCO1FBeENoQyxnQkFBVyxHQUFHLEtBQUssQ0FBQztRQUU3QixhQUFRLEdBQUcsRUFBRSxDQUFDO1FBRWQsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBc0M3QixDQUFDO0lBcENELElBQUksWUFBWTtRQUNkLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUM7SUFDckMsQ0FBQztJQUVELElBQUksWUFBWSxDQUFDLEtBQVc7UUFDMUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxJQUFJLFdB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LElBQUksSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDbEQsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7U0FDMUI7SUFDSCxDQUFDO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDekIsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUMvQixDQUFDOzsrR0F4TVUsa0JBQWtCO21HQUFsQixrQkFBa0IseU1DeEIvQix3bUNBeUJBOzJGRERhLGtCQUFrQjtrQkFQOUIsU0FBUzsrQkFDRSxjQUFjLHVCQUdILEtBQUssbUJBQ1QsdUJBQXVCLENBQUMsTUFBTTsySUFHdEIsYUFBYTtzQkFBckMsU0FBUzt1QkFBQyxZQUFZO2dCQUNkLFdBQVc7c0JBQW5CLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZGtWaXJ0dWFsU2Nyb2xsVmlld3BvcnQgfSBmcm9tICdAYW5ndWxhci9jZGsvc2Nyb2xsaW5nJztcbmltcG9ydCB7XG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuXG4gIENoYW5nZURldGVjdG9yUmVmLFxuXG4gIENvbXBvbmVudCxcbiAgSW5wdXQsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBWaWV3Q2hpbGRcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBjaHVuayB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBEYXRlcGlja2VyUHJvU2VydmljZSB9IGZyb20gJy4uL2RhdGVwaWNrZXItcHJvLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdkLXllYXItcGFuZWwnLFxuICB0ZW1wbGF0ZVVybDogJy4veWVhci1wYW5lbC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL3llYXItcGFuZWwuY29tcG9uZW50LnNjc3MnXSxcbiAgcHJlc2VydmVXaGl0ZXNwYWNlczogZmFsc2UsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXG59KVxuZXhwb3J0IGNsYXNzIFllYXJQYW5lbENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgQFZpZXdDaGlsZCgnc2Nyb2xsTGlzdCcpIHNjcm9sbExpc3RDbXA6IENka1ZpcnR1YWxTY3JvbGxWaWV3cG9ydDtcbiAgQElucHV0KCkgaXNSYW5nZVR5cGUgPSBmYWxzZTtcblxuICB5ZWFyTGlzdCA9IFtdO1xuXG4gIHVuc3Vic2NyaWJlJCA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgZ2V0IGN1ckhvdmVyRGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5waWNrZXJTcnYuY3VySG92ZXJEYXRlO1xuICB9XG5cbiAgc2V0IGN1ckhvdmVyRGF0ZSh2YWx1ZTogRGF0ZSkge1xuICAgIHRoaXMucGlja2VyU3J2LmN1ckhvdmVyRGF0ZSA9IHZhbHVlO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnREYXRlKCkge1xuICAgIGlmICh0aGlzLmlzUmFuZ2VUeXBlKSB7XG4gICAgICBpZiAodGhpcy5waWNrZXJTcnYuY3VycmVudEFjdGl2ZUlucHV0ID09PSAnc3RhcnQnKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBpY2tlclNydi5jdXJSYW5nZURhdGVbMF07XG4gICAgICB9IGVsc2UgaWYgKHRoaXMucGlja2VyU3J2LmN1cnJlbnRBY3RpdmVJbnB1dCA9PT0gJ2VuZCcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGlja2VyU3J2LmN1clJhbmdlRGF0ZVsxXTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMucGlja2VyU3J2LmN1ckRhdGU7XG4gICAgfVxuICB9XG5cbiAgc2V0IGN1cnJlbnREYXRlKHZhbHVlOiBEYXRlKSB7XG4gICAgaWYgKHRoaXMuaXNSYW5nZVR5cGUpIHtcbiAgICAgIGlmICh0aGlzLnBpY2tlclNydi5jdXJyZW50QWN0aXZlSW5wdXQgPT09ICdzdGFydCcpIHtcbiAgICAgICAgdGhpcy5waWNrZXJTcnYuY3VyUmFuZ2VEYXRlWzBdID0gdmFsdWU7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMucGlja2VyU3J2LmN1cnJlbnRBY3RpdmVJbnB1dCA9PT0gJ2VuZCcpIHtcbiAgICAgICAgdGhpcy5waWNrZXJTcnYuY3VyUmFuZ2VEYXRlWzFdID0gdmFsdWU7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucGlja2VyU3J2LmN1ckRhdGUgPSB2YWx1ZTtcbiAgICB9XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSBwaWNrZXJTcnY6IERhdGVwaWNrZXJQcm9TZXJ2aWNlXG4gICkge1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5pbml0WWVhckxpc3QoKTtcbiAgICB0aGlzLmluaXRPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBpbml0T2JzZXJ2YWJsZSgpIHtcbiAgICB0aGlzLnBpY2tlclNydi50b2dnbGVFdmVudC5zdWJzY3JpYmUoaXNPcGVuID0+IHtcbiAgICAgIGlmIChpc09wZW4pIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5nb1RvWWVhcih0aGlzLmN1cnJlbnREYXRlIHx8IG5ldyBEYXRlKCkpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMucGlja2VyU3J2LnVwZGF0ZURhdGVWYWx1ZS5waXBlKFxuICAgICAgdGFrZVVudGlsKHRoaXMudW5zdWJzY3JpYmUkKSxcbiAgICApLnN1YnNjcmliZShyZXMgPT4ge1xuICAgICAgaWYgKHJlcy50eXBlID09PSAncmFuZ2UnKSB7XG4gICAgICAgIHRoaXMucGlja2VyU3J2LmN1clJhbmdlRGF0ZSA9IHJlcy52YWx1ZSBhcyBEYXRlW107XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnBpY2tlclNydi5jdXJEYXRlID0gcmVzLnZhbHVlIGFzIERhdGU7XG4gICAgICB9XG4gICAgICB0aGlzLmdvVG9ZZWFyKHRoaXMuY3VycmVudERhdGUgfHwgbmV3IERhdGUoKSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnBpY2tlclNydi5hY3RpdmVJbnB1dENoYW5nZS5waXBlKFxuICAgICAgdGFrZVVudGlsKHRoaXMudW5zdWJzY3JpYmUkKVxuICAgICkuc3Vic2NyaWJlKHR5cGUgPT4ge1xuICAgICAgaWYgKHR5cGUgPT09ICdzdGFydCcpIHtcbiAgICAgICAgdGhpcy5nb1RvWWVhcih0aGlzLnBpY2tlclNydi5jdXJSYW5nZURhdGVbMF0gfHwgdGhpcy5waWNrZXJTcnYuY3VyUmFuZ2VEYXRlWzFdIHx8IG5ldyBEYXRlKCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5nb1RvWWVhcih0aGlzLnBpY2tlclNydi5jdXJSYW5nZURhdGVbMV0gfHwgdGhpcy5waWNrZXJTcnYuY3VyUmFuZ2VEYXRlWzBdIHx8IG5ldyBEYXRlKCkpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaW5pdFllYXJMaXN0KCkge1xuICAgIGNvbnN0IGxpc3QgPSBuZXcgQXJyYXkodGhpcy5waWNrZXJTcnYuY2FsZW5kYXJSYW5nZVsxXSAtIHRoaXMucGlja2VyU3J2LmNhbGVuZGFyUmFuZ2VbMF0gKyAxKS5maWxsKDEpLm1hcCgodCwgaSkgPT4ge1xuICAgICAgcmV0dXJuIGkgKyB0aGlzLnBpY2tlclNydi5jYWxlbmRhclJhbmdlWzBdO1xuICAgIH0pO1xuICAgIHRoaXMueWVhckxpc3QgPSBjaHVuayhsaXN0LCAzKTtcbiAgfVxuXG4gIGdvVG9ZZWFyKGRhdGU6IERhdGUpIHtcbiAgICBpZiAoZGF0ZSkge1xuICAgICAgY29uc3QgaW5kZXggPSBNYXRoLmZsb29yKChkYXRlLmdldEZ1bGxZZWFyKCkgLSB0aGlzLnBpY2tlclNydi5jYWxlbmRhclJhbmdlWzBdKSAvIDMpO1xuICAgICAgdGhpcy5zY3JvbGxMaXN0Q21wLnNjcm9sbFRvSW5kZXgoaW5kZXggLSAxKTtcbiAgICB9XG4gICAgdGhpcy5jZHIuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgaXNUaGlzWWVhcih5ZWFySW5kZXg6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB5ZWFySW5kZXggPT09IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKTtcbiAgfVxuXG4gIGlzQWN0aXZlWWVhcih5ZWFySW5kZXg6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnBpY2tlclNydi5pc1llYXJBY3RpdmUoeWVhckluZGV4KTtcbiAgfVxuXG4gIGlzU3RhcnREYXRlKHllYXJJbmRleDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgaWYgKCF0aGlzLmlzUmFuZ2VUeXBlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSh5ZWFySW5kZXgsIDAsIDEpO1xuICAgIHJldHVybiB0aGlzLnBpY2tlclNydi5pc1N0YXJ0RGF0ZShkYXRlKTtcbiAgfVxuXG4gIGlzRW5kRGF0ZSh5ZWFySW5kZXg6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpcy5pc1JhbmdlVHlwZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoeWVhckluZGV4LCAwLCAxKTtcbiAgICByZXR1cm4gdGhpcy5waWNrZXJTcnYuaXNFbmREYXRlKGRhdGUpO1xuICB9XG5cbiAgaXNEYXRlQWJhbmRvbih5ZWFySW5kZXg6IG51bWJlcikge1xuICAgIGlmICghdGhpcy5pc1JhbmdlVHlwZSB8fCAoIXRoaXMucGlja2VyU3J2LmN1clJhbmdlRGF0ZVswXSB8fCAhdGhpcy5waWNrZXJTcnYuY3VyUmFuZ2VEYXRlWzFdKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoeWVhckluZGV4LCAwLCAxKTtcbiAgICByZXR1cm4gdGhpcy5waWNrZXJTcnYuaXNEYXRlQWJhbmRvbihkYXRlKTtcbiAgfVxuXG4gIGlzQWN0aXZlVHlwZURhdGUoeWVhckluZGV4OiBudW1iZXIpIHtcbiAgICBpZiAoIXRoaXMuaXNSYW5nZVR5cGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoeWVhckluZGV4LCAwLCAxKTtcblxuICAgIHJldHVybiB0aGlzLnBpY2tlclNydi5pc0FjdGl2ZUlucHV0VHlwZURhdGUoZGF0ZSk7XG4gIH1cblxuICBpc0RhdGVJblJhbmdlKHllYXJJbmRleDogbnVtYmVyKSB7XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKHllYXJJbmRleCwgMCwgMSk7XG4gICAgcmV0dXJuIHRoaXMucGlja2VyU3J2LmlzRGF0ZUluUmFuZ2UoZGF0ZSk7XG4gIH1cblxuICBpc0RhdGVJblNlbGVjdFJhbmdlKHllYXJJbmRleDogbnVtYmVyKSB7XG4gICAgaWYgKCF0aGlzLmlzUmFuZ2VUeXBlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKHllYXJJbmRleCwgMCwgMSk7XG5cbiAgICByZXR1cm4gdGhpcy5waWNrZXJTcnYuaXNEYXRlSW5TZWxlY3RSYW5nZShkYXRlKTtcbiAgfVxuXG4gIHNlbGVjdFllYXIoeWVhckluZGV4OiBudW1iZXIpIHtcbiAgICBpZiAodGhpcy5pc0Rpc2FibGUoeWVhckluZGV4KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmN1cnJlbnREYXRlID0gbmV3IERhdGUoeWVhckluZGV4LCAwICwgMSk7XG5cbiAgICBpZiAodGhpcy5pc1JhbmdlVHlwZSkge1xuICAgICAgdGhpcy5waWNrZXJTcnYuZml4UmFuZ2VEYXRlKCk7XG4gICAgfVxuXG4gICAgLy8g6Z2e5pe26Ze05qih5byP5LiL6YCJ5a6M5byA5aeL5pel5pyf6Lez6L2s5Yiw57uT5p2f5pel5pyfXG4gICAgaWYgKHRoaXMuaXNSYW5nZVR5cGUpIHtcbiAgICAgIGlmICh0aGlzLnBpY2tlclNydi5jdXJyZW50QWN0aXZlSW5wdXQgPT09ICdzdGFydCcpIHtcbiAgICAgICAgdGhpcy5waWNrZXJTcnYuY3VycmVudEFjdGl2ZUlucHV0ID0gJ2VuZCc7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMucGlja2VyU3J2LmN1cnJlbnRBY3RpdmVJbnB1dCA9PT0gJ2VuZCcgJiYgIXRoaXMucGlja2VyU3J2LmN1clJhbmdlRGF0ZVswXSkge1xuICAgICAgICB0aGlzLnBpY2tlclNydi5jdXJyZW50QWN0aXZlSW5wdXQgPSAnc3RhcnQnO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5waWNrZXJTcnYuY2xvc2VEcm9wZG93bkV2ZW50Lm5leHQoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLnBpY2tlclNydi5zZWxlY3RlZERhdGVDaGFuZ2UubmV4dCh7XG4gICAgICB0eXBlOiB0aGlzLmlzUmFuZ2VUeXBlID8gJ3JhbmdlJyA6ICdzaW5nbGUnLFxuICAgICAgdmFsdWU6IHRoaXMuaXNSYW5nZVR5cGUgPyB0aGlzLnBpY2tlclNydi5jdXJSYW5nZURhdGUgOiB0aGlzLmN1cnJlbnREYXRlXG4gICAgfSk7XG5cbiAgICBpZiAodGhpcy5waWNrZXJTcnYuY2xvc2VBZnRlclNlbGVjdGVkKSB7XG4gICAgICB0aGlzLnBpY2tlclNydi5jbG9zZURyb3Bkb3duRXZlbnQubmV4dCgpO1xuICAgIH1cbiAgfVxuXG4gIGlzRGlzYWJsZSh5ZWFySW5kZXg6IG51bWJlcikge1xuICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSh5ZWFySW5kZXgsIDAsIDEpO1xuICAgIHJldHVybiB0aGlzLnBpY2tlclNydi5tYXhEYXRlLmdldFRpbWUoKSA8ICBkYXRlLmdldFRpbWUoKSB8fCB0aGlzLnBpY2tlclNydi5taW5EYXRlLmdldFRpbWUoKSA+ICBkYXRlLmdldFRpbWUoKTtcbiAgfVxuXG4gIHNldEhvdmVyVGFyZ2V0KHllYXJJbmRleDogbnVtYmVyKSB7XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKHllYXJJbmRleCwgMCwgMSk7XG4gICAgaWYgKHRoaXMuaXNSYW5nZVR5cGUgJiYgIXRoaXMuaXNEaXNhYmxlKHllYXJJbmRleCkpIHtcbiAgICAgIHRoaXMuY3VySG92ZXJEYXRlID0gZGF0ZTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnVuc3Vic2NyaWJlJC5uZXh0KCk7XG4gICAgdGhpcy51bnN1YnNjcmliZSQuY29tcGxldGUoKTtcbiAgfVxufVxuIiwiPGRpdiBjbGFzcz1cInllYXItbGlzdC1wYW5lbFwiIChtb3VzZWxlYXZlKT1cImN1ckhvdmVyRGF0ZSA9IG51bGxcIj5cbiAgPGNkay12aXJ0dWFsLXNjcm9sbC12aWV3cG9ydCAjc2Nyb2xsTGlzdCBbaXRlbVNpemVdPVwiNDhcIiBjbGFzcz1cImRldnVpLXllYXItbGlzdFwiIG1pbkJ1ZmZlclB4PVwiNDAwXCIgbWF4QnVmZmVyUHg9XCI2MDBcIj5cbiAgICA8ZGl2IGNsYXNzPVwiZGV2dWkteWVhci1saXN0LWl0ZW1cIiAqY2RrVmlydHVhbEZvcj1cImxldCB5ZWFycyBvZiB5ZWFyTGlzdDsgbGV0IGluZGV4ID0gaW5kZXhcIj5cbiAgICAgIDxwXG4gICAgICAgIGNsYXNzPVwiZGV2dWkteWVhci10aXRsZVwiXG4gICAgICAgIFtuZ0NsYXNzXT1cIntcbiAgICAgICAgICAnZGV2dWktdGhpcy15ZWFyJzogaXNUaGlzWWVhcih5ZWFyKSxcbiAgICAgICAgICAnZGV2dWktYWN0aXZlLXllYXInOiBpc0FjdGl2ZVllYXIoeWVhciksXG4gICAgICAgICAgJ2RldnVpLWRpc2FibGVkJzogaXNEaXNhYmxlKHllYXIpLFxuICAgICAgICAgICdkZXZ1aS10YWJsZS1kYXRlLWlucmFuZ2UnOiBpc0RhdGVJblJhbmdlKHllYXIpLFxuICAgICAgICAgICdkZXZ1aS10YWJsZS1kYXRlLXN0YXJ0JzogaXNTdGFydERhdGUoeWVhciksXG4gICAgICAgICAgJ2RldnVpLXRhYmxlLWRhdGUtZW5kJzogaXNFbmREYXRlKHllYXIpLFxuICAgICAgICAgICdkZXZ1aS10YWJsZS1kYXRlLWFiYW5kb24tc2VsZWN0ZWQnOiBpc0RhdGVBYmFuZG9uKHllYXIpLFxuICAgICAgICAgICdkZXZ1aS10YWJsZS1kYXRlLWluLXNlbGVjdGVkLXJhbmdlJzogaXNEYXRlSW5TZWxlY3RSYW5nZSh5ZWFyKSxcbiAgICAgICAgICAnZGV2dWktdGFibGUtZGF0ZS1hY3RpdmUtdHlwZSc6IGlzQWN0aXZlVHlwZURhdGUoeWVhcilcbiAgICAgICAgfVwiXG4gICAgICAgIChjbGljayk9XCJzZWxlY3RZZWFyKHllYXIpXCJcbiAgICAgICAgKG1vdXNlZW50ZXIpPVwic2V0SG92ZXJUYXJnZXQoeWVhcilcIlxuICAgICAgICAqbmdGb3I9XCJsZXQgeWVhciBvZiB5ZWFyc1wiXG4gICAgICA+XG4gICAgICAgIHt7IHllYXIgfX1cbiAgICAgIDwvcD5cbiAgICA8L2Rpdj5cbiAgPC9jZGstdmlydHVhbC1zY3JvbGwtdmlld3BvcnQ+XG48L2Rpdj5cbiJdfQ==