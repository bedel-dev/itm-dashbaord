import { DOCUMENT } from '@angular/common';
import { ComponentFactoryResolver, Directive, ElementRef, HostListener, Inject, Injector, Input, TemplateRef, ViewContainerRef } from '@angular/core';
import { OverlayContainerRef } from 'ng-devui/overlay-container';
import { of } from 'rxjs';
import { ReadTipComponent } from './read-tip.component';
import * as i0 from "@angular/core";
import * as i1 from "ng-devui/overlay-container";
export class ReadTipDirective {
    constructor(el, componentFactoryResolver, overlayContainerRef, inject, viewContainerRef, doc) {
        this.el = el;
        this.componentFactoryResolver = componentFactoryResolver;
        this.overlayContainerRef = overlayContainerRef;
        this.inject = inject;
        this.viewContainerRef = viewContainerRef;
        this.doc = doc;
        this.defaultOptions = {
            trigger: 'hover',
            showAnimate: false,
            mouseenterTime: 100,
            mouseleaveTime: 100,
            position: 'top',
            overlayClassName: '',
            appendToBody: true,
            rules: { selector: null },
        };
        this.onDocumentClick = (event) => {
            event.stopPropagation();
            if (!this.el.nativeElement.contains(event.target) &&
                !(this.readTipComponentRef && this.readTipComponentRef.instance.elementRef.nativeElement.contains(event.target))) {
                this.hide();
            }
        };
        this.document = this.doc;
    }
    set prevTarget(target) {
        if (target !== this._prevTarget) {
            this._prevTarget = target;
            this.hide();
        }
    }
    onMouseOver(event) {
        this.findElementIndex(event.target, this.readTipOptions?.rules, 'hover').subscribe((elementInfo) => {
            if (elementInfo?.shouldTrigger) {
                this.hide();
                if (!this.readTipComponentRef) {
                    const target = new ElementRef(event.target);
                    setTimeout(() => {
                        this.show(target, elementInfo.rule);
                    }, elementInfo.rule?.mouseenterTime);
                }
                if (this.readTipComponentRef) {
                    setTimeout(() => {
                        if (this.readTipComponentRef) {
                            this.readTipComponentRef.instance.updatePosition();
                        }
                    }, elementInfo.rule?.mouseenterTime);
                }
            }
        });
    }
    onMouseOut(event) {
        this.findElementIndex(event.target, this.readTipOptions?.rules, 'hover').subscribe((elementInfo) => {
            if (elementInfo?.shouldTrigger) {
                setTimeout(() => {
                    this.hide();
                }, elementInfo.rule?.mouseleaveTime);
            }
        });
    }
    onClick(event) {
        this.findElementIndex(event.target, this.readTipOptions?.rules, 'click').subscribe((elementInfo) => {
            this.prevTarget = event.target;
            if (elementInfo?.shouldTrigger) {
                if (!this.readTipComponentRef) {
                    const target = new ElementRef(event.target);
                    this.show(target, elementInfo.rule);
                }
                if (this.readTipComponentRef) {
                    setTimeout(() => {
                        if (this.readTipComponentRef) {
                            this.readTipComponentRef.instance.updatePosition();
                        }
                    });
                }
            }
        });
    }
    ngOnInit() { }
    ngOnDestroy() {
        this.destroy();
    }
    show(target, rule) {
        this.hide();
        if (!this.readTipComponentRef) {
            this.createReadTip(target, rule);
        }
        if (rule.showAnimate) {
            this.readTipComponentRef.instance.show();
        }
        if (rule.trigger === 'click') {
            this.document.addEventListener('click', this.onDocumentClick);
        }
    }
    createReadTip(target, rule) {
        if (rule.appendToBody) {
            this.readTipComponentRef = this.overlayContainerRef.createComponent(this.componentFactoryResolver.resolveComponentFactory(ReadTipComponent));
        }
        else {
            this.readTipComponentRef = this.viewContainerRef.createComponent(this.componentFactoryResolver.resolveComponentFactory(ReadTipComponent), this.viewContainerRef.length, this.inject);
        }
        if (this.contentTemplate) {
            Object.assign(this.readTipComponentRef.instance, {
                content: this.contentTemplate,
                triggerElementRef: target,
                appendToBody: rule.appendToBody,
                position: rule.position,
                overlayClassName: rule.overlayClassName,
            });
        }
        else {
            if (rule.dataFn) {
                rule.dataFn({ element: target.nativeElement, rule }).subscribe((data) => {
                    if (data.template) {
                        Object.assign(this.readTipComponentRef.instance, {
                            content: data.template,
                            customData: data.customData,
                            triggerElementRef: target,
                            appendToBody: rule.appendToBody,
                            position: rule.position,
                            overlayClassName: rule.overlayClassName,
                        });
                    }
                    else {
                        Object.assign(this.readTipComponentRef.instance, {
                            content: data.content,
                            title: data.title,
                            triggerElementRef: target,
                            appendToBody: rule.appendToBody,
                            position: rule.position,
                            overlayClassName: rule.overlayClassName,
                        });
                    }
                });
            }
            else {
                Object.assign(this.readTipComponentRef.instance, {
                    content: rule.content,
                    title: rule.title,
                    triggerElementRef: target,
                    appendToBody: rule.appendToBody,
                    position: rule.position,
                    overlayClassName: rule.overlayClassName,
                });
            }
        }
    }
    hide() {
        if (this.readTipComponentRef) {
            if (!this.readTipOptions.showAnimate) {
                this.destroy();
                return;
            }
            this.readTipComponentRef.instance.hide();
            this.readTipComponentRef.instance.onHidden = () => {
                this.destroy();
            };
        }
    }
    destroy() {
        if (this.readTipComponentRef) {
            this.readTipComponentRef.destroy();
            this.readTipComponentRef = null;
        }
        if (this.readTipOptions.trigger === 'click') {
            this.document.removeEventListener('click', this.onDocumentClick);
        }
    }
    findElementIndex(element, rules, trigger) {
        const keysCanInherit = ['trigger', 'showAnimate', 'mouseenterTime', 'mouseleaveTime', 'position', 'overlayClassName', 'appendToBody'];
        if (rules instanceof Array) {
            let elementIndex = -1;
            for (let i = 0; i < rules.length; i++) {
                if (this.isCorrectElement(rules[i].selector, element)) {
                    elementIndex = i;
                    break;
                }
            }
            keysCanInherit.forEach((key) => {
                if (rules[elementIndex]) {
                    rules[elementIndex][key] = rules[elementIndex][key] || this.readTipOptions[key] || this.defaultOptions[key];
                }
            });
            return of({
                shouldTrigger: rules[elementIndex]?.trigger === trigger && this.isCorrectElement(rules[elementIndex]?.selector, element),
                rule: rules[elementIndex],
            });
        }
        else {
            keysCanInherit.forEach((key) => {
                if (rules) {
                    rules[key] = rules[key] || this.readTipOptions[key] || this.defaultOptions[key];
                }
            });
            return of({
                shouldTrigger: rules?.trigger === trigger && this.isCorrectElement(rules?.selector, element),
                rule: rules,
            });
        }
    }
    isCorrectElement(selector, element) {
        const elementsArray = this.el.nativeElement.querySelectorAll(selector);
        for (let i = 0; i < elementsArray.length; i++) {
            if (elementsArray[i] === element) {
                return true;
            }
        }
        return false;
    }
}
ReadTipDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ReadTipDirective, deps: [{ token: i0.ElementRef }, { token: i0.ComponentFactoryResolver }, { token: i1.OverlayContainerRef }, { token: i0.Injector }, { token: i0.ViewContainerRef }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Directive });
ReadTipDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.3", type: ReadTipDirective, selector: "[dReadTip]", inputs: { readTipOptions: "readTipOptions", contentTemplate: "contentTemplate" }, host: { listeners: { "mouseover": "onMouseOver($event)", "mouseout": "onMouseOut($event)", "click": "onClick($event)" } }, exportAs: ["dReadTip"], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ReadTipDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[dReadTip]',
                    exportAs: 'dReadTip',
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.ComponentFactoryResolver }, { type: i1.OverlayContainerRef }, { type: i0.Injector }, { type: i0.ViewContainerRef }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; }, propDecorators: { readTipOptions: [{
                type: Input
            }], contentTemplate: [{
                type: Input
            }], onMouseOver: [{
                type: HostListener,
                args: ['mouseover', ['$event']]
            }], onMouseOut: [{
                type: HostListener,
                args: ['mouseout', ['$event']]
            }], onClick: [{
                type: HostListener,
                args: ['click', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZC10aXAuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vZGV2dWkvcmVhZC10aXAvcmVhZC10aXAuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQ0wsd0JBQXdCLEVBRXhCLFNBQVMsRUFDVCxVQUFVLEVBQ1YsWUFBWSxFQUNaLE1BQU0sRUFDTixRQUFRLEVBQ1IsS0FBSyxFQUdMLFdBQVcsRUFDWCxnQkFBZ0IsRUFDakIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDakUsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7O0FBT3hELE1BQU0sT0FBTyxnQkFBZ0I7SUFpRjNCLFlBQ1UsRUFBYyxFQUNkLHdCQUFrRCxFQUNsRCxtQkFBd0MsRUFDeEMsTUFBZ0IsRUFDaEIsZ0JBQWtDLEVBQ2hCLEdBQVE7UUFMMUIsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUNkLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4QyxXQUFNLEdBQU4sTUFBTSxDQUFVO1FBQ2hCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDaEIsUUFBRyxHQUFILEdBQUcsQ0FBSztRQWpGcEMsbUJBQWMsR0FBbUI7WUFDL0IsT0FBTyxFQUFFLE9BQU87WUFDaEIsV0FBVyxFQUFFLEtBQUs7WUFDbEIsY0FBYyxFQUFFLEdBQUc7WUFDbkIsY0FBYyxFQUFFLEdBQUc7WUFDbkIsUUFBUSxFQUFFLEtBQUs7WUFDZixnQkFBZ0IsRUFBRSxFQUFFO1lBQ3BCLFlBQVksRUFBRSxJQUFJO1lBQ2xCLEtBQUssRUFB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Q3ZFLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzdDLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxLQUFLLE9BQU8sRUFBRTtnQkFDaEMsT0FBTyxJQUFJLENBQUM7YUFDYjtTQUNGO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOzs2R0FyUFUsZ0JBQWdCLCtLQXVGakIsUUFBUTtpR0F2RlAsZ0JBQWdCOzJGQUFoQixnQkFBZ0I7a0JBSjVCLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLFlBQVk7b0JBQ3RCLFFBQVEsRUFBRSxVQUFVO2lCQUNyQjs7MEJBd0ZJLE1BQU07MkJBQUMsUUFBUTs0Q0EvRFQsY0FBYztzQkFBdEIsS0FBSztnQkFFRyxlQUFlO3NCQUF2QixLQUFLO2dCQUdOLFdBQVc7c0JBRFYsWUFBWTt1QkFBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUM7Z0JBdUJyQyxVQUFVO3NCQURULFlBQVk7dUJBQUMsVUFBVSxFQUFFLENBQUMsUUFBUSxDQUFDO2dCQVlwQyxPQUFPO3NCQUROLFlBQVk7dUJBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBDb21wb25lbnRSZWYsXG4gIERpcmVjdGl2ZSxcbiAgRWxlbWVudFJlZixcbiAgSG9zdExpc3RlbmVyLFxuICBJbmplY3QsXG4gIEluamVjdG9yLFxuICBJbnB1dCxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIFRlbXBsYXRlUmVmLFxuICBWaWV3Q29udGFpbmVyUmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT3ZlcmxheUNvbnRhaW5lclJlZiB9IGZyb20gJ25nLWRldnVpL292ZXJsYXktY29udGFpbmVyJztcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBSZWFkVGlwQ29tcG9uZW50IH0gZnJvbSAnLi9yZWFkLXRpcC5jb21wb25lbnQnO1xuaW1wb3J0IHsgUmVhZFRpcE9wdGlvbnMsIFJlYWRUaXBSdWxlIH0gZnJvbSAnLi9yZWFkLXRpcC50eXBlcyc7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tkUmVhZFRpcF0nLFxuICBleHBvcnRBczogJ2RSZWFkVGlwJyxcbn0pXG5leHBvcnQgY2xhc3MgUmVhZFRpcERpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgcmVhZFRpcENvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPFJlYWRUaXBDb21wb25lbnQ+O1xuXG4gIF9wcmV2VGFyZ2V0O1xuICBkb2N1bWVudDogRG9jdW1lbnQ7XG5cbiAgZGVmYXVsdE9wdGlvbnM6IFJlYWRUaXBPcHRpb25zID0ge1xuICAgIHRyaWdnZXI6ICdob3ZlcicsXG4gICAgc2hvd0FuaW1hdGU6IGZhbHNlLFxuICAgIG1vdXNlZW50ZXJUaW1lOiAxMDAsXG4gICAgbW91c2VsZWF2ZVRpbWU6IDEwMCxcbiAgICBwb3NpdGlvbjogJ3RvcCcsXG4gICAgb3ZlcmxheUNsYXNzTmFtZTogJycsXG4gICAgYXBwZW5kVG9Cb2R5OiB0cnVlLFxuICAgIHJ1bGVzOiB7IHNlbGVjdG9yOiBudWxsIH0sXG4gIH07XG5cbiAgc2V0IHByZXZUYXJnZXQodGFyZ2V0KSB7XG4gICAgaWYgKHRhcmdldCAhPT0gdGhpcy5fcHJldlRhcmdldCkge1xuICAgICAgdGhpcy5fcHJldlRhcmdldCA9IHRhcmdldDtcbiAgICAgIHRoaXMuaGlkZSgpO1xuICAgIH1cbiAgfVxuXG4gIEBJbnB1dCgpIHJlYWRUaXBPcHRpb25zOiBSZWFkVGlwT3B0aW9ucztcblxuICBASW5wdXQoKSBjb250ZW50VGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT47XG5cbiAgQEhvc3RMaXN0ZW5lcignbW91c2VvdmVyJywgWyckZXZlbnQnXSlcbiAgb25Nb3VzZU92ZXIoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICB0aGlzLmZpbmRFbGVtZW50SW5kZXgoZXZlbnQudGFyZ2V0LCB0aGlzLnJlYWRUaXBPcHRpb25zPy5ydWxlcywgJ2hvdmVyJykuc3Vic2NyaWJlKChlbGVtZW50SW5mbykgPT4ge1xuICAgICAgaWYgKGVsZW1lbnRJbmZvPy5zaG91bGRUcmlnZ2VyKSB7XG4gICAgICAgIHRoaXMuaGlkZSgpO1xuICAgICAgICBpZiAoIXRoaXMucmVhZFRpcENvbXBvbmVudFJlZikge1xuICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG5ldyBFbGVtZW50UmVmKGV2ZW50LnRhcmdldCk7XG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNob3codGFyZ2V0LCBlbGVtZW50SW5mby5ydWxlKTtcbiAgICAgICAgICB9LCBlbGVtZW50SW5mby5ydWxlPy5tb3VzZWVudGVyVGltZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucmVhZFRpcENvbXBvbmVudFJlZikge1xuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMucmVhZFRpcENvbXBvbmVudFJlZikge1xuICAgICAgICAgICAgICB0aGlzLnJlYWRUaXBDb21wb25lbnRSZWYuaW5zdGFuY2UudXBkYXRlUG9zaXRpb24oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LCBlbGVtZW50SW5mby5ydWxlPy5tb3VzZWVudGVyVGltZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ21vdXNlb3V0JywgWyckZXZlbnQnXSlcbiAgb25Nb3VzZU91dChldmVudDogTW91c2VFdmVudCkge1xuICAgIHRoaXMuZmluZEVsZW1lbnRJbmRleChldmVudC50YXJnZXQsIHRoaXMucmVhZFRpcE9wdGlvbnM/LnJ1bGVzLCAnaG92ZXInKS5zdWJzY3JpYmUoKGVsZW1lbnRJbmZvKSA9PiB7XG4gICAgICBpZiAoZWxlbWVudEluZm8/LnNob3VsZFRyaWdnZXIpIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5oaWRlKCk7XG4gICAgICAgIH0sIGVsZW1lbnRJbmZvLnJ1bGU/Lm1vdXNlbGVhdmVUaW1lKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJywgWyckZXZlbnQnXSlcbiAgb25DbGljayhldmVudDogTW91c2VFdmVudCkge1xuICAgIHRoaXMuZmluZEVsZW1lbnRJbmRleChldmVudC50YXJnZXQsIHRoaXMucmVhZFRpcE9wdGlvbnM/LnJ1bGVzLCAnY2xpY2snKS5zdWJzY3JpYmUoKGVsZW1lbnRJbmZvKSA9PiB7XG4gICAgICB0aGlzLnByZXZUYXJnZXQgPSBldmVudC50YXJnZXQ7XG4gICAgICBpZiAoZWxlbWVudEluZm8/LnNob3VsZFRyaWdnZXIpIHtcbiAgICAgICAgaWYgKCF0aGlzLnJlYWRUaXBDb21wb25lbnRSZWYpIHtcbiAgICAgICAgICBjb25zdCB0YXJnZXQgPSBuZXcgRWxlbWVudFJlZihldmVudC50YXJnZXQpO1xuICAgICAgICAgIHRoaXMuc2hvdyh0YXJnZXQsIGVsZW1lbnRJbmZvLnJ1bGUpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnJlYWRUaXBDb21wb25lbnRSZWYpIHtcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLnJlYWRUaXBDb21wb25lbnRSZWYpIHtcbiAgICAgICAgICAgICAgdGhpcy5yZWFkVGlwQ29tcG9uZW50UmVmLmluc3RhbmNlLnVwZGF0ZVBvc2l0aW9uKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIG92ZXJsYXlDb250YWluZXJSZWY6IE92ZXJsYXlDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSBpbmplY3Q6IEluamVjdG9yLFxuICAgIHByaXZhdGUgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZixcbiAgICBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIGRvYzogYW55XG4gICkge1xuICAgIHRoaXMuZG9jdW1lbnQgPSB0aGlzLmRvYztcbiAgfVxuXG4gIG5nT25Jbml0KCkge31cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRlc3Ryb3koKTtcbiAgfVxuXG4gIHNob3codGFyZ2V0LCBydWxlPzogUmVhZFRpcFJ1bGUpIHtcbiAgICB0aGlzLmhpZGUoKTtcbiAgICBpZiAoIXRoaXMucmVhZFRpcENvbXBvbmVudFJlZikge1xuICAgICAgdGhpcy5jcmVhdGVSZWFkVGlwKHRhcmdldCwgcnVsZSk7XG4gICAgfVxuXG4gICAgaWYgKHJ1bGUuc2hvd0FuaW1hdGUpIHtcbiAgICAgIHRoaXMucmVhZFRpcENvbXBvbmVudFJlZi5pbnN0YW5jZS5zaG93KCk7XG4gICAgfVxuICAgIGlmIChydWxlLnRyaWdnZXIgPT09ICdjbGljaycpIHtcbiAgICAgIHRoaXMuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLm9uRG9jdW1lbnRDbGljayk7XG4gICAgfVxuICB9XG5cbiAgY3JlYXRlUmVhZFRpcCh0YXJnZXQsIHJ1bGU/OiBSZWFkVGlwUnVsZSkge1xuICAgIGlmIChydWxlLmFwcGVuZFRvQm9keSkge1xuICAgICAgdGhpcy5yZWFkVGlwQ29tcG9uZW50UmVmID0gdGhpcy5vdmVybGF5Q29udGFpbmVyUmVmLmNyZWF0ZUNvbXBvbmVudChcbiAgICAgICAgdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoUmVhZFRpcENvbXBvbmVudClcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVhZFRpcENvbXBvbmVudFJlZiA9IHRoaXMudmlld0NvbnRhaW5lclJlZi5jcmVhdGVDb21wb25lbnQoXG4gICAgICAgIHRoaXMuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KFJlYWRUaXBDb21wb25lbnQpLFxuICAgICAgICB0aGlzLnZpZXdDb250YWluZXJSZWYubGVuZ3RoLFxuICAgICAgICB0aGlzLmluamVjdFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb250ZW50VGVtcGxhdGUpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5yZWFkVGlwQ29tcG9uZW50UmVmLmluc3RhbmNlLCB7XG4gICAgICAgIGNvbnRlbnQ6IHRoaXMuY29udGVudFRlbXBsYXRlLFxuICAgICAgICB0cmlnZ2VyRWxlbWVudFJlZjogdGFyZ2V0LFxuICAgICAgICBhcHBlbmRUb0JvZHk6IHJ1bGUuYXBwZW5kVG9Cb2R5LFxuICAgICAgICBwb3NpdGlvbjogcnVsZS5wb3NpdGlvbixcbiAgICAgICAgb3ZlcmxheUNsYXNzTmFtZTogcnVsZS5vdmVybGF5Q2xhc3NOYW1lLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChydWxlLmRhdGFGbikge1xuICAgICAgICBydWxlLmRhdGFGbih7IGVsZW1lbnQ6IHRhcmdldC5uYXRpdmVFbGVtZW50LCBydWxlIH0pLnN1YnNjcmliZSgoZGF0YSkgPT4ge1xuICAgICAgICAgIGlmIChkYXRhLnRlbXBsYXRlKSB7XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMucmVhZFRpcENvbXBvbmVudFJlZi5pbnN0YW5jZSwge1xuICAgICAgICAgICAgICBjb250ZW50OiBkYXRhLnRlbXBsYXRlLFxuICAgICAgICAgICAgICBjdXN0b21EYXRhOiBkYXRhLmN1c3RvbURhdGEsXG4gICAgICAgICAgICAgIHRyaWdnZXJFbGVtZW50UmVmOiB0YXJnZXQsXG4gICAgICAgICAgICAgIGFwcGVuZFRvQm9keTogcnVsZS5hcHBlbmRUb0JvZHksXG4gICAgICAgICAgICAgIHBvc2l0aW9uOiBydWxlLnBvc2l0aW9uLFxuICAgICAgICAgICAgICBvdmVybGF5Q2xhc3NOYW1lOiBydWxlLm92ZXJsYXlDbGFzc05hbWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnJlYWRUaXBDb21wb25lbnRSZWYuaW5zdGFuY2UsIHtcbiAgICAgICAgICAgICAgY29udGVudDogZGF0YS5jb250ZW50LFxuICAgICAgICAgICAgICB0aXRsZTogZGF0YS50aXRsZSxcbiAgICAgICAgICAgICAgdHJpZ2dlckVsZW1lbnRSZWY6IHRhcmdldCxcbiAgICAgICAgICAgICAgYXBwZW5kVG9Cb2R5OiBydWxlLmFwcGVuZFRvQm9keSxcbiAgICAgICAgICAgICAgcG9zaXRpb246IHJ1bGUucG9zaXRpb24sXG4gICAgICAgICAgICAgIG92ZXJsYXlDbGFzc05hbWU6IHJ1bGUub3ZlcmxheUNsYXNzTmFtZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMucmVhZFRpcENvbXBvbmVudFJlZi5pbnN0YW5jZSwge1xuICAgICAgICAgIGNvbnRlbnQ6IHJ1bGUuY29udGVudCxcbiAgICAgICAgICB0aXRsZTogcnVsZS50aXRsZSxcbiAgICAgICAgICB0cmlnZ2VyRWxlbWVudFJlZjogdGFyZ2V0LFxuICAgICAgICAgIGFwcGVuZFRvQm9keTogcnVsZS5hcHBlbmRUb0JvZHksXG4gICAgICAgICAgcG9zaXRpb246IHJ1bGUucG9zaXRpb24sXG4gICAgICAgICAgb3ZlcmxheUNsYXNzTmFtZTogcnVsZS5vdmVybGF5Q2xhc3NOYW1lLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBoaWRlKCkge1xuICAgIGlmICh0aGlzLnJlYWRUaXBDb21wb25lbnRSZWYpIHtcbiAgICAgIGlmICghdGhpcy5yZWFkVGlwT3B0aW9ucy5zaG93QW5pbWF0ZSkge1xuICAgICAgICB0aGlzLmRlc3Ryb3koKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnJlYWRUaXBDb21wb25lbnRSZWYuaW5zdGFuY2UuaGlkZSgpO1xuICAgICAgdGhpcy5yZWFkVGlwQ29tcG9uZW50UmVmLmluc3RhbmNlLm9uSGlkZGVuID0gKCkgPT4ge1xuICAgICAgICB0aGlzLmRlc3Ryb3koKTtcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5yZWFkVGlwQ29tcG9uZW50UmVmKSB7XG4gICAgICB0aGlzLnJlYWRUaXBDb21wb25lbnRSZWYuZGVzdHJveSgpO1xuICAgICAgdGhpcy5yZWFkVGlwQ29tcG9uZW50UmVmID0gbnVsbDtcbiAgICB9XG4gICAgaWYgKHRoaXMucmVhZFRpcE9wdGlvbnMudHJpZ2dlciA9PT0gJ2NsaWNrJykge1xuICAgICAgdGhpcy5kb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25Eb2N1bWVudENsaWNrKTtcbiAgICB9XG4gIH1cblxuICBvbkRvY3VtZW50Q2xpY2sgPSAoZXZlbnQpID0+IHtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICBpZiAoXG4gICAgICAhdGhpcy5lbC5uYXRpdmVFbGVtZW50LmNvbnRhaW5zKGV2ZW50LnRhcmdldCkgJiZcbiAgICAgICEodGhpcy5yZWFkVGlwQ29tcG9uZW50UmVmICYmIHRoaXMucmVhZFRpcENvbXBvbmVudFJlZi5pbnN0YW5jZS5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY29udGFpbnMoZXZlbnQudGFyZ2V0KSlcbiAgICApIHtcbiAgICAgIHRoaXMuaGlkZSgpO1xuICAgIH1cbiAgfTtcblxuICBmaW5kRWxlbWVudEluZGV4KGVsZW1lbnQsIHJ1bGVzLCB0cmlnZ2VyKSB7XG4gICAgY29uc3Qga2V5c0NhbkluaGVyaXQgPSBbJ3RyaWdnZXInLCAnc2hvd0FuaW1hdGUnLCAnbW91c2VlbnRlclRpbWUnLCAnbW91c2VsZWF2ZVRpbWUnLCAncG9zaXRpb24nLCAnb3ZlcmxheUNsYXNzTmFtZScsICdhcHBlbmRUb0JvZHknXTtcbiAgICBpZiAocnVsZXMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgbGV0IGVsZW1lbnRJbmRleCA9IC0xO1xuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJ1bGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmICh0aGlzLmlzQ29ycmVjdEVsZW1lbnQocnVsZXNbaV0uc2VsZWN0b3IsIGVsZW1lbnQpKSB7XG4gICAgICAgICAgZWxlbWVudEluZGV4ID0gaTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBrZXlzQ2FuSW5oZXJpdC5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgaWYgKHJ1bGVzW2VsZW1lbnRJbmRleF0pIHtcbiAgICAgICAgICBydWxlc1tlbGVtZW50SW5kZXhdW2tleV0gPSBydWxlc1tlbGVtZW50SW5kZXhdW2tleV0gfHwgdGhpcy5yZWFkVGlwT3B0aW9uc1trZXldIHx8IHRoaXMuZGVmYXVsdE9wdGlvbnNba2V5XTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gb2Yoe1xuICAgICAgICBzaG91bGRUcmlnZ2VyOiBydWxlc1tlbGVtZW50SW5kZXhdPy50cmlnZ2VyID09PSB0cmlnZ2VyICYmIHRoaXMuaXNDb3JyZWN0RWxlbWVudChydWxlc1tlbGVtZW50SW5kZXhdPy5zZWxlY3RvciwgZWxlbWVudCksXG4gICAgICAgIHJ1bGU6IHJ1bGVzW2VsZW1lbnRJbmRleF0sXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAga2V5c0NhbkluaGVyaXQuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgIGlmIChydWxlcykge1xuICAgICAgICAgIHJ1bGVzW2tleV0gPSBydWxlc1trZXldIHx8IHRoaXMucmVhZFRpcE9wdGlvbnNba2V5XSB8fCB0aGlzLmRlZmF1bHRPcHRpb25zW2tleV07XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIG9mKHtcbiAgICAgICAgc2hvdWxkVHJpZ2dlcjogcnVsZXM/LnRyaWdnZXIgPT09IHRyaWdnZXIgJiYgdGhpcy5pc0NvcnJlY3RFbGVtZW50KHJ1bGVzPy5zZWxlY3RvciwgZWxlbWVudCksXG4gICAgICAgIHJ1bGU6IHJ1bGVzLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgaXNDb3JyZWN0RWxlbWVudChzZWxlY3Rvcjogc3RyaW5nLCBlbGVtZW50KSB7XG4gICAgY29uc3QgZWxlbWVudHNBcnJheSA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVsZW1lbnRzQXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChlbGVtZW50c0FycmF5W2ldID09PSBlbGVtZW50KSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cbiJdfQ==