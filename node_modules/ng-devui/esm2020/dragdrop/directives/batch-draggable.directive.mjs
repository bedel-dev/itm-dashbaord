import { Directive, EventEmitter, Input, Output, Self } from '@angular/core';
import { DragDropService } from '../services/drag-drop.service';
import { DraggableDirective } from './draggable.directive';
import * as i0 from "@angular/core";
import * as i1 from "./draggable.directive";
import * as i2 from "../services/drag-drop.service";
export class BatchDraggableDirective {
    constructor(draggable, dragDropService) {
        this.draggable = draggable;
        this.dragDropService = dragDropService;
        this.batchDragGroup = 'default';
        this.batchDragActive = false;
        this.batchDragLastOneAutoActiveEventKeys = ['ctrlKey'];
        this.batchDragActiveEvent = new EventEmitter();
        this.needToRestore = false;
        this.batchDragStyle = ['badge', 'stack'];
        this.draggable.batchDraggable = this;
    }
    ngOnInit() {
        this.initDragDataByIdentity();
    }
    ngOnDestroy() {
        this.draggable.batchDraggable = undefined;
        if (this.dragData) {
            if (this.dragData.draggable === this.draggable) {
                this.dragData.draggable = undefined;
                if (!this.dragData.identity) {
                    this.removeFromBatchGroup();
                }
            }
        }
    }
    ngOnChanges(changes) {
        if (changes['batchDragActive']) {
            if (!this.initDragDataByIdentity()) {
                if (this.batchDragActive) {
                    if (!this.dragData && this.allowAddToBatchGroup()) {
                        this.addToBatchGroup();
                    }
                }
                else {
                    this.removeFromBatchGroup();
                }
            }
        }
    }
    ngAfterViewInit() {
        if (this.needToRestore) {
            this.restoreDragDataViewAfterViewInit();
            this.needToRestore = false;
        }
    }
    initDragDataByIdentity() {
        const dragData = this.findInBatchDragDataByIdentities();
        if (dragData) {
            if (this.batchDragActive) {
                if (!this.dragData) {
                    this.addToBatchGroup(dragData);
                    this.registerRestoreDragDataViewAfterViewInitWhiteDragging();
                }
            }
            else {
                this.removeFromBatchGroup(dragData);
            }
        }
        return dragData;
    }
    registerRestoreDragDataViewAfterViewInitWhiteDragging() {
        if (this.dragDropService.draggedEl && this.dragDropService.draggedElIdentity &&
            this.dragDropService.draggedEl !== this.draggable.el.nativeElement) {
            this.needToRestore = true;
        }
    }
    restoreDragDataViewAfterViewInit() {
        const draggable = this.draggable;
        if (draggable.originPlaceholder && draggable.originPlaceholder.show !== false) {
            draggable.insertOriginPlaceholder(true, false);
        }
        draggable.el.nativeElement.style.display = 'none';
    }
    allowAddToBatchGroup() {
        if (!this.dragDropService.batchDragGroup) {
            return true;
        }
        else {
            return this.batchDragGroup === this.dragDropService.batchDragGroup;
        }
    }
    addToBatchGroup(dragData) {
        this.dragDropService.batchDragGroup = this.dragDropService.batchDragGroup || this.batchDragGroup;
        if (dragData) {
            dragData.draggable = this.draggable;
            dragData.dragData = this.draggable.dragData;
            this.dragData = dragData;
        }
        else {
            this.dragData = this.dragData || {
                identity: this.draggable.dragIdentity || undefined,
                draggable: this.draggable,
                dragData: this.draggable.dragData
            };
            this.dragDropService.batchDragData = this.addToArrayIfNotExist(this.dragDropService.batchDragData, this.dragData);
        }
    }
    removeFromBatchGroup(dragData) {
        this.deleteFromArrayIfExist(this.dragDropService.batchDragData, dragData || this.dragData);
        this.dragData = undefined;
        if (!(this.dragDropService.batchDragData && this.dragDropService.batchDragData.length)) {
            this.dragDropService.batchDragGroup = undefined;
        }
    }
    addToArrayIfNotExist(array, target) {
        array = array || [];
        if (array.indexOf(target) === -1) {
            array.push(target);
        }
        return array;
    }
    deleteFromArrayIfExist(array, target) {
        if (!array) {
            return;
        }
        if (array.length > 0) {
            const index = array.indexOf(target);
            if (index > -1) {
                array.splice(index, 1);
            }
        }
        return array;
    }
    findInBatchDragDataByIdentities() {
        if (!this.draggable.dragIdentity) {
            return null;
        }
        else if (!this.dragDropService.batchDragData) {
            return undefined;
        }
        else {
            return this.dragDropService.batchDragData.filter(dragData => dragData.identity === this.draggable.dragIdentity).pop();
        }
    }
    active() {
        this.batchDragActiveEvent.emit({ el: this.draggable.el.nativeElement, data: this.draggable.dragData });
    }
    updateDragData() {
        // 选中状态才更新
        if (!this.dragData) {
            return;
        }
        // 需要维持内存地址不变
        Object.assign(this.dragData, {
            identity: this.draggable.dragIdentity || undefined,
            draggable: this.draggable,
            dragData: this.draggable.dragData
        });
    }
}
BatchDraggableDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: BatchDraggableDirective, deps: [{ token: i1.DraggableDirective, self: true }, { token: i2.DragDropService }], target: i0.ɵɵFactoryTarget.Directive });
BatchDraggableDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.3", type: BatchDraggableDirective, selector: "[dDraggable][batchDrag]", inputs: { batchDragGroup: "batchDragGroup", batchDragActive: "batchDragActive", batchDragLastOneAutoActiveEventKeys: "batchDragLastOneAutoActiveEventKeys", batchDragStyle: "batchDragStyle" }, outputs: { batchDragActiveEvent: "batchDragActiveEvent" }, exportAs: ["dBatchDraggable"], usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: BatchDraggableDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[dDraggable][batchDrag]',
                    exportAs: 'dBatchDraggable'
                }]
        }], ctorParameters: function () { return [{ type: i1.DraggableDirective, decorators: [{
                    type: Self
                }] }, { type: i2.DragDropService }]; }, propDecorators: { batchDragGroup: [{
                type: Input
            }], batchDragActive: [{
                type: Input
            }], batchDragLastOneAutoActiveEventKeys: [{
                type: Input
            }], batchDragActiveEvent: [{
                type: Output
            }], batchDragStyle: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmF0Y2gtZHJhZ2dhYmxlLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2RldnVpL2RyYWdkcm9wL2RpcmVjdGl2ZXMvYmF0Y2gtZHJhZ2dhYmxlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWlCLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFnQyxNQUFNLEVBQUUsSUFBSSxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUN6SSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDaEUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7Ozs7QUFPM0QsTUFBTSxPQUFPLHVCQUF1QjtJQVNsQyxZQUE0QixTQUE2QixFQUFXLGVBQWdDO1FBQXhFLGNBQVMsR0FBVCxTQUFTLENBQW9CO1FBQVcsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBUjNGLG1CQUFjLEdBQUcsU0FBUyxDQUFDO1FBQzNCLG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBQ3hCLHdDQUFtQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDakQseUJBQW9CLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUV6RCxrQkFBYSxHQUFHLEtBQUssQ0FBQztRQUNiLG1CQUFjLEdBQTBCLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBR2xFLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQztJQUN2QyxDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO0lBQ2hDLENBQUM7SUFFRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEdBQUcsU0FBUyxDQUFDO1FBQzFDLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNqQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxLQUFLLElBQUksQ0FB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Q0FBQyxZQUFZLElBQUksU0FBUztZQUNsRCxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsUUFBUSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUTtTQUNsQyxDQUFDLENBQUM7SUFDTCxDQUFDOztvSEF0SlUsdUJBQXVCO3dHQUF2Qix1QkFBdUI7MkZBQXZCLHVCQUF1QjtrQkFMbkMsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUseUJBQXlCO29CQUNuQyxRQUFRLEVBQUUsaUJBQWlCO2lCQUM1Qjs7MEJBV2MsSUFBSTswRUFSUixjQUFjO3NCQUF0QixLQUFLO2dCQUNHLGVBQWU7c0JBQXZCLEtBQUs7Z0JBQ0csbUNBQW1DO3NCQUEzQyxLQUFLO2dCQUNJLG9CQUFvQjtzQkFBN0IsTUFBTTtnQkFHRSxjQUFjO3NCQUF0QixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgRGlyZWN0aXZlLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSwgT25Jbml0LCBPdXRwdXQsIFNlbGYsIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERyYWdEcm9wU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2RyYWctZHJvcC5zZXJ2aWNlJztcbmltcG9ydCB7IERyYWdnYWJsZURpcmVjdGl2ZSB9IGZyb20gJy4vZHJhZ2dhYmxlLmRpcmVjdGl2ZSc7XG5leHBvcnQgdHlwZSBCYXRjaERyYWdTdHlsZSA9ICdiYWRnZScgfCAnc3RhY2snIHwgc3RyaW5nO1xuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW2REcmFnZ2FibGVdW2JhdGNoRHJhZ10nLFxuICBleHBvcnRBczogJ2RCYXRjaERyYWdnYWJsZSdcbn0pXG5cbmV4cG9ydCBjbGFzcyBCYXRjaERyYWdnYWJsZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQge1xuICBASW5wdXQoKSBiYXRjaERyYWdHcm91cCA9ICdkZWZhdWx0JztcbiAgQElucHV0KCkgYmF0Y2hEcmFnQWN0aXZlID0gZmFsc2U7XG4gIEBJbnB1dCgpIGJhdGNoRHJhZ0xhc3RPbmVBdXRvQWN0aXZlRXZlbnRLZXlzID0gWydjdHJsS2V5J107XG4gIEBPdXRwdXQoKSBiYXRjaERyYWdBY3RpdmVFdmVudCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBkcmFnRGF0YTtcbiAgbmVlZFRvUmVzdG9yZSA9IGZhbHNlO1xuICBASW5wdXQoKSBiYXRjaERyYWdTdHlsZTogQXJyYXk8QmF0Y2hEcmFnU3R5bGU+ID0gWydiYWRnZScsICdzdGFjayddO1xuXG4gIGNvbnN0cnVjdG9yKEBTZWxmKCkgcHJpdmF0ZSBkcmFnZ2FibGU6IERyYWdnYWJsZURpcmVjdGl2ZSwgIHByaXZhdGUgZHJhZ0Ryb3BTZXJ2aWNlOiBEcmFnRHJvcFNlcnZpY2UpIHtcbiAgICB0aGlzLmRyYWdnYWJsZS5iYXRjaERyYWdnYWJsZSA9IHRoaXM7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmluaXREcmFnRGF0YUJ5SWRlbnRpdHkoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZHJhZ2dhYmxlLmJhdGNoRHJhZ2dhYmxlID0gdW5kZWZpbmVkO1xuICAgIGlmICh0aGlzLmRyYWdEYXRhKSB7XG4gICAgICBpZiAodGhpcy5kcmFnRGF0YS5kcmFnZ2FibGUgPT09IHRoaXMuZHJhZ2dhYmxlKSB7XG4gICAgICAgIHRoaXMuZHJhZ0RhdGEuZHJhZ2dhYmxlID0gdW5kZWZpbmVkO1xuICAgICAgICBpZiAoIXRoaXMuZHJhZ0RhdGEuaWRlbnRpdHkpIHtcbiAgICAgICAgICB0aGlzLnJlbW92ZUZyb21CYXRjaEdyb3VwKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoY2hhbmdlc1snYmF0Y2hEcmFnQWN0aXZlJ10pICB7XG4gICAgICBpZiAoIXRoaXMuaW5pdERyYWdEYXRhQnlJZGVudGl0eSgpKSB7XG4gICAgICAgIGlmICh0aGlzLmJhdGNoRHJhZ0FjdGl2ZSkge1xuICAgICAgICAgIGlmICghdGhpcy5kcmFnRGF0YSAmJiB0aGlzLmFsbG93QWRkVG9CYXRjaEdyb3VwKCkpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkVG9CYXRjaEdyb3VwKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMucmVtb3ZlRnJvbUJhdGNoR3JvdXAoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgaWYgKHRoaXMubmVlZFRvUmVzdG9yZSkge1xuICAgICAgdGhpcy5yZXN0b3JlRHJhZ0RhdGFWaWV3QWZ0ZXJWaWV3SW5pdCgpO1xuICAgICAgdGhpcy5uZWVkVG9SZXN0b3JlID0gZmFsc2U7XG4gICAgfVxuICB9XG4gIGluaXREcmFnRGF0YUJ5SWRlbnRpdHkoKSB7XG4gICAgY29uc3QgZHJhZ0RhdGEgPSB0aGlzLmZpbmRJbkJhdGNoRHJhZ0RhdGFCeUlkZW50aXRpZXMoKTtcbiAgICBpZiAoZHJhZ0RhdGEpIHtcbiAgICAgIGlmICh0aGlzLmJhdGNoRHJhZ0FjdGl2ZSkge1xuICAgICAgICBpZiAoIXRoaXMuZHJhZ0RhdGEpIHtcbiAgICAgICAgICB0aGlzLmFkZFRvQmF0Y2hHcm91cChkcmFnRGF0YSk7XG4gICAgICAgICAgdGhpcy5yZWdpc3RlclJlc3RvcmVEcmFnRGF0YVZpZXdBZnRlclZpZXdJbml0V2hpdGVEcmFnZ2luZygpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJlbW92ZUZyb21CYXRjaEdyb3VwKGRyYWdEYXRhKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGRyYWdEYXRhO1xuICB9XG5cbiAgcmVnaXN0ZXJSZXN0b3JlRHJhZ0RhdGFWaWV3QWZ0ZXJWaWV3SW5pdFdoaXRlRHJhZ2dpbmcoKSB7XG4gICAgaWYgKHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLmRyYWdnZWRFbCAmJiB0aGlzLmRyYWdEcm9wU2VydmljZS5kcmFnZ2VkRWxJZGVudGl0eSAmJlxuICAgICAgdGhpcy5kcmFnRHJvcFNlcnZpY2UuZHJhZ2dlZEVsICE9PSB0aGlzLmRyYWdnYWJsZS5lbC5uYXRpdmVFbGVtZW50KSB7XG4gICAgICB0aGlzLm5lZWRUb1Jlc3RvcmUgPSB0cnVlO1xuICAgIH1cbiAgfVxuICByZXN0b3JlRHJhZ0RhdGFWaWV3QWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICBjb25zdCBkcmFnZ2FibGUgPSB0aGlzLmRyYWdnYWJsZTtcbiAgICBpZiAoZHJhZ2dhYmxlLm9yaWdpblBsYWNlaG9sZGVyICYmIGRyYWdnYWJsZS5vcmlnaW5QbGFjZWhvbGRlci5zaG93ICE9PSBmYWxzZSkge1xuICAgICAgZHJhZ2dhYmxlLmluc2VydE9yaWdpblBsYWNlaG9sZGVyKHRydWUsIGZhbHNlKTtcbiAgICB9XG4gICAgZHJhZ2dhYmxlLmVsLm5hdGl2ZUVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgfVxuXG4gIGFsbG93QWRkVG9CYXRjaEdyb3VwKCkge1xuICAgIGlmICghdGhpcy5kcmFnRHJvcFNlcnZpY2UuYmF0Y2hEcmFnR3JvdXApIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5iYXRjaERyYWdHcm91cCA9PT0gdGhpcy5kcmFnRHJvcFNlcnZpY2UuYmF0Y2hEcmFnR3JvdXA7XG4gICAgfVxuICB9XG4gIGFkZFRvQmF0Y2hHcm91cChkcmFnRGF0YT8pIHtcbiAgICB0aGlzLmRyYWdEcm9wU2VydmljZS5iYXRjaERyYWdHcm91cCA9IHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLmJhdGNoRHJhZ0dyb3VwIHx8IHRoaXMuYmF0Y2hEcmFnR3JvdXA7XG4gICAgaWYgKGRyYWdEYXRhKSB7XG4gICAgICBkcmFnRGF0YS5kcmFnZ2FibGUgPSB0aGlzLmRyYWdnYWJsZTtcbiAgICAgIGRyYWdEYXRhLmRyYWdEYXRhID0gdGhpcy5kcmFnZ2FibGUuZHJhZ0RhdGE7XG4gICAgICB0aGlzLmRyYWdEYXRhID0gZHJhZ0RhdGE7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZHJhZ0RhdGEgPSB0aGlzLmRyYWdEYXRhIHx8IHtcbiAgICAgICAgaWRlbnRpdHk6IHRoaXMuZHJhZ2dhYmxlLmRyYWdJZGVudGl0eSB8fCB1bmRlZmluZWQsXG4gICAgICAgIGRyYWdnYWJsZTogdGhpcy5kcmFnZ2FibGUsXG4gICAgICAgIGRyYWdEYXRhOiB0aGlzLmRyYWdnYWJsZS5kcmFnRGF0YVxuICAgICAgfTtcbiAgICAgIHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLmJhdGNoRHJhZ0RhdGEgPSB0aGlzLmFkZFRvQXJyYXlJZk5vdEV4aXN0KHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLmJhdGNoRHJhZ0RhdGEsIHRoaXMuZHJhZ0RhdGEpO1xuICAgIH1cbiAgfVxuICByZW1vdmVGcm9tQmF0Y2hHcm91cChkcmFnRGF0YT8pIHtcbiAgICB0aGlzLmRlbGV0ZUZyb21BcnJheUlmRXhpc3QodGhpcy5kcmFnRHJvcFNlcnZpY2UuYmF0Y2hEcmFnRGF0YSwgZHJhZ0RhdGEgfHwgdGhpcy5kcmFnRGF0YSk7XG4gICAgdGhpcy5kcmFnRGF0YSA9IHVuZGVmaW5lZDtcbiAgICBpZiAoISh0aGlzLmRyYWdEcm9wU2VydmljZS5iYXRjaERyYWdEYXRhICYmIHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLmJhdGNoRHJhZ0RhdGEubGVuZ3RoKSkge1xuICAgICAgdGhpcy5kcmFnRHJvcFNlcnZpY2UuYmF0Y2hEcmFnR3JvdXAgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRUb0FycmF5SWZOb3RFeGlzdChhcnJheTogYW55W10sIHRhcmdldDogYW55KSB7XG4gICAgYXJyYXkgPSBhcnJheSB8fCBbXTtcbiAgICBpZiAoYXJyYXkuaW5kZXhPZih0YXJnZXQpID09PSAtMSkge1xuICAgICAgYXJyYXkucHVzaCh0YXJnZXQpO1xuICAgIH1cbiAgICByZXR1cm4gYXJyYXk7XG4gIH1cblxuICBwcml2YXRlIGRlbGV0ZUZyb21BcnJheUlmRXhpc3QoYXJyYXk6IGFueVtdLCB0YXJnZXQ6IGFueSkge1xuICAgIGlmICghYXJyYXkpIHsgcmV0dXJuOyB9XG4gICAgaWYgKGFycmF5Lmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gYXJyYXkuaW5kZXhPZih0YXJnZXQpO1xuICAgICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGFycmF5O1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kSW5CYXRjaERyYWdEYXRhQnlJZGVudGl0aWVzKCkge1xuICAgIGlmICghdGhpcy5kcmFnZ2FibGUuZHJhZ0lkZW50aXR5KSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9IGVsc2UgaWYgKCF0aGlzLmRyYWdEcm9wU2VydmljZS5iYXRjaERyYWdEYXRhKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5kcmFnRHJvcFNlcnZpY2UuYmF0Y2hEcmFnRGF0YS5maWx0ZXIoZHJhZ0RhdGEgPT4gZHJhZ0RhdGEuaWRlbnRpdHkgPT09IHRoaXMuZHJhZ2dhYmxlLmRyYWdJZGVudGl0eSkucG9wKCk7XG4gICAgfVxuICB9XG5cbiAgYWN0aXZlKCkge1xuICAgIHRoaXMuYmF0Y2hEcmFnQWN0aXZlRXZlbnQuZW1pdCh7ZWw6IHRoaXMuZHJhZ2dhYmxlLmVsLm5hdGl2ZUVsZW1lbnQsIGRhdGE6IHRoaXMuZHJhZ2dhYmxlLmRyYWdEYXRhfSk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlRHJhZ0RhdGEoKSB7XG4gICAgLy8g6YCJ5Lit54q25oCB5omN5pu05pawXG4gICAgaWYgKCF0aGlzLmRyYWdEYXRhKSB7cmV0dXJuOyB9XG4gICAgLy8g6ZyA6KaB57u05oyB5YaF5a2Y5Zyw5Z2A5LiN5Y+YXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLmRyYWdEYXRhLCB7XG4gICAgICBpZGVudGl0eTogdGhpcy5kcmFnZ2FibGUuZHJhZ0lkZW50aXR5IHx8IHVuZGVmaW5lZCxcbiAgICAgIGRyYWdnYWJsZTogdGhpcy5kcmFnZ2FibGUsXG4gICAgICBkcmFnRGF0YTogdGhpcy5kcmFnZ2FibGUuZHJhZ0RhdGFcbiAgICB9KTtcbiAgfVxufVxuIl19