import { DOCUMENT } from '@angular/common';
import { Directive, ElementRef, Inject, Input, NgZone } from '@angular/core';
import { fromEvent, merge as mergeStatic, Subscription } from 'rxjs';
import { tap, throttleTime } from 'rxjs/operators';
import { DragDropService } from '../services/drag-drop.service';
import { Utils } from '../shared/utils';
import { DropScrollEnhanceTimingFunctionGroup, DropScrollOrientation } from './drop-scroll-enhance.type';
import * as i0 from "@angular/core";
import * as i1 from "../services/drag-drop.service";
export class DropScrollEnhancedDirective {
    constructor(el, zone, dragDropService, doc) {
        this.el = el;
        this.zone = zone;
        this.dragDropService = dragDropService;
        this.doc = doc;
        this.minSpeed = 50;
        this.maxSpeed = 1000;
        this.responseEdgeWidth = '100px';
        this.speedFn = DropScrollEnhanceTimingFunctionGroup.default;
        this.direction = 'v';
        this.backSpaceDroppable = true;
        this.subscription = new Subscription();
        this.document = this.doc;
    }
    ngAfterViewInit() {
        // 设置父元素
        this.el.nativeElement.parentNode.style.position = 'relative';
        this.el.nativeElement.parentNode.style.display = 'block';
        // 创建后退前进区域和对应的滚动函数
        this.forwardScrollArea = this.createScrollArea(this.direction, DropScrollOrientation.forward);
        this.backwardScrollArea = this.createScrollArea(this.direction, DropScrollOrientation.backward);
        this.forwardScrollFn = this.createScrollFn(this.direction, DropScrollOrientation.forward, this.speedFn);
        this.backwardScrollFn = this.createScrollFn(this.direction, DropScrollOrientation.backward, this.speedFn);
        this.zone.runOutsideAngular(() => {
            // 拖拽到其上触发滚动
            this.subscription.add(fromEvent(this.forwardScrollArea, 'dragover')
                .pipe(tap(event => { event.preventDefault(); event.stopPropagation(); }), throttleTime(100, undefined, { leading: true, trailing: false })).subscribe(event => this.forwardScrollFn(event)));
            this.subscription.add(fromEvent(this.backwardScrollArea, 'dragover')
                .pipe(tap(event => { event.preventDefault(); event.stopPropagation(); }), throttleTime(100, undefined, { leading: true, trailing: false }))
                .subscribe(event => this.backwardScrollFn(event)));
            // 拖拽放置委托
            this.subscription.add(mergeStatic(fromEvent(this.forwardScrollArea, 'drop'), fromEvent(this.backwardScrollArea, 'drop')).subscribe(event => this.delegateDropEvent(event)));
            // 拖拽离开清除参数
            this.subscription.add(mergeStatic(fromEvent(this.forwardScrollArea, 'dragleave', { passive: true }), fromEvent(this.backwardScrollArea, 'dragleave', { passive: true })).subscribe(event => this.cleanLastScrollTime()));
            // 滚动过程计算区域有效性，滚动条贴到边缘的时候无效，无效的时候设置鼠标事件可用为none
            this.subscription.add(fromEvent(this.el.nativeElement, 'scroll', { passive: true })
                .pipe(throttleTime(300, undefined, { leading: true, trailing: true }))
                .subscribe(event => {
                this.toggleScrollToOneEnd(this.el.nativeElement, this.forwardScrollArea, this.direction, DropScrollOrientation.forward);
                this.toggleScrollToOneEnd(this.el.nativeElement, this.backwardScrollArea, this.direction, DropScrollOrientation.backward);
            }));
            // 窗口缩放的时候重绘有效性区域
            this.subscription.add(fromEvent(window, 'resize', { passive: true })
                .pipe(throttleTime(300, undefined, { leading: true, trailing: true }))
                .subscribe(event => this.resizeArea()));
            // dragstart的时候显示拖拽滚动边缘面板
            this.subscription.add(this.dragDropService.dragStartEvent.subscribe(() => {
                if (!this.allowScroll()) {
                    return;
                }
                this.zone.runOutsideAngular(() => {
                    setTimeout(() => {
                        // 立马出现会打断边缘元素的拖拽
                        this.forwardScrollArea.style.display = 'block';
                        this.backwardScrollArea.style.display = 'block';
                    });
                });
            }));
            // dragEnd或drop的时候结束了拖拽，滚动区域影藏起来
            this.subscription.add(mergeStatic(this.dragDropService.dragEndEvent, this.dragDropService.dropEvent)
                .subscribe(() => {
                this.forwardScrollArea.style.display = 'none';
                this.backwardScrollArea.style.display = 'none';
                this.lastScrollTime = undefined;
            }));
        });
        setTimeout(() => {
            this.resizeArea();
        }, 0);
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
    createScrollFn(direction, orientation, speedFn) {
        if (typeof window === 'undefined') {
            return;
        }
        const scrollAttr = (direction === 'v') ? 'scrollTop' : 'scrollLeft';
        const eventAttr = (direction === 'v') ? 'clientY' : 'clientX';
        const scrollWidthAttr = (direction === 'v') ? 'scrollHeight' : 'scrollWidth';
        const offsetWidthAttr = (direction === 'v') ? 'offsetHeight' : 'offsetWidth';
        const clientWidthAttr = (direction === 'v') ? 'clientHeight' : 'clientWidth';
        const rectWidthAttr = (direction === 'v') ? 'height' : 'width';
        const compareTarget = (orientation === DropScrollOrientation.forward) ? this.forwardScrollArea : this.backwardScrollArea;
        const targetAttr = this.getCriticalEdge(direction, orientation);
        const scrollElement = this.el.nativeElement;
        return (event) => {
            const compareTargetRect = compareTarget.getBoundingClientRect();
            const distance = event[eventAttr] - compareTargetRect[targetAttr];
            let speed = speedFn(Math.abs(distance / (compareTargetRect[rectWidthAttr] || 1)));
            if (speed < this.minSpeed) {
                speed = this.minSpeed;
            }
            if (speed > this.maxSpeed) {
                speed = this.maxSpeed;
            }
            if (distance < 0) {
                speed = -speed;
            }
            if (this.animationFrameId) {
                window.cancelAnimationFrame(this.animationFrameId);
                this.animationFrameId = undefined;
            }
            this.animationFrameId = requestAnimationFrame(() => {
                const time = new Date().getTime();
                const moveDistance = Math.ceil(speed * (time - (this.lastScrollTime || time)) / 1000);
                scrollElement[scrollAttr] -= moveDistance;
                this.lastScrollTime = time;
                // 判断是不是到尽头
                if ((scrollElement[scrollAttr] === 0 && orientation === DropScrollOrientation.backward)
                    || ((scrollElement[scrollAttr]
                        + (scrollElement.getBoundingClientRect())[rectWidthAttr]
                        - scrollElement[offsetWidthAttr]
                        + scrollElement[clientWidthAttr]) === scrollElement[scrollWidthAttr]
                        && orientation === DropScrollOrientation.forward)) {
                    compareTarget.style.pointerEvents = 'none';
                    this.toggleActiveClass(compareTarget, false);
                }
                this.animationFrameId = undefined;
            });
            if (this.backSpaceDroppable) {
                Utils.dispatchEventToUnderElement(event);
            }
        };
    }
    delegateDropEvent(event) {
        if (this.backSpaceDroppable) {
            const ev = Utils.dispatchEventToUnderElement(event);
            if (ev.defaultPrevented) {
                event.preventDefault();
                event.stopPropagation();
            }
        }
    }
    getCriticalEdge(direction, orientation) {
        return (direction === 'v' && orientation === DropScrollOrientation.forward && 'bottom')
            || (direction === 'v' && orientation === DropScrollOrientation.backward && 'top')
            || (direction !== 'v' && orientation === DropScrollOrientation.forward && 'right')
            || (direction !== 'v' && orientation === DropScrollOrientation.backward && 'left') || 'bottom';
    }
    getSecondEdge(direction) {
        return (direction === 'v' && 'left')
            || (direction !== 'v' && 'top') || 'left';
    }
    createScrollArea(direction, orientation) {
        const area = this.document.createElement('div');
        area.className = 'dropover-scroll-area ' + 'dropover-scroll-area-' + this.getCriticalEdge(direction, orientation);
        // 处理大小
        area.classList.add('active');
        this.setAreaSize(area, direction, orientation);
        // 处理位置
        area.style.position = 'absolute';
        this.setAreaStyleLayout(area, direction, orientation);
        // 默认不展示
        area.style.display = 'none';
        // 附着元素
        this.el.nativeElement.parentNode.appendChild(area, this.el.nativeElement);
        return area;
    }
    setAreaSize(area, direction, orientation) {
        const rect = this.el.nativeElement.getBoundingClientRect();
        const containerAttr = direction === 'v' ? 'height' : 'width';
        const responseEdgeWidth = (typeof this.responseEdgeWidth === 'string')
            ? this.responseEdgeWidth
            : this.responseEdgeWidth(rect[containerAttr]);
        const settingOffset = this.viewOffset
            && (orientation === DropScrollOrientation.forward ? this.viewOffset.forward : this.viewOffset.backward);
        let width = direction === 'v' ? (rect.width + 'px') : responseEdgeWidth;
        let height = direction === 'v' ? responseEdgeWidth : (rect.height + 'px');
        if (settingOffset) {
            if (settingOffset.widthOffset) {
                width = 'calc(' + width + ' + ' + (settingOffset.widthOffset) + 'px)';
            }
            if (settingOffset.heightOffset) {
                height = 'calc(' + height + ' + ' + (settingOffset.heightOffset) + 'px)';
            }
        }
        area.style.width = width;
        area.style.height = height;
    }
    setAreaStyleLayout(area, direction, orientation) {
        const target = this.el.nativeElement;
        const relatedTarget = this.el.nativeElement.parentNode;
        const defaultOffset = { left: 0, right: 0, top: 0, bottom: 0 };
        const settingOffset = this.viewOffset
            && (orientation === DropScrollOrientation.forward ? this.viewOffset.forward : this.viewOffset.backward)
            || defaultOffset;
        const criticalEdge = this.getCriticalEdge(direction, orientation);
        const secondEdge = this.getSecondEdge(direction);
        [criticalEdge, secondEdge].forEach(edge => {
            area.style[edge] = this.getRelatedPosition(target, relatedTarget, edge, settingOffset[edge]);
        });
    }
    getRelatedPosition(target, relatedTarget, edge, offsetValue) {
        if (typeof window === 'undefined') {
            return '0px';
        }
        const relatedComputedStyle = window.getComputedStyle(relatedTarget);
        const relatedRect = relatedTarget.getBoundingClientRect();
        const selfRect = target.getBoundingClientRect();
        const helper = {
            left: ['left', 'Left'],
            right: ['right', 'Right'],
            top: ['top', 'Top'],
            bottom: ['bottom', 'Bottom'],
        };
        let factor = 1;
        if (edge === 'right' || edge === 'bottom') {
            factor = -1;
        }
        return (selfRect[helper[edge][0]] - relatedRect[helper[edge][0]]
            + parseInt(relatedComputedStyle['border' + helper[edge][1] + 'Width'], 10)) * factor
            + (offsetValue || 0)
            + 'px';
    }
    resizeArea() {
        [{ area: this.forwardScrollArea, orientation: DropScrollOrientation.forward },
            { area: this.backwardScrollArea, orientation: DropScrollOrientation.backward }
        ]
            .forEach(item => {
            this.setAreaSize(item.area, this.direction, item.orientation);
            this.setAreaStyleLayout(item.area, this.direction, item.orientation);
        });
    }
    toggleScrollToOneEnd(scrollElement, toggleElement, direction, orientation) {
        const scrollAttr = (direction === 'v') ? 'scrollTop' : 'scrollLeft';
        const scrollWidthAttr = (direction === 'v') ? 'scrollHeight' : 'scrollWidth';
        const offsetWidthAttr = (direction === 'v') ? 'offsetHeight' : 'offsetWidth';
        const clientWidthAttr = (direction === 'v') ? 'clientHeight' : 'clientWidth';
        const rectWidthAttr = (direction === 'v') ? 'height' : 'width';
        if ((scrollElement[scrollAttr] === 0 && orientation === DropScrollOrientation.backward) || (Math.abs(scrollElement[scrollAttr]
            + (scrollElement.getBoundingClientRect())[rectWidthAttr]
            - scrollElement[scrollWidthAttr]
            - scrollElement[offsetWidthAttr]
            + scrollElement[clientWidthAttr]) < 1
            && orientation === DropScrollOrientation.forward)) {
            toggleElement.style.pointerEvents = 'none';
            this.toggleActiveClass(toggleElement, false);
        }
        else {
            toggleElement.style.pointerEvents = 'auto';
            this.toggleActiveClass(toggleElement, true);
        }
    }
    cleanLastScrollTime() {
        if (this.animationFrameId && typeof window !== 'undefined') {
            window.cancelAnimationFrame(this.animationFrameId);
            this.animationFrameId = undefined;
        }
        this.lastScrollTime = undefined;
    }
    toggleActiveClass(target, active) {
        if (active) {
            target.classList.remove('inactive');
            target.classList.add('active');
        }
        else {
            target.classList.remove('active');
            target.classList.add('inactive');
        }
    }
    allowScroll() {
        if (!this.dropScrollScope) {
            return true;
        }
        let allowed = false;
        if (typeof this.dropScrollScope === 'string') {
            if (typeof this.dragDropService.scope === 'string') {
                allowed = this.dragDropService.scope === this.dropScrollScope;
            }
            if (this.dragDropService.scope instanceof Array) {
                allowed = this.dragDropService.scope.indexOf(this.dropScrollScope) > -1;
            }
        }
        if (this.dropScrollScope instanceof Array) {
            if (typeof this.dragDropService.scope === 'string') {
                allowed = this.dropScrollScope.indexOf(this.dragDropService.scope) > -1;
            }
            if (this.dragDropService.scope instanceof Array) {
                allowed = this.dropScrollScope.filter((item) => {
                    return this.dragDropService.scope.indexOf(item) !== -1;
                }).length > 0;
            }
        }
        return allowed;
    }
}
DropScrollEnhancedDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DropScrollEnhancedDirective, deps: [{ token: i0.ElementRef }, { token: i0.NgZone }, { token: i1.DragDropService }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Directive });
DropScrollEnhancedDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.3", type: DropScrollEnhancedDirective, selector: "[dDropScrollEnhanced]", inputs: { minSpeed: "minSpeed", maxSpeed: "maxSpeed", responseEdgeWidth: "responseEdgeWidth", speedFn: "speedFn", direction: "direction", viewOffset: "viewOffset", dropScrollScope: "dropScrollScope", backSpaceDroppable: "backSpaceDroppable" }, exportAs: ["dDropScrollEnhanced"], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DropScrollEnhancedDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[dDropScrollEnhanced]',
                    exportAs: 'dDropScrollEnhanced'
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.NgZone }, { type: i1.DragDropService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; }, propDecorators: { minSpeed: [{
                type: Input
            }], maxSpeed: [{
                type: Input
            }], responseEdgeWidth: [{
                type: Input
            }], speedFn: [{
                type: Input
            }], direction: [{
                type: Input
            }], viewOffset: [{
                type: Input
            }], dropScrollScope: [{
                type: Input
            }], backSpaceDroppable: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcC1zY3JvbGwtZW5oYW5jZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9kZXZ1aS9kcmFnZHJvcC9kaXJlY3RpdmVzL2Ryb3Atc2Nyb2xsLWVuaGFuY2UuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQWlCLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDdkcsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLElBQUksV0FBVyxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUNoRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDeEMsT0FBTyxFQUNzQyxvQ0FBb0MsRUFBRSxxQkFBcUIsRUFFdkcsTUFBTSw0QkFBNEIsQ0FBQzs7O0FBTXBDLE1BQU0sT0FBTywyQkFBMkI7SUFzQnRDLFlBQW9CLEVBQWMsRUFBVSxJQUFZLEVBQVUsZUFBZ0MsRUFDNUQsR0FBUTtRQUQxQixPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQVUsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUFVLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUM1RCxRQUFHLEdBQUgsR0FBRyxDQUFLO1FBdEJyQyxhQUFRLEdBQW9CLEVBQUUsQ0FBQztRQUMvQixhQUFRLEdBQW9CLElBQUksQ0FBQztRQUNqQyxzQkFBaUIsR0FBMEMsT0FBTyxDQUFDO1FBQ25FLFlBQU8sR0FBNEIsb0NBQW9DLENBQUMsT0FBTyxDQUFDO1FBQ2hGLGNBQVMsR0FBd0IsR0FBRyxDQUFD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SztnQkFDRyxTQUFTO3NCQUFqQixLQUFLO2dCQUNHLFVBQVU7c0JBQWxCLEtBQUs7Z0JBSUcsZUFBZTtzQkFBdkIsS0FBSztnQkFDRyxrQkFBa0I7c0JBQTFCLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBBZnRlclZpZXdJbml0LCBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIEluamVjdCwgSW5wdXQsIE5nWm9uZSwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIG1lcmdlIGFzIG1lcmdlU3RhdGljLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCwgdGhyb3R0bGVUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRHJhZ0Ryb3BTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZHJhZy1kcm9wLnNlcnZpY2UnO1xuaW1wb3J0IHsgVXRpbHMgfSBmcm9tICcuLi9zaGFyZWQvdXRpbHMnO1xuaW1wb3J0IHtcbiAgRHJvcFNjcm9sbEFyZWFPZmZzZXQsIERyb3BTY3JvbGxEaXJlY3Rpb24sIERyb3BTY3JvbGxFbmhhbmNlVGltaW5nRnVuY3Rpb25Hcm91cCwgRHJvcFNjcm9sbE9yaWVudGF0aW9uLFxuICBEcm9wU2Nyb2xsU3BlZWQsIERyb3BTY3JvbGxTcGVlZEZ1bmN0aW9uLCBEcm9wU2Nyb2xsVHJpZ2dlckVkZ2Vcbn0gZnJvbSAnLi9kcm9wLXNjcm9sbC1lbmhhbmNlLnR5cGUnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbZERyb3BTY3JvbGxFbmhhbmNlZF0nLFxuICBleHBvcnRBczogJ2REcm9wU2Nyb2xsRW5oYW5jZWQnXG59KVxuZXhwb3J0IGNsYXNzIERyb3BTY3JvbGxFbmhhbmNlZERpcmVjdGl2ZSBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgpIG1pblNwZWVkOiBEcm9wU2Nyb2xsU3BlZWQgPSA1MDtcbiAgQElucHV0KCkgbWF4U3BlZWQ6IERyb3BTY3JvbGxTcGVlZCA9IDEwMDA7XG4gIEBJbnB1dCgpIHJlc3BvbnNlRWRnZVdpZHRoOiBzdHJpbmcgfCAoKHRvdGFsOiBudW1iZXIpID0+IHN0cmluZykgID0gJzEwMHB4JztcbiAgQElucHV0KCkgc3BlZWRGbjogRHJvcFNjcm9sbFNwZWVkRnVuY3Rpb24gPSBEcm9wU2Nyb2xsRW5oYW5jZVRpbWluZ0Z1bmN0aW9uR3JvdXAuZGVmYXVsdDtcbiAgQElucHV0KCkgZGlyZWN0aW9uOiBEcm9wU2Nyb2xsRGlyZWN0aW9uID0gJ3YnO1xuICBASW5wdXQoKSB2aWV3T2Zmc2V0OiB7XG4gICAgZm9yd2FyZD86IERyb3BTY3JvbGxBcmVhT2Zmc2V0OyAvLyDku4Xph43opoHovrnlkozmrKHopoHovrnmnInmlYhcbiAgICBiYWNrd2FyZD86IERyb3BTY3JvbGxBcmVhT2Zmc2V0O1xuICB9O1xuICBASW5wdXQoKSBkcm9wU2Nyb2xsU2NvcGU6IHN0cmluZyB8IEFycmF5PHN0cmluZz47XG4gIEBJbnB1dCgpIGJhY2tTcGFjZURyb3BwYWJsZSA9IHRydWU7XG5cbiAgcHJpdmF0ZSBmb3J3YXJkU2Nyb2xsQXJlYTogSFRNTEVsZW1lbnQ7XG4gIHByaXZhdGUgYmFja3dhcmRTY3JvbGxBcmVhOiBIVE1MRWxlbWVudDtcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcbiAgcHJpdmF0ZSBmb3J3YXJkU2Nyb2xsRm46IChldmVudDogRHJhZ0V2ZW50KSA9PiB2b2lkO1xuICBwcml2YXRlIGJhY2t3YXJkU2Nyb2xsRm46IChldmVudDogRHJhZ0V2ZW50KSA9PiB2b2lkO1xuICBwcml2YXRlIGxhc3RTY3JvbGxUaW1lO1xuICBwcml2YXRlIGFuaW1hdGlvbkZyYW1lSWQ6IG51bWJlcjtcbiAgZG9jdW1lbnQ6IERvY3VtZW50O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsIHByaXZhdGUgem9uZTogTmdab25lLCBwcml2YXRlIGRyYWdEcm9wU2VydmljZTogRHJhZ0Ryb3BTZXJ2aWNlLFxuICAgICAgICAgICAgICBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIGRvYzogYW55KSB7XG4gICAgdGhpcy5kb2N1bWVudCA9IHRoaXMuZG9jO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIC8vIOiuvue9rueItuWFg+e0oFxuICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudC5wYXJlbnROb2RlLnN0eWxlLnBvc2l0aW9uID0gJ3JlbGF0aXZlJztcbiAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAvLyDliJvlu7rlkI7pgIDliY3ov5vljLrln5/lkozlr7nlupTnmoTmu5rliqjlh73mlbBcbiAgICB0aGlzLmZvcndhcmRTY3JvbGxBcmVhID0gdGhpcy5jcmVhdGVTY3JvbGxBcmVhKHRoaXMuZGlyZWN0aW9uLCBEcm9wU2Nyb2xsT3JpZW50YXRpb24uZm9yd2FyZCk7XG4gICAgdGhpcy5iYWNrd2FyZFNjcm9sbEFyZWEgPSB0aGlzLmNyZWF0ZVNjcm9sbEFyZWEodGhpcy5kaXJlY3Rpb24sIERyb3BTY3JvbGxPcmllbnRhdGlvbi5iYWNrd2FyZCk7XG4gICAgdGhpcy5mb3J3YXJkU2Nyb2xsRm4gPSB0aGlzLmNyZWF0ZVNjcm9sbEZuKHRoaXMuZGlyZWN0aW9uLCBEcm9wU2Nyb2xsT3JpZW50YXRpb24uZm9yd2FyZCwgdGhpcy5zcGVlZEZuKTtcbiAgICB0aGlzLmJhY2t3YXJkU2Nyb2xsRm4gPSB0aGlzLmNyZWF0ZVNjcm9sbEZuKHRoaXMuZGlyZWN0aW9uLCBEcm9wU2Nyb2xsT3JpZW50YXRpb24uYmFja3dhcmQsIHRoaXMuc3BlZWRGbik7XG4gICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIC8vIOaLluaLveWIsOWFtuS4iuinpuWPkea7muWKqFxuICAgICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKGZyb21FdmVudDxEcmFnRXZlbnQ+KHRoaXMuZm9yd2FyZFNjcm9sbEFyZWEsICdkcmFnb3ZlcicpXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIHRhcChldmVudCA9PiB7ZXZlbnQucHJldmVudERlZmF1bHQoKTsgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7IH0pLFxuICAgICAgICAgIHRocm90dGxlVGltZSgxMDAsIHVuZGVmaW5lZCwge2xlYWRpbmc6IHRydWUsIHRyYWlsaW5nOiBmYWxzZX0pXG4gICAgICAgICkuc3Vic2NyaWJlKGV2ZW50ID0+IHRoaXMuZm9yd2FyZFNjcm9sbEZuKGV2ZW50KSkpO1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKGZyb21FdmVudDxEcmFnRXZlbnQ+KHRoaXMuYmFja3dhcmRTY3JvbGxBcmVhLCAnZHJhZ292ZXInKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICB0YXAoZXZlbnQgPT4ge2V2ZW50LnByZXZlbnREZWZhdWx0KCk7IGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyB9KSxcbiAgICAgICAgICB0aHJvdHRsZVRpbWUoMTAwLCB1bmRlZmluZWQsIHtsZWFkaW5nOiB0cnVlLCB0cmFpbGluZzogZmFsc2V9KSlcbiAgICAgICAgLnN1YnNjcmliZShldmVudCA9PiB0aGlzLmJhY2t3YXJkU2Nyb2xsRm4oZXZlbnQpKSk7XG4gICAgICAvLyDmi5bmi73mlL7nva7lp5TmiZhcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChcbiAgICAgICAgbWVyZ2VTdGF0aWMoXG4gICAgICAgICAgZnJvbUV2ZW50PERyYWdFdmVudD4odGhpcy5mb3J3YXJkU2Nyb2xsQXJlYSwgJ2Ryb3AnKSxcbiAgICAgICAgICBmcm9tRXZlbnQ8RHJhZ0V2ZW50Pih0aGlzLmJhY2t3YXJkU2Nyb2xsQXJlYSwgJ2Ryb3AnKVxuICAgICAgICApLnN1YnNjcmliZShldmVudCA9PiB0aGlzLmRlbGVnYXRlRHJvcEV2ZW50KGV2ZW50KSkpO1xuICAgICAgLy8g5ouW5ou956a75byA5riF6Zmk5Y+C5pWwXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQoXG4gICAgICAgIG1lcmdlU3RhdGljKFxuICAgICAgICAgIGZyb21FdmVudCh0aGlzLmZvcndhcmRTY3JvbGxBcmVhLCAnZHJhZ2xlYXZlJywge3Bhc3NpdmU6IHRydWV9KSxcbiAgICAgICAgICBmcm9tRXZlbnQodGhpcy5iYWNrd2FyZFNjcm9sbEFyZWEsICdkcmFnbGVhdmUnLCB7cGFzc2l2ZTogdHJ1ZX0pXG4gICAgICAgICkuc3Vic2NyaWJlKGV2ZW50ID0+IHRoaXMuY2xlYW5MYXN0U2Nyb2xsVGltZSgpKVxuICAgICAgKTtcbiAgICAgIC8vIOa7muWKqOi/h+eoi+iuoeeul+WMuuWfn+acieaViOaAp++8jOa7muWKqOadoei0tOWIsOi+uee8mOeahOaXtuWAmeaXoOaViO+8jOaXoOaViOeahOaXtuWAmeiuvue9rum8oOagh+S6i+S7tuWPr+eUqOS4um5vbmVcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChcbiAgICAgICAgZnJvbUV2ZW50KHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ3Njcm9sbCcsIHtwYXNzaXZlOiB0cnVlfSlcbiAgICAgICAgICAucGlwZSh0aHJvdHRsZVRpbWUoMzAwLCB1bmRlZmluZWQsIHtsZWFkaW5nOiB0cnVlLCB0cmFpbGluZzogdHJ1ZX0pKVxuICAgICAgICAgIC5zdWJzY3JpYmUoZXZlbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy50b2dnbGVTY3JvbGxUb09uZUVuZCh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsIHRoaXMuZm9yd2FyZFNjcm9sbEFyZWEsIHRoaXMuZGlyZWN0aW9uLCBEcm9wU2Nyb2xsT3JpZW50YXRpb24uZm9yd2FyZCk7XG4gICAgICAgICAgICB0aGlzLnRvZ2dsZVNjcm9sbFRvT25lRW5kKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgdGhpcy5iYWNrd2FyZFNjcm9sbEFyZWEsIHRoaXMuZGlyZWN0aW9uLCBEcm9wU2Nyb2xsT3JpZW50YXRpb24uYmFja3dhcmQpO1xuICAgICAgICAgIH0pXG4gICAgICApO1xuICAgICAgLy8g56qX5Y+j57yp5pS+55qE5pe25YCZ6YeN57uY5pyJ5pWI5oCn5Yy65Z+fXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQoXG4gICAgICAgIGZyb21FdmVudCh3aW5kb3csICdyZXNpemUnLCB7cGFzc2l2ZTogdHJ1ZX0pXG4gICAgICAgICAgLnBpcGUodGhyb3R0bGVUaW1lKDMwMCwgdW5kZWZpbmVkLCB7bGVhZGluZzogdHJ1ZSwgdHJhaWxpbmc6IHRydWV9KSlcbiAgICAgICAgICAuc3Vic2NyaWJlKGV2ZW50ID0+IHRoaXMucmVzaXplQXJlYSgpKVxuICAgICAgKTtcbiAgICAgIC8vIGRyYWdzdGFydOeahOaXtuWAmeaYvuekuuaLluaLvea7muWKqOi+uee8mOmdouadv1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKFxuICAgICAgICB0aGlzLmRyYWdEcm9wU2VydmljZS5kcmFnU3RhcnRFdmVudC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgIGlmICghdGhpcy5hbGxvd1Njcm9sbCgpKSB7cmV0dXJuOyB9XG4gICAgICAgICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAvLyDnq4vpqazlh7rnjrDkvJrmiZPmlq3ovrnnvJjlhYPntKDnmoTmi5bmi71cbiAgICAgICAgICAgICAgdGhpcy5mb3J3YXJkU2Nyb2xsQXJlYS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgICAgICAgdGhpcy5iYWNrd2FyZFNjcm9sbEFyZWEuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgICAvLyBkcmFnRW5k5oiWZHJvcOeahOaXtuWAmee7k+adn+S6huaLluaLve+8jOa7muWKqOWMuuWfn+W9seiXj+i1t+adpVxuICAgICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKFxuICAgICAgICBtZXJnZVN0YXRpYyh0aGlzLmRyYWdEcm9wU2VydmljZS5kcmFnRW5kRXZlbnQsIHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLmRyb3BFdmVudClcbiAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZm9yd2FyZFNjcm9sbEFyZWEuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgICAgIHRoaXMuYmFja3dhcmRTY3JvbGxBcmVhLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgICAgICB0aGlzLmxhc3RTY3JvbGxUaW1lID0gdW5kZWZpbmVkO1xuICAgICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5yZXNpemVBcmVhKCk7XG4gICAgfSwgMCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgY3JlYXRlU2Nyb2xsRm4oZGlyZWN0aW9uOiBEcm9wU2Nyb2xsRGlyZWN0aW9uLCBvcmllbnRhdGlvbjogRHJvcFNjcm9sbE9yaWVudGF0aW9uLFxuICAgICAgICAgICAgICAgICBzcGVlZEZuOiBEcm9wU2Nyb2xsU3BlZWRGdW5jdGlvbikge1xuICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBzY3JvbGxBdHRyID0gKGRpcmVjdGlvbiA9PT0gJ3YnKSA/ICdzY3JvbGxUb3AnIDogJ3Njcm9sbExlZnQnO1xuICAgIGNvbnN0IGV2ZW50QXR0ciA9IChkaXJlY3Rpb24gPT09ICd2JykgPyAnY2xpZW50WScgOiAnY2xpZW50WCc7XG4gICAgY29uc3Qgc2Nyb2xsV2lkdGhBdHRyID0gKGRpcmVjdGlvbiA9PT0gJ3YnKSA/ICdzY3JvbGxIZWlnaHQnIDogJ3Njcm9sbFdpZHRoJztcbiAgICBjb25zdCBvZmZzZXRXaWR0aEF0dHIgPSAoZGlyZWN0aW9uID09PSAndicpID8gJ29mZnNldEhlaWdodCcgOiAnb2Zmc2V0V2lkdGgnO1xuICAgIGNvbnN0IGNsaWVudFdpZHRoQXR0ciA9IChkaXJlY3Rpb24gPT09ICd2JykgPyAnY2xpZW50SGVpZ2h0JyA6ICdjbGllbnRXaWR0aCc7XG4gICAgY29uc3QgcmVjdFdpZHRoQXR0ciA9IChkaXJlY3Rpb24gPT09ICd2JykgPyAnaGVpZ2h0JyA6ICd3aWR0aCc7XG4gICAgY29uc3QgY29tcGFyZVRhcmdldCA9IChvcmllbnRhdGlvbiA9PT0gRHJvcFNjcm9sbE9yaWVudGF0aW9uLmZvcndhcmQpID8gdGhpcy5mb3J3YXJkU2Nyb2xsQXJlYSA6IHRoaXMuYmFja3dhcmRTY3JvbGxBcmVhO1xuICAgIGNvbnN0IHRhcmdldEF0dHIgPSB0aGlzLmdldENyaXRpY2FsRWRnZShkaXJlY3Rpb24sIG9yaWVudGF0aW9uKTtcbiAgICBjb25zdCBzY3JvbGxFbGVtZW50ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50O1xuXG4gICAgcmV0dXJuIChldmVudDogRHJhZ0V2ZW50KSA9PiB7XG4gICAgICBjb25zdCBjb21wYXJlVGFyZ2V0UmVjdCA9IGNvbXBhcmVUYXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICBjb25zdCBkaXN0YW5jZSA9IGV2ZW50W2V2ZW50QXR0cl0gLSBjb21wYXJlVGFyZ2V0UmVjdFt0YXJnZXRBdHRyXTtcbiAgICAgIGxldCBzcGVlZCA9IHNwZWVkRm4oTWF0aC5hYnMoZGlzdGFuY2UgLyAoY29tcGFyZVRhcmdldFJlY3RbcmVjdFdpZHRoQXR0cl0gfHwgMSkpKTtcbiAgICAgIGlmIChzcGVlZCA8IHRoaXMubWluU3BlZWQpIHsgc3BlZWQgPSB0aGlzLm1pblNwZWVkOyB9XG4gICAgICBpZiAoc3BlZWQgPiB0aGlzLm1heFNwZWVkKSB7IHNwZWVkID0gdGhpcy5tYXhTcGVlZDsgfVxuICAgICAgaWYgKGRpc3RhbmNlIDwgMCkgeyBzcGVlZCA9IC0gc3BlZWQ7IH1cbiAgICAgIGlmICh0aGlzLmFuaW1hdGlvbkZyYW1lSWQpIHtcbiAgICAgICAgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMuYW5pbWF0aW9uRnJhbWVJZCk7XG4gICAgICAgIHRoaXMuYW5pbWF0aW9uRnJhbWVJZCA9IHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICAgIHRoaXMuYW5pbWF0aW9uRnJhbWVJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgIGNvbnN0IHRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgY29uc3QgbW92ZURpc3RhbmNlID0gTWF0aC5jZWlsKHNwZWVkICogKHRpbWUgLSAodGhpcy5sYXN0U2Nyb2xsVGltZSB8fCB0aW1lKSkgLyAxMDAwKTtcbiAgICAgICAgc2Nyb2xsRWxlbWVudFtzY3JvbGxBdHRyXSAtPSBtb3ZlRGlzdGFuY2U7XG4gICAgICAgIHRoaXMubGFzdFNjcm9sbFRpbWUgPSB0aW1lO1xuICAgICAgICAvLyDliKTmlq3mmK/kuI3mmK/liLDlsL3lpLRcbiAgICAgICAgaWYgKChzY3JvbGxFbGVtZW50W3Njcm9sbEF0dHJdID09PSAwICYmIG9yaWVudGF0aW9uID09PSBEcm9wU2Nyb2xsT3JpZW50YXRpb24uYmFja3dhcmQpXG4gICAgICAgIHx8ICgoc2Nyb2xsRWxlbWVudFtzY3JvbGxBdHRyXVxuICAgICAgICAgICsgKHNjcm9sbEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpW3JlY3RXaWR0aEF0dHJdXG4gICAgICAgICAgLSBzY3JvbGxFbGVtZW50W29mZnNldFdpZHRoQXR0cl1cbiAgICAgICAgICArIHNjcm9sbEVsZW1lbnRbY2xpZW50V2lkdGhBdHRyXVxuICAgICAgICApID09PSBzY3JvbGxFbGVtZW50W3Njcm9sbFdpZHRoQXR0cl1cbiAgICAgICAgICAmJiBvcmllbnRhdGlvbiA9PT0gRHJvcFNjcm9sbE9yaWVudGF0aW9uLmZvcndhcmQpXG4gICAgICAgICkge1xuICAgICAgICAgIGNvbXBhcmVUYXJnZXQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdub25lJztcbiAgICAgICAgICB0aGlzLnRvZ2dsZUFjdGl2ZUNsYXNzKGNvbXBhcmVUYXJnZXQsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmFuaW1hdGlvbkZyYW1lSWQgPSB1bmRlZmluZWQ7XG4gICAgICB9KTtcbiAgICAgIGlmICh0aGlzLmJhY2tTcGFjZURyb3BwYWJsZSkge1xuICAgICAgICBVdGlscy5kaXNwYXRjaEV2ZW50VG9VbmRlckVsZW1lbnQoZXZlbnQpO1xuICAgICAgfVxuICAgIH07XG4gIH1cbiAgZGVsZWdhdGVEcm9wRXZlbnQoZXZlbnQ6IERyYWdFdmVudCkge1xuICAgIGlmICh0aGlzLmJhY2tTcGFjZURyb3BwYWJsZSkge1xuICAgICAgY29uc3QgZXYgPSBVdGlscy5kaXNwYXRjaEV2ZW50VG9VbmRlckVsZW1lbnQoZXZlbnQpO1xuICAgICAgaWYgKGV2LmRlZmF1bHRQcmV2ZW50ZWQpIHtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGdldENyaXRpY2FsRWRnZShkaXJlY3Rpb246IERyb3BTY3JvbGxEaXJlY3Rpb24sIG9yaWVudGF0aW9uOiBEcm9wU2Nyb2xsT3JpZW50YXRpb24pOiBEcm9wU2Nyb2xsVHJpZ2dlckVkZ2Uge1xuICAgIHJldHVybiAoZGlyZWN0aW9uID09PSAndicgJiYgb3JpZW50YXRpb24gPT09IERyb3BTY3JvbGxPcmllbnRhdGlvbi5mb3J3YXJkICYmICdib3R0b20nKVxuICAgIHx8IChkaXJlY3Rpb24gPT09ICd2JyAmJiBvcmllbnRhdGlvbiA9PT0gRHJvcFNjcm9sbE9yaWVudGF0aW9uLmJhY2t3YXJkICYmICd0b3AnKVxuICAgIHx8IChkaXJlY3Rpb24gIT09ICd2JyAmJiBvcmllbnRhdGlvbiA9PT0gRHJvcFNjcm9sbE9yaWVudGF0aW9uLmZvcndhcmQgJiYgJ3JpZ2h0JylcbiAgICB8fCAoZGlyZWN0aW9uICE9PSAndicgJiYgb3JpZW50YXRpb24gPT09IERyb3BTY3JvbGxPcmllbnRhdGlvbi5iYWNrd2FyZCAmJiAnbGVmdCcpIHx8ICdib3R0b20nO1xuICB9XG4gIGdldFNlY29uZEVkZ2UoZGlyZWN0aW9uOiBEcm9wU2Nyb2xsRGlyZWN0aW9uKTogRHJvcFNjcm9sbFRyaWdnZXJFZGdlIHtcbiAgICByZXR1cm4gKGRpcmVjdGlvbiA9PT0gJ3YnICYmICdsZWZ0JylcbiAgICB8fCAoZGlyZWN0aW9uICE9PSAndicgJiYgICd0b3AnKSB8fCAnbGVmdCc7XG4gIH1cblxuICBjcmVhdGVTY3JvbGxBcmVhKGRpcmVjdGlvbjogRHJvcFNjcm9sbERpcmVjdGlvbiwgb3JpZW50YXRpb246IERyb3BTY3JvbGxPcmllbnRhdGlvbikge1xuICAgIGNvbnN0IGFyZWEgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIGFyZWEuY2xhc3NOYW1lID0gJ2Ryb3BvdmVyLXNjcm9sbC1hcmVhICcgKyAnZHJvcG92ZXItc2Nyb2xsLWFyZWEtJyArIHRoaXMuZ2V0Q3JpdGljYWxFZGdlKGRpcmVjdGlvbiwgb3JpZW50YXRpb24pO1xuICAgIC8vIOWkhOeQhuWkp+Wwj1xuICAgIGFyZWEuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7XG4gICAgdGhpcy5zZXRBcmVhU2l6ZShhcmVhLCBkaXJlY3Rpb24sIG9yaWVudGF0aW9uKTtcbiAgICAvLyDlpITnkIbkvY3nva5cbiAgICBhcmVhLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJztcbiAgICB0aGlzLnNldEFyZWFTdHlsZUxheW91dChhcmVhLCBkaXJlY3Rpb24sIG9yaWVudGF0aW9uKTtcblxuICAgIC8vIOm7mOiupOS4jeWxleekulxuICAgIGFyZWEuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAvLyDpmYTnnYDlhYPntKBcbiAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZS5hcHBlbmRDaGlsZChhcmVhLCB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQpO1xuICAgIHJldHVybiBhcmVhO1xuICB9XG5cbiAgc2V0QXJlYVNpemUoYXJlYTogSFRNTEVsZW1lbnQsIGRpcmVjdGlvbjogRHJvcFNjcm9sbERpcmVjdGlvbiwgb3JpZW50YXRpb246IERyb3BTY3JvbGxPcmllbnRhdGlvbikge1xuICAgIGNvbnN0IHJlY3QgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgY29uc3QgY29udGFpbmVyQXR0ciA9IGRpcmVjdGlvbiA9PT0gJ3YnID8gJ2hlaWdodCcgOiAnd2lkdGgnO1xuICAgIGNvbnN0IHJlc3BvbnNlRWRnZVdpZHRoID0gKHR5cGVvZiB0aGlzLnJlc3BvbnNlRWRnZVdpZHRoID09PSAnc3RyaW5nJylcbiAgICAgID8gdGhpcy5yZXNwb25zZUVkZ2VXaWR0aFxuICAgICAgOiB0aGlzLnJlc3BvbnNlRWRnZVdpZHRoKHJlY3RbY29udGFpbmVyQXR0cl0pO1xuICAgIGNvbnN0IHNldHRpbmdPZmZzZXQgPSB0aGlzLnZpZXdPZmZzZXRcbiAgICAgICYmIChvcmllbnRhdGlvbiA9PT0gRHJvcFNjcm9sbE9yaWVudGF0aW9uLmZvcndhcmQgPyB0aGlzLnZpZXdPZmZzZXQuZm9yd2FyZCA6IHRoaXMudmlld09mZnNldC5iYWNrd2FyZCk7XG4gICAgbGV0IHdpZHRoID0gZGlyZWN0aW9uID09PSAndicgPyAocmVjdC53aWR0aCArICdweCcpIDogcmVzcG9uc2VFZGdlV2lkdGg7XG4gICAgbGV0IGhlaWdodCA9ICBkaXJlY3Rpb24gPT09ICd2JyA/IHJlc3BvbnNlRWRnZVdpZHRoIDogKHJlY3QuaGVpZ2h0ICsgJ3B4Jyk7XG4gICAgaWYgKHNldHRpbmdPZmZzZXQpIHtcbiAgICAgIGlmIChzZXR0aW5nT2Zmc2V0LndpZHRoT2Zmc2V0KSB7XG4gICAgICAgIHdpZHRoID0gJ2NhbGMoJyArIHdpZHRoICsgJyArICcgKyAoc2V0dGluZ09mZnNldC53aWR0aE9mZnNldCkgKyAncHgpJztcbiAgICAgIH1cbiAgICAgIGlmIChzZXR0aW5nT2Zmc2V0LmhlaWdodE9mZnNldCkge1xuICAgICAgICBoZWlnaHQgPSAnY2FsYygnICsgaGVpZ2h0ICsgJyArICcgKyAoc2V0dGluZ09mZnNldC5oZWlnaHRPZmZzZXQpICsgJ3B4KSc7XG4gICAgICB9XG4gICAgfVxuICAgIGFyZWEuc3R5bGUud2lkdGggPSB3aWR0aDtcbiAgICBhcmVhLnN0eWxlLmhlaWdodCA9IGhlaWdodDtcbiAgfVxuXG4gIHNldEFyZWFTdHlsZUxheW91dCAoYXJlYTogSFRNTEVsZW1lbnQsIGRpcmVjdGlvbjogRHJvcFNjcm9sbERpcmVjdGlvbiwgb3JpZW50YXRpb246IERyb3BTY3JvbGxPcmllbnRhdGlvbikge1xuICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudDtcbiAgICBjb25zdCByZWxhdGVkVGFyZ2V0ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGU7XG4gICAgY29uc3QgZGVmYXVsdE9mZnNldCA9IHtsZWZ0OiAwLCByaWdodDogMCwgdG9wOiAwLCBib3R0b206IDB9O1xuICAgIGNvbnN0IHNldHRpbmdPZmZzZXQgPSB0aGlzLnZpZXdPZmZzZXRcbiAgICAgICYmIChvcmllbnRhdGlvbiA9PT0gRHJvcFNjcm9sbE9yaWVudGF0aW9uLmZvcndhcmQgPyB0aGlzLnZpZXdPZmZzZXQuZm9yd2FyZCA6IHRoaXMudmlld09mZnNldC5iYWNrd2FyZClcbiAgICAgIHx8IGRlZmF1bHRPZmZzZXQ7XG5cbiAgICBjb25zdCBjcml0aWNhbEVkZ2UgPSB0aGlzLmdldENyaXRpY2FsRWRnZShkaXJlY3Rpb24sIG9yaWVudGF0aW9uKTtcbiAgICBjb25zdCBzZWNvbmRFZGdlID0gdGhpcy5nZXRTZWNvbmRFZGdlKGRpcmVjdGlvbik7XG4gICAgW2NyaXRpY2FsRWRnZSwgc2Vjb25kRWRnZV0uZm9yRWFjaChlZGdlID0+IHtcbiAgICAgIGFyZWEuc3R5bGVbZWRnZV0gPSB0aGlzLmdldFJlbGF0ZWRQb3NpdGlvbih0YXJnZXQsIHJlbGF0ZWRUYXJnZXQsIGVkZ2UsIHNldHRpbmdPZmZzZXRbZWRnZV0pO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0UmVsYXRlZFBvc2l0aW9uKHRhcmdldCwgcmVsYXRlZFRhcmdldCwgZWRnZTogRHJvcFNjcm9sbFRyaWdnZXJFZGdlLCBvZmZzZXRWYWx1ZT86IG51bWJlcikge1xuICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgcmV0dXJuICcwcHgnO1xuICAgIH1cbiAgICBjb25zdCByZWxhdGVkQ29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHJlbGF0ZWRUYXJnZXQpO1xuICAgIGNvbnN0IHJlbGF0ZWRSZWN0ID0gcmVsYXRlZFRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBjb25zdCBzZWxmUmVjdCA9IHRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBjb25zdCBoZWxwZXIgPSB7XG4gICAgICBsZWZ0OiBbJ2xlZnQnLCAnTGVmdCddLFxuICAgICAgcmlnaHQ6IFsncmlnaHQnLCAnUmlnaHQnXSxcbiAgICAgIHRvcDogWyd0b3AnLCAnVG9wJ10sXG4gICAgICBib3R0b206IFsnYm90dG9tJywgJ0JvdHRvbSddLFxuICAgIH07XG4gICAgbGV0IGZhY3RvciA9IDE7XG4gICAgaWYgKGVkZ2UgPT09ICdyaWdodCcgfHwgZWRnZSA9PT0gJ2JvdHRvbScpIHsgZmFjdG9yID0gLTE7IH1cbiAgICByZXR1cm4gKHNlbGZSZWN0W2hlbHBlcltlZGdlXVswXV0gLSByZWxhdGVkUmVjdFtoZWxwZXJbZWRnZV1bMF1dXG4gICAgICAgICAgKyBwYXJzZUludChyZWxhdGVkQ29tcHV0ZWRTdHlsZVsnYm9yZGVyJyArICBoZWxwZXJbZWRnZV1bMV0gKyAnV2lkdGgnXSwgMTApKSAqIGZhY3RvclxuICAgICAgICAgICsgKG9mZnNldFZhbHVlIHx8IDApXG4gICAgICAgICAgKyAncHgnO1xuICB9XG5cbiAgcmVzaXplQXJlYSgpIHtcbiAgICBbe2FyZWE6IHRoaXMuZm9yd2FyZFNjcm9sbEFyZWEsIG9yaWVudGF0aW9uOiBEcm9wU2Nyb2xsT3JpZW50YXRpb24uZm9yd2FyZH0sXG4gICAgICB7YXJlYTogdGhpcy5iYWNrd2FyZFNjcm9sbEFyZWEsIG9yaWVudGF0aW9uOiBEcm9wU2Nyb2xsT3JpZW50YXRpb24uYmFja3dhcmR9XG4gICAgXVxuICAgICAgLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgIHRoaXMuc2V0QXJlYVNpemUoaXRlbS5hcmVhLCB0aGlzLmRpcmVjdGlvbiwgaXRlbS5vcmllbnRhdGlvbik7XG4gICAgICAgIHRoaXMuc2V0QXJlYVN0eWxlTGF5b3V0KGl0ZW0uYXJlYSwgdGhpcy5kaXJlY3Rpb24sIGl0ZW0ub3JpZW50YXRpb24pO1xuICAgICAgfSk7XG4gIH1cblxuICB0b2dnbGVTY3JvbGxUb09uZUVuZChzY3JvbGxFbGVtZW50OiBhbnksIHRvZ2dsZUVsZW1lbnQ6IEhUTUxFbGVtZW50LCBkaXJlY3Rpb246IERyb3BTY3JvbGxEaXJlY3Rpb24sIG9yaWVudGF0aW9uOiBEcm9wU2Nyb2xsT3JpZW50YXRpb24pIHtcbiAgICBjb25zdCBzY3JvbGxBdHRyID0gKGRpcmVjdGlvbiA9PT0gJ3YnKSA/ICdzY3JvbGxUb3AnIDogJ3Njcm9sbExlZnQnO1xuICAgIGNvbnN0IHNjcm9sbFdpZHRoQXR0ciA9IChkaXJlY3Rpb24gPT09ICd2JykgPyAnc2Nyb2xsSGVpZ2h0JyA6ICdzY3JvbGxXaWR0aCc7XG4gICAgY29uc3Qgb2Zmc2V0V2lkdGhBdHRyID0gKGRpcmVjdGlvbiA9PT0gJ3YnKSA/ICdvZmZzZXRIZWlnaHQnIDogJ29mZnNldFdpZHRoJztcbiAgICBjb25zdCBjbGllbnRXaWR0aEF0dHIgPSAoZGlyZWN0aW9uID09PSAndicpID8gJ2NsaWVudEhlaWdodCcgOiAnY2xpZW50V2lkdGgnO1xuICAgIGNvbnN0IHJlY3RXaWR0aEF0dHIgPSAoZGlyZWN0aW9uID09PSAndicpID8gJ2hlaWdodCcgOiAnd2lkdGgnO1xuICAgIGlmICgoc2Nyb2xsRWxlbWVudFtzY3JvbGxBdHRyXSA9PT0gMCAmJiBvcmllbnRhdGlvbiA9PT0gRHJvcFNjcm9sbE9yaWVudGF0aW9uLmJhY2t3YXJkKSB8fCAoXG4gICAgICBNYXRoLmFicyhcbiAgICAgICAgc2Nyb2xsRWxlbWVudFtzY3JvbGxBdHRyXVxuICAgICAgICArIChzY3JvbGxFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKVtyZWN0V2lkdGhBdHRyXVxuICAgICAgICAtIHNjcm9sbEVsZW1lbnRbc2Nyb2xsV2lkdGhBdHRyXVxuICAgICAgICAtIHNjcm9sbEVsZW1lbnRbb2Zmc2V0V2lkdGhBdHRyXVxuICAgICAgICArIHNjcm9sbEVsZW1lbnRbY2xpZW50V2lkdGhBdHRyXVxuICAgICAgKSA8IDFcbiAgICAgICYmIG9yaWVudGF0aW9uID09PSBEcm9wU2Nyb2xsT3JpZW50YXRpb24uZm9yd2FyZFxuICAgICkpIHtcbiAgICAgIHRvZ2dsZUVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdub25lJztcbiAgICAgIHRoaXMudG9nZ2xlQWN0aXZlQ2xhc3ModG9nZ2xlRWxlbWVudCwgZmFsc2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0b2dnbGVFbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnYXV0byc7XG4gICAgICB0aGlzLnRvZ2dsZUFjdGl2ZUNsYXNzKHRvZ2dsZUVsZW1lbnQsIHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIGNsZWFuTGFzdFNjcm9sbFRpbWUoKSB7XG4gICAgaWYgKHRoaXMuYW5pbWF0aW9uRnJhbWVJZCAmJiB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMuYW5pbWF0aW9uRnJhbWVJZCk7XG4gICAgICB0aGlzLmFuaW1hdGlvbkZyYW1lSWQgPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHRoaXMubGFzdFNjcm9sbFRpbWUgPSB1bmRlZmluZWQ7XG4gIH1cblxuICB0b2dnbGVBY3RpdmVDbGFzcyh0YXJnZXQsIGFjdGl2ZSkge1xuICAgIGlmIChhY3RpdmUpIHtcbiAgICAgIHRhcmdldC5jbGFzc0xpc3QucmVtb3ZlKCdpbmFjdGl2ZScpO1xuICAgICAgdGFyZ2V0LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0YXJnZXQuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7XG4gICAgICB0YXJnZXQuY2xhc3NMaXN0LmFkZCgnaW5hY3RpdmUnKTtcbiAgICB9XG4gIH1cblxuICBhbGxvd1Njcm9sbCgpOiBib29sZWFuIHtcbiAgICBpZiAoIXRoaXMuZHJvcFNjcm9sbFNjb3BlKSB7IHJldHVybiB0cnVlOyB9XG4gICAgbGV0IGFsbG93ZWQgPSBmYWxzZTtcbiAgICBpZiAodHlwZW9mIHRoaXMuZHJvcFNjcm9sbFNjb3BlID09PSAnc3RyaW5nJykge1xuICAgICAgaWYgKHR5cGVvZiB0aGlzLmRyYWdEcm9wU2VydmljZS5zY29wZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgYWxsb3dlZCA9IHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLnNjb3BlID09PSB0aGlzLmRyb3BTY3JvbGxTY29wZTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmRyYWdEcm9wU2VydmljZS5zY29wZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgIGFsbG93ZWQgPSB0aGlzLmRyYWdEcm9wU2VydmljZS5zY29wZS5pbmRleE9mKHRoaXMuZHJvcFNjcm9sbFNjb3BlKSA+IC0xO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5kcm9wU2Nyb2xsU2NvcGUgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgaWYgKHR5cGVvZiB0aGlzLmRyYWdEcm9wU2VydmljZS5zY29wZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgYWxsb3dlZCA9IHRoaXMuZHJvcFNjcm9sbFNjb3BlLmluZGV4T2YodGhpcy5kcmFnRHJvcFNlcnZpY2Uuc2NvcGUpID4gLTE7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5kcmFnRHJvcFNlcnZpY2Uuc2NvcGUgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICBhbGxvd2VkID0gdGhpcy5kcm9wU2Nyb2xsU2NvcGUuZmlsdGVyKChpdGVtKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLnNjb3BlLmluZGV4T2YoaXRlbSkgIT09IC0xO1xuICAgICAgICB9KS5sZW5ndGggPiAwO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYWxsb3dlZDtcbiAgfVxufVxuIl19