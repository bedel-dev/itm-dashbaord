import { Directive, ElementRef, Input, Optional, Self } from '@angular/core';
import { Subscription } from 'rxjs';
import { DescendantChildren } from '../services/drag-drop-desc-reg.service';
import { DropSortSyncDescendantRegisterService } from '../services/drag-drop-descendant-sync.service';
import { DragDropSyncService } from '../services/drag-drop-sync.service';
import { Utils } from '../shared/utils';
import { DroppableDirective } from './droppable.directive';
import * as i0 from "@angular/core";
import * as i1 from "./droppable.directive";
import * as i2 from "../services/drag-drop-sync.service";
import * as i3 from "../services/drag-drop-descendant-sync.service";
export class DropSortSyncDirective extends DescendantChildren {
    constructor(el, droppable, dragDropSyncService, dropSortSyncDrs) {
        super(dropSortSyncDrs);
        this.el = el;
        this.droppable = droppable;
        this.dragDropSyncService = dragDropSyncService;
        this.dropSortSyncDrs = dropSortSyncDrs;
        this.dropSyncGroup = '';
        this.direction = 'v'; // 与sortContainer正交的方向
        this.subscription = new Subscription();
        this.subRenderEvent = (nativeStyle) => {
            this.syncGroupDirectives = this.dragDropSyncService.getDropSyncByGroup(this.dropSyncGroup).filter(directive => directive !== this);
            this.syncGroupDirectives.forEach(dir => {
                dir.renderPlaceholder(nativeStyle, this.droppable);
            });
        };
        this.subInsertionEvent = (cmd) => {
            this.syncGroupDirectives = this.dragDropSyncService.getDropSyncByGroup(this.dropSyncGroup).filter(directive => directive !== this);
            this.syncGroupDirectives.forEach(dir => {
                dir.insertPlaceholderCommand({
                    command: cmd.command,
                    container: dir.sortContainer,
                    relatedEl: dir.getChildrenElByIndex(dir.sortContainer, cmd.index)
                });
            });
        };
        this.descendantItem = this;
    }
    ngOnInit() {
        this.sortContainer = this.el.nativeElement;
        if (this.droppable) {
            this.sortContainer = this.droppable.getSortContainer();
            this.subscription.add(this.droppable.placeholderInsertionEvent.subscribe(this.subInsertionEvent)).add(this.droppable.placeholderRenderEvent.subscribe(this.subRenderEvent));
        }
        super.ngOnInit();
    }
    ngOnDestroy() {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
        super.ngOnDestroy();
    }
    getChildrenElByIndex(target, index) {
        if (index === undefined || target && target.children && target.children.length < index || index < 0) {
            return null;
        }
        return this.sortContainer.children.item(index);
    }
    renderPlaceholder(nativeStyle, droppable) {
        if (!this.placeholder) {
            this.placeholder = document.createElement(droppable.placeholderTag);
            this.placeholder.className = 'drag-placeholder';
            this.placeholder.classList.add('drag-sync-placeholder');
            this.placeholder.innerText = droppable.placeholderText;
        }
        const { width, height } = nativeStyle;
        if (this.direction === 'v') {
            this.placeholder.style.width = width + 'px';
            this.placeholder.style.height = this.sortContainer.getBoundingClientRect().height + 'px';
        }
        else {
            this.placeholder.style.height = height + 'px';
            this.placeholder.style.width = this.sortContainer.getBoundingClientRect().width + 'px';
        }
        Utils.addElStyles(this.placeholder, droppable.placeholderStyle);
    }
    insertPlaceholderCommand(cmd) {
        if (cmd.command === 'insertBefore' && cmd.container) {
            cmd.container.insertBefore(this.placeholder, cmd.relatedEl);
            return;
        }
        if (cmd.command === 'append' && cmd.container) {
            cmd.container.appendChild(this.placeholder);
            return;
        }
        if (cmd.command === 'remove' && cmd.container) {
            if (cmd.container.contains(this.placeholder)) {
                cmd.container.removeChild(this.placeholder);
            }
            return;
        }
    }
}
DropSortSyncDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DropSortSyncDirective, deps: [{ token: i0.ElementRef }, { token: i1.DroppableDirective, optional: true, self: true }, { token: i2.DragDropSyncService }, { token: i3.DropSortSyncDescendantRegisterService }], target: i0.ɵɵFactoryTarget.Directive });
DropSortSyncDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.3", type: DropSortSyncDirective, selector: "[dDropSortSync]", inputs: { dropSyncGroup: ["dDropSortSync", "dropSyncGroup"], direction: ["dropSyncDirection", "direction"] }, exportAs: ["dDropSortSync"], usesInheritance: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DropSortSyncDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[dDropSortSync]',
                    exportAs: 'dDropSortSync'
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.DroppableDirective, decorators: [{
                    type: Optional
                }, {
                    type: Self
                }] }, { type: i2.DragDropSyncService }, { type: i3.DropSortSyncDescendantRegisterService }]; }, propDecorators: { dropSyncGroup: [{
                type: Input,
                args: ['dDropSortSync']
            }], direction: [{
                type: Input,
                args: ['dropSyncDirection']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcC1zb3J0LXN5bmMuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vZGV2dWkvZHJhZ2Ryb3AvZGlyZWN0aXZlcy9kcm9wLXNvcnQtc3luYy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFxQixRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hHLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDNUUsT0FBTyxFQUFFLHFDQUFxQyxFQUFFLE1BQU0sK0NBQStDLENBQUM7QUFDdEcsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDekUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDOzs7OztBQVEzRCxNQUFNLE9BQU8scUJBQXNCLFNBQVEsa0JBQXlDO0lBUWxGLFlBQ1MsRUFBYyxFQUNPLFNBQTZCLEVBQ2pELG1CQUF3QyxFQUN4QyxlQUFzRDtRQUU5RCxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7UUFMaEIsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUNPLGNBQVMsR0FBVCxTQUFTLENBQW9CO1FBQ2pELHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsb0JBQWUsR0FBZixlQUFlLENBQXVDO1FBWHhDLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ2YsY0FBUyxHQUFhLEdBQUcsQ0FBQyxDQUFDLHNCQUFzQjtRQUM3RSxpQkFBWSxHQUFpQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBa0NoRCxtQkFBYyxHQUFHLENBQUMsV0FBNEMsRUFBRSxFQUFFO1lBQ2hFLElBQUks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V0FBVyxDQUFDLENBQUM7WUFDNUMsT0FBTztTQUNSO1FBQ0QsSUFBSSxHQUFHLENBQUMsT0FBTyxLQUFLLFFBQVEsSUFBSSxHQUFHLENBQUMsU0FBUyxFQUFFO1lBQzdDLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFO2dCQUM1QyxHQUFHLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7YUFDN0M7WUFDRCxPQUFPO1NBQ1I7SUFDSCxDQUFDOztrSEEvRlUscUJBQXFCO3NHQUFyQixxQkFBcUI7MkZBQXJCLHFCQUFxQjtrQkFMakMsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsaUJBQWlCO29CQUMzQixRQUFRLEVBQUUsZUFBZTtpQkFDMUI7OzBCQVlJLFFBQVE7OzBCQUFJLElBQUk7a0lBVEssYUFBYTtzQkFBcEMsS0FBSzt1QkFBQyxlQUFlO2dCQUNNLFNBQVM7c0JBQXBDLEtBQUs7dUJBQUMsbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBJbnB1dCwgT25EZXN0cm95LCBPbkluaXQsIE9wdGlvbmFsLCBTZWxmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IERlc2NlbmRhbnRDaGlsZHJlbiB9IGZyb20gJy4uL3NlcnZpY2VzL2RyYWctZHJvcC1kZXNjLXJlZy5zZXJ2aWNlJztcbmltcG9ydCB7IERyb3BTb3J0U3luY0Rlc2NlbmRhbnRSZWdpc3RlclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9kcmFnLWRyb3AtZGVzY2VuZGFudC1zeW5jLnNlcnZpY2UnO1xuaW1wb3J0IHsgRHJhZ0Ryb3BTeW5jU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2RyYWctZHJvcC1zeW5jLnNlcnZpY2UnO1xuaW1wb3J0IHsgVXRpbHMgfSBmcm9tICcuLi9zaGFyZWQvdXRpbHMnO1xuaW1wb3J0IHsgRHJvcHBhYmxlRGlyZWN0aXZlIH0gZnJvbSAnLi9kcm9wcGFibGUuZGlyZWN0aXZlJztcbmltcG9ydCB7IERyYWdQbGFjZWhvbGRlckluc2VydGlvbkV2ZW50LCBEcmFnUGxhY2Vob2xkZXJJbnNlcnRpb25JbmRleEV2ZW50IH0gZnJvbSAnLi9wbGFjZWhvbGRlci1pbnNlcnRpb24tZXZlbnQudHlwZSc7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tkRHJvcFNvcnRTeW5jXScsXG4gIGV4cG9ydEFzOiAnZERyb3BTb3J0U3luYydcbn0pXG5cbmV4cG9ydCBjbGFzcyBEcm9wU29ydFN5bmNEaXJlY3RpdmUgZXh0ZW5kcyBEZXNjZW5kYW50Q2hpbGRyZW48RHJvcFNvcnRTeW5jRGlyZWN0aXZlPiBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgQElucHV0KCdkRHJvcFNvcnRTeW5jJykgZHJvcFN5bmNHcm91cCA9ICcnO1xuICBASW5wdXQoJ2Ryb3BTeW5jRGlyZWN0aW9uJykgZGlyZWN0aW9uOiAndid8ICdoJyA9ICd2JzsgLy8g5LiOc29ydENvbnRhaW5lcuato+S6pOeahOaWueWQkVxuICBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcbiAgc3luY0dyb3VwRGlyZWN0aXZlczogQXJyYXk8RHJvcFNvcnRTeW5jRGlyZWN0aXZlPjtcbiAgcGxhY2Vob2xkZXI6IEhUTUxFbGVtZW50O1xuICBzb3J0Q29udGFpbmVyOiBIVE1MRWxlbWVudDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgZWw6IEVsZW1lbnRSZWYsXG4gICAgQE9wdGlvbmFsKCkgQFNlbGYoKSBwcml2YXRlIGRyb3BwYWJsZTogRHJvcHBhYmxlRGlyZWN0aXZlLFxuICAgIHByaXZhdGUgZHJhZ0Ryb3BTeW5jU2VydmljZTogRHJhZ0Ryb3BTeW5jU2VydmljZSxcbiAgICBwcml2YXRlIGRyb3BTb3J0U3luY0RyczogRHJvcFNvcnRTeW5jRGVzY2VuZGFudFJlZ2lzdGVyU2VydmljZSxcbiAgKSB7XG4gICAgc3VwZXIoZHJvcFNvcnRTeW5jRHJzKTtcbiAgICB0aGlzLmRlc2NlbmRhbnRJdGVtID0gdGhpcztcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuc29ydENvbnRhaW5lciA9IHRoaXMuZWwubmF0aXZlRWxlbWVudDtcbiAgICBpZiAodGhpcy5kcm9wcGFibGUpIHtcbiAgICAgIHRoaXMuc29ydENvbnRhaW5lciA9IHRoaXMuZHJvcHBhYmxlLmdldFNvcnRDb250YWluZXIoKTtcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChcbiAgICAgICAgdGhpcy5kcm9wcGFibGUucGxhY2Vob2xkZXJJbnNlcnRpb25FdmVudC5zdWJzY3JpYmUodGhpcy5zdWJJbnNlcnRpb25FdmVudClcbiAgICAgICkuYWRkKFxuICAgICAgICB0aGlzLmRyb3BwYWJsZS5wbGFjZWhvbGRlclJlbmRlckV2ZW50LnN1YnNjcmliZSh0aGlzLnN1YlJlbmRlckV2ZW50KVxuICAgICAgKTtcbiAgICB9XG4gICAgc3VwZXIubmdPbkluaXQoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gICAgc3VwZXIubmdPbkRlc3Ryb3koKTtcbiAgfVxuICBzdWJSZW5kZXJFdmVudCA9IChuYXRpdmVTdHlsZToge3dpZHRoOiBudW1iZXI7IGhlaWdodDogbnVtYmVyfSkgPT4ge1xuICAgIHRoaXMuc3luY0dyb3VwRGlyZWN0aXZlcyA9IHRoaXMuZHJhZ0Ryb3BTeW5jU2VydmljZS5nZXREcm9wU3luY0J5R3JvdXAodGhpcy5kcm9wU3luY0dyb3VwKS5maWx0ZXIoZGlyZWN0aXZlID0+IGRpcmVjdGl2ZSAhPT0gdGhpcyk7XG4gICAgdGhpcy5zeW5jR3JvdXBEaXJlY3RpdmVzLmZvckVhY2goZGlyID0+IHtcbiAgICAgIGRpci5yZW5kZXJQbGFjZWhvbGRlcihuYXRpdmVTdHlsZSwgdGhpcy5kcm9wcGFibGUpO1xuICAgIH0pO1xuICB9O1xuXG4gIHN1Ykluc2VydGlvbkV2ZW50ID0gKGNtZDogRHJhZ1BsYWNlaG9sZGVySW5zZXJ0aW9uSW5kZXhFdmVudCkgPT4ge1xuICAgIHRoaXMuc3luY0dyb3VwRGlyZWN0aXZlcyA9IHRoaXMuZHJhZ0Ryb3BTeW5jU2VydmljZS5nZXREcm9wU3luY0J5R3JvdXAodGhpcy5kcm9wU3luY0dyb3VwKS5maWx0ZXIoZGlyZWN0aXZlID0+IGRpcmVjdGl2ZSAhPT0gdGhpcyk7XG4gICAgdGhpcy5zeW5jR3JvdXBEaXJlY3RpdmVzLmZvckVhY2goZGlyID0+IHtcbiAgICAgIGRpci5pbnNlcnRQbGFjZWhvbGRlckNvbW1hbmQoe1xuICAgICAgICBjb21tYW5kOiBjbWQuY29tbWFuZCxcbiAgICAgICAgY29udGFpbmVyOiBkaXIuc29ydENvbnRhaW5lcixcbiAgICAgICAgcmVsYXRlZEVsOiBkaXIuZ2V0Q2hpbGRyZW5FbEJ5SW5kZXgoZGlyLnNvcnRDb250YWluZXIsIGNtZC5pbmRleClcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9O1xuICBnZXRDaGlsZHJlbkVsQnlJbmRleCh0YXJnZXQsIGluZGV4Pykge1xuICAgIGlmIChpbmRleCA9PT0gdW5kZWZpbmVkIHx8IHRhcmdldCAmJiB0YXJnZXQuY2hpbGRyZW4gJiYgdGFyZ2V0LmNoaWxkcmVuLmxlbmd0aCA8IGluZGV4IHx8IGluZGV4IDwgMCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnNvcnRDb250YWluZXIuY2hpbGRyZW4uaXRlbShpbmRleCk7XG4gIH1cblxuICByZW5kZXJQbGFjZWhvbGRlcihuYXRpdmVTdHlsZToge3dpZHRoOiBudW1iZXI7IGhlaWdodDogbnVtYmVyfSwgZHJvcHBhYmxlKSB7XG4gICAgaWYgKCF0aGlzLnBsYWNlaG9sZGVyKSB7XG4gICAgICB0aGlzLnBsYWNlaG9sZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChkcm9wcGFibGUucGxhY2Vob2xkZXJUYWcpO1xuICAgICAgdGhpcy5wbGFjZWhvbGRlci5jbGFzc05hbWUgPSAnZHJhZy1wbGFjZWhvbGRlcic7XG4gICAgICB0aGlzLnBsYWNlaG9sZGVyLmNsYXNzTGlzdC5hZGQoJ2RyYWctc3luYy1wbGFjZWhvbGRlcicpO1xuICAgICAgdGhpcy5wbGFjZWhvbGRlci5pbm5lclRleHQgPSBkcm9wcGFibGUucGxhY2Vob2xkZXJUZXh0O1xuICAgIH1cbiAgICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBuYXRpdmVTdHlsZTtcbiAgICBpZiAodGhpcy5kaXJlY3Rpb24gPT09ICd2Jykge1xuICAgICAgdGhpcy5wbGFjZWhvbGRlci5zdHlsZS53aWR0aCA9IHdpZHRoICsgJ3B4JztcbiAgICAgIHRoaXMucGxhY2Vob2xkZXIuc3R5bGUuaGVpZ2h0ID0gdGhpcy5zb3J0Q29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmhlaWdodCArICdweCc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucGxhY2Vob2xkZXIuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgJ3B4JztcbiAgICAgIHRoaXMucGxhY2Vob2xkZXIuc3R5bGUud2lkdGggPSB0aGlzLnNvcnRDb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGggKyAncHgnO1xuICAgIH1cbiAgICBVdGlscy5hZGRFbFN0eWxlcyh0aGlzLnBsYWNlaG9sZGVyLCBkcm9wcGFibGUucGxhY2Vob2xkZXJTdHlsZSk7XG5cbiAgfVxuXG4gIGluc2VydFBsYWNlaG9sZGVyQ29tbWFuZChjbWQ6IERyYWdQbGFjZWhvbGRlckluc2VydGlvbkV2ZW50KSB7XG4gICAgaWYgKGNtZC5jb21tYW5kID09PSAnaW5zZXJ0QmVmb3JlJyAmJiBjbWQuY29udGFpbmVyKSB7XG4gICAgICBjbWQuY29udGFpbmVyLmluc2VydEJlZm9yZSh0aGlzLnBsYWNlaG9sZGVyLCBjbWQucmVsYXRlZEVsKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGNtZC5jb21tYW5kID09PSAnYXBwZW5kJyAmJiBjbWQuY29udGFpbmVyKSB7XG4gICAgICBjbWQuY29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMucGxhY2Vob2xkZXIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY21kLmNvbW1hbmQgPT09ICdyZW1vdmUnICYmIGNtZC5jb250YWluZXIpIHtcbiAgICAgIGlmIChjbWQuY29udGFpbmVyLmNvbnRhaW5zKHRoaXMucGxhY2Vob2xkZXIpKSB7XG4gICAgICAgIGNtZC5jb250YWluZXIucmVtb3ZlQ2hpbGQodGhpcy5wbGFjZWhvbGRlcik7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==