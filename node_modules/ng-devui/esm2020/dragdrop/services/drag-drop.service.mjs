import { DOCUMENT } from '@angular/common';
import { Inject, Injectable, NgZone } from '@angular/core';
import { Subject, Subscription } from 'rxjs';
import { Utils } from '../shared/utils';
import { DragDropTouch } from '../touch-support/dragdrop-touch';
import * as i0 from "@angular/core";
export class DragDropService {
    constructor(ngZone, doc) {
        this.ngZone = ngZone;
        this.doc = doc;
        this.dropTargets = [];
        this.dropEvent = new Subject();
        this.dragEndEvent = new Subject();
        this.dragStartEvent = new Subject();
        this.subscription = new Subscription();
        this.dragEmptyImage = new Image();
        this.dragItemParentName = '';
        this.dragItemChildrenName = '';
        this.intersectionObserver = null;
        /* 协同拖拽需要 */
        this.dragElShowHideEvent = new Subject();
        this.followMouse4CloneNode = (event) => {
            const { offsetLeft, offsetTop } = this.dragOffset;
            const { clientX, clientY } = event;
            requestAnimationFrame(() => {
                if (!this.dragCloneNode) {
                    return;
                }
                this.dragCloneNode.style.left = clientX - offsetLeft + 'px';
                this.dragCloneNode.style.top = clientY - offsetTop + 'px';
            });
        };
        this.touchInstance = DragDropTouch.getInstance();
        // service not support OnInit, only support OnDestroy, so write in constructor
        // safari的img必须要有src
        this.dragEmptyImage.src
            = 'data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==';
        this.document = this.doc;
    }
    newSubscription() {
        this.subscription.unsubscribe();
        // eslint-disable-next-line no-return-assign
        return this.subscription = new Subscription();
    }
    enableDraggedCloneNodeFollowMouse() {
        if (!this.dragCloneNode) {
            this.dragItemContainer = this.draggedEl.parentElement;
            if (this.dragPreviewDirective && this.dragPreviewDirective.dragPreviewTemplate) {
                this.dragPreviewDirective.createPreview();
                this.dragCloneNode = this.dragPreviewDirective.getPreviewElement();
                this.dragItemContainer = this.document.body;
            }
            else {
                this.dragCloneNode = this.draggedEl.cloneNode(true);
            }
            this.dragCloneNode.style.margin = '0';
            if (this.dragFollowOptions && this.dragFollowOptions.appendToBody) {
                this.dragItemContainer = this.document.body;
                this.copyStyle(this.draggedEl, this.dragCloneNode);
            }
            if (this.dragItemChildrenName !== '') {
                const parentElement = this.dragItemParentName === '' ? this.dragCloneNode : this.document.querySelector(this.dragItemParentName);
                const dragItemChildren = parentElement.querySelectorAll(this.dragItemChildrenName);
                this.interceptChildNode(parentElement, dragItemChildren);
            }
            // 拷贝canvas的内容
            const originCanvasArr = this.draggedEl.querySelectorAll('canvas');
            const targetCanvasArr = this.dragCloneNode.querySelectorAll('canvas');
            [].forEach.call(targetCanvasArr, (canvas, index) => {
                canvas.getContext('2d').drawImage(originCanvasArr[index], 0, 0);
            });
            this.ngZone.runOutsideAngular(() => {
                this.document.addEventListener('dragover', this.followMouse4CloneNode, { capture: true, passive: true });
            });
            this.dragCloneNode.style.width = this.dragOffset.width + 'px';
            this.dragCloneNode.style.height = this.dragOffset.height + 'px';
            if (!(this.dragPreviewDirective
                && this.dragPreviewDirective.dragPreviewTemplate
                && this.dragPreviewDirective.dragPreviewOptions
                && this.dragPreviewDirective.dragPreviewOptions.skipBatchPreview)) {
                // 批量拖拽样式
                if (this.batchDragging && this.batchDragData && this.batchDragData.length > 1) {
                    // 创建一个节点容器
                    const node = this.document.createElement('div');
                    node.appendChild(this.dragCloneNode);
                    node.classList.add('batch-dragged-node');
                    /* 计数样式定位 */
                    if (this.batchDragStyle && this.batchDragStyle.length && this.batchDragStyle.indexOf('badge') > -1) {
                        const badge = this.document.createElement('div');
                        badge.innerText = String(this.batchDragData.length);
                        badge.classList.add('batch-dragged-node-count');
                        node.style.position = 'relative';
                        const style = {
                            position: 'absolute',
                            right: '5px',
                            top: '-12px',
                            height: '24px',
                            width: '24px',
                            borderRadius: '12px',
                            fontSize: '14px',
                            lineHeight: '24px',
                            textAlign: 'center',
                            color: '#fff',
                            background: ['#5170ff', 'var(--brand-1, #5170ff)']
                        };
                        Utils.addElStyles(badge, style);
                        node.appendChild(badge);
                    }
                    /* 层叠感样式定位 */
                    if (this.batchDragStyle && this.batchDragStyle.length && this.batchDragStyle.indexOf('stack') > -1) {
                        let stack = 2;
                        if (this.batchDragData.length === 2) {
                            stack = 1;
                        }
                        for (let i = 0; i < stack; i++) {
                            const stackNode = this.dragCloneNode.cloneNode(false);
                            const stackStyle = {
                                position: 'absolute',
                                left: -5 * (i + 1) + 'px',
                                top: -5 * (i + 1) + 'px',
                                zIndex: String(-(i + 1)),
                                width: this.dragOffset.width + 'px',
                                height: this.dragOffset.height + 'px',
                                background: '#fff',
                                border: ['1px solid #5170ff', '1px solid var(--brand-1, #5170ff)']
                            };
                            Utils.addElStyles(stackNode, stackStyle);
                            node.appendChild(stackNode);
                        }
                    }
                    this.dragCloneNode = node;
                }
            }
            this.dragCloneNode.classList.add('drag-clone-node');
            if (!(this.dragPreviewDirective && this.dragPreviewDirective.dragPreviewTemplate)) {
                this.dragCloneNode.style.width = this.dragOffset.width + 'px';
                this.dragCloneNode.style.height = this.dragOffset.height + 'px';
            }
            this.dragCloneNode.style.position = 'fixed';
            this.dragCloneNode.style.zIndex = '1090';
            this.dragCloneNode.style.pointerEvents = 'none';
            this.dragCloneNode.style.top = this.dragOffset.top + 'px';
            this.dragCloneNode.style.left = this.dragOffset.left + 'px';
            this.dragCloneNode.style.willChange = 'left, top';
            this.dragItemContainer.appendChild(this.dragCloneNode);
            this.ngZone.runOutsideAngular(() => {
                setTimeout(() => {
                    if (this.draggedEl) {
                        this.draggedEl.style.display = 'none';
                        this.dragElShowHideEvent.next(false);
                        if (this.dragOriginPlaceholder) {
                            this.dragOriginPlaceholder.style.display = 'block';
                        }
                    }
                });
            });
        }
    }
    disableDraggedCloneNodeFollowMouse() {
        if (this.dragCloneNode) {
            this.document.removeEventListener('dragover', this.followMouse4CloneNode, { capture: true });
            this.dragItemContainer.removeChild(this.dragCloneNode);
            this.draggedEl.style.display = '';
            this.dragElShowHideEvent.next(true);
        }
        if (this.dragPreviewDirective && this.dragPreviewDirective.dragPreviewTemplate) {
            this.dragPreviewDirective.destroyPreview();
        }
        this.dragCloneNode = undefined;
        this.dragItemContainer = undefined;
        if (this.intersectionObserver) {
            this.intersectionObserver.disconnect();
        }
    }
    interceptChildNode(parentNode, childNodeList) {
        const interceptOptions = {
            root: parentNode
        };
        this.intersectionObserver = new IntersectionObserver(this.setChildNodeHide, interceptOptions);
        [].forEach.call(childNodeList, childNode => {
            this.intersectionObserver.observe(childNode);
        });
    }
    setChildNodeHide(entries) {
        entries.forEach(element => {
            const { isIntersecting, target: childNode } = element;
            if (isIntersecting) {
                childNode.style.display = 'block';
            }
            else {
                childNode.style.display = 'none';
            }
        });
    }
    getBatchDragData(identity, order = 'draggedElFirst') {
        const result = this.batchDragData.map(dragData => dragData.dragData);
        if (typeof order === 'function') {
            result.sort(order);
        }
        else if (order === 'draggedElFirst') {
            let dragData = this.dragData;
            if (identity) {
                const realDragData = this.batchDragData.filter(dd => dd.identity === identity).pop().dragData;
                dragData = realDragData;
            }
            result.splice(result.indexOf(dragData), 1);
            result.splice(0, 0, dragData);
        }
        return result;
    }
    /** usage:
     * constructor(..., private dragDropService: DragDropService) {}
     * cleanBatchDragData() { this.dragDropService.cleanBatchDragData(); }
     */
    cleanBatchDragData() {
        const batchDragData = this.batchDragData;
        if (this.batchDragData) {
            this.batchDragData
                .filter(dragData => dragData.draggable)
                .map(dragData => dragData.draggable)
                .forEach(draggable => { draggable.batchDraggable.dragData = undefined; });
            this.batchDragData = undefined;
            this.batchDragGroup = undefined;
        }
        return batchDragData;
    }
    copyStyle(source, target) {
        ['id', 'class', 'style', 'draggable'].forEach(function (att) {
            target.removeAttribute(att);
        });
        // copy style (without transitions)
        const computedStyle = getComputedStyle(source);
        for (let i = 0; i < computedStyle.length; i++) {
            const key = computedStyle[i];
            if (key.indexOf('transition') < 0) {
                target.style[key] = computedStyle[key];
            }
        }
        target.style.pointerEvents = 'none';
        // and repeat for all children
        for (let i = 0; i < source.children.length; i++) {
            this.copyStyle(source.children[i], target.children[i]);
        }
    }
}
DragDropService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DragDropService, deps: [{ token: i0.NgZone }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Injectable });
DragDropService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DragDropService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DragDropService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhZy1kcm9wLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9kZXZ1aS9kcmFnZHJvcC9zZXJ2aWNlcy9kcmFnLWRyb3Auc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNELE9BQU8sRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTdDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN4QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUNBQWlDLENBQUM7O0FBSWhFLE1BQU0sT0FBTyxlQUFlO0lBbUQxQixZQUFvQixNQUFjLEVBQTRCLEdBQVE7UUFBbEQsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUE0QixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBdEN0RSxnQkFBVyxHQUFHLEVBQUUsQ0FBQztRQUNqQixjQUFTLEdBQWlCLElBQUksT0FBTyxFQUFFLENBQUM7UUFDeEMsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1FBQ2xDLG1CQUFjLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQWdCcEMsaUJBQVksR0FBaUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNoRCxtQkFBYyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7UUFJN0IsdUJBQWtCLEdBQUcsRUFBRSxDQUFDO1FBQ3hCLHlCQUFvQixHQUFHLEVBQUUsQ0FBQztRQUMxQix5QkFBb0IsR0FBUSxJQUFJLENBQUM7UUFLakMsWUFBWTtRQUNaLHdCQUFtQixHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFvTDdDLDBCQUFxQixHQUFHLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDaEMsTUFBTSxFQUFFLFVB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QUFPLEVBQUUsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRztZQUN6RCxNQUFNLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzlCLENBQUMsQ0FBQyxDQUFDO1FBRUgsbUNBQW1DO1FBQ25DLE1BQU0sYUFBYSxHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9DLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzdDLE1BQU0sR0FBRyxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM3QixJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUNqQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN4QztTQUNGO1FBQ0QsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDO1FBQ3BDLDhCQUE4QjtRQUM5QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDL0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN4RDtJQUNILENBQUM7OzRHQTlSVSxlQUFlLHdDQW1Ea0IsUUFBUTtnSEFuRHpDLGVBQWU7MkZBQWYsZUFBZTtrQkFEM0IsVUFBVTs7MEJBb0Q0QixNQUFNOzJCQUFDLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBEcmFnUHJldmlld0RpcmVjdGl2ZSB9IGZyb20gJy4uL2RpcmVjdGl2ZXMvZHJhZy1wcmV2aWV3LmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBVdGlscyB9IGZyb20gJy4uL3NoYXJlZC91dGlscyc7XG5pbXBvcnQgeyBEcmFnRHJvcFRvdWNoIH0gZnJvbSAnLi4vdG91Y2gtc3VwcG9ydC9kcmFnZHJvcC10b3VjaCc7XG5pbXBvcnQgeyBEcmFnZ2FibGVEaXJlY3RpdmUgfSBmcm9tICcuLy4uL2RpcmVjdGl2ZXMvZHJhZ2dhYmxlLmRpcmVjdGl2ZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEcmFnRHJvcFNlcnZpY2Uge1xuICBkcmFnRGF0YTogYW55O1xuICBkcmFnZ2VkRWw6IGFueTtcbiAgZHJhZ2dlZEVsSWRlbnRpdHk6IGFueTtcbiAgYmF0Y2hEcmFnRGF0YTogQXJyYXk8e1xuICAgIGlkZW50aXR5PzogYW55O1xuICAgIGRyYWdnYWJsZTogRHJhZ2dhYmxlRGlyZWN0aXZlO1xuICAgIGRyYWdEYXRhOiBhbnk7XG4gIH0+O1xuICBiYXRjaERyYWdHcm91cDogc3RyaW5nO1xuICBiYXRjaERyYWdTdHlsZTogQXJyYXk8c3RyaW5nPjtcbiAgYmF0Y2hEcmFnZ2luZzogYm9vbGVhbjtcbiAgc2NvcGU6IHN0cmluZyB8IEFycmF5PHN0cmluZz47XG4gIGRyb3BUYXJnZXRzID0gW107XG4gIGRyb3BFdmVudDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3QoKTtcbiAgZHJhZ0VuZEV2ZW50ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICBkcmFnU3RhcnRFdmVudCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgZHJvcE9uSXRlbTogYm9vbGVhbjtcbiAgZHJhZ0ZvbGxvdzogYm9vbGVhbjtcbiAgZHJhZ0ZvbGxvd09wdGlvbnM6IHtcbiAgICBhcHBlbmRUb0JvZHk/OiBib29sZWFuO1xuICB9O1xuICBkcm9wT25PcmlnaW46IGJvb2xlYW47XG4gIGRyYWdnZWRFbEZvbGxvd2luZ01vdXNlOiBib29sZWFuO1xuICBkcmFnT2Zmc2V0OiB7XG4gICAgdG9wOiBudW1iZXI7XG4gICAgbGVmdDogbnVtYmVyO1xuICAgIG9mZnNldExlZnQ6IG51bWJlcjtcbiAgICBvZmZzZXRUb3A6IG51bWJlcjtcbiAgICB3aWR0aD86IG51bWJlcjtcbiAgICBoZWlnaHQ/OiBudW1iZXI7XG4gIH07XG4gIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuICBkcmFnRW1wdHlJbWFnZSA9IG5ldyBJbWFnZSgpO1xuICBkcmFnQ2xvbmVOb2RlOiBhbnk7XG4gIGRyYWdPcmlnaW5QbGFjZWhvbGRlcjogYW55O1xuICBkcmFnSXRlbUNvbnRhaW5lcjogYW55O1xuICBkcmFnSXRlbVBhcmVudE5hbWUgPSAnJztcbiAgZHJhZ0l0ZW1DaGlsZHJlbk5hbWUgPSAnJztcbiAgaW50ZXJzZWN0aW9uT2JzZXJ2ZXI6IGFueSA9IG51bGw7XG4gIHN1YjtcbiAgZHJhZ09yaWdpblBsYWNlaG9sZGVyTmV4dFNpYmxpbmc6IGFueTtcbiAgdG91Y2hJbnN0YW5jZTtcblxuICAvKiDljY/lkIzmi5bmi73pnIDopoEgKi9cbiAgZHJhZ0VsU2hvd0hpZGVFdmVudCA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG4gIGRyYWdTeW5jR3JvdXBEaXJlY3RpdmVzO1xuICAvKiDpooTop4jlip/og70gKi9cbiAgZHJhZ1ByZXZpZXdEaXJlY3RpdmU6IERyYWdQcmV2aWV3RGlyZWN0aXZlO1xuICBkb2N1bWVudDogRG9jdW1lbnQ7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSwgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2M6IGFueSkge1xuICAgIHRoaXMudG91Y2hJbnN0YW5jZSA9IERyYWdEcm9wVG91Y2guZ2V0SW5zdGFuY2UoKTtcbiAgICAvLyBzZXJ2aWNlIG5vdCBzdXBwb3J0IE9uSW5pdCwgb25seSBzdXBwb3J0IE9uRGVzdHJveSwgc28gd3JpdGUgaW4gY29uc3RydWN0b3JcbiAgICAvLyBzYWZhcmnnmoRpbWflv4XpobvopoHmnIlzcmNcbiAgICB0aGlzLmRyYWdFbXB0eUltYWdlLnNyY1xuICAgICAgPSAnZGF0YTppbWFnZS9naWY7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBRUFBQUFCQ0FZQUFBQWZGY1NKQUFBQURVbEVRVlFJbVdOZ1lHQmdBQUFBQlFBQmg2Rk8xQUFBQUFCSlJVNUVya0pnZ2c9PSc7XG4gICAgdGhpcy5kb2N1bWVudCA9IHRoaXMuZG9jO1xuICB9XG4gIG5ld1N1YnNjcmlwdGlvbigpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1yZXR1cm4tYXNzaWduXG4gICAgcmV0dXJuIHRoaXMuc3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuICB9XG5cbiAgZW5hYmxlRHJhZ2dlZENsb25lTm9kZUZvbGxvd01vdXNlKCkge1xuICAgIGlmICghdGhpcy5kcmFnQ2xvbmVOb2RlKSB7XG4gICAgICB0aGlzLmRyYWdJdGVtQ29udGFpbmVyID0gdGhpcy5kcmFnZ2VkRWwucGFyZW50RWxlbWVudDtcbiAgICAgIGlmICh0aGlzLmRyYWdQcmV2aWV3RGlyZWN0aXZlICYmIHRoaXMuZHJhZ1ByZXZpZXdEaXJlY3RpdmUuZHJhZ1ByZXZpZXdUZW1wbGF0ZSkge1xuICAgICAgICB0aGlzLmRyYWdQcmV2aWV3RGlyZWN0aXZlLmNyZWF0ZVByZXZpZXcoKTtcbiAgICAgICAgdGhpcy5kcmFnQ2xvbmVOb2RlID0gdGhpcy5kcmFnUHJldmlld0RpcmVjdGl2ZS5nZXRQcmV2aWV3RWxlbWVudCgpO1xuICAgICAgICB0aGlzLmRyYWdJdGVtQ29udGFpbmVyID0gdGhpcy5kb2N1bWVudC5ib2R5O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5kcmFnQ2xvbmVOb2RlID0gdGhpcy5kcmFnZ2VkRWwuY2xvbmVOb2RlKHRydWUpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmRyYWdDbG9uZU5vZGUuc3R5bGUubWFyZ2luID0gJzAnO1xuICAgICAgaWYgKHRoaXMuZHJhZ0ZvbGxvd09wdGlvbnMgJiYgdGhpcy5kcmFnRm9sbG93T3B0aW9ucy5hcHBlbmRUb0JvZHkpIHtcbiAgICAgICAgdGhpcy5kcmFnSXRlbUNvbnRhaW5lciA9IHRoaXMuZG9jdW1lbnQuYm9keTtcbiAgICAgICAgdGhpcy5jb3B5U3R5bGUodGhpcy5kcmFnZ2VkRWwsIHRoaXMuZHJhZ0Nsb25lTm9kZSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmRyYWdJdGVtQ2hpbGRyZW5OYW1lICE9PSAnJykge1xuICAgICAgICBjb25zdCBwYXJlbnRFbGVtZW50ID0gdGhpcy5kcmFnSXRlbVBhcmVudE5hbWUgPT09ICcnID8gdGhpcy5kcmFnQ2xvbmVOb2RlIDogdGhpcy5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKHRoaXMuZHJhZ0l0ZW1QYXJlbnROYW1lKTtcbiAgICAgICAgY29uc3QgZHJhZ0l0ZW1DaGlsZHJlbiA9IHBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCh0aGlzLmRyYWdJdGVtQ2hpbGRyZW5OYW1lKTtcbiAgICAgICAgdGhpcy5pbnRlcmNlcHRDaGlsZE5vZGUocGFyZW50RWxlbWVudCwgZHJhZ0l0ZW1DaGlsZHJlbik7XG4gICAgICB9XG4gICAgICAvLyDmi7fotJ1jYW52YXPnmoTlhoXlrrlcbiAgICAgIGNvbnN0IG9yaWdpbkNhbnZhc0FyciA9IHRoaXMuZHJhZ2dlZEVsLnF1ZXJ5U2VsZWN0b3JBbGwoJ2NhbnZhcycpO1xuICAgICAgY29uc3QgdGFyZ2V0Q2FudmFzQXJyID0gdGhpcy5kcmFnQ2xvbmVOb2RlLnF1ZXJ5U2VsZWN0b3JBbGwoJ2NhbnZhcycpO1xuICAgICAgW10uZm9yRWFjaC5jYWxsKHRhcmdldENhbnZhc0FyciwgKGNhbnZhcywgaW5kZXgpID0+IHtcbiAgICAgICAgY2FudmFzLmdldENvbnRleHQoJzJkJykuZHJhd0ltYWdlKG9yaWdpbkNhbnZhc0FycltpbmRleF0sIDAsIDApO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgdGhpcy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdkcmFnb3ZlcicsIHRoaXMuZm9sbG93TW91c2U0Q2xvbmVOb2RlLCB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWUgfSk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuZHJhZ0Nsb25lTm9kZS5zdHlsZS53aWR0aCA9IHRoaXMuZHJhZ09mZnNldC53aWR0aCArICdweCc7XG4gICAgICB0aGlzLmRyYWdDbG9uZU5vZGUuc3R5bGUuaGVpZ2h0ID0gdGhpcy5kcmFnT2Zmc2V0LmhlaWdodCArICdweCc7XG5cbiAgICAgIGlmICghKHRoaXMuZHJhZ1ByZXZpZXdEaXJlY3RpdmVcbiAgICAgICAgJiYgdGhpcy5kcmFnUHJldmlld0RpcmVjdGl2ZS5kcmFnUHJldmlld1RlbXBsYXRlXG4gICAgICAgICYmIHRoaXMuZHJhZ1ByZXZpZXdEaXJlY3RpdmUuZHJhZ1ByZXZpZXdPcHRpb25zXG4gICAgICAgICYmIHRoaXMuZHJhZ1ByZXZpZXdEaXJlY3RpdmUuZHJhZ1ByZXZpZXdPcHRpb25zLnNraXBCYXRjaFByZXZpZXcpKSB7XG4gICAgICAgIC8vIOaJuemHj+aLluaLveagt+W8j1xuICAgICAgICBpZiAodGhpcy5iYXRjaERyYWdnaW5nICYmIHRoaXMuYmF0Y2hEcmFnRGF0YSAmJiB0aGlzLmJhdGNoRHJhZ0RhdGEubGVuZ3RoID4gMSkge1xuICAgICAgICAgIC8vIOWIm+W7uuS4gOS4quiKgueCueWuueWZqFxuICAgICAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQodGhpcy5kcmFnQ2xvbmVOb2RlKTtcbiAgICAgICAgICBub2RlLmNsYXNzTGlzdC5hZGQoJ2JhdGNoLWRyYWdnZWQtbm9kZScpO1xuXG4gICAgICAgICAgLyog6K6h5pWw5qC35byP5a6a5L2NICovXG4gICAgICAgICAgaWYgKHRoaXMuYmF0Y2hEcmFnU3R5bGUgJiYgdGhpcy5iYXRjaERyYWdTdHlsZS5sZW5ndGggJiYgdGhpcy5iYXRjaERyYWdTdHlsZS5pbmRleE9mKCdiYWRnZScpID4gLTEpIHtcbiAgICAgICAgICAgIGNvbnN0IGJhZGdlID0gdGhpcy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgIGJhZGdlLmlubmVyVGV4dCA9IFN0cmluZyh0aGlzLmJhdGNoRHJhZ0RhdGEubGVuZ3RoKTtcbiAgICAgICAgICAgIGJhZGdlLmNsYXNzTGlzdC5hZGQoJ2JhdGNoLWRyYWdnZWQtbm9kZS1jb3VudCcpO1xuICAgICAgICAgICAgbm9kZS5zdHlsZS5wb3NpdGlvbiA9ICdyZWxhdGl2ZSc7XG4gICAgICAgICAgICBjb25zdCBzdHlsZSA9IHtcbiAgICAgICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsXG4gICAgICAgICAgICAgIHJpZ2h0OiAnNXB4JyxcbiAgICAgICAgICAgICAgdG9wOiAnLTEycHgnLFxuICAgICAgICAgICAgICBoZWlnaHQ6ICcyNHB4JyxcbiAgICAgICAgICAgICAgd2lkdGg6ICcyNHB4JyxcbiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAnMTJweCcsXG4gICAgICAgICAgICAgIGZvbnRTaXplOiAnMTRweCcsXG4gICAgICAgICAgICAgIGxpbmVIZWlnaHQ6ICcyNHB4JyxcbiAgICAgICAgICAgICAgdGV4dEFsaWduOiAnY2VudGVyJyxcbiAgICAgICAgICAgICAgY29sb3I6ICcjZmZmJyxcbiAgICAgICAgICAgICAgYmFja2dyb3VuZDogWycjNTE3MGZmJywgJ3ZhcigtLWJyYW5kLTEsICM1MTcwZmYpJ11cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBVdGlscy5hZGRFbFN0eWxlcyhiYWRnZSwgc3R5bGUpO1xuICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChiYWRnZSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLyog5bGC5Y+g5oSf5qC35byP5a6a5L2NICovXG4gICAgICAgICAgaWYgKHRoaXMuYmF0Y2hEcmFnU3R5bGUgJiYgdGhpcy5iYXRjaERyYWdTdHlsZS5sZW5ndGggJiYgdGhpcy5iYXRjaERyYWdTdHlsZS5pbmRleE9mKCdzdGFjaycpID4gLTEpIHtcbiAgICAgICAgICAgIGxldCBzdGFjayA9IDI7XG4gICAgICAgICAgICBpZiAodGhpcy5iYXRjaERyYWdEYXRhLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICBzdGFjayA9IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0YWNrOyBpKyspIHtcbiAgICAgICAgICAgICAgY29uc3Qgc3RhY2tOb2RlID0gdGhpcy5kcmFnQ2xvbmVOb2RlLmNsb25lTm9kZShmYWxzZSk7XG4gICAgICAgICAgICAgIGNvbnN0IHN0YWNrU3R5bGUgPSB7XG4gICAgICAgICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsXG4gICAgICAgICAgICAgICAgbGVmdDogLTUgKiAoaSArIDEpICsgJ3B4JyxcbiAgICAgICAgICAgICAgICB0b3A6IC01ICogKGkgKyAxKSArICdweCcsXG4gICAgICAgICAgICAgICAgekluZGV4OiBTdHJpbmcoLSAoaSArIDEpKSxcbiAgICAgICAgICAgICAgICB3aWR0aDogdGhpcy5kcmFnT2Zmc2V0LndpZHRoICsgJ3B4JyxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IHRoaXMuZHJhZ09mZnNldC5oZWlnaHQgKyAncHgnLFxuICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6ICcjZmZmJyxcbiAgICAgICAgICAgICAgICBib3JkZXI6IFsnMXB4IHNvbGlkICM1MTcwZmYnLCAnMXB4IHNvbGlkIHZhcigtLWJyYW5kLTEsICM1MTcwZmYpJ11cbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgVXRpbHMuYWRkRWxTdHlsZXMoc3RhY2tOb2RlLCBzdGFja1N0eWxlKTtcbiAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChzdGFja05vZGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLmRyYWdDbG9uZU5vZGUgPSBub2RlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZHJhZ0Nsb25lTm9kZS5jbGFzc0xpc3QuYWRkKCdkcmFnLWNsb25lLW5vZGUnKTtcbiAgICAgIGlmICghKHRoaXMuZHJhZ1ByZXZpZXdEaXJlY3RpdmUgJiYgdGhpcy5kcmFnUHJldmlld0RpcmVjdGl2ZS5kcmFnUHJldmlld1RlbXBsYXRlKSkge1xuICAgICAgICB0aGlzLmRyYWdDbG9uZU5vZGUuc3R5bGUud2lkdGggPSB0aGlzLmRyYWdPZmZzZXQud2lkdGggKyAncHgnO1xuICAgICAgICB0aGlzLmRyYWdDbG9uZU5vZGUuc3R5bGUuaGVpZ2h0ID0gdGhpcy5kcmFnT2Zmc2V0LmhlaWdodCArICdweCc7XG4gICAgICB9XG4gICAgICB0aGlzLmRyYWdDbG9uZU5vZGUuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnO1xuICAgICAgdGhpcy5kcmFnQ2xvbmVOb2RlLnN0eWxlLnpJbmRleCA9ICcxMDkwJztcbiAgICAgIHRoaXMuZHJhZ0Nsb25lTm9kZS5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ25vbmUnO1xuICAgICAgdGhpcy5kcmFnQ2xvbmVOb2RlLnN0eWxlLnRvcCA9IHRoaXMuZHJhZ09mZnNldC50b3AgKyAncHgnO1xuICAgICAgdGhpcy5kcmFnQ2xvbmVOb2RlLnN0eWxlLmxlZnQgPSB0aGlzLmRyYWdPZmZzZXQubGVmdCArICdweCc7XG4gICAgICB0aGlzLmRyYWdDbG9uZU5vZGUuc3R5bGUud2lsbENoYW5nZSA9ICdsZWZ0LCB0b3AnO1xuICAgICAgdGhpcy5kcmFnSXRlbUNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLmRyYWdDbG9uZU5vZGUpO1xuICAgICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5kcmFnZ2VkRWwpIHtcbiAgICAgICAgICAgIHRoaXMuZHJhZ2dlZEVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgICAgICB0aGlzLmRyYWdFbFNob3dIaWRlRXZlbnQubmV4dChmYWxzZSk7XG4gICAgICAgICAgICBpZiAodGhpcy5kcmFnT3JpZ2luUGxhY2Vob2xkZXIpIHtcbiAgICAgICAgICAgICAgdGhpcy5kcmFnT3JpZ2luUGxhY2Vob2xkZXIuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGRpc2FibGVEcmFnZ2VkQ2xvbmVOb2RlRm9sbG93TW91c2UoKSB7XG4gICAgaWYgKHRoaXMuZHJhZ0Nsb25lTm9kZSkge1xuICAgICAgdGhpcy5kb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdkcmFnb3ZlcicsIHRoaXMuZm9sbG93TW91c2U0Q2xvbmVOb2RlLCB7IGNhcHR1cmU6IHRydWUgfSk7XG4gICAgICB0aGlzLmRyYWdJdGVtQ29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuZHJhZ0Nsb25lTm9kZSk7XG4gICAgICB0aGlzLmRyYWdnZWRFbC5zdHlsZS5kaXNwbGF5ID0gJyc7XG4gICAgICB0aGlzLmRyYWdFbFNob3dIaWRlRXZlbnQubmV4dCh0cnVlKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuZHJhZ1ByZXZpZXdEaXJlY3RpdmUgJiYgdGhpcy5kcmFnUHJldmlld0RpcmVjdGl2ZS5kcmFnUHJldmlld1RlbXBsYXRlKSB7XG4gICAgICB0aGlzLmRyYWdQcmV2aWV3RGlyZWN0aXZlLmRlc3Ryb3lQcmV2aWV3KCk7XG4gICAgfVxuICAgIHRoaXMuZHJhZ0Nsb25lTm9kZSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmRyYWdJdGVtQ29udGFpbmVyID0gdW5kZWZpbmVkO1xuXG4gICAgaWYgKHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIpIHtcbiAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xuICAgIH1cbiAgfVxuXG4gIGludGVyY2VwdENoaWxkTm9kZShwYXJlbnROb2RlLCBjaGlsZE5vZGVMaXN0KSB7XG4gICAgY29uc3QgaW50ZXJjZXB0T3B0aW9ucyA9IHtcbiAgICAgIHJvb3Q6IHBhcmVudE5vZGVcbiAgICB9O1xuICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIodGhpcy5zZXRDaGlsZE5vZGVIaWRlLCBpbnRlcmNlcHRPcHRpb25zKTtcbiAgICBbXS5mb3JFYWNoLmNhbGwoY2hpbGROb2RlTGlzdCwgY2hpbGROb2RlID0+IHtcbiAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIub2JzZXJ2ZShjaGlsZE5vZGUpO1xuICAgIH0pO1xuICB9XG5cbiAgc2V0Q2hpbGROb2RlSGlkZShlbnRyaWVzKSB7XG4gICAgZW50cmllcy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgY29uc3QgeyBpc0ludGVyc2VjdGluZywgdGFyZ2V0OiBjaGlsZE5vZGUgfSA9IGVsZW1lbnQ7XG4gICAgICBpZiAoaXNJbnRlcnNlY3RpbmcpIHtcbiAgICAgICAgY2hpbGROb2RlLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2hpbGROb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBmb2xsb3dNb3VzZTRDbG9uZU5vZGUgPSAoZXZlbnQpID0+IHtcbiAgICBjb25zdCB7IG9mZnNldExlZnQsIG9mZnNldFRvcCB9ID0gdGhpcy5kcmFnT2Zmc2V0O1xuICAgIGNvbnN0IHsgY2xpZW50WCwgY2xpZW50WSB9ID0gZXZlbnQ7XG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIGlmICghdGhpcy5kcmFnQ2xvbmVOb2RlKSB7IHJldHVybjsgfVxuICAgICAgdGhpcy5kcmFnQ2xvbmVOb2RlLnN0eWxlLmxlZnQgPSBjbGllbnRYIC0gb2Zmc2V0TGVmdCArICdweCc7XG4gICAgICB0aGlzLmRyYWdDbG9uZU5vZGUuc3R5bGUudG9wID0gY2xpZW50WSAtIG9mZnNldFRvcCArICdweCc7XG4gICAgfSk7XG4gIH07XG5cbiAgZ2V0QmF0Y2hEcmFnRGF0YShpZGVudGl0eT8sIG9yZGVyOiAoKGE6IGFueSwgYjogYW55KSA9PiBudW1iZXIpIHwgJ3NlbGVjdCcgfCAnZHJhZ2dlZEVsRmlyc3QnID0gJ2RyYWdnZWRFbEZpcnN0Jykge1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuYmF0Y2hEcmFnRGF0YS5tYXAoZHJhZ0RhdGEgPT4gZHJhZ0RhdGEuZHJhZ0RhdGEpO1xuICAgIGlmICh0eXBlb2Ygb3JkZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHJlc3VsdC5zb3J0KDwoKGE6IGFueSwgYjogYW55KSA9PiBudW1iZXIpPm9yZGVyKTtcbiAgICB9IGVsc2UgaWYgKG9yZGVyID09PSAnZHJhZ2dlZEVsRmlyc3QnKSB7XG4gICAgICBsZXQgZHJhZ0RhdGEgPSB0aGlzLmRyYWdEYXRhO1xuICAgICAgaWYgKGlkZW50aXR5KSB7XG4gICAgICAgIGNvbnN0IHJlYWxEcmFnRGF0YSA9IHRoaXMuYmF0Y2hEcmFnRGF0YS5maWx0ZXIoZGQgPT4gZGQuaWRlbnRpdHkgPT09IGlkZW50aXR5KS5wb3AoKS5kcmFnRGF0YTtcbiAgICAgICAgZHJhZ0RhdGEgPSByZWFsRHJhZ0RhdGE7XG4gICAgICB9XG4gICAgICByZXN1bHQuc3BsaWNlKHJlc3VsdC5pbmRleE9mKGRyYWdEYXRhKSwgMSk7XG4gICAgICByZXN1bHQuc3BsaWNlKDAsIDAsIGRyYWdEYXRhKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKiB1c2FnZTpcbiAgICogY29uc3RydWN0b3IoLi4uLCBwcml2YXRlIGRyYWdEcm9wU2VydmljZTogRHJhZ0Ryb3BTZXJ2aWNlKSB7fVxuICAgKiBjbGVhbkJhdGNoRHJhZ0RhdGEoKSB7IHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLmNsZWFuQmF0Y2hEcmFnRGF0YSgpOyB9XG4gICAqL1xuICBwdWJsaWMgY2xlYW5CYXRjaERyYWdEYXRhKCkge1xuICAgIGNvbnN0IGJhdGNoRHJhZ0RhdGEgPSB0aGlzLmJhdGNoRHJhZ0RhdGE7XG4gICAgaWYgKHRoaXMuYmF0Y2hEcmFnRGF0YSkge1xuICAgICAgdGhpcy5iYXRjaERyYWdEYXRhXG4gICAgICAgIC5maWx0ZXIoZHJhZ0RhdGEgPT4gZHJhZ0RhdGEuZHJhZ2dhYmxlKVxuICAgICAgICAubWFwKGRyYWdEYXRhID0+IGRyYWdEYXRhLmRyYWdnYWJsZSlcbiAgICAgICAgLmZvckVhY2goZHJhZ2dhYmxlID0+IHtkcmFnZ2FibGUuYmF0Y2hEcmFnZ2FibGUuZHJhZ0RhdGEgPSB1bmRlZmluZWQ7fSk7XG4gICAgICB0aGlzLmJhdGNoRHJhZ0RhdGEgPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLmJhdGNoRHJhZ0dyb3VwID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICByZXR1cm4gYmF0Y2hEcmFnRGF0YTtcbiAgfVxuXG4gIHB1YmxpYyBjb3B5U3R5bGUoc291cmNlLCB0YXJnZXQpIHtcbiAgICBbJ2lkJywgJ2NsYXNzJywgJ3N0eWxlJywgJ2RyYWdnYWJsZSddLmZvckVhY2goZnVuY3Rpb24gKGF0dCkge1xuICAgICAgdGFyZ2V0LnJlbW92ZUF0dHJpYnV0ZShhdHQpO1xuICAgIH0pO1xuXG4gICAgLy8gY29weSBzdHlsZSAod2l0aG91dCB0cmFuc2l0aW9ucylcbiAgICBjb25zdCBjb21wdXRlZFN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZShzb3VyY2UpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29tcHV0ZWRTdHlsZS5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3Qga2V5ID0gY29tcHV0ZWRTdHlsZVtpXTtcbiAgICAgIGlmIChrZXkuaW5kZXhPZigndHJhbnNpdGlvbicpIDwgMCkge1xuICAgICAgICB0YXJnZXQuc3R5bGVba2V5XSA9IGNvbXB1dGVkU3R5bGVba2V5XTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGFyZ2V0LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnbm9uZSc7XG4gICAgLy8gYW5kIHJlcGVhdCBmb3IgYWxsIGNoaWxkcmVuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzb3VyY2UuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRoaXMuY29weVN0eWxlKHNvdXJjZS5jaGlsZHJlbltpXSwgdGFyZ2V0LmNoaWxkcmVuW2ldKTtcbiAgICB9XG4gIH1cblxufVxuIl19