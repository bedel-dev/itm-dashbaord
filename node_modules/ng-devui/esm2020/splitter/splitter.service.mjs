import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
export class SplitterService {
    constructor() {
        this.paneCount = 0;
        this.paneChangeSubject = new Subject();
    }
    // 配置pane信息，panes列表，方向，容器大小，方便后续计算使用
    configPane({ panes, orientation, containerSize }) {
        this.panes = panes;
        this.panes.forEach((pane, index) => {
            pane.order = index * 2;
            pane.orientation = orientation;
        });
        this.paneCount = this.panes.length;
        this.containerSize = containerSize;
    }
    // 按下的时候计算pane的size信息
    dragState(splitbarIndex) {
        const prev = this.getPane(splitbarIndex);
        const next = this.getPane(splitbarIndex + 1);
        const total = prev.computedSize + next.computedSize;
        return {
            prev: {
                index: splitbarIndex,
                initialSize: prev.computedSize,
                // 设置有最小值，直接取值，如果没有设置就用两个pane总和减去相邻pane的最大值，都没设置（NAN）在取0
                minSize: this.toPixels(prev.minSize) || total - this.toPixels(next.maxSize) || 0,
                // 设置有最大值，直接取值，如果没有设置就用两个pane总和减去相邻pane的最小值，都没设置（NAN）在取两个pane总和
                maxSize: this.toPixels(prev.maxSize) || total - this.toPixels(next.minSize) || total
            },
            next: {
                index: splitbarIndex + 1,
                initialSize: next.computedSize,
                minSize: this.toPixels(next.minSize) || total - this.toPixels(prev.maxSize) || 0,
                maxSize: this.toPixels(next.maxSize) || total - this.toPixels(prev.minSize) || total
            }
        };
    }
    // 设置pane大小
    setSize(state, distance) {
        const prev = this.getPane(state.prev.index);
        const next = this.getPane(state.next.index);
        if (prev.size && next.size) {
            // 相邻的两个pane都指定了size，需要同时修改size
            this.resize(state.prev, distance);
            this.resize(state.next, -distance);
        }
        else if (next.size) {
            // 如果 next pane，指定了size就修改next pane
            this.resize(state.next, -distance);
        }
        else {
            // 最后不管pre pane，有没有指定，都修改 pre pane
            this.resize(state.prev, distance);
        }
    }
    // 大小限制函数，（max）小于最小值时取最小值， （min）大于最大值时取最大值
    clamp(minSize, maxSize, initialSize) {
        return Math.min(maxSize, Math.max(minSize, initialSize));
    }
    // resize pane的大小
    resize(paneState, moveSize) {
        const pane = this.getPane(paneState.index);
        const splitterSize = this.containerSize();
        const newSize = this.clamp(paneState.minSize, paneState.maxSize, paneState.initialSize + moveSize);
        let size = '';
        if (this.isPercent(pane.size)) {
            size = (100 * newSize / splitterSize) + '%';
        }
        else {
            size = newSize + 'px';
        }
        pane.size = size;
        pane.sizeChange.emit(size);
    }
    // 判断pane是否可以调整大小，只要有一边设置了不可调整或者收起，相邻pane调整就失效
    isResizable(splitBarIndex) {
        const prevPane = this.getPane(splitBarIndex);
        const nextPane = this.getPane(splitBarIndex + 1);
        const paneCollapsed = prevPane.collapsed || nextPane.collapsed;
        return prevPane.resizable && nextPane.resizable && !paneCollapsed;
    }
    // 判断分割条是否是固定的，只要有一边不能调整, 就是禁用状态固定bar
    isStaticBar(splitBarIndex) {
        const prevPane = this.getPane(splitBarIndex);
        const nextPane = this.getPane(splitBarIndex + 1);
        return !(prevPane.resizable && nextPane.resizable);
    }
    // 获取pane，防止没有初始化的时候调用内部方法取值
    getPane(index) {
        if (!this.panes || index < 0 || index >= this.panes.length) {
            throw new Error('no pane can return.');
        }
        return this.panes[index];
    }
    // 判断是不是百分比设置宽度
    isPercent(size) {
        return /%$/.test(size);
    }
    // 计算时把百分比转换为像素
    toPixels(size) {
        // 值不满足转换时，result为NAN，方便计算最小、最大宽度判断
        let result = parseFloat(size);
        if (this.isPercent(size)) {
            result = (this.containerSize() * result / 100);
        }
        return result;
    }
    // 切换pane展开，收起
    togglePane(paneIndex, nearPaneIndex, lockStatus) {
        const pane = this.getPane(paneIndex);
        const nearPane = this.getPane(nearPaneIndex);
        if (pane.collapsible) {
            pane._collapsed = lockStatus ? pane._collapsed : !pane._collapsed;
            pane.toggleCollapseClass();
            nearPane.toggleNearPaneFlexGrow(pane._collapsed);
            pane.collapsedChange.emit(pane._collapsed);
        }
    }
}
SplitterService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SplitterService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
SplitterService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SplitterService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SplitterService, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BsaXR0ZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2RldnVpL3NwbGl0dGVyL3NwbGl0dGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDOztBQUkvQixNQUFNLE9BQU8sZUFBZTtJQUQ1QjtRQUlFLGNBQVMsR0FBRyxDQUFDLENBQUM7UUFDZCxzQkFBaUIsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0tBeUhuQztJQXhIQyxvQ0FBb0M7SUFDcEMsVUFBVSxDQUFDLEVBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUM7UUFDNUMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDakMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQ2pDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUNuQyxJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztJQUNyQyxDQUFDO0lBRUQscUJBQXFCO0lBQ3JCLFNBQVMsQ0FBQyxhQUFhO1FBQ3JCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDekMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDN0MsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxD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OzJGQUFmLGVBQWU7a0JBRDNCLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBTcGxpdHRlclBhbmVDb21wb25lbnQgfSBmcm9tICcuL3NwbGl0dGVyLXBhbmUuY29tcG9uZW50JztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNwbGl0dGVyU2VydmljZSB7XG4gIHBhbmVzOiBBcnJheTxTcGxpdHRlclBhbmVDb21wb25lbnQ+O1xuICBwcml2YXRlIGNvbnRhaW5lclNpemU6IEZ1bmN0aW9uO1xuICBwYW5lQ291bnQgPSAwO1xuICBwYW5lQ2hhbmdlU3ViamVjdCA9IG5ldyBTdWJqZWN0KCk7XG4gIC8vIOmFjee9rnBhbmXkv6Hmga/vvIxwYW5lc+WIl+ihqO+8jOaWueWQke+8jOWuueWZqOWkp+Wwj++8jOaWueS+v+WQjue7reiuoeeul+S9v+eUqFxuICBjb25maWdQYW5lKHtwYW5lcywgb3JpZW50YXRpb24sIGNvbnRhaW5lclNpemV9KSB7XG4gICAgdGhpcy5wYW5lcyA9IHBhbmVzO1xuICAgIHRoaXMucGFuZXMuZm9yRWFjaCgocGFuZSwgaW5kZXgpID0+IHtcbiAgICAgIHBhbmUub3JkZXIgPSBpbmRleCAqIDI7XG4gICAgICBwYW5lLm9yaWVudGF0aW9uID0gb3JpZW50YXRpb247XG4gICAgfSk7XG4gICAgdGhpcy5wYW5lQ291bnQgPSB0aGlzLnBhbmVzLmxlbmd0aDtcbiAgICB0aGlzLmNvbnRhaW5lclNpemUgPSBjb250YWluZXJTaXplO1xuICB9XG5cbiAgLy8g5oyJ5LiL55qE5pe25YCZ6K6h566XcGFuZeeahHNpemXkv6Hmga9cbiAgZHJhZ1N0YXRlKHNwbGl0YmFySW5kZXgpIHtcbiAgICBjb25zdCBwcmV2ID0gdGhpcy5nZXRQYW5lKHNwbGl0YmFySW5kZXgpO1xuICAgIGNvbnN0IG5leHQgPSB0aGlzLmdldFBhbmUoc3BsaXRiYXJJbmRleCArIDEpO1xuICAgIGNvbnN0IHRvdGFsID0gcHJldi5jb21wdXRlZFNpemUgKyBuZXh0LmNvbXB1dGVkU2l6ZTtcbiAgICByZXR1cm4ge1xuICAgICAgcHJldjoge1xuICAgICAgICBpbmRleDogc3BsaXRiYXJJbmRleCxcbiAgICAgICAgaW5pdGlhbFNpemU6IHByZXYuY29tcHV0ZWRTaXplLFxuICAgICAgICAvLyDorr7nva7mnInmnIDlsI/lgLzvvIznm7TmjqXlj5blgLzvvIzlpoLmnpzmsqHmnInorr7nva7lsLHnlKjkuKTkuKpwYW5l5oC75ZKM5YeP5Y6755u46YK7cGFuZeeahOacgOWkp+WAvO+8jOmDveayoeiuvue9ru+8iE5BTu+8ieWcqOWPljBcbiAgICAgICAgbWluU2l6ZTogdGhpcy50b1BpeGVscyhwcmV2Lm1pblNpemUpIHx8IHRvdGFsIC0gdGhpcy50b1BpeGVscyhuZXh0Lm1heFNpemUpIHx8IDAsXG4gICAgICAgIC8vIOiuvue9ruacieacgOWkp+WAvO+8jOebtOaOpeWPluWAvO+8jOWmguaenOayoeacieiuvue9ruWwseeUqOS4pOS4qnBhbmXmgLvlkozlh4/ljrvnm7jpgrtwYW5l55qE5pyA5bCP5YC877yM6YO95rKh6K6+572u77yITkFO77yJ5Zyo5Y+W5Lik5LiqcGFuZeaAu+WSjFxuICAgICAgICBtYXhTaXplOiB0aGlzLnRvUGl4ZWxzKHByZXYubWF4U2l6ZSkgfHwgdG90YWwgLSB0aGlzLnRvUGl4ZWxzKG5leHQubWluU2l6ZSkgfHwgdG90YWxcbiAgICAgIH0sXG4gICAgICBuZXh0OiB7XG4gICAgICAgIGluZGV4OiBzcGxpdGJhckluZGV4ICsgMSxcbiAgICAgICAgaW5pdGlhbFNpemU6IG5leHQuY29tcHV0ZWRTaXplLFxuICAgICAgICBtaW5TaXplOiB0aGlzLnRvUGl4ZWxzKG5leHQubWluU2l6ZSkgfHwgdG90YWwgLSB0aGlzLnRvUGl4ZWxzKHByZXYubWF4U2l6ZSkgfHwgMCxcbiAgICAgICAgbWF4U2l6ZTogdGhpcy50b1BpeGVscyhuZXh0Lm1heFNpemUpIHx8IHRvdGFsIC0gdGhpcy50b1BpeGVscyhwcmV2Lm1pblNpemUpIHx8IHRvdGFsXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8vIOiuvue9rnBhbmXlpKflsI9cbiAgc2V0U2l6ZShzdGF0ZSwgZGlzdGFuY2UpIHtcbiAgICBjb25zdCBwcmV2ID0gdGhpcy5nZXRQYW5lKHN0YXRlLnByZXYuaW5kZXgpO1xuICAgIGNvbnN0IG5leHQgPSB0aGlzLmdldFBhbmUoc3RhdGUubmV4dC5pbmRleCk7XG4gICAgaWYgKHByZXYuc2l6ZSAmJiBuZXh0LnNpemUpIHtcbiAgICAgIC8vIOebuOmCu+eahOS4pOS4qnBhbmXpg73mjIflrprkuoZzaXpl77yM6ZyA6KaB5ZCM5pe25L+u5pS5c2l6ZVxuICAgICAgdGhpcy5yZXNpemUoc3RhdGUucHJldiwgZGlzdGFuY2UpO1xuICAgICAgdGhpcy5yZXNpemUoc3RhdGUubmV4dCwgLWRpc3RhbmNlKTtcbiAgICB9IGVsc2UgaWYgKG5leHQuc2l6ZSkge1xuICAgICAgLy8g5aaC5p6cIG5leHQgcGFuZe+8jOaMh+WumuS6hnNpemXlsLHkv67mlLluZXh0IHBhbmVcbiAgICAgIHRoaXMucmVzaXplKHN0YXRlLm5leHQsIC1kaXN0YW5jZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOacgOWQjuS4jeeuoXByZSBwYW5l77yM5pyJ5rKh5pyJ5oyH5a6a77yM6YO95L+u5pS5IHByZSBwYW5lXG4gICAgICB0aGlzLnJlc2l6ZShzdGF0ZS5wcmV2LCBkaXN0YW5jZSk7XG4gICAgfVxuICB9XG5cbiAgLy8g5aSn5bCP6ZmQ5Yi25Ye95pWw77yM77yIbWF477yJ5bCP5LqO5pyA5bCP5YC85pe25Y+W5pyA5bCP5YC877yMIO+8iG1pbu+8ieWkp+S6juacgOWkp+WAvOaXtuWPluacgOWkp+WAvFxuICBjbGFtcChtaW5TaXplLCBtYXhTaXplLCBpbml0aWFsU2l6ZSkge1xuICAgIHJldHVybiBNYXRoLm1pbihtYXhTaXplLCBNYXRoLm1heChtaW5TaXplLCBpbml0aWFsU2l6ZSkpO1xuICB9XG5cbiAgLy8gcmVzaXplIHBhbmXnmoTlpKflsI9cbiAgcmVzaXplKHBhbmVTdGF0ZSwgbW92ZVNpemUpIHtcbiAgICBjb25zdCBwYW5lID0gdGhpcy5nZXRQYW5lKHBhbmVTdGF0ZS5pbmRleCk7XG4gICAgY29uc3Qgc3BsaXR0ZXJTaXplID0gdGhpcy5jb250YWluZXJTaXplKCk7XG4gICAgY29uc3QgbmV3U2l6ZSA9IHRoaXMuY2xhbXAocGFuZVN0YXRlLm1pblNpemUsIHBhbmVTdGF0ZS5tYXhTaXplLCBwYW5lU3RhdGUuaW5pdGlhbFNpemUgKyBtb3ZlU2l6ZSk7XG4gICAgbGV0IHNpemUgPSAnJztcbiAgICBpZiAodGhpcy5pc1BlcmNlbnQocGFuZS5zaXplKSkge1xuICAgICAgc2l6ZSA9ICgxMDAgKiBuZXdTaXplIC8gc3BsaXR0ZXJTaXplKSArICclJztcbiAgICB9IGVsc2Uge1xuICAgICAgc2l6ZSA9IG5ld1NpemUgKyAncHgnO1xuICAgIH1cbiAgICBwYW5lLnNpemUgPSBzaXplO1xuICAgIHBhbmUuc2l6ZUNoYW5nZS5lbWl0KHNpemUpO1xuICB9XG5cbiAgLy8g5Yik5patcGFuZeaYr+WQpuWPr+S7peiwg+aVtOWkp+Wwj++8jOWPquimgeacieS4gOi+ueiuvue9ruS6huS4jeWPr+iwg+aVtOaIluiAheaUtui1t++8jOebuOmCu3BhbmXosIPmlbTlsLHlpLHmlYhcbiAgaXNSZXNpemFibGUoc3BsaXRCYXJJbmRleCkge1xuICAgIGNvbnN0IHByZXZQYW5lID0gdGhpcy5nZXRQYW5lKHNwbGl0QmFySW5kZXgpO1xuICAgIGNvbnN0IG5leHRQYW5lID0gdGhpcy5nZXRQYW5lKHNwbGl0QmFySW5kZXggKyAxKTtcbiAgICBjb25zdCBwYW5lQ29sbGFwc2VkID0gcHJldlBhbmUuY29sbGFwc2VkIHx8IG5leHRQYW5lLmNvbGxhcHNlZDtcbiAgICByZXR1cm4gcHJldlBhbmUucmVzaXphYmxlICYmIG5leHRQYW5lLnJlc2l6YWJsZSAmJiAhcGFuZUNvbGxhcHNlZDtcbiAgfVxuXG4gIC8vIOWIpOaWreWIhuWJsuadoeaYr+WQpuaYr+WbuuWumueahO+8jOWPquimgeacieS4gOi+ueS4jeiDveiwg+aVtCwg5bCx5piv56aB55So54q25oCB5Zu65a6aYmFyXG4gIGlzU3RhdGljQmFyKHNwbGl0QmFySW5kZXgpIHtcbiAgICBjb25zdCBwcmV2UGFuZSA9IHRoaXMuZ2V0UGFuZShzcGxpdEJhckluZGV4KTtcbiAgICBjb25zdCBuZXh0UGFuZSA9IHRoaXMuZ2V0UGFuZShzcGxpdEJhckluZGV4ICsgMSk7XG4gICAgcmV0dXJuICEocHJldlBhbmUucmVzaXphYmxlICYmIG5leHRQYW5lLnJlc2l6YWJsZSk7XG4gIH1cblxuICAvLyDojrflj5ZwYW5l77yM6Ziy5q2i5rKh5pyJ5Yid5aeL5YyW55qE5pe25YCZ6LCD55So5YaF6YOo5pa55rOV5Y+W5YC8XG4gIGdldFBhbmUoaW5kZXgpIHtcbiAgICBpZiAoIXRoaXMucGFuZXMgfHwgaW5kZXggPCAwIHx8IGluZGV4ID49IHRoaXMucGFuZXMubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vIHBhbmUgY2FuIHJldHVybi4nKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucGFuZXNbaW5kZXhdO1xuICB9XG5cbiAgLy8g5Yik5pat5piv5LiN5piv55m+5YiG5q+U6K6+572u5a695bqmXG4gIGlzUGVyY2VudChzaXplKSB7XG4gICAgcmV0dXJuIC8lJC8udGVzdChzaXplKTtcbiAgfVxuXG4gIC8vIOiuoeeul+aXtuaKiueZvuWIhuavlOi9rOaNouS4uuWDj+e0oFxuICB0b1BpeGVscyhzaXplKSB7XG4gICAgLy8g5YC85LiN5ruh6Laz6L2s5o2i5pe277yMcmVzdWx05Li6TkFO77yM5pa55L6/6K6h566X5pyA5bCP44CB5pyA5aSn5a695bqm5Yik5patXG4gICAgbGV0IHJlc3VsdCA9IHBhcnNlRmxvYXQoc2l6ZSk7XG4gICAgaWYgKHRoaXMuaXNQZXJjZW50KHNpemUpKSB7XG4gICAgICByZXN1bHQgPSAodGhpcy5jb250YWluZXJTaXplKCkgKiByZXN1bHQgLyAxMDApO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLy8g5YiH5o2icGFuZeWxleW8gO+8jOaUtui1t1xuICB0b2dnbGVQYW5lKHBhbmVJbmRleCwgbmVhclBhbmVJbmRleCwgbG9ja1N0YXR1cz8pIHtcbiAgICBjb25zdCBwYW5lID0gdGhpcy5nZXRQYW5lKHBhbmVJbmRleCk7XG4gICAgY29uc3QgbmVhclBhbmUgPSB0aGlzLmdldFBhbmUobmVhclBhbmVJbmRleCk7XG4gICAgaWYgKHBhbmUuY29sbGFwc2libGUpIHtcbiAgICAgIHBhbmUuX2NvbGxhcHNlZCA9IGxvY2tTdGF0dXMgPyBwYW5lLl9jb2xsYXBzZWQgOiAhcGFuZS5fY29sbGFwc2VkO1xuICAgICAgcGFuZS50b2dnbGVDb2xsYXBzZUNsYXNzKCk7XG4gICAgICBuZWFyUGFuZS50b2dnbGVOZWFyUGFuZUZsZXhHcm93KHBhbmUuX2NvbGxhcHNlZCk7XG4gICAgICBwYW5lLmNvbGxhcHNlZENoYW5nZS5lbWl0KHBhbmUuX2NvbGxhcHNlZCk7XG4gICAgfVxuICB9XG59XG4iXX0=