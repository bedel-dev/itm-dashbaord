import { UploadStatus } from './file-uploader.types';
export class FileUploader {
    constructor(file, uploadOptions) {
        this.file = file;
        this.uploadOptions = uploadOptions;
        this.percentage = 0;
        this.file = file;
        this.uploadOptions = uploadOptions;
        this.status = UploadStatus.preLoad;
    }
    sendCommonHandle(uploadFiles) {
        const { uri, method, headers, authToken, authTokenHeader, additionalParameter, fileFieldName, withCredentials, responseType } = this.uploadOptions;
        const authTokenHeader_ = authTokenHeader || 'Authorization';
        const fileFieldName_ = fileFieldName || 'file';
        this.xhr = new XMLHttpRequest();
        this.xhr.open(method || 'POST', uri);
        if (withCredentials) {
            this.xhr.withCredentials = withCredentials;
        }
        if (responseType) {
            this.xhr.responseType = responseType;
        }
        if (authToken) {
            this.xhr.setRequestHeader(authTokenHeader_, authToken);
        }
        if (headers) {
            Object.keys(headers).forEach((key) => {
                this.xhr.setRequestHeader(key, headers[key]);
            });
        }
        this.xhr.upload.onprogress = e => {
            this.percentage = Math.round(e.loaded * 100 / e.total);
        };
        const formData = uploadFiles && uploadFiles.length ?
            this.oneTimeUploadFiles(fileFieldName_, additionalParameter, uploadFiles) :
            this.parallelUploadFiles(fileFieldName_, additionalParameter);
        this.xhr.send(formData);
        this.status = UploadStatus.uploading;
        this.xhr.onabort = () => {
            this.status = UploadStatus.preLoad;
            this.xhr = null;
        };
    }
    sendErrorAndLoadHandle(resolve, reject, isMultiple = false) {
        this.xhr.onerror = () => {
            this.response = this.xhr.response;
            this.status = UploadStatus.failed;
            if (isMultiple) {
                reject({ file: this.file, response: this.xhr.response, status: UploadStatus.failed });
            }
            else {
                reject({ file: this.file, response: this.xhr.response });
            }
        };
        this.xhr.onload = () => {
            if (this.xhr.readyState === 4 && this.xhr.status >= 200 && this.xhr.status < 300) {
                this.response = this.xhr.response;
                this.status = UploadStatus.uploaded;
                if (isMultiple) {
                    resolve({ file: this.file, response: this.xhr.response, status: UploadStatus.uploaded });
                }
                else {
                    resolve({ file: this.file, response: this.xhr.response });
                }
            }
            else {
                this.response = this.xhr.response;
                this.status = UploadStatus.failed;
                if (isMultiple) {
                    reject({ file: this.file, response: this.xhr.response, status: UploadStatus.failed });
                }
                else {
                    reject({ file: this.file, response: this.xhr.response });
                }
            }
        };
    }
    send(uploadFiles) {
        return new Promise((resolve, reject) => {
            this.sendCommonHandle(uploadFiles);
            this.sendErrorAndLoadHandle(resolve, reject);
        });
    }
    sendMultiple(uploadFiles) {
        return new Promise((resolve, reject) => {
            this.sendCommonHandle(uploadFiles);
            this.sendErrorAndLoadHandle(resolve, reject, true);
        });
    }
    parallelUploadFiles(fileFieldName_, additionalParameter) {
        const formData = new FormData();
        formData.append(fileFieldName_, this.file, this.file.name);
        if (additionalParameter) {
            Object.keys(additionalParameter).forEach((key) => {
                formData.append(key, additionalParameter[key]);
            });
        }
        return formData;
    }
    oneTimeUploadFiles(fileFieldName_, additionalParameter, uploadFiles) {
        const formData = new FormData();
        uploadFiles.forEach(element => {
            formData.append(fileFieldName_, element.file, element.file.name);
            if (additionalParameter) {
                Object.keys(additionalParameter).forEach((key) => {
                    formData.append(key, additionalParameter[key]);
                });
            }
        });
        return formData;
    }
    cancel() {
        if (this.xhr) {
            this.xhr.abort();
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS11cGxvYWRlci5jbGFzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2RldnVpL3VwbG9hZC9maWxlLXVwbG9hZGVyLmNsYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxZQUFZLEVBQ2IsTUFBTSx1QkFBdUIsQ0FBQztBQUUvQixNQUFNLE9BQU8sWUFBWTtJQU12QixZQUFtQixJQUFVLEVBQ1YsYUFBNkI7UUFEN0IsU0FBSSxHQUFKLElBQUksQ0FBTTtRQUNWLGtCQUFhLEdBQWIsYUFBYSxDQUFnQjtRQUh6QyxlQUFVLEdBQUcsQ0FBQyxDQUFDO1FBSXBCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBYSxDQUFDO1FBQ25DLElBQUksQ0FBQyxNQUFNLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQztJQUNyQyxDQUFDO0lBRU8sZ0JBQWdCLENBQUMsV0FBWTtRQUNuQyxNQUFNLEVBQ0osR0FBRyxFQUNILE1BQU0sRUFDTixPQUFPLEVBQ1AsU0FBUyxFQUNULGVBQWUsRUFDZixtQkFBbUIsRUFDbkIsYUFBYSxFQUNiLGVBQWUsRUFDZixZQUFZLEVBQ2IsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQ3ZCLE1BQU0sZ0JBQWdCLEdBQUcsZUFBZSxJQUFJLGVBQWUsQ0FBQztRQUM1RCxNQUFNLGNBQWMsR0FBRyxhQUFhLElBQUksTUFBTSxDQUFDO1FBRS9DLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztRQUNoQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRXJDLElBQUksZUFBZSxFQUFFO1lBQ25CLElBQUksQ0FBQyxHQUFHLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztTQUM1QztRQUVELElBQUksWUFBWSxFQUFFO1lBQ2hCLElB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QUFDO2FBQ0o7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFTSxNQUFNO1FBQ1gsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1osSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUNsQjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIElVcGxvYWRPcHRpb25zLFxuICBVcGxvYWRTdGF0dXNcbn0gZnJvbSAnLi9maWxlLXVwbG9hZGVyLnR5cGVzJztcblxuZXhwb3J0IGNsYXNzIEZpbGVVcGxvYWRlciB7XG4gIHByaXZhdGUgeGhyOiBYTUxIdHRwUmVxdWVzdDtcbiAgcHVibGljIHN0YXR1czogVXBsb2FkU3RhdHVzO1xuICBwdWJsaWMgcmVzcG9uc2U6IGFueTtcbiAgcHVibGljIHBlcmNlbnRhZ2UgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBmaWxlOiBGaWxlLFxuICAgICAgICAgICAgICBwdWJsaWMgdXBsb2FkT3B0aW9uczogSVVwbG9hZE9wdGlvbnMpIHtcbiAgICB0aGlzLmZpbGUgPSBmaWxlO1xuICAgIHRoaXMudXBsb2FkT3B0aW9ucyA9IHVwbG9hZE9wdGlvbnM7XG4gICAgdGhpcy5zdGF0dXMgPSBVcGxvYWRTdGF0dXMucHJlTG9hZDtcbiAgfVxuXG4gIHByaXZhdGUgc2VuZENvbW1vbkhhbmRsZSh1cGxvYWRGaWxlcz8pIHtcbiAgICBjb25zdCB7XG4gICAgICB1cmksXG4gICAgICBtZXRob2QsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYXV0aFRva2VuLFxuICAgICAgYXV0aFRva2VuSGVhZGVyLFxuICAgICAgYWRkaXRpb25hbFBhcmFtZXRlcixcbiAgICAgIGZpbGVGaWVsZE5hbWUsXG4gICAgICB3aXRoQ3JlZGVudGlhbHMsXG4gICAgICByZXNwb25zZVR5cGVcbiAgICB9ID0gdGhpcy51cGxvYWRPcHRpb25zO1xuICAgIGNvbnN0IGF1dGhUb2tlbkhlYWRlcl8gPSBhdXRoVG9rZW5IZWFkZXIgfHwgJ0F1dGhvcml6YXRpb24nO1xuICAgIGNvbnN0IGZpbGVGaWVsZE5hbWVfID0gZmlsZUZpZWxkTmFtZSB8fCAnZmlsZSc7XG5cbiAgICB0aGlzLnhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgIHRoaXMueGhyLm9wZW4obWV0aG9kIHx8ICdQT1NUJywgdXJpKTtcblxuICAgIGlmICh3aXRoQ3JlZGVudGlhbHMpIHtcbiAgICAgIHRoaXMueGhyLndpdGhDcmVkZW50aWFscyA9IHdpdGhDcmVkZW50aWFscztcbiAgICB9XG5cbiAgICBpZiAocmVzcG9uc2VUeXBlKSB7XG4gICAgICB0aGlzLnhoci5yZXNwb25zZVR5cGUgPSByZXNwb25zZVR5cGU7XG4gICAgfVxuXG4gICAgaWYgKGF1dGhUb2tlbikge1xuICAgICAgdGhpcy54aHIuc2V0UmVxdWVzdEhlYWRlcihhdXRoVG9rZW5IZWFkZXJfLCBhdXRoVG9rZW4pO1xuICAgIH1cblxuICAgIGlmIChoZWFkZXJzKSB7XG4gICAgICBPYmplY3Qua2V5cyhoZWFkZXJzKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgdGhpcy54aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIGhlYWRlcnNba2V5XSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLnhoci51cGxvYWQub25wcm9ncmVzcyA9IGUgPT4ge1xuICAgICAgdGhpcy5wZXJjZW50YWdlID0gTWF0aC5yb3VuZChlLmxvYWRlZCAqIDEwMCAvIGUudG90YWwpO1xuICAgIH07XG5cbiAgICBjb25zdCBmb3JtRGF0YSA9IHVwbG9hZEZpbGVzICYmIHVwbG9hZEZpbGVzLmxlbmd0aCA/XG4gICAgICB0aGlzLm9uZVRpbWVVcGxvYWRGaWxlcyhmaWxlRmllbGROYW1lXywgYWRkaXRpb25hbFBhcmFtZXRlciwgdXBsb2FkRmlsZXMpIDpcbiAgICAgIHRoaXMucGFyYWxsZWxVcGxvYWRGaWxlcyhmaWxlRmllbGROYW1lXywgYWRkaXRpb25hbFBhcmFtZXRlcik7XG5cbiAgICB0aGlzLnhoci5zZW5kKGZvcm1EYXRhKTtcbiAgICB0aGlzLnN0YXR1cyA9IFVwbG9hZFN0YXR1cy51cGxvYWRpbmc7XG5cbiAgICB0aGlzLnhoci5vbmFib3J0ID0gKCkgPT4ge1xuICAgICAgdGhpcy5zdGF0dXMgPSBVcGxvYWRTdGF0dXMucHJlTG9hZDtcbiAgICAgIHRoaXMueGhyID0gbnVsbDtcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBzZW5kRXJyb3JBbmRMb2FkSGFuZGxlKHJlc29sdmUsIHJlamVjdCwgaXNNdWx0aXBsZT1mYWxzZSkge1xuICAgIHRoaXMueGhyLm9uZXJyb3IgPSAoKSA9PiB7XG4gICAgICB0aGlzLnJlc3BvbnNlID0gdGhpcy54aHIucmVzcG9uc2U7XG4gICAgICB0aGlzLnN0YXR1cyA9IFVwbG9hZFN0YXR1cy5mYWlsZWQ7XG4gICAgICBpZiAoaXNNdWx0aXBsZSkge1xuICAgICAgICByZWplY3QoeyBmaWxlOiB0aGlzLmZpbGUsIHJlc3BvbnNlOiB0aGlzLnhoci5yZXNwb25zZSwgc3RhdHVzOiBVcGxvYWRTdGF0dXMuZmFpbGVkIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVqZWN0KHsgZmlsZTogdGhpcy5maWxlLCByZXNwb25zZTogdGhpcy54aHIucmVzcG9uc2UgfSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMueGhyLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgIGlmICh0aGlzLnhoci5yZWFkeVN0YXRlID09PSA0ICYmIHRoaXMueGhyLnN0YXR1cyA+PSAyMDAgJiYgdGhpcy54aHIuc3RhdHVzIDwgMzAwKSB7XG4gICAgICAgIHRoaXMucmVzcG9uc2UgPSB0aGlzLnhoci5yZXNwb25zZTtcbiAgICAgICAgdGhpcy5zdGF0dXMgPSBVcGxvYWRTdGF0dXMudXBsb2FkZWQ7XG4gICAgICAgIGlmIChpc011bHRpcGxlKSB7XG4gICAgICAgICAgcmVzb2x2ZSh7IGZpbGU6IHRoaXMuZmlsZSwgcmVzcG9uc2U6IHRoaXMueGhyLnJlc3BvbnNlLCBzdGF0dXM6IFVwbG9hZFN0YXR1cy51cGxvYWRlZCB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNvbHZlKHsgZmlsZTogdGhpcy5maWxlLCByZXNwb25zZTogdGhpcy54aHIucmVzcG9uc2UgfSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucmVzcG9uc2UgPSB0aGlzLnhoci5yZXNwb25zZTtcbiAgICAgICAgdGhpcy5zdGF0dXMgPSBVcGxvYWRTdGF0dXMuZmFpbGVkO1xuICAgICAgICBpZihpc011bHRpcGxlKSB7XG4gICAgICAgICAgcmVqZWN0KHsgZmlsZTogdGhpcy5maWxlLCByZXNwb25zZTogdGhpcy54aHIucmVzcG9uc2UsIHN0YXR1czogVXBsb2FkU3RhdHVzLmZhaWxlZCB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZWplY3QoeyBmaWxlOiB0aGlzLmZpbGUsIHJlc3BvbnNlOiB0aGlzLnhoci5yZXNwb25zZSB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgc2VuZCh1cGxvYWRGaWxlcz8pOiBQcm9taXNlPHsgZmlsZTogRmlsZTsgcmVzcG9uc2U6IGFueSB9PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuc2VuZENvbW1vbkhhbmRsZSh1cGxvYWRGaWxlcyk7XG5cbiAgICAgIHRoaXMuc2VuZEVycm9yQW5kTG9hZEhhbmRsZShyZXNvbHZlLCByZWplY3QpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHNlbmRNdWx0aXBsZSh1cGxvYWRGaWxlcz8pOiBQcm9taXNlPHsgZmlsZTogRmlsZTsgcmVzcG9uc2U6IGFueTsgc3RhdHVzOiBVcGxvYWRTdGF0dXMgfT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnNlbmRDb21tb25IYW5kbGUodXBsb2FkRmlsZXMpO1xuXG4gICAgICB0aGlzLnNlbmRFcnJvckFuZExvYWRIYW5kbGUocmVzb2x2ZSwgcmVqZWN0LCB0cnVlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBwYXJhbGxlbFVwbG9hZEZpbGVzKGZpbGVGaWVsZE5hbWVfLCBhZGRpdGlvbmFsUGFyYW1ldGVyKSB7XG4gICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICBmb3JtRGF0YS5hcHBlbmQoZmlsZUZpZWxkTmFtZV8sIHRoaXMuZmlsZSwgdGhpcy5maWxlLm5hbWUpO1xuICAgIGlmIChhZGRpdGlvbmFsUGFyYW1ldGVyKSB7XG4gICAgICBPYmplY3Qua2V5cyhhZGRpdGlvbmFsUGFyYW1ldGVyKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoa2V5LCBhZGRpdGlvbmFsUGFyYW1ldGVyW2tleV0pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBmb3JtRGF0YTtcbiAgfVxuXG4gIHB1YmxpYyBvbmVUaW1lVXBsb2FkRmlsZXMoZmlsZUZpZWxkTmFtZV8sIGFkZGl0aW9uYWxQYXJhbWV0ZXIsIHVwbG9hZEZpbGVzKSB7XG4gICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICB1cGxvYWRGaWxlcy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgZm9ybURhdGEuYXBwZW5kKGZpbGVGaWVsZE5hbWVfLCBlbGVtZW50LmZpbGUsIGVsZW1lbnQuZmlsZS5uYW1lKTtcbiAgICAgIGlmIChhZGRpdGlvbmFsUGFyYW1ldGVyKSB7XG4gICAgICAgIE9iamVjdC5rZXlzKGFkZGl0aW9uYWxQYXJhbWV0ZXIpLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgZm9ybURhdGEuYXBwZW5kKGtleSwgYWRkaXRpb25hbFBhcmFtZXRlcltrZXldKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGZvcm1EYXRhO1xuICB9XG5cbiAgcHVibGljIGNhbmNlbCgpIHtcbiAgICBpZiAodGhpcy54aHIpIHtcbiAgICAgIHRoaXMueGhyLmFib3J0KCk7XG4gICAgfVxuICB9XG59XG4iXX0=