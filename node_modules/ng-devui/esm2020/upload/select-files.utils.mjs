import { DOCUMENT } from '@angular/common';
import { Inject, Injectable } from '@angular/core';
import { I18nService } from 'ng-devui/i18n';
import { from, Observable } from 'rxjs';
import { mergeMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "ng-devui/i18n";
export class SelectFiles {
    constructor(i18n, doc) {
        this.i18n = i18n;
        this.doc = doc;
        this.selectFiles = ({ multiple, accept, webkitdirectory }) => {
            return new Promise((resolve) => {
                const tempNode = this.document.getElementById('d-upload-temp');
                if (tempNode) {
                    this.document.body.removeChild(tempNode);
                }
                const input = this.document.createElement('input');
                input.style.position = 'fixed';
                input.style.left = '-2000px';
                input.style.top = '-2000px';
                input.setAttribute('id', 'd-upload-temp');
                input.setAttribute('type', 'file');
                if (multiple) {
                    input.setAttribute('multiple', '');
                }
                if (accept) {
                    input.setAttribute('accept', accept);
                }
                if (webkitdirectory) {
                    input.setAttribute('webkitdirectory', '');
                }
                input.addEventListener('change', event => {
                    resolve(Array.prototype.slice.call(event.target.files));
                });
                this.document.body.appendChild(input); // Fix compatibility issue with Internet Explorer 11
                this.simulateClickEvent(input);
            });
        };
        this.isAllowedFileType = (accept, file) => {
            if (accept) {
                const acceptArr = accept.split(',');
                const baseMimeType = file.type.replace(/\/.*$/, '');
                return acceptArr.some((type) => {
                    const validType = type.trim();
                    //  suffix name (e.g. '.png,.xlsx')
                    if (validType.startsWith('.')) {
                        return (file.name.toLowerCase().indexOf(validType.toLowerCase(), file.name.toLowerCase().length - validType.toLowerCase().length) > -1);
                        // mime type like 'image/*'
                    }
                    else if (/\/\*$/.test(validType)) {
                        return baseMimeType === validType.replace(/\/.*$/, '');
                    }
                    //  mime type like 'text/plain,application/json'
                    return file.type === validType;
                });
            }
            return true;
        };
        this.beyondMaximalSize = (fileSize, maximumSize) => {
            if (maximumSize) {
                return fileSize > 1024 * 1024 * maximumSize;
            }
            return false;
        };
        this.beyondAllFilesMaximalSize = (fileSize, maximumSize) => {
            if (maximumSize) {
                return fileSize > 1024 * 1024 * maximumSize;
            }
            return false;
        };
        this.triggerSelectFiles = (fileOptions, uploadOptions) => {
            const { multiple, accept, webkitdirectory } = fileOptions;
            return from(this.selectFiles({ multiple, accept, webkitdirectory })).pipe(mergeMap(file => file));
        };
        this.triggerDropFiles = (fileOptions, uploadOptions, files) => {
            return new Observable(observer => observer.next(files)).pipe(mergeMap(file => file));
        };
        this.document = this.doc;
        this.i18nText = this.i18n.getI18nText().upload;
        this.i18nSubscription = this.i18n.langChange().subscribe((data) => {
            this.i18nText = data.upload;
        });
    }
    checkAllFilesSize(fileSize, maximumSize) {
        if (this.beyondMaximalSize(fileSize, maximumSize)) {
            this.BEYOND_MAXIMAL_FILE_SIZE_MSG = this.i18nText.getAllFilesBeyondMaximalFileSizeMsg(maximumSize);
            return { checkError: true, errorMsg: this.BEYOND_MAXIMAL_FILE_SIZE_MSG };
        }
    }
    _validateFiles(file, accept, uploadOptions) {
        if (!this.isAllowedFileType(accept, file)) {
            this.NOT_ALLOWED_FILE_TYPE_MSG = this.i18nText.getNotAllowedFileTypeMsg(file.name, accept);
            return { checkError: true, errorMsg: this.NOT_ALLOWED_FILE_TYPE_MSG };
        }
        if (this.beyondMaximalSize(file.size, uploadOptions.maximumSize)) {
            this.BEYOND_MAXIMAL_FILE_SIZE_MSG = this.i18nText.getBeyondMaximalFileSizeMsg(file.name, uploadOptions.maximumSize);
            return { checkError: true, errorMsg: this.BEYOND_MAXIMAL_FILE_SIZE_MSG };
        }
        return { checkError: false, errorMsg: undefined };
    }
    simulateClickEvent(input) {
        const evt = this.document.createEvent('MouseEvents');
        evt.initMouseEvent('click', true, true, window, 1, 0, 0, 0, 0, false, false, false, false, 0, null);
        input.dispatchEvent(evt);
    }
}
SelectFiles.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SelectFiles, deps: [{ token: i1.I18nService }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Injectable });
SelectFiles.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SelectFiles });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SelectFiles, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.I18nService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LWZpbGVzLnV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vZGV2dWkvdXBsb2FkL3NlbGVjdC1maWxlcy51dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFpQixXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0QsT0FBTyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7O0FBSTFDLE1BQU0sT0FBTyxXQUFXO0lBT3RCLFlBQW9CLElBQWlCLEVBQTRCLEdBQVE7UUFBckQsU0FBSSxHQUFKLElBQUksQ0FBYTtRQUE0QixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBUXpFLGdCQUFXLEdBQUcsQ0FBQyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsZUFBZSxFQUFnQixFQUFtQixFQUFFO1lBQ3JGLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDN0IsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLENBQUM7Z0JBQy9ELElBQUksUUFBUSxFQUFFO29CQUNaLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztpQkFDMUM7Z0JBQ0QsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBRW5ELEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztnQkFDL0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsU0FB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QUFHLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDcEcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMzQixDQUFDOzt3R0FySFUsV0FBVyw2Q0FPeUIsUUFBUTs0R0FQNUMsV0FBVzsyRkFBWCxXQUFXO2tCQUR2QixVQUFVOzswQkFRK0IsTUFBTTsyQkFBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJMThuSW50ZXJmYWNlLCBJMThuU2VydmljZSB9IGZyb20gJ25nLWRldnVpL2kxOG4nO1xuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtZXJnZU1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IElGaWxlT3B0aW9ucywgSVVwbG9hZE9wdGlvbnMgfSBmcm9tICcuL2ZpbGUtdXBsb2FkZXIudHlwZXMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU2VsZWN0RmlsZXMge1xuICBOT1RfQUxMT1dFRF9GSUxFX1RZUEVfTVNHOiBzdHJpbmc7XG4gIEJFWU9ORF9NQVhJTUFMX0ZJTEVfU0laRV9NU0c6IHN0cmluZztcbiAgaTE4blRleHQ6IEkxOG5JbnRlcmZhY2VbJ3VwbG9hZCddO1xuICBpMThuU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIGRvY3VtZW50OiBEb2N1bWVudDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGkxOG46IEkxOG5TZXJ2aWNlLCBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIGRvYzogYW55KSB7XG4gICAgdGhpcy5kb2N1bWVudCA9IHRoaXMuZG9jO1xuICAgIHRoaXMuaTE4blRleHQgPSB0aGlzLmkxOG4uZ2V0STE4blRleHQoKS51cGxvYWQ7XG4gICAgdGhpcy5pMThuU3Vic2NyaXB0aW9uID0gdGhpcy5pMThuLmxhbmdDaGFuZ2UoKS5zdWJzY3JpYmUoKGRhdGEpID0+IHtcbiAgICAgIHRoaXMuaTE4blRleHQgPSBkYXRhLnVwbG9hZDtcbiAgICB9KTtcbiAgfVxuXG4gIHNlbGVjdEZpbGVzID0gKHsgbXVsdGlwbGUsIGFjY2VwdCwgd2Via2l0ZGlyZWN0b3J5IH06IElGaWxlT3B0aW9ucyk6IFByb21pc2U8RmlsZVtdPiA9PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICBjb25zdCB0ZW1wTm9kZSA9IHRoaXMuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2QtdXBsb2FkLXRlbXAnKTtcbiAgICAgIGlmICh0ZW1wTm9kZSkge1xuICAgICAgICB0aGlzLmRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGVtcE5vZGUpO1xuICAgICAgfVxuICAgICAgY29uc3QgaW5wdXQgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7XG5cbiAgICAgIGlucHV0LnN0eWxlLnBvc2l0aW9uID0gJ2ZpeGVkJztcbiAgICAgIGlucHV0LnN0eWxlLmxlZnQgPSAnLTIwMDBweCc7XG4gICAgICBpbnB1dC5zdHlsZS50b3AgPSAnLTIwMDBweCc7XG5cbiAgICAgIGlucHV0LnNldEF0dHJpYnV0ZSgnaWQnLCAnZC11cGxvYWQtdGVtcCcpO1xuICAgICAgaW5wdXQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ2ZpbGUnKTtcbiAgICAgIGlmIChtdWx0aXBsZSkge1xuICAgICAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoJ211bHRpcGxlJywgJycpO1xuICAgICAgfVxuICAgICAgaWYgKGFjY2VwdCkge1xuICAgICAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoJ2FjY2VwdCcsIGFjY2VwdCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh3ZWJraXRkaXJlY3RvcnkpIHtcbiAgICAgICAgaW5wdXQuc2V0QXR0cmlidXRlKCd3ZWJraXRkaXJlY3RvcnknLCAnJyk7XG4gICAgICB9XG5cbiAgICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGV2ZW50ID0+IHtcbiAgICAgICAgcmVzb2x2ZShBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCgoZXZlbnQudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQpLmZpbGVzKSk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpbnB1dCk7IC8vIEZpeCBjb21wYXRpYmlsaXR5IGlzc3VlIHdpdGggSW50ZXJuZXQgRXhwbG9yZXIgMTFcbiAgICAgIHRoaXMuc2ltdWxhdGVDbGlja0V2ZW50KGlucHV0KTtcbiAgICB9KTtcbiAgfTtcblxuICBpc0FsbG93ZWRGaWxlVHlwZSA9IChhY2NlcHQ6IHN0cmluZywgZmlsZTogRmlsZSkgPT4ge1xuICAgIGlmIChhY2NlcHQpIHtcbiAgICAgIGNvbnN0IGFjY2VwdEFyciA9IGFjY2VwdC5zcGxpdCgnLCcpO1xuICAgICAgY29uc3QgYmFzZU1pbWVUeXBlID0gZmlsZS50eXBlLnJlcGxhY2UoL1xcLy4qJC8sICcnKTtcbiAgICAgIHJldHVybiBhY2NlcHRBcnIuc29tZSgodHlwZTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IHZhbGlkVHlwZSA9IHR5cGUudHJpbSgpO1xuICAgICAgICAvLyAgc3VmZml4IG5hbWUgKGUuZy4gJy5wbmcsLnhsc3gnKVxuICAgICAgICBpZiAodmFsaWRUeXBlLnN0YXJ0c1dpdGgoJy4nKSkge1xuICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICBmaWxlLm5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKHZhbGlkVHlwZS50b0xvd2VyQ2FzZSgpLCBmaWxlLm5hbWUudG9Mb3dlckNhc2UoKS5sZW5ndGggLSB2YWxpZFR5cGUudG9Mb3dlckNhc2UoKS5sZW5ndGgpID4gLTFcbiAgICAgICAgICApO1xuICAgICAgICAgIC8vIG1pbWUgdHlwZSBsaWtlICdpbWFnZS8qJ1xuICAgICAgICB9IGVsc2UgaWYgKC9cXC9cXCokLy50ZXN0KHZhbGlkVHlwZSkpIHtcbiAgICAgICAgICByZXR1cm4gYmFzZU1pbWVUeXBlID09PSB2YWxpZFR5cGUucmVwbGFjZSgvXFwvLiokLywgJycpO1xuICAgICAgICB9XG4gICAgICAgIC8vICBtaW1lIHR5cGUgbGlrZSAndGV4dC9wbGFpbixhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICByZXR1cm4gZmlsZS50eXBlID09PSB2YWxpZFR5cGU7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH07XG5cbiAgYmV5b25kTWF4aW1hbFNpemUgPSAoZmlsZVNpemUsIG1heGltdW1TaXplKSA9PiB7XG4gICAgaWYgKG1heGltdW1TaXplKSB7XG4gICAgICByZXR1cm4gZmlsZVNpemUgPiAxMDI0ICogMTAyNCAqIG1heGltdW1TaXplO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG5cbiAgYmV5b25kQWxsRmlsZXNNYXhpbWFsU2l6ZSA9IChmaWxlU2l6ZSwgbWF4aW11bVNpemUpID0+IHtcbiAgICBpZiAobWF4aW11bVNpemUpIHtcbiAgICAgIHJldHVybiBmaWxlU2l6ZSA+IDEwMjQgKiAxMDI0ICogbWF4aW11bVNpemU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcblxuICB0cmlnZ2VyU2VsZWN0RmlsZXMgPSAoZmlsZU9wdGlvbnM6IElGaWxlT3B0aW9ucywgdXBsb2FkT3B0aW9uczogSVVwbG9hZE9wdGlvbnMpID0+IHtcbiAgICBjb25zdCB7IG11bHRpcGxlLCBhY2NlcHQsIHdlYmtpdGRpcmVjdG9yeX0gPSBmaWxlT3B0aW9ucztcbiAgICByZXR1cm4gZnJvbSh0aGlzLnNlbGVjdEZpbGVzKHsgbXVsdGlwbGUsIGFjY2VwdCAsIHdlYmtpdGRpcmVjdG9yeX0pKS5waXBlKG1lcmdlTWFwKGZpbGUgPT4gPGFueT5maWxlKSk7XG4gIH07XG5cbiAgdHJpZ2dlckRyb3BGaWxlcyA9IChmaWxlT3B0aW9uczogSUZpbGVPcHRpb25zLCB1cGxvYWRPcHRpb25zOiBJVXBsb2FkT3B0aW9ucywgZmlsZXM6IGFueSkgPT4ge1xuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShvYnNlcnZlciA9PiBvYnNlcnZlci5uZXh0KGZpbGVzKSkucGlwZShtZXJnZU1hcChmaWxlID0+IDxhbnk+ZmlsZSkpO1xuXG4gIH07XG5cbiAgY2hlY2tBbGxGaWxlc1NpemUoZmlsZVNpemUsIG1heGltdW1TaXplKSB7XG4gICAgaWYgKHRoaXMuYmV5b25kTWF4aW1hbFNpemUoZmlsZVNpemUsIG1heGltdW1TaXplKSkge1xuICAgICAgdGhpcy5CRVlPTkRfTUFYSU1BTF9GSUxFX1NJWkVfTVNHID0gdGhpcy5pMThuVGV4dC5nZXRBbGxGaWxlc0JleW9uZE1heGltYWxGaWxlU2l6ZU1zZyhtYXhpbXVtU2l6ZSk7XG4gICAgICByZXR1cm4geyBjaGVja0Vycm9yOiB0cnVlLCBlcnJvck1zZzogdGhpcy5CRVlPTkRfTUFYSU1BTF9GSUxFX1NJWkVfTVNHIH07XG4gICAgfVxuICB9XG5cbiAgX3ZhbGlkYXRlRmlsZXMoZmlsZSwgYWNjZXB0LCB1cGxvYWRPcHRpb25zKSB7XG4gICAgaWYgKCF0aGlzLmlzQWxsb3dlZEZpbGVUeXBlKGFjY2VwdCwgPEZpbGU+ZmlsZSkpIHtcbiAgICAgIHRoaXMuTk9UX0FMTE9XRURfRklMRV9UWVBFX01TRyA9IHRoaXMuaTE4blRleHQuZ2V0Tm90QWxsb3dlZEZpbGVUeXBlTXNnKCg8RmlsZT5maWxlKS5uYW1lLCBhY2NlcHQpO1xuICAgICAgcmV0dXJuIHsgY2hlY2tFcnJvcjogdHJ1ZSwgZXJyb3JNc2c6IHRoaXMuTk9UX0FMTE9XRURfRklMRV9UWVBFX01TRyB9O1xuICAgIH1cbiAgICBpZiAodGhpcy5iZXlvbmRNYXhpbWFsU2l6ZSgoPEZpbGU+ZmlsZSkuc2l6ZSwgdXBsb2FkT3B0aW9ucy5tYXhpbXVtU2l6ZSkpIHtcbiAgICAgIHRoaXMuQkVZT05EX01BWElNQUxfRklMRV9TSVpFX01TRyA9IHRoaXMuaTE4blRleHQuZ2V0QmV5b25kTWF4aW1hbEZpbGVTaXplTXNnKCg8RmlsZT5maWxlKS5uYW1lLCB1cGxvYWRPcHRpb25zLm1heGltdW1TaXplKTtcbiAgICAgIHJldHVybiB7IGNoZWNrRXJyb3I6IHRydWUsIGVycm9yTXNnOiB0aGlzLkJFWU9ORF9NQVhJTUFMX0ZJTEVfU0laRV9NU0cgfTtcbiAgICB9XG4gICAgcmV0dXJuIHsgY2hlY2tFcnJvcjogZmFsc2UsIGVycm9yTXNnOiB1bmRlZmluZWQgfTtcbiAgfVxuXG4gIHNpbXVsYXRlQ2xpY2tFdmVudChpbnB1dCkge1xuICAgIGNvbnN0IGV2dCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ01vdXNlRXZlbnRzJyk7XG4gICAgZXZ0LmluaXRNb3VzZUV2ZW50KCdjbGljaycsIHRydWUsIHRydWUsIHdpbmRvdywgMSwgMCwgMCwgMCwgMCwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIG51bGwpO1xuICAgIGlucHV0LmRpc3BhdGNoRXZlbnQoZXZ0KTtcbiAgfVxufVxuIl19