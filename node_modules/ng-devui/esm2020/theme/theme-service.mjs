import { THEME_KEY } from './key-config';
import { PrefersColorSchemeMediaQuery } from './media-query';
import { ContextService, EventBus, StorageService } from './utils/index';
/**
 * 负责CSS变量主题的装卸，主题元数据转换成主题数据
 */
export class ThemeService {
    constructor(eventBus, storage, context) {
        this.eventBus = eventBus === undefined ? new EventBus() : eventBus;
        this.storage = storage === undefined ? new StorageService() : storage;
        this.context = context === undefined ? new ContextService() : context;
    }
    set appendClasses(classes) {
        if (this._appendedClasses) {
            this.removeAppendedClass(this._appendedClasses);
        }
        if (classes) {
            this.addAppendClass(classes);
        }
        this._appendedClasses = classes;
    }
    get appendClasses() {
        return this._appendedClasses;
    }
    initializeTheme(specificThemeId, allowDynamicTheme) {
        const themeId = specificThemeId
            || this.storage.tryGetLocalStorage(THEME_KEY.userLastPreferTheme)
            || this.context.getDataFromNameSpace(THEME_KEY.currentTheme);
        let theme;
        if (themeId) {
            const themes = this.context.getDataFromNameSpace(THEME_KEY.themeCollection);
            if (themes && Object.keys(themes).length > 0) {
                theme = themes[themeId];
            }
        }
        this.currentTheme = theme || {
            id: 'empty-theme',
            name: '',
            data: {}
        };
        this.createColorTransition();
        if (!theme && allowDynamicTheme) {
            return;
        }
        this.applyTheme(this.currentTheme);
    }
    formatCSSVariables(themeData) {
        return Object.keys(themeData).map(cssVar => ('--' + cssVar + ':' + themeData[cssVar])).join(';');
    }
    applyTheme(theme) {
        this.addColorTransition();
        this.currentTheme = theme;
        if (!this.contentElement) {
            const styleElement = document.getElementById(THEME_KEY.styleElementId);
            if (styleElement) {
                this.contentElement = styleElement;
            }
            else {
                this.contentElement = document.createElement('style');
                this.contentElement.id = THEME_KEY.styleElementId;
                document.head.appendChild(this.contentElement);
            }
        }
        this.contentElement.innerText = ':root { ' + this.formatCSSVariables(theme.data) + ' }';
        this.contentElement.setAttribute(THEME_KEY.uiThemeAttributeName, this.currentTheme.id);
        document.body.setAttribute(THEME_KEY.uiThemeAttributeName, this.currentTheme.id);
        // 用于挂载额外变量和类名
        this.applyExtraData();
        this.saveCustomTheme(this.currentTheme);
        // 通知外部主题变更
        this.notify(theme, 'themeChanged');
        setTimeout(() => { this.removeColorTransition(); }, 500);
    }
    saveCustomTheme(customTheme) {
        this.storage.trySetLocalStorage(THEME_KEY.userLastPreferTheme, customTheme.id);
        this.storage.trySetLocalStorage(THEME_KEY.userLastPreferThemeData, JSON.stringify(customTheme.data));
        this.context.setDataFromNameSpace(THEME_KEY.currentTheme, customTheme.id);
    }
    notify(theme, eventType) {
        if (!this.eventBus) {
            return;
        }
        this.eventBus.trigger(eventType, theme);
    }
    setEventBus(eb) {
        this.eventBus = eb;
    }
    addAppendClass(classNames) {
        document.body.classList.add(...classNames);
    }
    removeAppendedClass(classNames) {
        document.body.classList.remove(...classNames);
    }
    setExtraData(data, apply = false) {
        this.extraData = data;
        if (apply) {
            this.applyExtraData();
        }
    }
    applyExtraData() {
        const theme = this.currentTheme;
        if (this.extraData && this.extraData[theme.id] && this.extraData[theme.id].cssVariables) {
            this.contentElement.innerText
                = ':root { ' + this.formatCSSVariables(theme.data) + ' }'
                    + ':root { ' + this.formatCSSVariables(this.extraData[theme.id].cssVariables) + ' }';
        }
        if (this.extraData && this.extraData[theme.id] && this.extraData[theme.id].appendClasses) {
            this.appendClasses = this.extraData[theme.id].appendClasses;
        }
        else {
            this.appendClasses = undefined;
        }
    }
    unloadTheme() {
        if (this.contentElement && document.contains(this.contentElement)) {
            this.contentElement.parentElement.removeChild(this.contentElement);
        }
        if (this.appendClasses) {
            this.appendClasses = undefined;
        }
    }
    registerMediaQuery() {
        if (!this.mediaQuery) {
            this.mediaQuery = new PrefersColorSchemeMediaQuery();
        }
        this.mediaQuery.register();
    }
    unregisterMediaQuery() {
        if (!this.mediaQuery) {
            return;
        }
        this.mediaQuery.unregister();
        this.mediaQuery = undefined;
    }
    createColorTransition() {
        this.colorTransitionElement = document.createElement('style');
        this.colorTransitionElement.id = THEME_KEY.transitionStyleElementId;
        this.colorTransitionElement.innerText = `
      * { transition: background .3s ease-out, background-color .3s ease-out,
                    border .3s ease-out, border-color .3s ease-out,
                    box-shadow .3s ease-out, box-shadow-color .3s ease-out}
    `;
    }
    addColorTransition() {
        document.head.appendChild(this.colorTransitionElement);
    }
    removeColorTransition() {
        if (!this.colorTransitionElement.parentElement) {
            return;
        }
        this.colorTransitionElement.parentElement.removeChild(this.colorTransitionElement);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhlbWUtc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2RldnVpL3RoZW1lL3RoZW1lLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN6QyxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFN0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQStDLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV0SDs7R0FFRztBQUNILE1BQU0sT0FBTyxZQUFZO0lBZ0N2QixZQUFZLFFBQW9CLEVBQUUsT0FBeUIsRUFBRSxPQUF5QjtRQUNwRixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztRQUNuRSxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksY0FBYyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUN0RSxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksY0FBYyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUN4RSxDQUFDO0lBcEJELElBQUksYUFBYSxDQUFDLE9BQXNCO1FBQ3RDLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQ3pCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztTQUNqRDtRQUNELElBQUksT0FBTyxFQUFFO1lBQ1gsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUM5QjtRQUNELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxPQUFPLENBQUM7SUFDbEMsQ0FBQztJQUVELElBQUksYUFBYTtRQUNm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fSBmcm9tICcuL2tleS1jb25maWcnO1xuaW1wb3J0IHsgUHJlZmVyc0NvbG9yU2NoZW1lTWVkaWFRdWVyeSB9IGZyb20gJy4vbWVkaWEtcXVlcnknO1xuaW1wb3J0IHsgVGhlbWUgfSBmcm9tICcuL3RoZW1lJztcbmltcG9ydCB7IENvbnRleHRTZXJ2aWNlLCBFdmVudEJ1cywgSUNvbnRleHRTZXJ2aWNlLCBJRXZlbnRCdXMsIElTdG9yYWdlU2VydmljZSwgU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL3V0aWxzL2luZGV4JztcblxuLyoqXG4gKiDotJ/otKNDU1Plj5jph4/kuLvpopjnmoToo4XljbjvvIzkuLvpopjlhYPmlbDmja7ovazmjaLmiJDkuLvpopjmlbDmja5cbiAqL1xuZXhwb3J0IGNsYXNzIFRoZW1lU2VydmljZSB7XG4gIGV2ZW50QnVzOiBJRXZlbnRCdXM7XG4gIHN0b3JhZ2U6IElTdG9yYWdlU2VydmljZTtcbiAgY29udGV4dDogSUNvbnRleHRTZXJ2aWNlO1xuICBjdXJyZW50VGhlbWU6IFRoZW1lO1xuICBjb250ZW50RWxlbWVudDogSFRNTFN0eWxlRWxlbWVudDtcbiAgY29sb3JUcmFuc2l0aW9uRWxlbWVudDogSFRNTFN0eWxlRWxlbWVudDtcbiAgZXh0cmFEYXRhOiB7XG4gICAgW3RoZW1lSWQ6IHN0cmluZ106IHtcbiAgICAgIGNzc1ZhcmlhYmxlcz86IHtcbiAgICAgICAgW3Zhcm5hbWU6IHN0cmluZ106IHN0cmluZztcbiAgICAgIH07XG4gICAgICBhcHBlbmRDbGFzc2VzPzogQXJyYXk8c3RyaW5nPjtcbiAgICB9O1xuICB9O1xuICBwcml2YXRlIF9hcHBlbmRlZENsYXNzZXM6IEFycmF5PHN0cmluZz47XG4gIHNldCBhcHBlbmRDbGFzc2VzKGNsYXNzZXM6IEFycmF5PHN0cmluZz4pIHtcbiAgICBpZiAodGhpcy5fYXBwZW5kZWRDbGFzc2VzKSB7XG4gICAgICB0aGlzLnJlbW92ZUFwcGVuZGVkQ2xhc3ModGhpcy5fYXBwZW5kZWRDbGFzc2VzKTtcbiAgICB9XG4gICAgaWYgKGNsYXNzZXMpIHtcbiAgICAgIHRoaXMuYWRkQXBwZW5kQ2xhc3MoY2xhc3Nlcyk7XG4gICAgfVxuICAgIHRoaXMuX2FwcGVuZGVkQ2xhc3NlcyA9IGNsYXNzZXM7XG4gIH1cblxuICBnZXQgYXBwZW5kQ2xhc3NlcygpIHtcbiAgICByZXR1cm4gdGhpcy5fYXBwZW5kZWRDbGFzc2VzO1xuICB9XG5cbiAgcHVibGljIG1lZGlhUXVlcnk6IFByZWZlcnNDb2xvclNjaGVtZU1lZGlhUXVlcnk7XG5cbiAgY29uc3RydWN0b3IoZXZlbnRCdXM/OiBJRXZlbnRCdXMsIHN0b3JhZ2U/OiBJU3RvcmFnZVNlcnZpY2UsIGNvbnRleHQ/OiBJQ29udGV4dFNlcnZpY2UpIHtcbiAgICB0aGlzLmV2ZW50QnVzID0gZXZlbnRCdXMgPT09IHVuZGVmaW5lZCA/IG5ldyBFdmVudEJ1cygpIDogZXZlbnRCdXM7XG4gICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZSA9PT0gdW5kZWZpbmVkID8gbmV3IFN0b3JhZ2VTZXJ2aWNlKCkgOiBzdG9yYWdlO1xuICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQgPT09IHVuZGVmaW5lZCA/IG5ldyBDb250ZXh0U2VydmljZSgpIDogY29udGV4dDtcbiAgfVxuXG4gIGluaXRpYWxpemVUaGVtZShzcGVjaWZpY1RoZW1lSWQ/OiBzdHJpbmcsIGFsbG93RHluYW1pY1RoZW1lPzogYm9vbGVhbikge1xuICAgIGNvbnN0IHRoZW1lSWQgPSBzcGVjaWZpY1RoZW1lSWRcbiAgICAgICAgICAgICAgICB8fCB0aGlzLnN0b3JhZ2UudHJ5R2V0TG9jYWxTdG9yYWdlKFRIRU1FX0tFWS51c2VyTGFzdFByZWZlclRoZW1lKVxuICAgICAgICAgICAgICAgIHx8IHRoaXMuY29udGV4dC5nZXREYXRhRnJvbU5hbWVTcGFjZShUSEVNRV9LRVkuY3VycmVudFRoZW1lKTtcbiAgICBsZXQgdGhlbWU7XG5cbiAgICBpZiAodGhlbWVJZCkge1xuICAgICAgY29uc3QgdGhlbWVzID0gdGhpcy5jb250ZXh0LmdldERhdGFGcm9tTmFtZVNwYWNlKFRIRU1FX0tFWS50aGVtZUNvbGxlY3Rpb24pO1xuICAgICAgaWYgKHRoZW1lcyAmJiBPYmplY3Qua2V5cyh0aGVtZXMpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhlbWUgPSB0aGVtZXNbdGhlbWVJZF07XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuY3VycmVudFRoZW1lID0gdGhlbWUgfHwge1xuICAgICAgaWQ6ICdlbXB0eS10aGVtZScsXG4gICAgICBuYW1lOiAnJyxcbiAgICAgIGRhdGE6IHt9XG4gICAgfTtcbiAgICB0aGlzLmNyZWF0ZUNvbG9yVHJhbnNpdGlvbigpO1xuICAgIGlmICghdGhlbWUgJiYgYWxsb3dEeW5hbWljVGhlbWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5hcHBseVRoZW1lKHRoaXMuY3VycmVudFRoZW1lKTtcbiAgfVxuXG4gIGZvcm1hdENTU1ZhcmlhYmxlcyh0aGVtZURhdGE6IFRoZW1lWydkYXRhJ10pIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhlbWVEYXRhKS5tYXAoXG4gICAgICBjc3NWYXIgPT4gKCctLScgKyBjc3NWYXIgKyAnOicgKyB0aGVtZURhdGFbY3NzVmFyXSlcbiAgICApLmpvaW4oJzsnKTtcbiAgfVxuXG4gIGFwcGx5VGhlbWUodGhlbWU6IFRoZW1lKSB7XG4gICAgdGhpcy5hZGRDb2xvclRyYW5zaXRpb24oKTtcbiAgICB0aGlzLmN1cnJlbnRUaGVtZSA9IHRoZW1lO1xuICAgIGlmICghdGhpcy5jb250ZW50RWxlbWVudCkge1xuICAgICAgY29uc3Qgc3R5bGVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoVEhFTUVfS0VZLnN0eWxlRWxlbWVudElkKTtcbiAgICAgIGlmIChzdHlsZUVsZW1lbnQpIHtcbiAgICAgICAgdGhpcy5jb250ZW50RWxlbWVudCA9IDxIVE1MU3R5bGVFbGVtZW50PnN0eWxlRWxlbWVudDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuY29udGVudEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpO1xuICAgICAgICB0aGlzLmNvbnRlbnRFbGVtZW50LmlkID0gVEhFTUVfS0VZLnN0eWxlRWxlbWVudElkO1xuICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHRoaXMuY29udGVudEVsZW1lbnQpO1xuICAgICAgfVxuXG4gICAgfVxuICAgIHRoaXMuY29udGVudEVsZW1lbnQuaW5uZXJUZXh0ID0gJzpyb290IHsgJyArIHRoaXMuZm9ybWF0Q1NTVmFyaWFibGVzKHRoZW1lLmRhdGEpICsgJyB9JztcbiAgICB0aGlzLmNvbnRlbnRFbGVtZW50LnNldEF0dHJpYnV0ZShUSEVNRV9LRVkudWlUaGVtZUF0dHJpYnV0ZU5hbWUsIHRoaXMuY3VycmVudFRoZW1lLmlkKTtcbiAgICBkb2N1bWVudC5ib2R5LnNldEF0dHJpYnV0ZShUSEVNRV9LRVkudWlUaGVtZUF0dHJpYnV0ZU5hbWUsIHRoaXMuY3VycmVudFRoZW1lLmlkKTtcblxuICAgIC8vIOeUqOS6juaMgui9vemineWkluWPmOmHj+WSjOexu+WQjVxuICAgIHRoaXMuYXBwbHlFeHRyYURhdGEoKTtcbiAgICB0aGlzLnNhdmVDdXN0b21UaGVtZSh0aGlzLmN1cnJlbnRUaGVtZSk7XG5cbiAgICAvLyDpgJrnn6XlpJbpg6jkuLvpopjlj5jmm7RcbiAgICB0aGlzLm5vdGlmeSh0aGVtZSwgJ3RoZW1lQ2hhbmdlZCcpO1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge3RoaXMucmVtb3ZlQ29sb3JUcmFuc2l0aW9uKCk7IH0sIDUwMCk7XG4gIH1cblxuICBzYXZlQ3VzdG9tVGhlbWUoY3VzdG9tVGhlbWU6IFRoZW1lKSB7XG4gICAgdGhpcy5zdG9yYWdlLnRyeVNldExvY2FsU3RvcmFnZShUSEVNRV9LRVkudXNlckxhc3RQcmVmZXJUaGVtZSwgY3VzdG9tVGhlbWUuaWQpO1xuICAgIHRoaXMuc3RvcmFnZS50cnlTZXRMb2NhbFN0b3JhZ2UoVEhFTUVfS0VZLnVzZXJMYXN0UHJlZmVyVGhlbWVEYXRhLCBKU09OLnN0cmluZ2lmeShjdXN0b21UaGVtZS5kYXRhKSk7XG4gICAgdGhpcy5jb250ZXh0LnNldERhdGFGcm9tTmFtZVNwYWNlKFRIRU1FX0tFWS5jdXJyZW50VGhlbWUsIGN1c3RvbVRoZW1lLmlkKTtcbiAgfVxuXG4gIHByaXZhdGUgbm90aWZ5KHRoZW1lOiBUaGVtZSwgZXZlbnRUeXBlOiBzdHJpbmcpIHtcbiAgICBpZiAoIXRoaXMuZXZlbnRCdXMpIHsgcmV0dXJuOyB9XG4gICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKGV2ZW50VHlwZSwgdGhlbWUpO1xuICB9XG5cbiAgc2V0RXZlbnRCdXMoZWI6IElFdmVudEJ1cykge1xuICAgIHRoaXMuZXZlbnRCdXMgPSBlYjtcbiAgfVxuXG4gIHByaXZhdGUgYWRkQXBwZW5kQ2xhc3MoY2xhc3NOYW1lczogQXJyYXk8c3RyaW5nPikge1xuICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCguLi5jbGFzc05hbWVzKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlQXBwZW5kZWRDbGFzcyhjbGFzc05hbWVzOiBBcnJheTxzdHJpbmc+KSB7XG4gICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKC4uLmNsYXNzTmFtZXMpO1xuICB9XG5cbiAgc2V0RXh0cmFEYXRhKGRhdGEsIGFwcGx5ID0gZmFsc2UpIHtcbiAgICB0aGlzLmV4dHJhRGF0YSA9IGRhdGE7XG4gICAgaWYgKGFwcGx5KSB7XG4gICAgICB0aGlzLmFwcGx5RXh0cmFEYXRhKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhcHBseUV4dHJhRGF0YSgpIHtcbiAgICBjb25zdCB0aGVtZSA9IHRoaXMuY3VycmVudFRoZW1lO1xuICAgIGlmICh0aGlzLmV4dHJhRGF0YSAmJiB0aGlzLmV4dHJhRGF0YVt0aGVtZS5pZF0gJiYgdGhpcy5leHRyYURhdGFbdGhlbWUuaWRdLmNzc1ZhcmlhYmxlcykge1xuICAgICAgdGhpcy5jb250ZW50RWxlbWVudC5pbm5lclRleHRcbiAgICAgID0gJzpyb290IHsgJyArIHRoaXMuZm9ybWF0Q1NTVmFyaWFibGVzKHRoZW1lLmRhdGEpICsgJyB9J1xuICAgICAgKyAnOnJvb3QgeyAnICsgdGhpcy5mb3JtYXRDU1NWYXJpYWJsZXModGhpcy5leHRyYURhdGFbdGhlbWUuaWRdLmNzc1ZhcmlhYmxlcykgKyAnIH0nO1xuICAgIH1cbiAgICBpZiAodGhpcy5leHRyYURhdGEgJiYgdGhpcy5leHRyYURhdGFbdGhlbWUuaWRdICYmIHRoaXMuZXh0cmFEYXRhW3RoZW1lLmlkXS5hcHBlbmRDbGFzc2VzKSB7XG4gICAgICB0aGlzLmFwcGVuZENsYXNzZXMgPSB0aGlzLmV4dHJhRGF0YVt0aGVtZS5pZF0uYXBwZW5kQ2xhc3NlcztcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hcHBlbmRDbGFzc2VzID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyB1bmxvYWRUaGVtZSgpIHtcbiAgICBpZiAodGhpcy5jb250ZW50RWxlbWVudCAmJiBkb2N1bWVudC5jb250YWlucyh0aGlzLmNvbnRlbnRFbGVtZW50KSkge1xuICAgICAgdGhpcy5jb250ZW50RWxlbWVudC5wYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKHRoaXMuY29udGVudEVsZW1lbnQpO1xuICAgIH1cbiAgICBpZiAodGhpcy5hcHBlbmRDbGFzc2VzKSB7XG4gICAgICB0aGlzLmFwcGVuZENsYXNzZXMgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlZ2lzdGVyTWVkaWFRdWVyeSgpIHtcbiAgICBpZiAoIXRoaXMubWVkaWFRdWVyeSkge1xuICAgICAgdGhpcy5tZWRpYVF1ZXJ5ID0gbmV3IFByZWZlcnNDb2xvclNjaGVtZU1lZGlhUXVlcnkoKTtcbiAgICB9XG4gICAgdGhpcy5tZWRpYVF1ZXJ5LnJlZ2lzdGVyKCk7XG4gIH1cblxuICBwdWJsaWMgdW5yZWdpc3Rlck1lZGlhUXVlcnkoKSB7XG4gICAgaWYgKCF0aGlzLm1lZGlhUXVlcnkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5tZWRpYVF1ZXJ5LnVucmVnaXN0ZXIoKTtcbiAgICB0aGlzLm1lZGlhUXVlcnkgPSB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNvbG9yVHJhbnNpdGlvbigpIHtcbiAgICB0aGlzLmNvbG9yVHJhbnNpdGlvbkVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpO1xuICAgIHRoaXMuY29sb3JUcmFuc2l0aW9uRWxlbWVudC5pZCA9IFRIRU1FX0tFWS50cmFuc2l0aW9uU3R5bGVFbGVtZW50SWQ7XG4gICAgdGhpcy5jb2xvclRyYW5zaXRpb25FbGVtZW50LmlubmVyVGV4dCA9IGBcbiAgICAgICogeyB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kIC4zcyBlYXNlLW91dCwgYmFja2dyb3VuZC1jb2xvciAuM3MgZWFzZS1vdXQsXG4gICAgICAgICAgICAgICAgICAgIGJvcmRlciAuM3MgZWFzZS1vdXQsIGJvcmRlci1jb2xvciAuM3MgZWFzZS1vdXQsXG4gICAgICAgICAgICAgICAgICAgIGJveC1zaGFkb3cgLjNzIGVhc2Utb3V0LCBib3gtc2hhZG93LWNvbG9yIC4zcyBlYXNlLW91dH1cbiAgICBgO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRDb2xvclRyYW5zaXRpb24oKSB7XG4gICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZCh0aGlzLmNvbG9yVHJhbnNpdGlvbkVsZW1lbnQpO1xuICB9XG4gIHByaXZhdGUgcmVtb3ZlQ29sb3JUcmFuc2l0aW9uKCkge1xuICAgIGlmICghdGhpcy5jb2xvclRyYW5zaXRpb25FbGVtZW50LnBhcmVudEVsZW1lbnQpIHtyZXR1cm47IH1cbiAgICB0aGlzLmNvbG9yVHJhbnNpdGlvbkVsZW1lbnQucGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLmNvbG9yVHJhbnNpdGlvbkVsZW1lbnQpO1xuICB9XG59XG4iXX0=