import { Injectable } from '@angular/core';
import { cloneDeep } from 'lodash-es';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
export class CascaderService {
    constructor() {
        this._currentValue = [];
        this.multipleValue = [];
        this.columnList = [];
        this.searchResultList = [];
        this.canSelectParent = false;
        this.isMultiple = false;
        this.isLazyLoad = false;
        this.lazyloadCache = {};
        this.closeMianDropdown = new Subject();
        this.currentValueChange = new Subject();
        this.resetStatus = new Subject();
        this.openDrawer = new Subject();
        this.updateShowText = new Subject();
        this.updateTagList = new Subject();
    }
    set currentValue(value) {
        this._currentValue = value.filter(item => item !== undefined);
        this.currentValueChange.next(this._currentValue);
    }
    get currentValue() {
        return this._currentValue;
    }
    set currentMultipleValue(value) {
        this.resetNodeStatus();
        this.multipleValue = value;
    }
    get currentMultipleValue() {
        this.multipleValue = [];
        this.getMultipleValue([], this.options);
        return this.multipleValue;
    }
    initOptions(options) {
        this.columnList = [];
        this.options = cloneDeep(options);
        // 标记根节点
        this.options.forEach(t => { t['isRoot'] = true; });
        this.columnList.push(this.options);
    }
    openColumn(option, colIndex, islazyLoad, reload = false) {
        this.clearTargetActive(this.columnList[colIndex].find(t => t.active));
        option.active = true;
        this.columnList.splice(colIndex + 1);
        if (option.children && option.children.length) {
            this.columnList.push(option.children);
            this.openDrawer.next();
        }
        else if (islazyLoad) {
            option._loading = true;
            const fn = this.loadChildrenFn(option);
            if (fn.then) {
                fn.then(res => {
                    this.columnList.splice(colIndex + 1); // 防止多个同时懒加载，造成多余的添加
                    option.children = res || [];
                    option._loading = false;
                    this.columnList.push(res || []);
                    this.openDrawer.next();
                    if (this.isMultiple) {
                        this.updateOptionCheckedStatus(option.value, option.checked, true, true, !reload);
                    }
                    if (reload) {
                        if (!this.isMultiple) {
                            this.updateOptionByValue();
                        }
                        this.updateShowText.next();
                    }
                });
            }
            else {
                fn.subscribe(res => {
                    this.columnList.splice(colIndex + 1); // 防止多个同时懒加载，造成多余的添加
                    option.children = res || [];
                    option._loading = false;
                    this.columnList.push(res || []);
                    this.openDrawer.next();
                    if (this.isMultiple) {
                        this.updateOptionCheckedStatus(option.value, option.checked, true, true, !reload);
                    }
                    if (reload) {
                        if (!this.isMultiple) {
                            this.updateOptionByValue();
                        }
                        this.updateShowText.next();
                    }
                });
            }
        }
    }
    clearTargetActive(option) {
        if (!option) {
            return;
        }
        option.active = false;
        if (option.children) {
            this.clearTargetActive(option.children.find(t => t.active));
        }
    }
    setCurrentValue() {
        this.currentValue = this.columnList.map(listItem => listItem.find(optionItem => optionItem.active)?.value);
    }
    updateOptionByValue() {
        this.resetNodeStatus();
        this.columnList = [this.options];
        for (let index = 0; index < this.currentValue.length; index++) {
            const target = this.columnList[index]?.find(listItem => listItem.value === this.currentValue[index]);
            if (target) {
                target['active'] = true;
                if (target.children && target.children.length) { // 有子菜单展开子菜单
                    this.columnList.push(target.children);
                }
                else if (this.isLazyLoad) { // 懒加载没有子菜单的情况下，非叶子节点执行展开，叶子节点执行选中
                    this.openColumn(target, index, !target.isLeaf, !target.isLeaf);
                    break;
                }
            }
            else {
                break;
            }
        }
    }
    lazyloadMultipleChild(target, index) {
        if (!this.lazyloadCache[target.value]) {
            this.lazyloadCache[target.value] = true;
            this.openColumn(target, index, true, true);
        }
    }
    resetNodeStatus(option = this.options) {
        option.forEach(item => {
            item['active'] = false;
            item['checked'] = false;
            item['halfChecked'] = false;
            if (item.children) {
                this.resetNodeStatus(item.children);
            }
        });
    }
    // 在多选模式下，更新节点树的checked状态
    updateOptionCheckedStatus(targetValue, checked, upward = true, downward = true, isEmit = true) {
        let targetNode = this.options.find(t => t.value === targetValue);
        // 当主下拉列表包含了目标，即目标无父节点
        if (targetNode) {
            targetNode['checked'] = checked;
            targetNode['halfChecked'] = false;
            if (targetNode.children && downward) {
                this.updateChildrenChecked(targetNode, checked, isEmit);
            }
        }
        else { // 当存在父节点时，需要检查同级节点来确定父节点状态
            const parentNode = this.getParentNode(targetValue);
            targetNode = parentNode.children.find(t => t.value === targetValue);
            targetNode['checked'] = checked;
            targetNode['halfChecked'] = false;
            if (targetNode.children && downward) {
                this.updateChildrenChecked(targetNode, checked, isEmit);
            }
            if (upward) {
                this.updateParentChecked(parentNode, isEmit);
            }
        }
    }
    // 子节点按父节点状态更新
    updateChildrenChecked(node, checked, isEmit) {
        let hasDisable = false;
        node.children.forEach(child => {
            if (!child.disabled) {
                child['checked'] = checked;
                child['halfChecked'] = false;
                if (child.children && child.children.length) {
                    if (this.canSelectParent) {
                        this.updateTagList.next({
                            isAdd: checked,
                            option: child,
                            isEmit
                        });
                    }
                    this.updateChildrenChecked(child, checked, isEmit);
                }
                else {
                    this.updateTagList.next({
                        isAdd: checked,
                        option: child,
                        isEmit
                    });
                }
            }
            else {
                hasDisable = true;
            }
        });
        if (hasDisable && !this.canSelectParent) {
            this.updateParentChecked(node, isEmit);
        }
    }
    // 父节点按所有子节点状态更新
    updateParentChecked(node, isEmit) {
        const checkedChild = node.children.find(t => t['checked']);
        const halfcheckedChild = node.children.find(t => t['halfChecked']);
        const uncheckedChild = node.children.find(t => !t['halfChecked'] && !t['checked']);
        if (halfcheckedChild || (checkedChild && uncheckedChild)) {
            node['checked'] = false;
            node['halfChecked'] = true;
        }
        else if (!checkedChild && !halfcheckedChild) {
            node['checked'] = false;
            node['halfChecked'] = false;
        }
        else {
            node['checked'] = true;
            node['halfChecked'] = false;
        }
        if (this.canSelectParent) {
            this.updateTagList.next({
                isAdd: node['checked'],
                option: node,
                isEmit
            });
        }
        // 如果此节点非根节点，则继续找它的父节点进行更新
        if (!node['isRoot']) {
            this.updateParentChecked(this.getParentNode(node.value), isEmit);
        }
    }
    // 获取父节点
    getParentNode(childValue) {
        const queue = [...this.options];
        let cur;
        while (queue.length) {
            cur = queue.shift();
            if (cur.children && cur.children.find(t => t.value === childValue)) {
                break;
            }
            else if (cur.children) {
                queue.push(...cur.children);
            }
        }
        return cur;
    }
    getMultipleValue(value, option) {
        option.forEach(item => {
            const _value = [...value];
            if (item.children && item.children.length && (item.checked || item.halfChecked)) {
                _value.push(item.value);
                this.getMultipleValue(_value, item.children);
            }
            else if (item.checked) {
                _value.push(item.value);
                this.multipleValue.push(_value);
            }
        });
    }
    closeAllDropdown() {
        this.closeMianDropdown.next();
    }
    // 搜索功能
    searchByString(str, currentlabel, currentValue = [], list = this.options) {
        list.forEach(item => {
            const label = currentlabel ? currentlabel + ' / ' + item.label : item.label;
            const valueList = [...currentValue, item.value];
            if (item.children && item.children.length) {
                this.searchByString(str, label, valueList, item.children);
            }
            else {
                if (!item.disabled && label.toLowerCase().indexOf(str.toLowerCase()) !== -1) {
                    this.searchResultList.push({
                        label,
                        valueList,
                        checked: item.checked
                    });
                }
            }
        });
    }
    ngOnDestroy() {
        this.closeMianDropdown.complete();
        this.currentValueChange.complete();
        this.updateTagList.complete();
        this.resetStatus.complete();
        this.openDrawer.complete();
    }
}
CascaderService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: CascaderService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
CascaderService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: CascaderService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: CascaderService, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FzY2FkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2RldnVpL2Nhc2NhZGVyL2Nhc2NhZGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUN0RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7O0FBSTNDLE1BQU0sT0FBTyxlQUFlO0lBRDVCO1FBR0Usa0JBQWEsR0FBMkIsRUFBRSxDQUFDO1FBRTNDLGtCQUFhLEdBQTZCLEVBQUUsQ0FBQztRQUk3QyxlQUFVLEdBQXFCLEVBQUUsQ0FBQztRQUNsQyxxQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFFdEIsb0JBQWUsR0FBRyxLQUFLLENBQUM7UUFFeEIsZUFBVSxHQUFHLEtBQUssQ0FBQztRQUVuQixlQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ25CLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBd0JWLHNCQUFpQixHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDeEMsdUJBQWtCLEdBQUcsSUFBSSxPQUFPLEVBQTBCLENBQUM7UUFDM0QsZ0JBQVcsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBQ2xDLGVBQVUsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBQ2pDLG1CQUFjLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUNyQyxrQkFBYSxHQUFHLElBQUksT0FBTyxFQUloQyxDQUFDO0tBd1FOO0lBclNDLElBQUksWUFBWSxDQUFDLEtBQTZCO1FBQzVDLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQztRQUM5RCxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FB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LENBQUMsUUFBUSxFQUFFLENBQUM7SUFDN0IsQ0FBQzs7NEdBdlRVLGVBQWU7Z0hBQWYsZUFBZTsyRkFBZixlQUFlO2tCQUQzQixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQ2FzY2FkZXJJdGVtIH0gZnJvbSAnLi9jYXNjYWRlci50eXBlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENhc2NhZGVyU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG5cbiAgX2N1cnJlbnRWYWx1ZTogQXJyYXk8c3RyaW5nIHwgbnVtYmVyPiA9IFtdO1xuXG4gIG11bHRpcGxlVmFsdWU6IEFycmF5PHN0cmluZyB8IG51bWJlcj5bXSA9IFtdO1xuXG4gIG9wdGlvbnM6IENhc2NhZGVySXRlbVtdO1xuXG4gIGNvbHVtbkxpc3Q6IENhc2NhZGVySXRlbVtdW10gPSBbXTtcbiAgc2VhcmNoUmVzdWx0TGlzdCA9IFtdO1xuXG4gIGNhblNlbGVjdFBhcmVudCA9IGZhbHNlO1xuXG4gIGlzTXVsdGlwbGUgPSBmYWxzZTtcblxuICBpc0xhenlMb2FkID0gZmFsc2U7XG4gIGxhenlsb2FkQ2FjaGUgPSB7fTtcblxuICBsb2FkQ2hpbGRyZW5GbjogKHZhbHVlOiBDYXNjYWRlckl0ZW0pID0+IFByb21pc2U8Q2FzY2FkZXJJdGVtW10+IHwgT2JzZXJ2YWJsZTxDYXNjYWRlckl0ZW1bXT47XG5cbiAgc2V0IGN1cnJlbnRWYWx1ZSh2YWx1ZTogQXJyYXk8c3RyaW5nIHwgbnVtYmVyPikge1xuICAgIHRoaXMuX2N1cnJlbnRWYWx1ZSA9IHZhbHVlLmZpbHRlcihpdGVtID0+IGl0ZW0gIT09IHVuZGVmaW5lZCk7XG4gICAgdGhpcy5jdXJyZW50VmFsdWVDaGFuZ2UubmV4dCh0aGlzLl9jdXJyZW50VmFsdWUpO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRWYWx1ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5fY3VycmVudFZhbHVlO1xuICB9XG5cbiAgc2V0IGN1cnJlbnRNdWx0aXBsZVZhbHVlKHZhbHVlKSB7XG4gICAgdGhpcy5yZXNldE5vZGVTdGF0dXMoKTtcbiAgICB0aGlzLm11bHRpcGxlVmFsdWUgPSB2YWx1ZTtcbiAgfVxuXG4gIGdldCBjdXJyZW50TXVsdGlwbGVWYWx1ZSgpIHtcbiAgICB0aGlzLm11bHRpcGxlVmFsdWUgPSBbXTtcbiAgICB0aGlzLmdldE11bHRpcGxlVmFsdWUoW10sIHRoaXMub3B0aW9ucyk7XG4gICAgcmV0dXJuIHRoaXMubXVsdGlwbGVWYWx1ZTtcbiAgfVxuXG4gIHJlYWRvbmx5IGNsb3NlTWlhbkRyb3Bkb3duID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgcmVhZG9ubHkgY3VycmVudFZhbHVlQ2hhbmdlID0gbmV3IFN1YmplY3Q8QXJyYXk8c3RyaW5nIHwgbnVtYmVyPj4oKTtcbiAgcmVhZG9ubHkgcmVzZXRTdGF0dXMgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuICByZWFkb25seSBvcGVuRHJhd2VyID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgcmVhZG9ubHkgdXBkYXRlU2hvd1RleHQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuICByZWFkb25seSB1cGRhdGVUYWdMaXN0ID0gbmV3IFN1YmplY3Q8e1xuICAgIGlzQWRkOiBib29sZWFuO1xuICAgIG9wdGlvbjogQ2FzY2FkZXJJdGVtO1xuICAgIGlzRW1pdDogYm9vbGVhbjsgLy8g5piv5ZCm6Kem5Y+Rb25jaGFuZ2VzLOWvueWkluWPkeWHuuWAvFxuICB9PigpO1xuXG4gIGluaXRPcHRpb25zKG9wdGlvbnM6IENhc2NhZGVySXRlbVtdKTogdm9pZCB7XG4gICAgdGhpcy5jb2x1bW5MaXN0ID0gW107XG4gICAgdGhpcy5vcHRpb25zID0gY2xvbmVEZWVwKG9wdGlvbnMpO1xuICAgIC8vIOagh+iusOagueiKgueCuVxuICAgIHRoaXMub3B0aW9ucy5mb3JFYWNoKHQgPT4ge3RbJ2lzUm9vdCddID0gdHJ1ZTt9KTtcbiAgICB0aGlzLmNvbHVtbkxpc3QucHVzaCh0aGlzLm9wdGlvbnMpO1xuICB9XG5cbiAgb3BlbkNvbHVtbihvcHRpb246IENhc2NhZGVySXRlbSwgY29sSW5kZXg6IG51bWJlciwgaXNsYXp5TG9hZDogYm9vbGVhbiwgcmVsb2FkID0gZmFsc2UpOiB2b2lkIHtcbiAgICB0aGlzLmNsZWFyVGFyZ2V0QWN0aXZlKHRoaXMuY29sdW1uTGlzdFtjb2xJbmRleF0uZmluZCh0ID0+IHQuYWN0aXZlKSk7XG4gICAgb3B0aW9uLmFjdGl2ZSA9IHRydWU7XG4gICAgdGhpcy5jb2x1bW5MaXN0LnNwbGljZShjb2xJbmRleCArIDEpO1xuXG4gICAgaWYgKG9wdGlvbi5jaGlsZHJlbiAmJiBvcHRpb24uY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICB0aGlzLmNvbHVtbkxpc3QucHVzaChvcHRpb24uY2hpbGRyZW4pO1xuICAgICAgdGhpcy5vcGVuRHJhd2VyLm5leHQoKTtcbiAgICB9IGVsc2UgaWYgKGlzbGF6eUxvYWQpIHtcbiAgICAgIG9wdGlvbi5fbG9hZGluZyA9IHRydWU7XG5cbiAgICAgIGNvbnN0IGZuID0gdGhpcy5sb2FkQ2hpbGRyZW5GbihvcHRpb24pO1xuXG4gICAgICBpZiAoKGZuIGFzIFByb21pc2U8Q2FzY2FkZXJJdGVtW10+KS50aGVuKSB7XG4gICAgICAgIChmbiBhcyBQcm9taXNlPENhc2NhZGVySXRlbVtdPikudGhlbihyZXMgPT4ge1xuICAgICAgICAgIHRoaXMuY29sdW1uTGlzdC5zcGxpY2UoY29sSW5kZXggKyAxKTsgLy8g6Ziy5q2i5aSa5Liq5ZCM5pe25oeS5Yqg6L2977yM6YCg5oiQ5aSa5L2Z55qE5re75YqgXG4gICAgICAgICAgb3B0aW9uLmNoaWxkcmVuID0gcmVzIHx8IFtdO1xuICAgICAgICAgIG9wdGlvbi5fbG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAgIHRoaXMuY29sdW1uTGlzdC5wdXNoKHJlcyB8fCBbXSk7XG4gICAgICAgICAgdGhpcy5vcGVuRHJhd2VyLm5leHQoKTtcblxuICAgICAgICAgIGlmICh0aGlzLmlzTXVsdGlwbGUpIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlT3B0aW9uQ2hlY2tlZFN0YXR1cyhvcHRpb24udmFsdWUsIG9wdGlvbi5jaGVja2VkLCB0cnVlLCB0cnVlLCAhcmVsb2FkKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlbG9hZCkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmlzTXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVPcHRpb25CeVZhbHVlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVNob3dUZXh0Lm5leHQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgKGZuIGFzIE9ic2VydmFibGU8Q2FzY2FkZXJJdGVtW10+KS5zdWJzY3JpYmUocmVzID0+IHtcbiAgICAgICAgICB0aGlzLmNvbHVtbkxpc3Quc3BsaWNlKGNvbEluZGV4ICsgMSk7IC8vIOmYsuatouWkmuS4quWQjOaXtuaHkuWKoOi9ve+8jOmAoOaIkOWkmuS9meeahOa3u+WKoFxuICAgICAgICAgIG9wdGlvbi5jaGlsZHJlbiA9IHJlcyB8fCBbXTtcbiAgICAgICAgICBvcHRpb24uX2xvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgICB0aGlzLmNvbHVtbkxpc3QucHVzaChyZXMgfHwgW10pO1xuICAgICAgICAgIHRoaXMub3BlbkRyYXdlci5uZXh0KCk7XG5cbiAgICAgICAgICBpZiAodGhpcy5pc011bHRpcGxlKSB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZU9wdGlvbkNoZWNrZWRTdGF0dXMob3B0aW9uLnZhbHVlLCBvcHRpb24uY2hlY2tlZCwgdHJ1ZSwgdHJ1ZSwgIXJlbG9hZCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHJlbG9hZCkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmlzTXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVPcHRpb25CeVZhbHVlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVNob3dUZXh0Lm5leHQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNsZWFyVGFyZ2V0QWN0aXZlKG9wdGlvbjogQ2FzY2FkZXJJdGVtKTogdm9pZCB7XG4gICAgaWYgKCFvcHRpb24pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgb3B0aW9uLmFjdGl2ZSA9IGZhbHNlO1xuICAgIGlmIChvcHRpb24uY2hpbGRyZW4pIHtcbiAgICAgIHRoaXMuY2xlYXJUYXJnZXRBY3RpdmUob3B0aW9uLmNoaWxkcmVuLmZpbmQodCA9PiB0LmFjdGl2ZSkpO1xuICAgIH1cbiAgfVxuXG4gIHNldEN1cnJlbnRWYWx1ZSgpOiB2b2lkIHtcbiAgICB0aGlzLmN1cnJlbnRWYWx1ZSA9IHRoaXMuY29sdW1uTGlzdC5tYXAobGlzdEl0ZW0gPT4gbGlzdEl0ZW0uZmluZChvcHRpb25JdGVtID0+IG9wdGlvbkl0ZW0uYWN0aXZlKT8udmFsdWUpO1xuICB9XG5cbiAgdXBkYXRlT3B0aW9uQnlWYWx1ZSgpOiB2b2lkIHtcbiAgICB0aGlzLnJlc2V0Tm9kZVN0YXR1cygpO1xuICAgIHRoaXMuY29sdW1uTGlzdCA9IFt0aGlzLm9wdGlvbnNdO1xuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0aGlzLmN1cnJlbnRWYWx1ZS5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuY29sdW1uTGlzdFtpbmRleF0/LmZpbmQobGlzdEl0ZW0gPT4gbGlzdEl0ZW0udmFsdWUgPT09IHRoaXMuY3VycmVudFZhbHVlW2luZGV4XSk7XG5cbiAgICAgIGlmICh0YXJnZXQpIHtcbiAgICAgICAgdGFyZ2V0WydhY3RpdmUnXSA9IHRydWU7XG4gICAgICAgIGlmICh0YXJnZXQuY2hpbGRyZW4gJiYgdGFyZ2V0LmNoaWxkcmVuLmxlbmd0aCkgeyAvLyDmnInlrZDoj5zljZXlsZXlvIDlrZDoj5zljZVcbiAgICAgICAgICB0aGlzLmNvbHVtbkxpc3QucHVzaCh0YXJnZXQuY2hpbGRyZW4pO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNMYXp5TG9hZCkgeyAvLyDmh5LliqDovb3msqHmnInlrZDoj5zljZXnmoTmg4XlhrXkuIvvvIzpnZ7lj7blrZDoioLngrnmiafooYzlsZXlvIDvvIzlj7blrZDoioLngrnmiafooYzpgInkuK1cbiAgICAgICAgICB0aGlzLm9wZW5Db2x1bW4odGFyZ2V0LCBpbmRleCwgIXRhcmdldC5pc0xlYWYsICF0YXJnZXQuaXNMZWFmKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbGF6eWxvYWRNdWx0aXBsZUNoaWxkKHRhcmdldDogQ2FzY2FkZXJJdGVtLCBpbmRleDogbnVtYmVyKSB7XG4gICAgaWYgKCF0aGlzLmxhenlsb2FkQ2FjaGVbdGFyZ2V0LnZhbHVlXSkge1xuICAgICAgdGhpcy5sYXp5bG9hZENhY2hlW3RhcmdldC52YWx1ZV0gPSB0cnVlO1xuICAgICAgdGhpcy5vcGVuQ29sdW1uKHRhcmdldCwgaW5kZXgsIHRydWUsIHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIHJlc2V0Tm9kZVN0YXR1cyhvcHRpb246IENhc2NhZGVySXRlbVtdID0gdGhpcy5vcHRpb25zKTogdm9pZCB7XG4gICAgb3B0aW9uLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpdGVtWydhY3RpdmUnXSA9IGZhbHNlO1xuICAgICAgaXRlbVsnY2hlY2tlZCddID0gZmFsc2U7XG4gICAgICBpdGVtWydoYWxmQ2hlY2tlZCddID0gZmFsc2U7XG4gICAgICBpZiAoaXRlbS5jaGlsZHJlbikge1xuICAgICAgICB0aGlzLnJlc2V0Tm9kZVN0YXR1cyhpdGVtLmNoaWxkcmVuKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8vIOWcqOWkmumAieaooeW8j+S4i++8jOabtOaWsOiKgueCueagkeeahGNoZWNrZWTnirbmgIFcbiAgdXBkYXRlT3B0aW9uQ2hlY2tlZFN0YXR1cyh0YXJnZXRWYWx1ZTogc3RyaW5nIHwgbnVtYmVyLCBjaGVja2VkOiBib29sZWFuLCB1cHdhcmQgPSB0cnVlLCBkb3dud2FyZCA9IHRydWUsIGlzRW1pdCA9IHRydWUpOiB2b2lkIHtcbiAgICBsZXQgdGFyZ2V0Tm9kZSA9IHRoaXMub3B0aW9ucy5maW5kKHQgPT4gdC52YWx1ZSA9PT0gdGFyZ2V0VmFsdWUpO1xuICAgIC8vIOW9k+S4u+S4i+aLieWIl+ihqOWMheWQq+S6huebruagh++8jOWNs+ebruagh+aXoOeItuiKgueCuVxuICAgIGlmICh0YXJnZXROb2RlKSB7XG4gICAgICB0YXJnZXROb2RlWydjaGVja2VkJ10gPSBjaGVja2VkO1xuICAgICAgdGFyZ2V0Tm9kZVsnaGFsZkNoZWNrZWQnXSA9IGZhbHNlO1xuICAgICAgaWYgKHRhcmdldE5vZGUuY2hpbGRyZW4gJiYgZG93bndhcmQpIHtcbiAgICAgICAgdGhpcy51cGRhdGVDaGlsZHJlbkNoZWNrZWQodGFyZ2V0Tm9kZSwgY2hlY2tlZCwgaXNFbWl0KTtcbiAgICAgIH1cbiAgICB9IGVsc2UgeyAvLyDlvZPlrZjlnKjniLboioLngrnml7bvvIzpnIDopoHmo4Dmn6XlkIznuqfoioLngrnmnaXnoa7lrprniLboioLngrnnirbmgIFcbiAgICAgIGNvbnN0IHBhcmVudE5vZGUgPSB0aGlzLmdldFBhcmVudE5vZGUodGFyZ2V0VmFsdWUpO1xuICAgICAgdGFyZ2V0Tm9kZSA9IHBhcmVudE5vZGUuY2hpbGRyZW4uZmluZCh0ID0+IHQudmFsdWUgPT09IHRhcmdldFZhbHVlKTtcblxuICAgICAgdGFyZ2V0Tm9kZVsnY2hlY2tlZCddID0gY2hlY2tlZDtcbiAgICAgIHRhcmdldE5vZGVbJ2hhbGZDaGVja2VkJ10gPSBmYWxzZTtcbiAgICAgIGlmICh0YXJnZXROb2RlLmNoaWxkcmVuICYmIGRvd253YXJkKSB7XG4gICAgICAgIHRoaXMudXBkYXRlQ2hpbGRyZW5DaGVja2VkKHRhcmdldE5vZGUsIGNoZWNrZWQsIGlzRW1pdCk7XG4gICAgICB9XG4gICAgICBpZiAodXB3YXJkKSB7XG4gICAgICAgIHRoaXMudXBkYXRlUGFyZW50Q2hlY2tlZChwYXJlbnROb2RlLCBpc0VtaXQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIOWtkOiKgueCueaMieeItuiKgueCueeKtuaAgeabtOaWsFxuICB1cGRhdGVDaGlsZHJlbkNoZWNrZWQobm9kZTogQ2FzY2FkZXJJdGVtLCBjaGVja2VkOiBib29sZWFuLCBpc0VtaXQ6IGJvb2xlYW4pIHtcbiAgICBsZXQgaGFzRGlzYWJsZSA9IGZhbHNlO1xuICAgIG5vZGUuY2hpbGRyZW4uZm9yRWFjaChjaGlsZCA9PiB7XG4gICAgICBpZiAoIWNoaWxkLmRpc2FibGVkKSB7XG4gICAgICAgIGNoaWxkWydjaGVja2VkJ10gPSBjaGVja2VkO1xuICAgICAgICBjaGlsZFsnaGFsZkNoZWNrZWQnXSA9IGZhbHNlO1xuICAgICAgICBpZiAoY2hpbGQuY2hpbGRyZW4gJiYgY2hpbGQuY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgICAgaWYgKHRoaXMuY2FuU2VsZWN0UGFyZW50KSB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVRhZ0xpc3QubmV4dCh7XG4gICAgICAgICAgICAgIGlzQWRkOiBjaGVja2VkLFxuICAgICAgICAgICAgICBvcHRpb246IGNoaWxkLFxuICAgICAgICAgICAgICBpc0VtaXRcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLnVwZGF0ZUNoaWxkcmVuQ2hlY2tlZChjaGlsZCwgY2hlY2tlZCwgaXNFbWl0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLnVwZGF0ZVRhZ0xpc3QubmV4dCh7XG4gICAgICAgICAgICBpc0FkZDogY2hlY2tlZCxcbiAgICAgICAgICAgIG9wdGlvbjogY2hpbGQsXG4gICAgICAgICAgICBpc0VtaXRcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaGFzRGlzYWJsZSA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAoaGFzRGlzYWJsZSAmJiAhdGhpcy5jYW5TZWxlY3RQYXJlbnQpIHtcbiAgICAgIHRoaXMudXBkYXRlUGFyZW50Q2hlY2tlZChub2RlLCBpc0VtaXQpO1xuICAgIH1cbiAgfVxuXG4gIC8vIOeItuiKgueCueaMieaJgOacieWtkOiKgueCueeKtuaAgeabtOaWsFxuICB1cGRhdGVQYXJlbnRDaGVja2VkKG5vZGU6IENhc2NhZGVySXRlbSwgaXNFbWl0OiBib29sZWFuKSB7XG4gICAgY29uc3QgY2hlY2tlZENoaWxkID0gbm9kZS5jaGlsZHJlbi5maW5kKHQgPT4gdFsnY2hlY2tlZCddKTtcbiAgICBjb25zdCBoYWxmY2hlY2tlZENoaWxkID0gbm9kZS5jaGlsZHJlbi5maW5kKHQgPT4gdFsnaGFsZkNoZWNrZWQnXSk7XG4gICAgY29uc3QgdW5jaGVja2VkQ2hpbGQgPSBub2RlLmNoaWxkcmVuLmZpbmQodCA9PiAhdFsnaGFsZkNoZWNrZWQnXSAmJiAhdFsnY2hlY2tlZCddKTtcblxuICAgIGlmIChoYWxmY2hlY2tlZENoaWxkIHx8IChjaGVja2VkQ2hpbGQgJiYgdW5jaGVja2VkQ2hpbGQpKSB7XG4gICAgICBub2RlWydjaGVja2VkJ10gPSBmYWxzZTtcbiAgICAgIG5vZGVbJ2hhbGZDaGVja2VkJ10gPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAoIWNoZWNrZWRDaGlsZCAmJiAhaGFsZmNoZWNrZWRDaGlsZCkge1xuICAgICAgbm9kZVsnY2hlY2tlZCddID0gZmFsc2U7XG4gICAgICBub2RlWydoYWxmQ2hlY2tlZCddID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vZGVbJ2NoZWNrZWQnXSA9IHRydWU7XG4gICAgICBub2RlWydoYWxmQ2hlY2tlZCddID0gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY2FuU2VsZWN0UGFyZW50KSB7XG4gICAgICB0aGlzLnVwZGF0ZVRhZ0xpc3QubmV4dCh7XG4gICAgICAgIGlzQWRkOiBub2RlWydjaGVja2VkJ10sXG4gICAgICAgIG9wdGlvbjogbm9kZSxcbiAgICAgICAgaXNFbWl0XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyDlpoLmnpzmraToioLngrnpnZ7moLnoioLngrnvvIzliJnnu6fnu63mib7lroPnmoTniLboioLngrnov5vooYzmm7TmlrBcbiAgICBpZiAoIW5vZGVbJ2lzUm9vdCddKSB7XG4gICAgICB0aGlzLnVwZGF0ZVBhcmVudENoZWNrZWQodGhpcy5nZXRQYXJlbnROb2RlKG5vZGUudmFsdWUpLCBpc0VtaXQpO1xuICAgIH1cbiAgfVxuXG4gIC8vIOiOt+WPlueItuiKgueCuVxuICBnZXRQYXJlbnROb2RlKGNoaWxkVmFsdWU6IHN0cmluZyB8IG51bWJlcik6IENhc2NhZGVySXRlbSB7XG4gICAgY29uc3QgcXVldWUgPSBbLi4udGhpcy5vcHRpb25zXTtcbiAgICBsZXQgY3VyOiBDYXNjYWRlckl0ZW07XG4gICAgd2hpbGUgKHF1ZXVlLmxlbmd0aCkge1xuICAgICAgY3VyID0gcXVldWUuc2hpZnQoKTtcbiAgICAgIGlmIChjdXIuY2hpbGRyZW4gJiYgY3VyLmNoaWxkcmVuLmZpbmQodCA9PiB0LnZhbHVlID09PSBjaGlsZFZhbHVlKSkge1xuICAgICAgICBicmVhaztcbiAgICAgIH0gZWxzZSBpZiAoY3VyLmNoaWxkcmVuKSB7XG4gICAgICAgIHF1ZXVlLnB1c2goLi4uY3VyLmNoaWxkcmVuKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGN1cjtcbiAgfVxuXG4gIGdldE11bHRpcGxlVmFsdWUodmFsdWUsIG9wdGlvbjogQ2FzY2FkZXJJdGVtW10pOiB2b2lkIHtcbiAgICBvcHRpb24uZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGNvbnN0IF92YWx1ZSA9IFsuLi52YWx1ZV07XG4gICAgICBpZiAoaXRlbS5jaGlsZHJlbiAmJiBpdGVtLmNoaWxkcmVuLmxlbmd0aCAmJiAoaXRlbS5jaGVja2VkIHx8IGl0ZW0uaGFsZkNoZWNrZWQpKSB7XG4gICAgICAgIF92YWx1ZS5wdXNoKGl0ZW0udmFsdWUpO1xuICAgICAgICB0aGlzLmdldE11bHRpcGxlVmFsdWUoX3ZhbHVlLCBpdGVtLmNoaWxkcmVuKTtcbiAgICAgIH0gZWxzZSBpZiAoaXRlbS5jaGVja2VkKSB7XG4gICAgICAgIF92YWx1ZS5wdXNoKGl0ZW0udmFsdWUpO1xuICAgICAgICB0aGlzLm11bHRpcGxlVmFsdWUucHVzaChfdmFsdWUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgY2xvc2VBbGxEcm9wZG93bigpOiB2b2lkIHtcbiAgICB0aGlzLmNsb3NlTWlhbkRyb3Bkb3duLm5leHQoKTtcbiAgfVxuXG4gIC8vIOaQnOe0ouWKn+iDvVxuICBzZWFyY2hCeVN0cmluZyhzdHI6IHN0cmluZywgY3VycmVudGxhYmVsPzogc3RyaW5nLCBjdXJyZW50VmFsdWU6IEFycmF5PHN0cmluZyB8IG51bWJlcj4gPSBbXSwgbGlzdCA9IHRoaXMub3B0aW9ucyk6IHZvaWQge1xuICAgIGxpc3QuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGNvbnN0IGxhYmVsID0gY3VycmVudGxhYmVsID8gY3VycmVudGxhYmVsICsgJyAvICcgKyBpdGVtLmxhYmVsIDogaXRlbS5sYWJlbDtcbiAgICAgIGNvbnN0IHZhbHVlTGlzdCA9IFsuLi5jdXJyZW50VmFsdWUsIGl0ZW0udmFsdWVdO1xuICAgICAgaWYgKGl0ZW0uY2hpbGRyZW4gJiYgaXRlbS5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5zZWFyY2hCeVN0cmluZyhzdHIsIGxhYmVsLCB2YWx1ZUxpc3QsIGl0ZW0uY2hpbGRyZW4pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKCFpdGVtLmRpc2FibGVkICYmIGxhYmVsLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihzdHIudG9Mb3dlckNhc2UoKSkgIT09IC0xKSB7XG4gICAgICAgICAgdGhpcy5zZWFyY2hSZXN1bHRMaXN0LnB1c2goe1xuICAgICAgICAgICAgbGFiZWwsXG4gICAgICAgICAgICB2YWx1ZUxpc3QsXG4gICAgICAgICAgICBjaGVja2VkOiBpdGVtLmNoZWNrZWRcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5jbG9zZU1pYW5Ecm9wZG93bi5jb21wbGV0ZSgpO1xuICAgIHRoaXMuY3VycmVudFZhbHVlQ2hhbmdlLmNvbXBsZXRlKCk7XG4gICAgdGhpcy51cGRhdGVUYWdMaXN0LmNvbXBsZXRlKCk7XG4gICAgdGhpcy5yZXNldFN0YXR1cy5jb21wbGV0ZSgpO1xuICAgIHRoaXMub3BlbkRyYXdlci5jb21wbGV0ZSgpO1xuICB9XG5cbn1cbiJdfQ==