import { Directive, ElementRef, HostBinding, Injector, Input, TemplateRef, ViewContainerRef } from '@angular/core';
import { forkJoin, from, Observable, Subscription, throwError } from 'rxjs';
import { catchError } from 'rxjs/operators';
import { LoadingBackdropComponent } from './loading-backdrop.component';
import { LoadingComponent } from './loading.component';
import * as i0 from "@angular/core";
export class LoadingDirective {
    constructor(triggerElementRef, viewContainerRef, injector, elementRef) {
        this.triggerElementRef = triggerElementRef;
        this.viewContainerRef = viewContainerRef;
        this.injector = injector;
        this.elementRef = elementRef;
        this.active = true;
    }
    ngOnChanges(changes) {
        if (changes['showLoading'] || changes['loading'] || changes['backdrop'] || changes['loadingTemplateRef']
            || changes['message'] || changes['positionType'] || changes['view'] || changes['zIndex']) {
            if (this.showLoading !== undefined) {
                this.showLoadingChangeEvent(this.showLoading);
            }
            if (this.loading !== undefined) {
                this.loadingChangeEvent(this.loading);
            }
        }
    }
    loadingChangeEvent(loading) {
        if (loading instanceof Subscription) {
            this.startLoading();
            loading.add(() => this.endLoading());
            return;
        }
        const loadingArr = [].concat(loading).map(item => {
            if (item instanceof Observable) {
                return item;
            }
            return from(item);
        });
        if (loadingArr.length > 0) {
            this.startLoading();
            forkJoin(loadingArr)
                .pipe(catchError(error => {
                return throwError(error);
            }))
                .subscribe({
                next: null,
                error: () => {
                    this.endLoading();
                },
                complete: () => {
                    this.endLoading();
                }
            });
        }
    }
    showLoadingChangeEvent(showLoading) {
        if (showLoading === true) {
            this.startLoading();
        }
        else {
            this.endLoading();
        }
    }
    startLoading() {
        this.position = this.positionType || 'relative';
        if (this.backdrop && !this.backdropRef) {
            this.createLoadingBackdrop();
        }
        if (!this.backdrop && this.backdropRef) {
            this.backdropRef.destroy();
            this.backdropRef = null;
        }
        if (!this.loadingRef) {
            this.loadingRef = this.viewContainerRef.createComponent(LoadingComponent, {
                index: null,
                injector: this.injector,
            });
            this.insert(this.loadingRef.hostView);
        }
        Object.assign(this.loadingRef.instance, {
            message: this.message,
            loadingTemplateRef: this.loadingTemplateRef,
            top: this.view ? this.view.top : '50%',
            left: this.view ? this.view.left : '50%',
            isCustomPosition: !!this.view,
            zIndex: this.zIndex ? this.zIndex : '',
        });
    }
    endLoading() {
        if (this.loadingRef) {
            this.loadingRef.destroy();
            this.loadingRef = null;
        }
        if (this.backdropRef) {
            this.backdropRef.destroy();
            this.backdropRef = null;
        }
        this.position = '';
    }
    createLoadingBackdrop() {
        this.backdropRef =
            !this.backdropRef &&
                this.viewContainerRef.createComponent(LoadingBackdropComponent, {
                    index: null,
                    injector: this.injector,
                });
        this.insert(this.backdropRef.hostView);
        Object.assign(this.backdropRef.instance, {
            triggerElementRef: this.triggerElementRef,
            backdrop: this.backdrop,
            zIndex: this.zIndex ? this.zIndex : ''
        });
    }
    insert(viewRef) {
        viewRef.rootNodes.forEach(node => this.elementRef.nativeElement.appendChild(node));
        return viewRef;
    }
}
LoadingDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: LoadingDirective, deps: [{ token: i0.ElementRef }, { token: i0.ViewContainerRef }, { token: i0.Injector }, { token: i0.ElementRef }], target: i0.ɵɵFactoryTarget.Directive });
LoadingDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.3", type: LoadingDirective, selector: "[dLoading]", inputs: { message: "message", backdrop: "backdrop", loadingTemplateRef: "loadingTemplateRef", positionType: "positionType", view: "view", showLoading: "showLoading", loading: "loading", zIndex: "zIndex" }, host: { properties: { "style.position": "this.position" } }, exportAs: ["dLoading"], usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: LoadingDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[dLoading]',
                    exportAs: 'dLoading'
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.ViewContainerRef }, { type: i0.Injector }, { type: i0.ElementRef }]; }, propDecorators: { message: [{
                type: Input
            }], backdrop: [{
                type: Input
            }], loadingTemplateRef: [{
                type: Input
            }], positionType: [{
                type: Input
            }], view: [{
                type: Input
            }], position: [{
                type: HostBinding,
                args: ['style.position']
            }], showLoading: [{
                type: Input
            }], loading: [{
                type: Input
            }], zIndex: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9kZXZ1aS9sb2FkaW5nL2xvYWRpbmcuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxTQUFTLEVBQ1QsVUFBVSxFQUVWLFdBQVcsRUFDWCxRQUFRLEVBQ1IsS0FBSyxFQUdMLFdBQVcsRUFBRSxnQkFBZ0IsRUFDOUIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDNUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDOztBQU12RCxNQUFNLE9BQU8sZ0JBQWdCO0lBb0IzQixZQUNVLGlCQUE2QixFQUM3QixnQkFBa0MsRUFDbEMsUUFBa0IsRUFDbEIsVUFBc0I7UUFIdEIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFZO1FBQzdCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBTmhDLFdBQU0sR0FBRyxJQUFJLENBQUM7SUFPVixDQUFDO0lBQ0wsV0FBVyxDQUFDLE9BQXNCO1FBQ2hDLElBQUksT0FBTyxDQUFDLGFBQWEsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksT0FBTyxDQUFDLG9CQUFvQixDQUFDO2VBQ25HLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFLLE9B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VyxDQUFDLFFBQVEsRUFBRTtZQUN2QyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsaUJBQWlCO1lBQ3pDLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN2QixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRTtTQUN2QyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sTUFBTSxDQUFDLE9BQWdCO1FBQzVCLE9BQWdDLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzdHLE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7OzZHQS9JVSxnQkFBZ0I7aUdBQWhCLGdCQUFnQjsyRkFBaEIsZ0JBQWdCO2tCQUo1QixTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxZQUFZO29CQUN0QixRQUFRLEVBQUUsVUFBVTtpQkFDckI7Z0xBRVUsT0FBTztzQkFBZixLQUFLO2dCQUNHLFFBQVE7c0JBQWhCLEtBQUs7Z0JBQ0csa0JBQWtCO3NCQUExQixLQUFLO2dCQUNHLFlBQVk7c0JBQXBCLEtBQUs7Z0JBQ0csSUFBSTtzQkFBWixLQUFLO2dCQUtOLFFBQVE7c0JBRFAsV0FBVzt1QkFBQyxnQkFBZ0I7Z0JBR3BCLFdBQVc7c0JBQW5CLEtBQUs7Z0JBRUcsT0FBTztzQkFBZixLQUFLO2dCQUNHLE1BQU07c0JBQWQsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudFJlZixcbiAgRGlyZWN0aXZlLFxuICBFbGVtZW50UmVmLFxuICBFbWJlZGRlZFZpZXdSZWYsXG4gIEhvc3RCaW5kaW5nLFxuICBJbmplY3RvcixcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVGVtcGxhdGVSZWYsIFZpZXdDb250YWluZXJSZWYsIFZpZXdSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmb3JrSm9pbiwgZnJvbSwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTG9hZGluZ0JhY2tkcm9wQ29tcG9uZW50IH0gZnJvbSAnLi9sb2FkaW5nLWJhY2tkcm9wLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBMb2FkaW5nQ29tcG9uZW50IH0gZnJvbSAnLi9sb2FkaW5nLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBMb2FkaW5nVHlwZSB9IGZyb20gJy4vbG9hZGluZy50eXBlcyc7XG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbZExvYWRpbmddJyxcbiAgZXhwb3J0QXM6ICdkTG9hZGluZydcbn0pXG5leHBvcnQgY2xhc3MgTG9hZGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcyB7XG4gIEBJbnB1dCgpIG1lc3NhZ2U6IHN0cmluZztcbiAgQElucHV0KCkgYmFja2Ryb3A6IGJvb2xlYW47XG4gIEBJbnB1dCgpIGxvYWRpbmdUZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8YW55PjtcbiAgQElucHV0KCkgcG9zaXRpb25UeXBlOiBzdHJpbmc7XG4gIEBJbnB1dCgpIHZpZXc6IHtcbiAgICB0b3A/OiBzdHJpbmc7XG4gICAgbGVmdD86IHN0cmluZztcbiAgfTtcbiAgQEhvc3RCaW5kaW5nKCdzdHlsZS5wb3NpdGlvbicpXG4gIHBvc2l0aW9uOiBzdHJpbmc7XG5cbiAgQElucHV0KCkgc2hvd0xvYWRpbmc7XG5cbiAgQElucHV0KCkgbG9hZGluZzogTG9hZGluZ1R5cGU7XG4gIEBJbnB1dCgpIHpJbmRleDogbnVtYmVyIDtcbiAgYmFja2Ryb3BSZWY6IENvbXBvbmVudFJlZjxhbnk+O1xuICBsb2FkaW5nUmVmOiBDb21wb25lbnRSZWY8YW55PjtcbiAgYWN0aXZlID0gdHJ1ZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHRyaWdnZXJFbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICAgIHByaXZhdGUgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZixcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcbiAgICBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWZcbiAgKSB7IH1cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgIGlmIChjaGFuZ2VzWydzaG93TG9hZGluZyddIHx8IGNoYW5nZXNbJ2xvYWRpbmcnXSB8fCBjaGFuZ2VzWydiYWNrZHJvcCddIHx8IGNoYW5nZXNbJ2xvYWRpbmdUZW1wbGF0ZVJlZiddXG4gICAgICB8fCBjaGFuZ2VzWydtZXNzYWdlJ10gfHwgY2hhbmdlc1sncG9zaXRpb25UeXBlJ10gfHwgY2hhbmdlc1sndmlldyddICB8fCBjaGFuZ2VzWyd6SW5kZXgnXSkge1xuICAgICAgaWYgKHRoaXMuc2hvd0xvYWRpbmcgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLnNob3dMb2FkaW5nQ2hhbmdlRXZlbnQodGhpcy5zaG93TG9hZGluZyk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5sb2FkaW5nICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5sb2FkaW5nQ2hhbmdlRXZlbnQodGhpcy5sb2FkaW5nKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsb2FkaW5nQ2hhbmdlRXZlbnQobG9hZGluZykge1xuICAgIGlmIChsb2FkaW5nIGluc3RhbmNlb2YgU3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLnN0YXJ0TG9hZGluZygpO1xuICAgICAgbG9hZGluZy5hZGQoKCkgPT4gdGhpcy5lbmRMb2FkaW5nKCkpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBsb2FkaW5nQXJyID0gW10uY29uY2F0KGxvYWRpbmcpLm1hcChpdGVtID0+IHtcbiAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgT2JzZXJ2YWJsZSkge1xuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBmcm9tKGl0ZW0pO1xuICAgIH0pO1xuXG4gICAgaWYgKGxvYWRpbmdBcnIubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5zdGFydExvYWRpbmcoKTtcbiAgICAgIGZvcmtKb2luKGxvYWRpbmdBcnIpXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgICAgbmV4dDogbnVsbCxcbiAgICAgICAgICBlcnJvcjogKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5lbmRMb2FkaW5nKCk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBjb21wbGV0ZTogKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5lbmRMb2FkaW5nKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBzaG93TG9hZGluZ0NoYW5nZUV2ZW50KHNob3dMb2FkaW5nKSB7XG4gICAgaWYgKHNob3dMb2FkaW5nID09PSB0cnVlKSB7XG4gICAgICB0aGlzLnN0YXJ0TG9hZGluZygpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmVuZExvYWRpbmcoKTtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBzdGFydExvYWRpbmcoKSB7XG4gICAgdGhpcy5wb3NpdGlvbiA9IHRoaXMucG9zaXRpb25UeXBlIHx8ICdyZWxhdGl2ZSc7XG5cbiAgICBpZiAodGhpcy5iYWNrZHJvcCAmJiAhdGhpcy5iYWNrZHJvcFJlZikge1xuICAgICAgdGhpcy5jcmVhdGVMb2FkaW5nQmFja2Ryb3AoKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuYmFja2Ryb3AgJiYgdGhpcy5iYWNrZHJvcFJlZikge1xuICAgICAgdGhpcy5iYWNrZHJvcFJlZi5kZXN0cm95KCk7XG4gICAgICB0aGlzLmJhY2tkcm9wUmVmID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMubG9hZGluZ1JlZikge1xuICAgICAgdGhpcy5sb2FkaW5nUmVmID0gdGhpcy52aWV3Q29udGFpbmVyUmVmLmNyZWF0ZUNvbXBvbmVudChMb2FkaW5nQ29tcG9uZW50LCB7XG4gICAgICAgIGluZGV4OiBudWxsLFxuICAgICAgICBpbmplY3RvcjogdGhpcy5pbmplY3RvcixcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmluc2VydCh0aGlzLmxvYWRpbmdSZWYuaG9zdFZpZXcpO1xuICAgIH1cblxuICAgIE9iamVjdC5hc3NpZ24odGhpcy5sb2FkaW5nUmVmLmluc3RhbmNlLCB7XG4gICAgICBtZXNzYWdlOiB0aGlzLm1lc3NhZ2UsXG4gICAgICBsb2FkaW5nVGVtcGxhdGVSZWY6IHRoaXMubG9hZGluZ1RlbXBsYXRlUmVmLFxuICAgICAgdG9wOiB0aGlzLnZpZXcgPyB0aGlzLnZpZXcudG9wIDogJzUwJScsXG4gICAgICBsZWZ0OiB0aGlzLnZpZXcgPyB0aGlzLnZpZXcubGVmdCA6ICc1MCUnLFxuICAgICAgaXNDdXN0b21Qb3NpdGlvbjogISF0aGlzLnZpZXcsXG4gICAgICB6SW5kZXg6IHRoaXMuekluZGV4ID8gdGhpcy56SW5kZXggOiAnJyxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZW5kTG9hZGluZygpIHtcbiAgICBpZiAodGhpcy5sb2FkaW5nUmVmKSB7XG4gICAgICB0aGlzLmxvYWRpbmdSZWYuZGVzdHJveSgpO1xuICAgICAgdGhpcy5sb2FkaW5nUmVmID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5iYWNrZHJvcFJlZikge1xuICAgICAgdGhpcy5iYWNrZHJvcFJlZi5kZXN0cm95KCk7XG4gICAgICB0aGlzLmJhY2tkcm9wUmVmID0gbnVsbDtcbiAgICB9XG4gICAgdGhpcy5wb3NpdGlvbiA9ICcnO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVMb2FkaW5nQmFja2Ryb3AoKSB7XG4gICAgdGhpcy5iYWNrZHJvcFJlZiA9XG4gICAgICAhdGhpcy5iYWNrZHJvcFJlZiAmJlxuICAgICAgdGhpcy52aWV3Q29udGFpbmVyUmVmLmNyZWF0ZUNvbXBvbmVudChMb2FkaW5nQmFja2Ryb3BDb21wb25lbnQsIHtcbiAgICAgICAgaW5kZXg6IG51bGwsXG4gICAgICAgIGluamVjdG9yOiB0aGlzLmluamVjdG9yLFxuICAgICAgfSk7XG4gICAgdGhpcy5pbnNlcnQodGhpcy5iYWNrZHJvcFJlZi5ob3N0Vmlldyk7XG5cbiAgICBPYmplY3QuYXNzaWduKHRoaXMuYmFja2Ryb3BSZWYuaW5zdGFuY2UsIHtcbiAgICAgIHRyaWdnZXJFbGVtZW50UmVmOiB0aGlzLnRyaWdnZXJFbGVtZW50UmVmLFxuICAgICAgYmFja2Ryb3A6IHRoaXMuYmFja2Ryb3AsXG4gICAgICB6SW5kZXg6IHRoaXMuekluZGV4ID8gdGhpcy56SW5kZXggOiAnJ1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpbnNlcnQodmlld1JlZjogVmlld1JlZik6IFZpZXdSZWYge1xuICAgICh2aWV3UmVmIGFzIEVtYmVkZGVkVmlld1JlZjxhbnk+KS5yb290Tm9kZXMuZm9yRWFjaChub2RlID0+IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmFwcGVuZENoaWxkKG5vZGUpKTtcbiAgICByZXR1cm4gdmlld1JlZjtcbiAgfVxufVxuIl19