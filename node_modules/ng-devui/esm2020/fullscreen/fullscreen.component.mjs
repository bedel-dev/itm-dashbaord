import { DOCUMENT } from '@angular/common';
import { Component, ElementRef, EventEmitter, Inject, Input, Output } from '@angular/core';
import { DEFAULT_MODE, DEFAULT_ZINDEX, ESC_KEYCODE } from './fullscreen.config';
import * as i0 from "@angular/core";
export class FullscreenComponent {
    constructor(elementRef, doc) {
        this.elementRef = elementRef;
        this.doc = doc;
        this.isFullscreen = false;
        this.mode = DEFAULT_MODE;
        this.zIndex = DEFAULT_ZINDEX;
        this.fullscreenLaunch = new EventEmitter();
        this.onFullScreenChange = (event) => {
            if (this.currentTarget) {
                const targetElement = this.currentTarget;
                if (this.doc.fullscreenElement || this.doc.msFullscreenElement || this.doc.webkitFullscreenElement) { // 进入全屏
                    this.addFullScreenStyle();
                    this.launchNormalFullscreen(targetElement);
                }
                else { // 退出全屏
                    this.removeFullScreenStyle();
                    this.currentTarget = null;
                    this.exitNormalFullscreen(targetElement);
                }
                // F11退出全屏时，需要将全屏状态传出去
                const isFullscreen = !!(this.doc.fullscreenElement || this.doc.msFullscreenElement || this.doc.webkitFullscreenElement);
                this.fullscreenLaunch.emit({
                    isFullscreen
                });
                this.isFullscreen = isFullscreen;
            }
        };
        this.handleFullscreen = async () => {
            const targetElement = this.elementRef.nativeElement.querySelector('[fullscreen-target]');
            let isFullscreen;
            if (this.mode === 'normal') {
                const fullscreen = targetElement.classList.contains('fullscreen');
                if (!fullscreen) { // 进入全屏
                    this.addFullScreenStyle();
                    this.launchNormalFullscreen(targetElement);
                    isFullscreen = true;
                }
                else { // 退出全屏
                    this.removeFullScreenStyle();
                    this.exitNormalFullscreen(targetElement);
                    isFullscreen = false;
                }
            }
            else {
                this.currentTarget = targetElement;
                if (this.doc.fullscreenElement || this.doc.msFullscreenElement || this.doc.webkitFullscreenElement) {
                    isFullscreen = await this.exitImmersiveFullScreen(this.doc);
                }
                else {
                    isFullscreen = await this.launchImmersiveFullScreen(this.doc.documentElement);
                }
            }
            this.isFullscreen = isFullscreen;
            this.fullscreenLaunch.emit({
                isFullscreen
            });
        };
        this.handleKeyDown = (event) => {
            if (event.keyCode === ESC_KEYCODE) { // 按ESC键退出全屏
                if (this.isFullscreen) {
                    const targetElement = this.elementRef.nativeElement.querySelector('[fullscreen-target]');
                    if (this.mode === 'normal') {
                        this.removeFullScreenStyle();
                        this.exitNormalFullscreen(targetElement);
                    }
                    else {
                        if (this.doc.fullscreenElement) {
                            this.exitImmersiveFullScreen(this.doc);
                        }
                    }
                    this.fullscreenLaunch.emit({
                        isFullscreen: false
                    });
                    this.isFullscreen = false;
                }
            }
        };
        this.document = this.doc;
    }
    ngOnInit() {
        this.document.addEventListener('fullscreenchange', this.onFullScreenChange);
        this.document.addEventListener('MSFullscreenChange', this.onFullScreenChange);
        this.document.addEventListener('webkitfullscreenchange', this.onFullScreenChange);
        this.document.addEventListener('keydown', this.handleKeyDown);
    }
    ngAfterViewInit() {
        const btnLaunch = this.elementRef.nativeElement.querySelector('[fullscreen-launch]');
        if (btnLaunch) {
            btnLaunch.addEventListener('click', this.handleFullscreen);
        }
    }
    launchNormalFullscreen(targetElement) {
        targetElement.classList.add('fullscreen');
        if (this.zIndex) {
            targetElement.setAttribute('style', `z-index: ${this.zIndex}`);
        }
    }
    exitNormalFullscreen(targetElement) {
        targetElement.classList.remove('fullscreen');
        targetElement.style.zIndex = null;
    }
    async launchImmersiveFullScreen(docElement) {
        let fullscreenLaunch;
        if (docElement.requestFullscreen) {
            fullscreenLaunch = docElement.requestFullscreen();
        }
        else if (docElement.mozRequestFullScreen) {
            fullscreenLaunch = docElement.mozRequestFullScreen();
        }
        else if (docElement.webkitRequestFullScreen) {
            fullscreenLaunch = Promise.resolve(docElement.webkitRequestFullScreen());
        }
        else if (docElement.msRequestFullscreen) {
            fullscreenLaunch = Promise.resolve(docElement.msRequestFullscreen());
        }
        return await fullscreenLaunch.then(() => !!this.doc.fullscreenElement);
    }
    async exitImmersiveFullScreen(doc) {
        let fullscreenExit;
        if (doc.exitFullscreen) {
            fullscreenExit = doc.exitFullscreen();
        }
        else if (doc.mozCancelFullScreen) {
            fullscreenExit = doc.mozCancelFullScreen();
        }
        else if (doc.webkitCancelFullScreen) {
            fullscreenExit = Promise.resolve(doc.webkitCancelFullScreen());
        }
        else if (doc.msExitFullscreen) {
            fullscreenExit = Promise.resolve(doc.msExitFullscreen());
        }
        return await fullscreenExit.then(() => !!this.doc.fullscreenElement);
    }
    ngOnDestroy() {
        this.document.removeEventListener('fullscreenchange', this.onFullScreenChange);
        this.document.removeEventListener('MSFullscreenChange', this.onFullScreenChange);
        this.document.removeEventListener('webkitfullscreenchange', this.onFullScreenChange);
        this.document.removeEventListener('keydown', this.handleKeyDown);
        const btnLaunch = this.elementRef.nativeElement.querySelector('[fullscreen-launch]');
        if (btnLaunch) {
            btnLaunch.removeEventListener('click', this.handleFullscreen);
        }
    }
    addFullScreenStyle() {
        this.document.getElementsByTagName('html')[0].classList.add('devui-fullscreen');
    }
    removeFullScreenStyle() {
        this.document.getElementsByTagName('html')[0].classList.remove('devui-fullscreen');
    }
}
FullscreenComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: FullscreenComponent, deps: [{ token: i0.ElementRef }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Component });
FullscreenComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.1.3", type: FullscreenComponent, selector: "d-fullscreen", inputs: { mode: "mode", zIndex: "zIndex", target: "target" }, outputs: { fullscreenLaunch: "fullscreenLaunch" }, ngImport: i0, template: "<div class=\"fullscreen-container\">\n  <ng-content select=\"[fullscreen-launch]\"></ng-content>\n  <ng-content select=\"[fullscreen-target]\"></ng-content>\n</div>\n", styles: [":host ::ng-deep .fullscreen{position:fixed;top:0;left:0;width:100%;height:100%;z-index:10;overflow:auto;background-color:#fff;background-color:var(--devui-base-bg, #ffffff)}::ng-deep .devui-fullscreen{overflow:hidden}\n"] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: FullscreenComponent, decorators: [{
            type: Component,
            args: [{ selector: 'd-fullscreen', preserveWhitespaces: false, template: "<div class=\"fullscreen-container\">\n  <ng-content select=\"[fullscreen-launch]\"></ng-content>\n  <ng-content select=\"[fullscreen-target]\"></ng-content>\n</div>\n", styles: [":host ::ng-deep .fullscreen{position:fixed;top:0;left:0;width:100%;height:100%;z-index:10;overflow:auto;background-color:#fff;background-color:var(--devui-base-bg, #ffffff)}::ng-deep .devui-fullscreen{overflow:hidden}\n"] }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; }, propDecorators: { mode: [{
                type: Input
            }], zIndex: [{
                type: Input
            }], target: [{
                type: Input
            }], fullscreenLaunch: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVsbHNjcmVlbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9kZXZ1aS9mdWxsc2NyZWVuL2Z1bGxzY3JlZW4uY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vZGV2dWkvZnVsbHNjcmVlbi9mdWxsc2NyZWVuLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQWlCLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQXFCLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3SCxPQUFPLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7QUFTaEYsTUFBTSxPQUFPLG1CQUFtQjtJQWM5QixZQUNVLFVBQXNCLEVBQ0osR0FBUTtRQUQxQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ0osUUFBRyxHQUFILEdBQUcsQ0FBSztRQWQ1QixpQkFBWSxHQUFHLEtBQUssQ0FBQztRQUVwQixTQUFJLEdBQW1CLFlBQVksQ0FBQztRQUNwQyxXQUFNLEdBQUcsY0FBYyxDQUFDO1FBTXZCLHFCQUFnQixHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBOERoRSx1QkFBa0IsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ3JDLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtnQkFDdEIsTUFBTSxhQUFhLEdBQWdCLElBQUksQ0FBQyxhQUFhLENBQUM7Z0JBQ3RELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsdUJBQXVCLEVBQUUsRUFBRSxPQUFPO29CQUMzRyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztvQkFDMUIsSUFBSSxD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LE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUNsRixDQUFDO0lBRU8scUJBQXFCO1FBQzNCLElBQUksQ0FBQyxRQUFRLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQ3JGLENBQUM7O2dIQTNKVSxtQkFBbUIsNENBZ0JwQixRQUFRO29HQWhCUCxtQkFBbUIscUtDWGhDLHdLQUlBOzJGRE9hLG1CQUFtQjtrQkFOL0IsU0FBUzsrQkFDRSxjQUFjLHVCQUdILEtBQUs7OzBCQWtCdkIsTUFBTTsyQkFBQyxRQUFROzRDQVpULElBQUk7c0JBQVosS0FBSztnQkFDRyxNQUFNO3NCQUFkLEtBQUs7Z0JBSUcsTUFBTTtzQkFBZCxLQUFLO2dCQUVJLGdCQUFnQjtzQkFBekIsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEFmdGVyVmlld0luaXQsIENvbXBvbmVudCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbmplY3QsIElucHV0LCBPbkRlc3Ryb3ksIE9uSW5pdCwgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBERUZBVUxUX01PREUsIERFRkFVTFRfWklOREVYLCBFU0NfS0VZQ09ERSB9IGZyb20gJy4vZnVsbHNjcmVlbi5jb25maWcnO1xuaW1wb3J0IHsgRnVsbHNjcmVlbk1vZGUgfSBmcm9tICcuL2Z1bGxzY3JlZW4udHlwZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2QtZnVsbHNjcmVlbicsXG4gIHRlbXBsYXRlVXJsOiAnLi9mdWxsc2NyZWVuLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbICcuL2Z1bGxzY3JlZW4uY29tcG9uZW50LnNjc3MnIF0sXG4gIHByZXNlcnZlV2hpdGVzcGFjZXM6IGZhbHNlLFxufSlcbmV4cG9ydCBjbGFzcyBGdWxsc2NyZWVuQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQge1xuICBwcml2YXRlIGN1cnJlbnRUYXJnZXQ6IEhUTUxFbGVtZW50O1xuICBwcml2YXRlIGlzRnVsbHNjcmVlbiA9IGZhbHNlO1xuXG4gIEBJbnB1dCgpIG1vZGU6IEZ1bGxzY3JlZW5Nb2RlID0gREVGQVVMVF9NT0RFO1xuICBASW5wdXQoKSB6SW5kZXggPSBERUZBVUxUX1pJTkRFWDtcbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBASW5wdXQoKSB0YXJnZXQ6IEhUTUxFbGVtZW50O1xuXG4gIEBPdXRwdXQoKSBmdWxsc2NyZWVuTGF1bmNoOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBkb2N1bWVudDogRG9jdW1lbnQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgZG9jOiBhbnlcbiAgKSB7XG4gICAgdGhpcy5kb2N1bWVudCA9IHRoaXMuZG9jO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdmdWxsc2NyZWVuY2hhbmdlJywgdGhpcy5vbkZ1bGxTY3JlZW5DaGFuZ2UpO1xuICAgIHRoaXMuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignTVNGdWxsc2NyZWVuQ2hhbmdlJywgdGhpcy5vbkZ1bGxTY3JlZW5DaGFuZ2UpO1xuICAgIHRoaXMuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignd2Via2l0ZnVsbHNjcmVlbmNoYW5nZScsIHRoaXMub25GdWxsU2NyZWVuQ2hhbmdlKTtcbiAgICB0aGlzLmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLmhhbmRsZUtleURvd24pO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIGNvbnN0IGJ0bkxhdW5jaCA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tmdWxsc2NyZWVuLWxhdW5jaF0nKTtcbiAgICBpZiAoYnRuTGF1bmNoKSB7IGJ0bkxhdW5jaC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuaGFuZGxlRnVsbHNjcmVlbik7IH1cbiAgfVxuXG4gIHByaXZhdGUgbGF1bmNoTm9ybWFsRnVsbHNjcmVlbih0YXJnZXRFbGVtZW50OiBIVE1MRWxlbWVudCkge1xuICAgIHRhcmdldEVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnZnVsbHNjcmVlbicpO1xuICAgIGlmICh0aGlzLnpJbmRleCkge1xuICAgICAgdGFyZ2V0RWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgYHotaW5kZXg6ICR7dGhpcy56SW5kZXh9YCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBleGl0Tm9ybWFsRnVsbHNjcmVlbih0YXJnZXRFbGVtZW50OiBIVE1MRWxlbWVudCkge1xuICAgIHRhcmdldEVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSgnZnVsbHNjcmVlbicpO1xuICAgIHRhcmdldEVsZW1lbnQuc3R5bGUuekluZGV4ID0gbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbGF1bmNoSW1tZXJzaXZlRnVsbFNjcmVlbihkb2NFbGVtZW50OiBhbnkpIHtcbiAgICBsZXQgZnVsbHNjcmVlbkxhdW5jaDtcbiAgICBpZiAoZG9jRWxlbWVudC5yZXF1ZXN0RnVsbHNjcmVlbikge1xuICAgICAgZnVsbHNjcmVlbkxhdW5jaCA9IGRvY0VsZW1lbnQucmVxdWVzdEZ1bGxzY3JlZW4oKTtcbiAgICB9IGVsc2UgaWYgKGRvY0VsZW1lbnQubW96UmVxdWVzdEZ1bGxTY3JlZW4pIHtcbiAgICAgIGZ1bGxzY3JlZW5MYXVuY2ggPSBkb2NFbGVtZW50Lm1velJlcXVlc3RGdWxsU2NyZWVuKCk7XG4gICAgfSBlbHNlIGlmIChkb2NFbGVtZW50LndlYmtpdFJlcXVlc3RGdWxsU2NyZWVuKSB7XG4gICAgICBmdWxsc2NyZWVuTGF1bmNoID0gUHJvbWlzZS5yZXNvbHZlKGRvY0VsZW1lbnQud2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4oKSk7XG4gICAgfSBlbHNlIGlmIChkb2NFbGVtZW50Lm1zUmVxdWVzdEZ1bGxzY3JlZW4pIHtcbiAgICAgIGZ1bGxzY3JlZW5MYXVuY2ggPSBQcm9taXNlLnJlc29sdmUoZG9jRWxlbWVudC5tc1JlcXVlc3RGdWxsc2NyZWVuKCkpO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgZnVsbHNjcmVlbkxhdW5jaC50aGVuKCgpID0+ICEhdGhpcy5kb2MuZnVsbHNjcmVlbkVsZW1lbnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBleGl0SW1tZXJzaXZlRnVsbFNjcmVlbihkb2M6IGFueSkge1xuICAgIGxldCBmdWxsc2NyZWVuRXhpdDtcbiAgICBpZiAoZG9jLmV4aXRGdWxsc2NyZWVuKSB7XG4gICAgICBmdWxsc2NyZWVuRXhpdCA9IGRvYy5leGl0RnVsbHNjcmVlbigpO1xuICAgIH0gZWxzZSBpZiAoZG9jLm1vekNhbmNlbEZ1bGxTY3JlZW4pIHtcbiAgICAgIGZ1bGxzY3JlZW5FeGl0ID0gZG9jLm1vekNhbmNlbEZ1bGxTY3JlZW4oKTtcbiAgICB9IGVsc2UgaWYgKGRvYy53ZWJraXRDYW5jZWxGdWxsU2NyZWVuKSB7XG4gICAgICBmdWxsc2NyZWVuRXhpdCA9IFByb21pc2UucmVzb2x2ZShkb2Mud2Via2l0Q2FuY2VsRnVsbFNjcmVlbigpKTtcbiAgICB9IGVsc2UgaWYgKGRvYy5tc0V4aXRGdWxsc2NyZWVuKSB7XG4gICAgICBmdWxsc2NyZWVuRXhpdCA9IFByb21pc2UucmVzb2x2ZShkb2MubXNFeGl0RnVsbHNjcmVlbigpKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IGZ1bGxzY3JlZW5FeGl0LnRoZW4oKCkgPT4gISF0aGlzLmRvYy5mdWxsc2NyZWVuRWxlbWVudCk7XG4gIH1cblxuICBwcml2YXRlIG9uRnVsbFNjcmVlbkNoYW5nZSA9IChldmVudCkgPT4ge1xuICAgIGlmICh0aGlzLmN1cnJlbnRUYXJnZXQpIHtcbiAgICAgIGNvbnN0IHRhcmdldEVsZW1lbnQ6IEhUTUxFbGVtZW50ID0gdGhpcy5jdXJyZW50VGFyZ2V0O1xuICAgICAgaWYgKHRoaXMuZG9jLmZ1bGxzY3JlZW5FbGVtZW50IHx8IHRoaXMuZG9jLm1zRnVsbHNjcmVlbkVsZW1lbnQgfHwgdGhpcy5kb2Mud2Via2l0RnVsbHNjcmVlbkVsZW1lbnQpIHsgLy8g6L+b5YWl5YWo5bGPXG4gICAgICAgIHRoaXMuYWRkRnVsbFNjcmVlblN0eWxlKCk7XG4gICAgICAgIHRoaXMubGF1bmNoTm9ybWFsRnVsbHNjcmVlbih0YXJnZXRFbGVtZW50KTtcbiAgICAgIH0gZWxzZSB7IC8vIOmAgOWHuuWFqOWxj1xuICAgICAgICB0aGlzLnJlbW92ZUZ1bGxTY3JlZW5TdHlsZSgpO1xuICAgICAgICB0aGlzLmN1cnJlbnRUYXJnZXQgPSBudWxsO1xuICAgICAgICB0aGlzLmV4aXROb3JtYWxGdWxsc2NyZWVuKHRhcmdldEVsZW1lbnQpO1xuICAgICAgfVxuICAgICAgLy8gRjEx6YCA5Ye65YWo5bGP5pe277yM6ZyA6KaB5bCG5YWo5bGP54q25oCB5Lyg5Ye65Y67XG4gICAgICBjb25zdCBpc0Z1bGxzY3JlZW4gPSAhISh0aGlzLmRvYy5mdWxsc2NyZWVuRWxlbWVudCB8fCB0aGlzLmRvYy5tc0Z1bGxzY3JlZW5FbGVtZW50IHx8IHRoaXMuZG9jLndlYmtpdEZ1bGxzY3JlZW5FbGVtZW50KTtcbiAgICAgIHRoaXMuZnVsbHNjcmVlbkxhdW5jaC5lbWl0KHtcbiAgICAgICAgaXNGdWxsc2NyZWVuXG4gICAgICB9KTtcbiAgICAgIHRoaXMuaXNGdWxsc2NyZWVuID0gaXNGdWxsc2NyZWVuO1xuICAgIH1cbiAgfTtcblxuICBwdWJsaWMgaGFuZGxlRnVsbHNjcmVlbiA9IGFzeW5jICgpID0+IHtcbiAgICBjb25zdCB0YXJnZXRFbGVtZW50ID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignW2Z1bGxzY3JlZW4tdGFyZ2V0XScpO1xuICAgIGxldCBpc0Z1bGxzY3JlZW47XG4gICAgaWYgKHRoaXMubW9kZSA9PT0gJ25vcm1hbCcpIHtcbiAgICAgIGNvbnN0IGZ1bGxzY3JlZW4gPSB0YXJnZXRFbGVtZW50LmNsYXNzTGlzdC5jb250YWlucygnZnVsbHNjcmVlbicpO1xuICAgICAgaWYgKCFmdWxsc2NyZWVuKSB7IC8vIOi/m+WFpeWFqOWxj1xuICAgICAgICB0aGlzLmFkZEZ1bGxTY3JlZW5TdHlsZSgpO1xuICAgICAgICB0aGlzLmxhdW5jaE5vcm1hbEZ1bGxzY3JlZW4odGFyZ2V0RWxlbWVudCk7XG4gICAgICAgIGlzRnVsbHNjcmVlbiA9IHRydWU7XG4gICAgICB9IGVsc2UgeyAvLyDpgIDlh7rlhajlsY9cbiAgICAgICAgdGhpcy5yZW1vdmVGdWxsU2NyZWVuU3R5bGUoKTtcbiAgICAgICAgdGhpcy5leGl0Tm9ybWFsRnVsbHNjcmVlbih0YXJnZXRFbGVtZW50KTtcbiAgICAgICAgaXNGdWxsc2NyZWVuID0gZmFsc2U7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3VycmVudFRhcmdldCA9IHRhcmdldEVsZW1lbnQ7XG4gICAgICBpZiAodGhpcy5kb2MuZnVsbHNjcmVlbkVsZW1lbnQgfHwgdGhpcy5kb2MubXNGdWxsc2NyZWVuRWxlbWVudCB8fCB0aGlzLmRvYy53ZWJraXRGdWxsc2NyZWVuRWxlbWVudCkge1xuICAgICAgICBpc0Z1bGxzY3JlZW4gPSBhd2FpdCB0aGlzLmV4aXRJbW1lcnNpdmVGdWxsU2NyZWVuKHRoaXMuZG9jKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlzRnVsbHNjcmVlbiA9IGF3YWl0IHRoaXMubGF1bmNoSW1tZXJzaXZlRnVsbFNjcmVlbih0aGlzLmRvYy5kb2N1bWVudEVsZW1lbnQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuaXNGdWxsc2NyZWVuID0gaXNGdWxsc2NyZWVuO1xuICAgIHRoaXMuZnVsbHNjcmVlbkxhdW5jaC5lbWl0KHtcbiAgICAgIGlzRnVsbHNjcmVlblxuICAgIH0pO1xuICB9O1xuXG4gIHByaXZhdGUgaGFuZGxlS2V5RG93biA9IChldmVudCkgPT4ge1xuICAgIGlmIChldmVudC5rZXlDb2RlID09PSBFU0NfS0VZQ09ERSkgeyAvLyDmjIlFU0PplK7pgIDlh7rlhajlsY9cbiAgICAgIGlmICh0aGlzLmlzRnVsbHNjcmVlbikge1xuICAgICAgICBjb25zdCB0YXJnZXRFbGVtZW50ID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignW2Z1bGxzY3JlZW4tdGFyZ2V0XScpO1xuICAgICAgICBpZiAodGhpcy5tb2RlID09PSAnbm9ybWFsJykge1xuICAgICAgICAgIHRoaXMucmVtb3ZlRnVsbFNjcmVlblN0eWxlKCk7XG4gICAgICAgICAgdGhpcy5leGl0Tm9ybWFsRnVsbHNjcmVlbih0YXJnZXRFbGVtZW50KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodGhpcy5kb2MuZnVsbHNjcmVlbkVsZW1lbnQpIHsgdGhpcy5leGl0SW1tZXJzaXZlRnVsbFNjcmVlbih0aGlzLmRvYyk7IH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLmZ1bGxzY3JlZW5MYXVuY2guZW1pdCh7XG4gICAgICAgICAgaXNGdWxsc2NyZWVuOiBmYWxzZVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5pc0Z1bGxzY3JlZW4gPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdmdWxsc2NyZWVuY2hhbmdlJywgdGhpcy5vbkZ1bGxTY3JlZW5DaGFuZ2UpO1xuICAgIHRoaXMuZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignTVNGdWxsc2NyZWVuQ2hhbmdlJywgdGhpcy5vbkZ1bGxTY3JlZW5DaGFuZ2UpO1xuICAgIHRoaXMuZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignd2Via2l0ZnVsbHNjcmVlbmNoYW5nZScsIHRoaXMub25GdWxsU2NyZWVuQ2hhbmdlKTtcbiAgICB0aGlzLmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLmhhbmRsZUtleURvd24pO1xuICAgIGNvbnN0IGJ0bkxhdW5jaCA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tmdWxsc2NyZWVuLWxhdW5jaF0nKTtcbiAgICBpZiAoYnRuTGF1bmNoKSB7IGJ0bkxhdW5jaC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuaGFuZGxlRnVsbHNjcmVlbik7IH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkRnVsbFNjcmVlblN0eWxlKCkge1xuICAgIHRoaXMuZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2h0bWwnKVswXS5jbGFzc0xpc3QuYWRkKCdkZXZ1aS1mdWxsc2NyZWVuJyk7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUZ1bGxTY3JlZW5TdHlsZSgpIHtcbiAgICB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdodG1sJylbMF0uY2xhc3NMaXN0LnJlbW92ZSgnZGV2dWktZnVsbHNjcmVlbicpO1xuICB9XG59XG4iLCI8ZGl2IGNsYXNzPVwiZnVsbHNjcmVlbi1jb250YWluZXJcIj5cbiAgPG5nLWNvbnRlbnQgc2VsZWN0PVwiW2Z1bGxzY3JlZW4tbGF1bmNoXVwiPjwvbmctY29udGVudD5cbiAgPG5nLWNvbnRlbnQgc2VsZWN0PVwiW2Z1bGxzY3JlZW4tdGFyZ2V0XVwiPjwvbmctY29udGVudD5cbjwvZGl2PlxuIl19