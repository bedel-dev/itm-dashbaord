import { DOCUMENT } from '@angular/common';
import { ComponentFactoryResolver, Inject, Injectable, RendererFactory2 } from '@angular/core';
import { OverlayContainerRef } from 'ng-devui/overlay-container';
import { DevConfigService } from 'ng-devui/utils';
import { assign, isUndefined } from 'lodash-es';
import { ModalContainerComponent } from './modal-container.component';
import { ModalComponent } from './modal.component';
import * as i0 from "@angular/core";
import * as i1 from "ng-devui/overlay-container";
import * as i2 from "ng-devui/utils";
export class DialogService {
    constructor(componentFactoryResolver, overlayContainerRef, rendererFactory, devConfigService, doc) {
        this.componentFactoryResolver = componentFactoryResolver;
        this.overlayContainerRef = overlayContainerRef;
        this.rendererFactory = rendererFactory;
        this.devConfigService = devConfigService;
        this.doc = doc;
        this.renderer = this.rendererFactory.createRenderer(null, null);
        this.document = this.doc;
    }
    open({ id, width, zIndex, backDropZIndex, backdropCloseable, maxHeight, showAnimation, 
    /**
     * @deprecated
     */
    showAnimate, title, content, html, data, buttons, injector, componentFactoryResolver, beforeHidden, onClose, dialogtype = 'standard', showCloseBtn = true, draggable = true, placement = 'center', offsetX, offsetY, bodyScrollable = true, contentTemplate, escapable = true }) {
        const finalComponentFactoryResolver = componentFactoryResolver || this.componentFactoryResolver;
        const modalRef = this.overlayContainerRef.createComponent(finalComponentFactoryResolver.resolveComponentFactory(ModalComponent), injector);
        let showAnimateValue = true;
        const componentConfig = this.devConfigService.getConfigForComponent('modal') || {};
        const configValue = componentConfig['showAnimation'];
        const apiConfig = this.devConfigService.getConfigForApi('showAnimation');
        if (configValue !== undefined) {
            showAnimateValue = configValue;
        }
        else if (apiConfig !== undefined) {
            showAnimateValue = apiConfig;
        }
        if (showAnimation === undefined) {
            if (showAnimate !== undefined) {
                showAnimation = showAnimate;
            }
            else {
                showAnimation = showAnimateValue;
            }
        }
        assign(modalRef.instance, {
            id,
            width,
            zIndex,
            backDropZIndex,
            showAnimation,
            beforeHidden,
            // set backdropCloseable default value "true" when not passing it
            backdropCloseable: isUndefined(backdropCloseable) ? true : backdropCloseable,
            draggable,
            placement,
            offsetX,
            offsetY,
            bodyScrollable,
            escapable
        });
        const modalContainerRef = modalRef.instance.modalContainerHost.viewContainerRef
            .createComponent(finalComponentFactoryResolver.resolveComponentFactory(ModalContainerComponent), 0, injector);
        assign(modalContainerRef.instance, { title, buttons, maxHeight, dialogtype, showCloseBtn });
        if (contentTemplate) {
            assign(modalContainerRef.instance, { contentTemplate });
        }
        else {
            if (typeof content === 'string') {
                assign(modalContainerRef.instance, { content, html });
            }
            else {
                this.contentRef = modalContainerRef.instance.modalContentHost.viewContainerRef
                    .createComponent(finalComponentFactoryResolver.resolveComponentFactory(content));
                assign(this.contentRef.instance, { data, dialogtype });
            }
        }
        modalContainerRef.instance.onClose = () => {
            modalRef.instance.hide();
        };
        modalRef.instance.updateButtonOptions = buttonOptions => modalContainerRef.instance.updateButtonOptions(buttonOptions);
        modalRef.instance.onHidden = () => {
            if (modalRef.instance.documentOverFlow) {
                this.renderer.removeStyle(this.document.body, 'top');
                this.renderer.removeStyle(this.document.body, 'left');
                this.renderer.removeClass(this.document.body, 'devui-body-scrollblock');
                this.renderer.removeClass(this.document.body, 'devui-body-overflow-hidden');
                this.document.documentElement.scrollTop = modalRef.instance.scrollTop;
                this.document.body.scrollTop = modalRef.instance.scrollTop;
                this.document.documentElement.scrollLeft = modalRef.instance.scrollLeft;
                this.document.body.scrollLeft = modalRef.instance.scrollLeft;
            }
            if (onClose) {
                onClose();
            }
            setTimeout(() => {
                modalRef.hostView.destroy();
            });
        };
        modalRef.instance.show();
        return {
            modalInstance: modalRef.instance,
            modalContentInstance: this.contentRef ? this.contentRef.instance : null,
        };
    }
}
DialogService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DialogService, deps: [{ token: i0.ComponentFactoryResolver }, { token: i1.OverlayContainerRef }, { token: i0.RendererFactory2 }, { token: i2.DevConfigService }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Injectable });
DialogService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DialogService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: DialogService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i0.ComponentFactoryResolver }, { type: i1.OverlayContainerRef }, { type: i0.RendererFactory2 }, { type: i2.DevConfigService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9nLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9kZXZ1aS9tb2RhbC9kaWFsb2cuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUNMLHdCQUF3QixFQUV4QixNQUFNLEVBQ04sVUFBVSxFQUNDLGdCQUFnQixFQUM1QixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNoRCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7Ozs7QUFJbkQsTUFBTSxPQUFPLGFBQWE7SUFLeEIsWUFBb0Isd0JBQWtELEVBQ2xELG1CQUF3QyxFQUFVLGVBQWlDLEVBQ25GLGdCQUFrQyxFQUNoQixHQUFRO1FBSDFCLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUFVLG9CQUFlLEdBQWYsZUFBZSxDQUFrQjtRQUNuRixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2hCLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFDNUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQzNCLENBQUM7SUFFRCxJQUFJLENBQUMsRUFDSCxFQUFFLEVBQ0YsS0FBSyxFQUNMLE1B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QUMsU0FBUyxDQUFDO2dCQUMzRCxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxVQUFVLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUM7Z0JBQ3hFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQzthQUM5RDtZQUNELElBQUksT0FBTyxFQUFFO2dCQUNYLE9BQU8sRUFBRSxDQUFDO2FBQ1g7WUFDRCxVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUNkLFFBQVEsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDOUIsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7UUFFRixRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXpCLE9BQU87WUFDTCxhQUFhLEVBQUUsUUFBUSxDQUFDLFFBQVE7WUFDaEMsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUk7U0FDeEUsQ0FBQztJQUNKLENBQUM7OzBHQW5JVSxhQUFhLDZKQVFKLFFBQVE7OEdBUmpCLGFBQWE7MkZBQWIsYUFBYTtrQkFEekIsVUFBVTs7MEJBU0ksTUFBTTsyQkFBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBDb21wb25lbnRSZWYsXG4gIEluamVjdCxcbiAgSW5qZWN0YWJsZSxcbiAgUmVuZGVyZXIyLCBSZW5kZXJlckZhY3RvcnkyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT3ZlcmxheUNvbnRhaW5lclJlZiB9IGZyb20gJ25nLWRldnVpL292ZXJsYXktY29udGFpbmVyJztcbmltcG9ydCB7IERldkNvbmZpZ1NlcnZpY2UgfSBmcm9tICduZy1kZXZ1aS91dGlscyc7XG5pbXBvcnQgeyBhc3NpZ24sIGlzVW5kZWZpbmVkIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IE1vZGFsQ29udGFpbmVyQ29tcG9uZW50IH0gZnJvbSAnLi9tb2RhbC1jb250YWluZXIuY29tcG9uZW50JztcbmltcG9ydCB7IE1vZGFsQ29tcG9uZW50IH0gZnJvbSAnLi9tb2RhbC5jb21wb25lbnQnO1xuaW1wb3J0IHsgSURpYWxvZ09wdGlvbnMgfSBmcm9tICcuL21vZGFsLnR5cGVzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERpYWxvZ1NlcnZpY2Uge1xuICBjb250ZW50UmVmOiBDb21wb25lbnRSZWY8YW55PjtcbiAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyO1xuICBkb2N1bWVudDogRG9jdW1lbnQ7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBvdmVybGF5Q29udGFpbmVyUmVmOiBPdmVybGF5Q29udGFpbmVyUmVmLCBwcml2YXRlIHJlbmRlcmVyRmFjdG9yeTogUmVuZGVyZXJGYWN0b3J5MixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBkZXZDb25maWdTZXJ2aWNlOiBEZXZDb25maWdTZXJ2aWNlLFxuICAgICAgICAgICAgICBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIGRvYzogYW55KSB7XG4gICAgdGhpcy5yZW5kZXJlciA9IHRoaXMucmVuZGVyZXJGYWN0b3J5LmNyZWF0ZVJlbmRlcmVyKG51bGwsIG51bGwpO1xuICAgIHRoaXMuZG9jdW1lbnQgPSB0aGlzLmRvYztcbiAgfVxuXG4gIG9wZW4oe1xuICAgIGlkLFxuICAgIHdpZHRoLFxuICAgIHpJbmRleCxcbiAgICBiYWNrRHJvcFpJbmRleCxcbiAgICBiYWNrZHJvcENsb3NlYWJsZSxcbiAgICBtYXhIZWlnaHQsXG4gICAgc2hvd0FuaW1hdGlvbixcbiAgICAvKipcbiAgICAgKiBAZGVwcmVjYXRlZFxuICAgICAqL1xuICAgIHNob3dBbmltYXRlLFxuICAgIHRpdGxlLFxuICAgIGNvbnRlbnQsXG4gICAgaHRtbCxcbiAgICBkYXRhLFxuICAgIGJ1dHRvbnMsXG4gICAgaW5qZWN0b3IsXG4gICAgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIGJlZm9yZUhpZGRlbixcbiAgICBvbkNsb3NlLFxuICAgIGRpYWxvZ3R5cGUgPSAnc3RhbmRhcmQnLFxuICAgIHNob3dDbG9zZUJ0biA9IHRydWUsXG4gICAgZHJhZ2dhYmxlID0gdHJ1ZSxcbiAgICBwbGFjZW1lbnQgPSAnY2VudGVyJyxcbiAgICBvZmZzZXRYLFxuICAgIG9mZnNldFksXG4gICAgYm9keVNjcm9sbGFibGUgPSB0cnVlLFxuICAgIGNvbnRlbnRUZW1wbGF0ZSxcbiAgICBlc2NhcGFibGUgPSB0cnVlXG4gIH06IElEaWFsb2dPcHRpb25zKSB7XG4gICAgY29uc3QgZmluYWxDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgPSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgfHwgdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI7XG5cbiAgICBjb25zdCBtb2RhbFJlZiA9IHRoaXMub3ZlcmxheUNvbnRhaW5lclJlZi5jcmVhdGVDb21wb25lbnQoXG4gICAgICBmaW5hbENvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShNb2RhbENvbXBvbmVudCksXG4gICAgICBpbmplY3RvclxuICAgICk7XG4gICAgbGV0IHNob3dBbmltYXRlVmFsdWUgPSB0cnVlO1xuICAgIGNvbnN0IGNvbXBvbmVudENvbmZpZyA9IHRoaXMuZGV2Q29uZmlnU2VydmljZS5nZXRDb25maWdGb3JDb21wb25lbnQoJ21vZGFsJykgfHwge307XG4gICAgY29uc3QgY29uZmlnVmFsdWUgPSBjb21wb25lbnRDb25maWdbJ3Nob3dBbmltYXRpb24nXTtcbiAgICBjb25zdCBhcGlDb25maWcgPSB0aGlzLmRldkNvbmZpZ1NlcnZpY2UuZ2V0Q29uZmlnRm9yQXBpKCdzaG93QW5pbWF0aW9uJyk7XG4gICAgaWYgKGNvbmZpZ1ZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHNob3dBbmltYXRlVmFsdWUgPSBjb25maWdWYWx1ZTtcbiAgICB9IGVsc2UgaWYgKGFwaUNvbmZpZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBzaG93QW5pbWF0ZVZhbHVlID0gYXBpQ29uZmlnO1xuICAgIH1cblxuICAgIGlmIChzaG93QW5pbWF0aW9uID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmIChzaG93QW5pbWF0ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHNob3dBbmltYXRpb24gPSBzaG93QW5pbWF0ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNob3dBbmltYXRpb24gPSBzaG93QW5pbWF0ZVZhbHVlO1xuICAgICAgfVxuICAgIH1cbiAgICBhc3NpZ24obW9kYWxSZWYuaW5zdGFuY2UsIHtcbiAgICAgIGlkLFxuICAgICAgd2lkdGgsXG4gICAgICB6SW5kZXgsXG4gICAgICBiYWNrRHJvcFpJbmRleCxcbiAgICAgIHNob3dBbmltYXRpb24sXG4gICAgICBiZWZvcmVIaWRkZW4sXG4gICAgICAvLyBzZXQgYmFja2Ryb3BDbG9zZWFibGUgZGVmYXVsdCB2YWx1ZSBcInRydWVcIiB3aGVuIG5vdCBwYXNzaW5nIGl0XG4gICAgICBiYWNrZHJvcENsb3NlYWJsZTogaXNVbmRlZmluZWQoYmFja2Ryb3BDbG9zZWFibGUpID8gdHJ1ZSA6IGJhY2tkcm9wQ2xvc2VhYmxlLFxuICAgICAgZHJhZ2dhYmxlLFxuICAgICAgcGxhY2VtZW50LFxuICAgICAgb2Zmc2V0WCxcbiAgICAgIG9mZnNldFksXG4gICAgICBib2R5U2Nyb2xsYWJsZSxcbiAgICAgIGVzY2FwYWJsZVxuICAgIH0pO1xuXG4gICAgY29uc3QgbW9kYWxDb250YWluZXJSZWYgPSBtb2RhbFJlZi5pbnN0YW5jZS5tb2RhbENvbnRhaW5lckhvc3Qudmlld0NvbnRhaW5lclJlZlxuICAgICAgLmNyZWF0ZUNvbXBvbmVudChmaW5hbENvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShNb2RhbENvbnRhaW5lckNvbXBvbmVudCksIDAsIGluamVjdG9yKTtcbiAgICBhc3NpZ24obW9kYWxDb250YWluZXJSZWYuaW5zdGFuY2UsIHsgdGl0bGUsIGJ1dHRvbnMsIG1heEhlaWdodCwgZGlhbG9ndHlwZSwgc2hvd0Nsb3NlQnRuIH0pO1xuXG4gICAgaWYgKGNvbnRlbnRUZW1wbGF0ZSkge1xuICAgICAgYXNzaWduKG1vZGFsQ29udGFpbmVyUmVmLmluc3RhbmNlLCB7IGNvbnRlbnRUZW1wbGF0ZSB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHR5cGVvZiBjb250ZW50ID09PSAnc3RyaW5nJykge1xuICAgICAgICBhc3NpZ24obW9kYWxDb250YWluZXJSZWYuaW5zdGFuY2UsIHsgY29udGVudCwgaHRtbCB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuY29udGVudFJlZiA9IG1vZGFsQ29udGFpbmVyUmVmLmluc3RhbmNlLm1vZGFsQ29udGVudEhvc3Qudmlld0NvbnRhaW5lclJlZlxuICAgICAgICAgIC5jcmVhdGVDb21wb25lbnQoZmluYWxDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoY29udGVudCkpO1xuICAgICAgICBhc3NpZ24odGhpcy5jb250ZW50UmVmLmluc3RhbmNlLCB7IGRhdGEsIGRpYWxvZ3R5cGUgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbW9kYWxDb250YWluZXJSZWYuaW5zdGFuY2Uub25DbG9zZSA9ICgpID0+IHtcbiAgICAgIG1vZGFsUmVmLmluc3RhbmNlLmhpZGUoKTtcbiAgICB9O1xuXG4gICAgbW9kYWxSZWYuaW5zdGFuY2UudXBkYXRlQnV0dG9uT3B0aW9ucyA9IGJ1dHRvbk9wdGlvbnMgPT4gbW9kYWxDb250YWluZXJSZWYuaW5zdGFuY2UudXBkYXRlQnV0dG9uT3B0aW9ucyhidXR0b25PcHRpb25zKTtcblxuICAgIG1vZGFsUmVmLmluc3RhbmNlLm9uSGlkZGVuID0gKCkgPT4ge1xuICAgICAgaWYgKG1vZGFsUmVmLmluc3RhbmNlLmRvY3VtZW50T3ZlckZsb3cpIHtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVTdHlsZSh0aGlzLmRvY3VtZW50LmJvZHksICd0b3AnKTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVTdHlsZSh0aGlzLmRvY3VtZW50LmJvZHksICdsZWZ0Jyk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5kb2N1bWVudC5ib2R5LCAnZGV2dWktYm9keS1zY3JvbGxibG9jaycpO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuZG9jdW1lbnQuYm9keSwgJ2RldnVpLWJvZHktb3ZlcmZsb3ctaGlkZGVuJyk7XG4gICAgICAgIHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCA9IG1vZGFsUmVmLmluc3RhbmNlLnNjcm9sbFRvcDtcbiAgICAgICAgdGhpcy5kb2N1bWVudC5ib2R5LnNjcm9sbFRvcCA9IG1vZGFsUmVmLmluc3RhbmNlLnNjcm9sbFRvcDtcbiAgICAgICAgdGhpcy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCA9IG1vZGFsUmVmLmluc3RhbmNlLnNjcm9sbExlZnQ7XG4gICAgICAgIHRoaXMuZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0ID0gbW9kYWxSZWYuaW5zdGFuY2Uuc2Nyb2xsTGVmdDtcbiAgICAgIH1cbiAgICAgIGlmIChvbkNsb3NlKSB7XG4gICAgICAgIG9uQ2xvc2UoKTtcbiAgICAgIH1cbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBtb2RhbFJlZi5ob3N0Vmlldy5kZXN0cm95KCk7XG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgbW9kYWxSZWYuaW5zdGFuY2Uuc2hvdygpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG1vZGFsSW5zdGFuY2U6IG1vZGFsUmVmLmluc3RhbmNlLFxuICAgICAgbW9kYWxDb250ZW50SW5zdGFuY2U6IHRoaXMuY29udGVudFJlZiA/IHRoaXMuY29udGVudFJlZi5pbnN0YW5jZSA6IG51bGwsXG4gICAgfTtcbiAgfVxufVxuIl19