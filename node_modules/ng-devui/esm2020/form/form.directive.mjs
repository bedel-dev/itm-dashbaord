import { ContentChildren, Directive, EventEmitter, HostBinding, Input, Optional, Output, QueryList, Self } from '@angular/core';
import { ControlContainer } from '@angular/forms';
import { filter, startWith, take } from 'rxjs/operators';
import { DFormControlRuleDirective, DFormGroupRuleDirective } from './validator-directive/form-control-rules.directive';
import * as i0 from "@angular/core";
import * as i1 from "@angular/forms";
import * as i2 from "./validator-directive/form-control-rules.directive";
export var FormLayout;
(function (FormLayout) {
    FormLayout["Horizontal"] = "horizontal";
    FormLayout["Vertical"] = "vertical";
    FormLayout["Columns"] = "columns";
})(FormLayout || (FormLayout = {}));
export class FormDirective {
    constructor(cd, dValidateRuleDir) {
        this.layout = FormLayout.Horizontal;
        this.labelSize = '';
        this.labelAlign = 'start';
        this.dHasFeedback = false;
        this.dSubmit = new EventEmitter();
        this._cd = cd;
        this._dValidateRuleDir = dValidateRuleDir;
    }
    get layoutHorizontal() {
        return this.layout === FormLayout.Horizontal;
    }
    get layoutVertical() {
        return this.layout === FormLayout.Vertical;
    }
    get layoutColumns() {
        return this.layout === FormLayout.Columns;
    }
    get labelSizeLg() {
        return this.labelSize === 'lg';
    }
    get labelSizeSm() {
        return this.labelSize === 'sm';
    }
    get labelAlignStart() {
        return this.labelAlign === 'start';
    }
    get labelAlignCenter() {
        return this.labelAlign === 'center';
    }
    get labelAlignEnd() {
        return this.labelAlign === 'end';
    }
    updateOnSubmit($event, data) {
        this._operateAllControl(this._cd.control, (cd) => {
            cd.markAsDirty();
            cd.updateValueAndValidity();
        });
        /* emit event should after validate */
        this._cd.control.statusChanges
            .pipe(startWith(this._cd.control.status), filter((status) => {
            return status !== 'PENDING';
        }), take(1))
            .subscribe(() => {
            if (this._cd) {
                this._cd.onSubmit($event); // TODO: 需触发原生form表单的submit方法
                if (this._dValidateRuleDir) {
                    this.dSubmit.emit({
                        valid: this._dValidateRuleDir.isReady,
                        directive: this._dValidateRuleDir,
                        data: data,
                        errors: this._getAllErrors(this._cd.control)
                    });
                }
                else {
                    this.dSubmit.emit({
                        valid: this._cd.valid,
                        directive: this._cd,
                        data: data,
                        errors: this._getAllErrors(this._cd.control)
                    });
                }
            }
            if (this.childrenCtrDirs) {
                for (const validateDir of this.childrenCtrDirs) {
                    if (validateDir.invalid && validateDir.showType === 'popover') {
                        validateDir.showPopMessage(); // TODO: 表单类组件需要实现focus方法，若无focus，将无法正常blur
                        break;
                    }
                }
            }
        });
    }
    updateOnReset() {
        if (this._cd) {
            this._cd.onReset(); // TODO: 需触发原生form表单的reset方法
        }
        this._operateAllControl(this._cd.control, (cd) => {
            cd.markAsPristine();
            cd.updateValueAndValidity();
        });
    }
    _operateAllControl(control, operatorFn) {
        if (control) {
            operatorFn(control);
            const controls = control.controls;
            if (controls) {
                for (const key of Object.keys(controls)) {
                    this._operateAllControl(controls[key], operatorFn);
                }
            }
        }
    }
    _getAllErrors(control) {
        const res = {};
        if (control) {
            res.errors = control.errors;
            const controls = control.controls;
            if (controls) {
                for (const key of Object.keys(controls)) {
                    res[key] = this._getAllErrors(controls[key]);
                }
            }
        }
        return res;
    }
}
FormDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: FormDirective, deps: [{ token: i1.ControlContainer, optional: true, self: true }, { token: i2.DFormGroupRuleDirective, optional: true, self: true }], target: i0.ɵɵFactoryTarget.Directive });
FormDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.3", type: FormDirective, selector: "[dForm]", inputs: { layout: "layout", labelSize: "labelSize", labelAlign: "labelAlign", dFeedbackType: "dFeedbackType", dHasFeedback: "dHasFeedback" }, outputs: { dSubmit: "dSubmit" }, host: { properties: { "class.devui-form-horizontal": "this.layoutHorizontal", "class.devui-form-vertical": "this.layoutVertical", "class.devui-form-columns": "this.layoutColumns", "class.devui-form-lg": "this.labelSizeLg", "class.devui-form-sm": "this.labelSizeSm", "class.devui-form-label-align-start": "this.labelAlignStart", "class.devui-form-label-align-center": "this.labelAlignCenter", "class.devui-form-label-align-end": "this.labelAlignEnd" } }, queries: [{ propertyName: "childrenCtrDirs", predicate: DFormControlRuleDirective, descendants: true }], exportAs: ["dForm"], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: FormDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[dForm]',
                    exportAs: 'dForm',
                }]
        }], ctorParameters: function () { return [{ type: i1.ControlContainer, decorators: [{
                    type: Optional
                }, {
                    type: Self
                }] }, { type: i2.DFormGroupRuleDirective, decorators: [{
                    type: Optional
                }, {
                    type: Self
                }] }]; }, propDecorators: { layout: [{
                type: Input
            }], labelSize: [{
                type: Input
            }], labelAlign: [{
                type: Input
            }], dFeedbackType: [{
                type: Input
            }], dHasFeedback: [{
                type: Input
            }], dSubmit: [{
                type: Output
            }], childrenCtrDirs: [{
                type: ContentChildren,
                args: [DFormControlRuleDirective, { descendants: true }]
            }], layoutHorizontal: [{
                type: HostBinding,
                args: ['class.devui-form-horizontal']
            }], layoutVertical: [{
                type: HostBinding,
                args: ['class.devui-form-vertical']
            }], layoutColumns: [{
                type: HostBinding,
                args: ['class.devui-form-columns']
            }], labelSizeLg: [{
                type: HostBinding,
                args: ['class.devui-form-lg']
            }], labelSizeSm: [{
                type: HostBinding,
                args: ['class.devui-form-sm']
            }], labelAlignStart: [{
                type: HostBinding,
                args: ['class.devui-form-label-align-start']
            }], labelAlignCenter: [{
                type: HostBinding,
                args: ['class.devui-form-label-align-center']
            }], labelAlignEnd: [{
                type: HostBinding,
                args: ['class.devui-form-label-align-end']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9kZXZ1aS9mb3JtL2Zvcm0uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoSSxPQUFPLEVBQTZDLGdCQUFnQixFQUE0QixNQUFNLGdCQUFnQixDQUFDO0FBQ3ZILE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pELE9BQU8sRUFBRSx5QkFBeUIsRUFBRSx1QkFBdUIsRUFBRSxNQUFNLG9EQUFvRCxDQUFDOzs7O0FBRXhILE1BQU0sQ0FBTixJQUFZLFVBSVg7QUFKRCxXQUFZLFVBQVU7SUFDcEIsdUNBQXlCLENBQUE7SUFDekIsbUNBQXFCLENBQUE7SUFDckIsaUNBQW1CLENBQUE7QUFDckIsQ0FBQyxFQUpXLFVBQVUsS0FBVixVQUFVLFFBSXJCO0FBTUQsTUFBTSxPQUFPLGFBQWE7SUE2SXhCLFlBQWdDLEVBQW9CLEVBQXNCLGdCQUF5QztRQTVJMUcsV0FBTSxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQUM7UUFDL0IsY0FBUyxHQUFxQixFQUFFLENBQUM7UUFDakMsZUFBVSxHQUErQixPQUFPLENBQUM7UUFPakQsaUJBQVksR0FBRyxLQUFLLENBQUM7UUFFcEIsWUFBTyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFrSXJDLElBQUksQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2QsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGdCQUFnQixDQUFDO0lBQzVDLENBQUM7SUE5SEQsSUFDSSxnQkFBZ0I7UUFDbEIsT0FBTyxJQUFJLENBQUMsTUFBTSxLQUFLLFVBQVUs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RjtTQUNGO1FBRUQsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDOzswR0EzSVUsYUFBYTs4RkFBYixhQUFhLG9zQkFnQlAseUJBQXlCOzJGQWhCL0IsYUFBYTtrQkFKekIsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsU0FBUztvQkFDbkIsUUFBUSxFQUFFLE9BQU87aUJBQ2xCOzswQkE4SWMsUUFBUTs7MEJBQUksSUFBSTs7MEJBQTBCLFFBQVE7OzBCQUFJLElBQUk7NENBNUk5RCxNQUFNO3NCQUFkLEtBQUs7Z0JBQ0csU0FBUztzQkFBakIsS0FBSztnQkFDRyxVQUFVO3NCQUFsQixLQUFLO2dCQUtHLGFBQWE7c0JBQXJCLEtBQUs7Z0JBRUcsWUFBWTtzQkFBcEIsS0FBSztnQkFFSSxPQUFPO3NCQUFoQixNQUFNO2dCQUk0RCxlQUFlO3NCQUFqRixlQUFlO3VCQUFDLHlCQUF5QixFQUFFLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRTtnQkFHN0QsZ0JBQWdCO3NCQURuQixXQUFXO3VCQUFDLDZCQUE2QjtnQkFNdEMsY0FBYztzQkFEakIsV0FBVzt1QkFBQywyQkFBMkI7Z0JBTXBDLGFBQWE7c0JBRGhCLFdBQVc7dUJBQUMsMEJBQTBCO2dCQU1uQyxXQUFXO3NCQURkLFdBQVc7dUJBQUMscUJBQXFCO2dCQU05QixXQUFXO3NCQURkLFdBQVc7dUJBQUMscUJBQXFCO2dCQU05QixlQUFlO3NCQURsQixXQUFXO3VCQUFDLG9DQUFvQztnQkFNN0MsZ0JBQWdCO3NCQURuQixXQUFXO3VCQUFDLHFDQUFxQztnQkFNOUMsYUFBYTtzQkFEaEIsV0FBVzt1QkFBQyxrQ0FBa0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb250ZW50Q2hpbGRyZW4sIERpcmVjdGl2ZSwgRXZlbnRFbWl0dGVyLCBIb3N0QmluZGluZywgSW5wdXQsIE9wdGlvbmFsLCBPdXRwdXQsIFF1ZXJ5TGlzdCwgU2VsZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sLCBBYnN0cmFjdENvbnRyb2xEaXJlY3RpdmUsIENvbnRyb2xDb250YWluZXIsIE5nRm9ybSwgVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IGZpbHRlciwgc3RhcnRXaXRoLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgREZvcm1Db250cm9sUnVsZURpcmVjdGl2ZSwgREZvcm1Hcm91cFJ1bGVEaXJlY3RpdmUgfSBmcm9tICcuL3ZhbGlkYXRvci1kaXJlY3RpdmUvZm9ybS1jb250cm9sLXJ1bGVzLmRpcmVjdGl2ZSc7XG5cbmV4cG9ydCBlbnVtIEZvcm1MYXlvdXQge1xuICBIb3Jpem9udGFsID0gJ2hvcml6b250YWwnLFxuICBWZXJ0aWNhbCA9ICd2ZXJ0aWNhbCcsXG4gIENvbHVtbnMgPSAnY29sdW1ucycsXG59XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tkRm9ybV0nLFxuICBleHBvcnRBczogJ2RGb3JtJyxcbn0pXG5leHBvcnQgY2xhc3MgRm9ybURpcmVjdGl2ZSB7XG4gIEBJbnB1dCgpIGxheW91dCA9IEZvcm1MYXlvdXQuSG9yaXpvbnRhbDtcbiAgQElucHV0KCkgbGFiZWxTaXplOiAnc20nIHwgJycgfCAnbGcnID0gJyc7XG4gIEBJbnB1dCgpIGxhYmVsQWxpZ246ICdzdGFydCcgfCAnY2VudGVyJyB8ICdlbmQnID0gJ3N0YXJ0JztcblxuICAvKipcbiAgICogQGRlcHJlY2F0ZWQgVXNlIGRIYXNGZWVkYmFjayB0byByZXBsYWNlLCBObyBsb25nZXIgc3VwcG9ydCBmb3IgbGFiZWxcbiAgICovXG4gIEBJbnB1dCgpIGRGZWVkYmFja1R5cGU6ICdsYWJlbCcgfCAnY29udHJvbCc7XG5cbiAgQElucHV0KCkgZEhhc0ZlZWRiYWNrID0gZmFsc2U7XG5cbiAgQE91dHB1dCgpIGRTdWJtaXQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgcHVibGljIHJlYWRvbmx5IF9jZDogQWJzdHJhY3RDb250cm9sRGlyZWN0aXZlO1xuICBwdWJsaWMgcmVhZG9ubHkgX2RWYWxpZGF0ZVJ1bGVEaXI6IERGb3JtR3JvdXBSdWxlRGlyZWN0aXZlO1xuICBAQ29udGVudENoaWxkcmVuKERGb3JtQ29udHJvbFJ1bGVEaXJlY3RpdmUsIHsgZGVzY2VuZGFudHM6IHRydWUgfSkgY2hpbGRyZW5DdHJEaXJzOiBRdWVyeUxpc3Q8REZvcm1Db250cm9sUnVsZURpcmVjdGl2ZT47XG5cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcy5kZXZ1aS1mb3JtLWhvcml6b250YWwnKVxuICBnZXQgbGF5b3V0SG9yaXpvbnRhbCgpIHtcbiAgICByZXR1cm4gdGhpcy5sYXlvdXQgPT09IEZvcm1MYXlvdXQuSG9yaXpvbnRhbDtcbiAgfVxuXG4gIEBIb3N0QmluZGluZygnY2xhc3MuZGV2dWktZm9ybS12ZXJ0aWNhbCcpXG4gIGdldCBsYXlvdXRWZXJ0aWNhbCgpIHtcbiAgICByZXR1cm4gdGhpcy5sYXlvdXQgPT09IEZvcm1MYXlvdXQuVmVydGljYWw7XG4gIH1cblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzLmRldnVpLWZvcm0tY29sdW1ucycpXG4gIGdldCBsYXlvdXRDb2x1bW5zKCkge1xuICAgIHJldHVybiB0aGlzLmxheW91dCA9PT0gRm9ybUxheW91dC5Db2x1bW5zO1xuICB9XG5cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcy5kZXZ1aS1mb3JtLWxnJylcbiAgZ2V0IGxhYmVsU2l6ZUxnKCkge1xuICAgIHJldHVybiB0aGlzLmxhYmVsU2l6ZSA9PT0gJ2xnJztcbiAgfVxuXG4gIEBIb3N0QmluZGluZygnY2xhc3MuZGV2dWktZm9ybS1zbScpXG4gIGdldCBsYWJlbFNpemVTbSgpIHtcbiAgICByZXR1cm4gdGhpcy5sYWJlbFNpemUgPT09ICdzbSc7XG4gIH1cblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzLmRldnVpLWZvcm0tbGFiZWwtYWxpZ24tc3RhcnQnKVxuICBnZXQgbGFiZWxBbGlnblN0YXJ0KCkge1xuICAgIHJldHVybiB0aGlzLmxhYmVsQWxpZ24gPT09ICdzdGFydCc7XG4gIH1cblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzLmRldnVpLWZvcm0tbGFiZWwtYWxpZ24tY2VudGVyJylcbiAgZ2V0IGxhYmVsQWxpZ25DZW50ZXIoKSB7XG4gICAgcmV0dXJuIHRoaXMubGFiZWxBbGlnbiA9PT0gJ2NlbnRlcic7XG4gIH1cblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzLmRldnVpLWZvcm0tbGFiZWwtYWxpZ24tZW5kJylcbiAgZ2V0IGxhYmVsQWxpZ25FbmQoKSB7XG4gICAgcmV0dXJuIHRoaXMubGFiZWxBbGlnbiA9PT0gJ2VuZCc7XG4gIH1cblxuICB1cGRhdGVPblN1Ym1pdCgkZXZlbnQ/LCBkYXRhPzogYW55KSB7XG4gICAgdGhpcy5fb3BlcmF0ZUFsbENvbnRyb2wodGhpcy5fY2QuY29udHJvbCwgKGNkOiBBYnN0cmFjdENvbnRyb2wpID0+IHtcbiAgICAgIGNkLm1hcmtBc0RpcnR5KCk7XG4gICAgICBjZC51cGRhdGVWYWx1ZUFuZFZhbGlkaXR5KCk7XG4gICAgfSk7XG5cbiAgICAvKiBlbWl0IGV2ZW50IHNob3VsZCBhZnRlciB2YWxpZGF0ZSAqL1xuICAgIHRoaXMuX2NkLmNvbnRyb2wuc3RhdHVzQ2hhbmdlc1xuICAgICAgLnBpcGUoXG4gICAgICAgIHN0YXJ0V2l0aCh0aGlzLl9jZC5jb250cm9sLnN0YXR1cyksXG4gICAgICAgIGZpbHRlcigoc3RhdHVzKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHN0YXR1cyAhPT0gJ1BFTkRJTkcnO1xuICAgICAgICB9KSxcbiAgICAgICAgdGFrZSgxKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLl9jZCkge1xuICAgICAgICAgICh0aGlzLl9jZCBhcyBOZ0Zvcm0pLm9uU3VibWl0KCRldmVudCk7IC8vIFRPRE86IOmcgOinpuWPkeWOn+eUn2Zvcm3ooajljZXnmoRzdWJtaXTmlrnms5VcbiAgICAgICAgICBpZiAodGhpcy5fZFZhbGlkYXRlUnVsZURpcikge1xuICAgICAgICAgICAgdGhpcy5kU3VibWl0LmVtaXQoe1xuICAgICAgICAgICAgICB2YWxpZDogdGhpcy5fZFZhbGlkYXRlUnVsZURpci5pc1JlYWR5LFxuICAgICAgICAgICAgICBkaXJlY3RpdmU6IHRoaXMuX2RWYWxpZGF0ZVJ1bGVEaXIsXG4gICAgICAgICAgICAgIGRhdGE6IGRhdGEsXG4gICAgICAgICAgICAgIGVycm9yczogdGhpcy5fZ2V0QWxsRXJyb3JzKHRoaXMuX2NkLmNvbnRyb2wpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5kU3VibWl0LmVtaXQoe1xuICAgICAgICAgICAgICB2YWxpZDogdGhpcy5fY2QudmFsaWQsXG4gICAgICAgICAgICAgIGRpcmVjdGl2ZTogdGhpcy5fY2QsXG4gICAgICAgICAgICAgIGRhdGE6IGRhdGEsXG4gICAgICAgICAgICAgIGVycm9yczogdGhpcy5fZ2V0QWxsRXJyb3JzKHRoaXMuX2NkLmNvbnRyb2wpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5jaGlsZHJlbkN0ckRpcnMpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IHZhbGlkYXRlRGlyIG9mIHRoaXMuY2hpbGRyZW5DdHJEaXJzKSB7XG4gICAgICAgICAgICBpZiAodmFsaWRhdGVEaXIuaW52YWxpZCAmJiB2YWxpZGF0ZURpci5zaG93VHlwZSA9PT0gJ3BvcG92ZXInKSB7XG4gICAgICAgICAgICAgIHZhbGlkYXRlRGlyLnNob3dQb3BNZXNzYWdlKCk7IC8vIFRPRE86IOihqOWNleexu+e7hOS7tumcgOimgeWunueOsGZvY3Vz5pa55rOV77yM6Iul5pegZm9jdXPvvIzlsIbml6Dms5XmraPluLhibHVyXG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICB1cGRhdGVPblJlc2V0KCkge1xuICAgIGlmICh0aGlzLl9jZCkge1xuICAgICAgKHRoaXMuX2NkIGFzIE5nRm9ybSkub25SZXNldCgpOyAvLyBUT0RPOiDpnIDop6blj5Hljp/nlJ9mb3Jt6KGo5Y2V55qEcmVzZXTmlrnms5VcbiAgICB9XG4gICAgdGhpcy5fb3BlcmF0ZUFsbENvbnRyb2wodGhpcy5fY2QuY29udHJvbCwgKGNkOiBBYnN0cmFjdENvbnRyb2wpID0+IHtcbiAgICAgIGNkLm1hcmtBc1ByaXN0aW5lKCk7XG4gICAgICBjZC51cGRhdGVWYWx1ZUFuZFZhbGlkaXR5KCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9vcGVyYXRlQWxsQ29udHJvbChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wsIG9wZXJhdG9yRm46IChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpID0+IHZvaWQpIHtcbiAgICBpZiAoY29udHJvbCkge1xuICAgICAgb3BlcmF0b3JGbihjb250cm9sKTtcbiAgICAgIGNvbnN0IGNvbnRyb2xzID0gKGNvbnRyb2wgYXMgYW55KS5jb250cm9scztcbiAgICAgIGlmIChjb250cm9scykge1xuICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhjb250cm9scykpIHtcbiAgICAgICAgICB0aGlzLl9vcGVyYXRlQWxsQ29udHJvbChjb250cm9sc1trZXldLCBvcGVyYXRvckZuKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2dldEFsbEVycm9ycyhjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpIHtcbiAgICBjb25zdCByZXM6IHtba2V5OiBzdHJpbmddOiBWYWxpZGF0aW9uRXJyb3JzfSA9IHt9O1xuICAgIGlmIChjb250cm9sKSB7XG4gICAgICByZXMuZXJyb3JzID0gY29udHJvbC5lcnJvcnM7XG4gICAgICBjb25zdCBjb250cm9scyA9IChjb250cm9sIGFzIGFueSkuY29udHJvbHM7XG4gICAgICBpZiAoY29udHJvbHMpIHtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoY29udHJvbHMpKSB7XG4gICAgICAgICAgcmVzW2tleV0gPSB0aGlzLl9nZXRBbGxFcnJvcnMoY29udHJvbHNba2V5XSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgQFNlbGYoKSBjZDogQ29udHJvbENvbnRhaW5lciwgQE9wdGlvbmFsKCkgQFNlbGYoKSBkVmFsaWRhdGVSdWxlRGlyOiBERm9ybUdyb3VwUnVsZURpcmVjdGl2ZSkge1xuICAgIHRoaXMuX2NkID0gY2Q7XG4gICAgdGhpcy5fZFZhbGlkYXRlUnVsZURpciA9IGRWYWxpZGF0ZVJ1bGVEaXI7XG4gIH1cbn1cbiJdfQ==