import { Pipe } from '@angular/core';
import { I18nService } from 'ng-devui/i18n';
import * as datefns from 'date-fns';
import { of, Subject } from 'rxjs';
import { map, takeUntil } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "ng-devui/i18n";
export class RelativeTimePipe {
    constructor(i18n) {
        this.i18n = i18n;
        this._destroyed$ = new Subject();
    }
    transform(value, limit, compareDate, weekStartsOn = 1) {
        if (!value) {
            return of('');
        }
        const threshold = {
            month: 3,
            week: 4,
            day: 6,
            hour: 6,
            minute: 59,
            second: 59 // at least 59 seconds using minute.
        };
        if (!datefns.isDate(value)) {
            value = new Date(value);
        }
        const now = compareDate ? new Date(compareDate) : Date.now();
        const startOfYearForTarget = datefns.startOfYear(value);
        const startOfYearForToday = datefns.startOfYear(now);
        const diffYears = datefns.differenceInYears(startOfYearForToday, startOfYearForTarget);
        const absDiffYears = Math.abs(diffYears);
        const startOfMonthForTarget = datefns.startOfMonth(value);
        const startOfMonthForToday = datefns.startOfMonth(now);
        const diffMonths = datefns.differenceInMonths(startOfMonthForToday, startOfMonthForTarget);
        const absDiffMonths = Math.abs(diffMonths);
        const startOfWeekForTarget = datefns.startOfWeek(value, { weekStartsOn });
        const startOfWeekForToday = datefns.startOfWeek(now, { weekStartsOn });
        const diffWeeks = datefns.differenceInWeeks(startOfWeekForToday, startOfWeekForTarget);
        const absDiffWeeks = Math.abs(diffWeeks);
        const startOfDayForTarget = datefns.startOfDay(value);
        const startOfDayForToday = datefns.startOfDay(now);
        const diffDays = datefns.differenceInDays(startOfDayForToday, startOfDayForTarget);
        const absDiffDays = Math.abs(diffDays);
        const diffHours = datefns.differenceInHours(now, value);
        const absDiffHours = Math.abs(diffHours);
        const diffMinutes = datefns.differenceInMinutes(now, value);
        const absDiffMinutes = Math.abs(diffMinutes);
        const diffSeconds = datefns.differenceInSeconds(now, value);
        const absDiffSeconds = Math.abs(diffSeconds);
        return this.i18n.langChange().pipe(map((data) => {
            if (absDiffSeconds > limit) {
                return new Date(value);
            }
            const i18nCommonText = data['relativeTime'];
            if (absDiffYears > 0 && absDiffMonths > threshold.month) {
                return diffYears > 0 ? i18nCommonText.yearsAgo(absDiffYears) : i18nCommonText.yearsLater(absDiffYears);
            }
            else if (absDiffMonths > 0 && absDiffWeeks >= threshold.week) {
                return diffMonths > 0 ? i18nCommonText.monthsAgo(absDiffMonths) : i18nCommonText.monthsLater(absDiffMonths);
            }
            else if (absDiffWeeks > 0 && absDiffDays > threshold.day) {
                return diffWeeks > 0 ? i18nCommonText.weeksAgo(absDiffWeeks) : i18nCommonText.weeksLater(absDiffWeeks);
            }
            else if (absDiffDays > 0 && absDiffHours > threshold.hour) {
                return diffDays > 0 ? i18nCommonText.daysAgo(absDiffDays) : i18nCommonText.daysLater(absDiffDays);
            }
            else if (absDiffHours > 0 && absDiffMinutes > threshold.minute) {
                return absDiffHours + (diffHours > 0 ? i18nCommonText.hoursAgo : i18nCommonText.hoursLater);
            }
            else if (absDiffMinutes > 0 && absDiffSeconds > threshold.second) {
                return absDiffMinutes + (diffMinutes > 0 ? i18nCommonText.minutesAgo : i18nCommonText.minutesLater);
            }
            else if (diffSeconds || diffSeconds === 0) {
                return diffSeconds >= 0 ? i18nCommonText.justnow : i18nCommonText.later;
            }
            else {
                return '';
            }
        }), takeUntil(this._destroyed$));
    }
    ngOnDestroy() {
        this._destroyed$.next();
        this._destroyed$.complete();
    }
}
RelativeTimePipe.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: RelativeTimePipe, deps: [{ token: i1.I18nService }], target: i0.ɵɵFactoryTarget.Pipe });
RelativeTimePipe.ɵpipe = i0.ɵɵngDeclarePipe({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: RelativeTimePipe, name: "dRelativeTime" });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: RelativeTimePipe, decorators: [{
            type: Pipe,
            args: [{
                    name: 'dRelativeTime'
                }]
        }], ctorParameters: function () { return [{ type: i1.I18nService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVsYXRpdmUtdGltZS5waXBlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vZGV2dWkvcmVsYXRpdmUtdGltZS9yZWxhdGl2ZS10aW1lLnBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFhLElBQUksRUFBaUIsTUFBTSxlQUFlLENBQUM7QUFDL0QsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEtBQUssT0FBTyxNQUFNLFVBQVUsQ0FBQztBQUNwQyxPQUFPLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQyxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7QUFLaEQsTUFBTSxPQUFPLGdCQUFnQjtJQUUzQixZQUFvQixJQUFpQjtRQUFqQixTQUFJLEdBQUosSUFBSSxDQUFhO1FBRDdCLGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUNJLENBQUM7SUFFekMsU0FBUyxDQUNQLEtBQTZCLEVBQzdCLEtBQWEsRUFDYixXQUFvQyxFQUNwQyxlQUEwQyxDQUFDO1FBRTNDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDVixPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNmO1FBQ0QsTUFBTSxTQUFTLEdBQUc7WUFDaEIsS0FBSyxFQUFFLENBQUM7WUFDUixJQUFJLEVBQUUsQ0FBQztZQUNQLEdBQUcsRUFBRSxDQUFDO1lBQ04sSUFBSSxFQUFFLENBQUM7WUFDUCxNQUFNLEVBQUUsRUFBRTtZQUNWLE1BQU0sRUFBRSxFQUFFLENBQUMsb0NBQW9DO1NBQ2hELENBQUM7UUFFRixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUMxQixLQUFLLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDekI7UUFFRCxNQUFNLEdBQUcsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFN0QsTUFBTSxvQkFBb0IsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFPLEtBQUssQ0FBQyxDQUFDO1FBQzlELE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNyRCxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsbUJBQW1CLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztRQUN2RixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXpDLE1BQU0scUJBQXFCLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBTyxLQUFLLENBQUMsQ0FBQztRQUNoRSxNQUFNLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdkQsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLG9CQUFvQixFQUFFLHFCQUFxQixDQUFDLENBQUM7UUFDM0YsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUUzQyxNQUFNLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQU8sS0FBSyxFQUFFLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUNoRixNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUN2RSxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsbUJBQW1CLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztRQUN2RixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXpDLE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBTyxLQUFLLENBQUMsQ0FBQztRQUM1RCxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkQsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixFQUFFLG1CQUFtQixDQUFDLENBQUM7UUFDbkYsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV2QyxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFRLEtBQUssQ0FBQyxDQUFDO1FBQzlELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFekMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsRUFBUSxLQUFLLENBQUMsQ0FBQztRQUNsRSxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRTdDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLEVBQVEsS0FBSyxDQUFDLENBQUM7UUFDbEUsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUU3QyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsSUFBSSxDQUNoQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNYLElBQUksY0FBYyxHQUFHLEtBQUssRUFBRTtnQkFDMUIsT0FBTyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUN4QjtZQUNELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUM1QyxJQUFJLFlBQVksR0FBRyxDQUFDLElBQUksYUFBYSxHQUFHLFNBQVMsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3ZELE9BQVEsU0FBUyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUN6RztpQkFBTSxJQUFJLGFBQWEsR0FBRyxDQUFDLElBQUksWUFBWSxJQUFJLFNBQVMsQ0FBQyxJQUFJLEVBQUU7Z0JBQzlELE9BQVEsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQzthQUM5RztpQkFBTSxJQUFJLFlBQVksR0FBRyxDQUFDLElBQUksV0FBVyxHQUFHLFNBQVMsQ0FBQyxHQUFHLEVBQUU7Z0JBQzFELE9BQVEsU0FBUyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUN6RztpQkFBTSxJQUFJLFdBQVcsR0FBRyxDQUFDLElBQUksWUFBWSxHQUFHLFNBQVMsQ0FBQyxJQUFJLEVBQUU7Z0JBQzNELE9BQVEsUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUNwRztpQkFBTSxJQUFJLFlBQVksR0FBRyxDQUFDLElBQUksY0FBYyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUU7Z0JBQ2hFLE9BQU8sWUFBWSxHQUFHLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQzdGO2lCQUFNLElBQUksY0FBYyxHQUFHLENBQUMsSUFBSSxjQUFjLEdBQUcsU0FBUyxDQUFDLE1BQU0sRUFBRTtnQkFDbEUsT0FBTyxjQUFjLEdBQUcsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDckc7aUJBQU0sSUFBSSxXQUFXLElBQUksV0FBVyxLQUFLLENBQUMsRUFBRTtnQkFDM0MsT0FBTyxXQUFXLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDO2FBQ3pFO2lCQUFNO2dCQUNMLE9BQU8sRUFBRSxDQUFDO2FBQ1g7UUFDSCxDQUFDLENBQUMsRUFDRixTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUM1QixDQUFDO0lBQ0osQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDOUIsQ0FBQzs7NkdBeEZVLGdCQUFnQjsyR0FBaEIsZ0JBQWdCOzJGQUFoQixnQkFBZ0I7a0JBSDVCLElBQUk7bUJBQUM7b0JBQ0osSUFBSSxFQUFFLGVBQWU7aUJBQ3RCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT25EZXN0cm95LCBQaXBlLCBQaXBlVHJhbnNmb3JtIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJMThuU2VydmljZSB9IGZyb20gJ25nLWRldnVpL2kxOG4nO1xuaW1wb3J0ICogYXMgZGF0ZWZucyBmcm9tICdkYXRlLWZucyc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBQaXBlKHtcbiAgbmFtZTogJ2RSZWxhdGl2ZVRpbWUnXG59KVxuZXhwb3J0IGNsYXNzIFJlbGF0aXZlVGltZVBpcGUgaW1wbGVtZW50cyBQaXBlVHJhbnNmb3JtLCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIF9kZXN0cm95ZWQkID0gbmV3IFN1YmplY3QoKTtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpMThuOiBJMThuU2VydmljZSkge31cblxuICB0cmFuc2Zvcm0oXG4gICAgdmFsdWU6IHN0cmluZyB8IG51bWJlciB8IERhdGUsXG4gICAgbGltaXQ6IG51bWJlcixcbiAgICBjb21wYXJlRGF0ZT86IHN0cmluZyB8IG51bWJlciB8IERhdGUsXG4gICAgd2Vla1N0YXJ0c09uOiAwIHwgMSB8IDIgfCAzIHwgNCB8IDYgfCA1ID0gMVxuICApOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bWJlciB8IERhdGU+IHtcbiAgICBpZiAoIXZhbHVlKSB7XG4gICAgICByZXR1cm4gb2YoJycpO1xuICAgIH1cbiAgICBjb25zdCB0aHJlc2hvbGQgPSB7XG4gICAgICBtb250aDogMywgLy8gYXQgbGVhc3QgMyBtb250aHMgdXNpbmcgeWVhci5cbiAgICAgIHdlZWs6IDQsIC8vIGF0IGxlYXN0IDQgd2Vla3MgdXNpbmcgbW9udGguXG4gICAgICBkYXk6IDYsIC8vIGF0IGxlYXN0IDYgZGF5cyB1c2luZyB3ZWVrcy5cbiAgICAgIGhvdXI6IDYsIC8vIGF0IGxlYXN0IDYgaG91cnMgdXNpbmcgZGF5LlxuICAgICAgbWludXRlOiA1OSwgLy8gYXQgbGVhc3QgNTkgbWludXRlcyB1c2luZyBob3VyLlxuICAgICAgc2Vjb25kOiA1OSAvLyBhdCBsZWFzdCA1OSBzZWNvbmRzIHVzaW5nIG1pbnV0ZS5cbiAgICB9O1xuXG4gICAgaWYgKCFkYXRlZm5zLmlzRGF0ZSh2YWx1ZSkpIHtcbiAgICAgIHZhbHVlID0gbmV3IERhdGUodmFsdWUpO1xuICAgIH1cblxuICAgIGNvbnN0IG5vdyA9IGNvbXBhcmVEYXRlID8gbmV3IERhdGUoY29tcGFyZURhdGUpIDogRGF0ZS5ub3coKTtcblxuICAgIGNvbnN0IHN0YXJ0T2ZZZWFyRm9yVGFyZ2V0ID0gZGF0ZWZucy5zdGFydE9mWWVhcig8RGF0ZT52YWx1ZSk7XG4gICAgY29uc3Qgc3RhcnRPZlllYXJGb3JUb2RheSA9IGRhdGVmbnMuc3RhcnRPZlllYXIobm93KTtcbiAgICBjb25zdCBkaWZmWWVhcnMgPSBkYXRlZm5zLmRpZmZlcmVuY2VJblllYXJzKHN0YXJ0T2ZZZWFyRm9yVG9kYXksIHN0YXJ0T2ZZZWFyRm9yVGFyZ2V0KTtcbiAgICBjb25zdCBhYnNEaWZmWWVhcnMgPSBNYXRoLmFicyhkaWZmWWVhcnMpO1xuXG4gICAgY29uc3Qgc3RhcnRPZk1vbnRoRm9yVGFyZ2V0ID0gZGF0ZWZucy5zdGFydE9mTW9udGgoPERhdGU+dmFsdWUpO1xuICAgIGNvbnN0IHN0YXJ0T2ZNb250aEZvclRvZGF5ID0gZGF0ZWZucy5zdGFydE9mTW9udGgobm93KTtcbiAgICBjb25zdCBkaWZmTW9udGhzID0gZGF0ZWZucy5kaWZmZXJlbmNlSW5Nb250aHMoc3RhcnRPZk1vbnRoRm9yVG9kYXksIHN0YXJ0T2ZNb250aEZvclRhcmdldCk7XG4gICAgY29uc3QgYWJzRGlmZk1vbnRocyA9IE1hdGguYWJzKGRpZmZNb250aHMpO1xuXG4gICAgY29uc3Qgc3RhcnRPZldlZWtGb3JUYXJnZXQgPSBkYXRlZm5zLnN0YXJ0T2ZXZWVrKDxEYXRlPnZhbHVlLCB7IHdlZWtTdGFydHNPbiB9KTtcbiAgICBjb25zdCBzdGFydE9mV2Vla0ZvclRvZGF5ID0gZGF0ZWZucy5zdGFydE9mV2Vlayhub3csIHsgd2Vla1N0YXJ0c09uIH0pO1xuICAgIGNvbnN0IGRpZmZXZWVrcyA9IGRhdGVmbnMuZGlmZmVyZW5jZUluV2Vla3Moc3RhcnRPZldlZWtGb3JUb2RheSwgc3RhcnRPZldlZWtGb3JUYXJnZXQpO1xuICAgIGNvbnN0IGFic0RpZmZXZWVrcyA9IE1hdGguYWJzKGRpZmZXZWVrcyk7XG5cbiAgICBjb25zdCBzdGFydE9mRGF5Rm9yVGFyZ2V0ID0gZGF0ZWZucy5zdGFydE9mRGF5KDxEYXRlPnZhbHVlKTtcbiAgICBjb25zdCBzdGFydE9mRGF5Rm9yVG9kYXkgPSBkYXRlZm5zLnN0YXJ0T2ZEYXkobm93KTtcbiAgICBjb25zdCBkaWZmRGF5cyA9IGRhdGVmbnMuZGlmZmVyZW5jZUluRGF5cyhzdGFydE9mRGF5Rm9yVG9kYXksIHN0YXJ0T2ZEYXlGb3JUYXJnZXQpO1xuICAgIGNvbnN0IGFic0RpZmZEYXlzID0gTWF0aC5hYnMoZGlmZkRheXMpO1xuXG4gICAgY29uc3QgZGlmZkhvdXJzID0gZGF0ZWZucy5kaWZmZXJlbmNlSW5Ib3Vycyhub3csIDxEYXRlPnZhbHVlKTtcbiAgICBjb25zdCBhYnNEaWZmSG91cnMgPSBNYXRoLmFicyhkaWZmSG91cnMpO1xuXG4gICAgY29uc3QgZGlmZk1pbnV0ZXMgPSBkYXRlZm5zLmRpZmZlcmVuY2VJbk1pbnV0ZXMobm93LCA8RGF0ZT52YWx1ZSk7XG4gICAgY29uc3QgYWJzRGlmZk1pbnV0ZXMgPSBNYXRoLmFicyhkaWZmTWludXRlcyk7XG5cbiAgICBjb25zdCBkaWZmU2Vjb25kcyA9IGRhdGVmbnMuZGlmZmVyZW5jZUluU2Vjb25kcyhub3csIDxEYXRlPnZhbHVlKTtcbiAgICBjb25zdCBhYnNEaWZmU2Vjb25kcyA9IE1hdGguYWJzKGRpZmZTZWNvbmRzKTtcblxuICAgIHJldHVybiB0aGlzLmkxOG4ubGFuZ0NoYW5nZSgpLnBpcGUoXG4gICAgICBtYXAoKGRhdGEpID0+IHtcbiAgICAgICAgaWYgKGFic0RpZmZTZWNvbmRzID4gbGltaXQpIHtcbiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGkxOG5Db21tb25UZXh0ID0gZGF0YVsncmVsYXRpdmVUaW1lJ107XG4gICAgICAgIGlmIChhYnNEaWZmWWVhcnMgPiAwICYmIGFic0RpZmZNb250aHMgPiB0aHJlc2hvbGQubW9udGgpIHtcbiAgICAgICAgICByZXR1cm4gIGRpZmZZZWFycyA+IDAgPyBpMThuQ29tbW9uVGV4dC55ZWFyc0FnbyhhYnNEaWZmWWVhcnMpIDogaTE4bkNvbW1vblRleHQueWVhcnNMYXRlcihhYnNEaWZmWWVhcnMpO1xuICAgICAgICB9IGVsc2UgaWYgKGFic0RpZmZNb250aHMgPiAwICYmIGFic0RpZmZXZWVrcyA+PSB0aHJlc2hvbGQud2Vlaykge1xuICAgICAgICAgIHJldHVybiAgZGlmZk1vbnRocyA+IDAgPyBpMThuQ29tbW9uVGV4dC5tb250aHNBZ28oYWJzRGlmZk1vbnRocykgOiBpMThuQ29tbW9uVGV4dC5tb250aHNMYXRlcihhYnNEaWZmTW9udGhzKTtcbiAgICAgICAgfSBlbHNlIGlmIChhYnNEaWZmV2Vla3MgPiAwICYmIGFic0RpZmZEYXlzID4gdGhyZXNob2xkLmRheSkge1xuICAgICAgICAgIHJldHVybiAgZGlmZldlZWtzID4gMCA/IGkxOG5Db21tb25UZXh0LndlZWtzQWdvKGFic0RpZmZXZWVrcykgOiBpMThuQ29tbW9uVGV4dC53ZWVrc0xhdGVyKGFic0RpZmZXZWVrcyk7XG4gICAgICAgIH0gZWxzZSBpZiAoYWJzRGlmZkRheXMgPiAwICYmIGFic0RpZmZIb3VycyA+IHRocmVzaG9sZC5ob3VyKSB7XG4gICAgICAgICAgcmV0dXJuICBkaWZmRGF5cyA+IDAgPyBpMThuQ29tbW9uVGV4dC5kYXlzQWdvKGFic0RpZmZEYXlzKSA6IGkxOG5Db21tb25UZXh0LmRheXNMYXRlcihhYnNEaWZmRGF5cyk7XG4gICAgICAgIH0gZWxzZSBpZiAoYWJzRGlmZkhvdXJzID4gMCAmJiBhYnNEaWZmTWludXRlcyA+IHRocmVzaG9sZC5taW51dGUpIHtcbiAgICAgICAgICByZXR1cm4gYWJzRGlmZkhvdXJzICsgKGRpZmZIb3VycyA+IDAgPyBpMThuQ29tbW9uVGV4dC5ob3Vyc0FnbyA6IGkxOG5Db21tb25UZXh0LmhvdXJzTGF0ZXIpO1xuICAgICAgICB9IGVsc2UgaWYgKGFic0RpZmZNaW51dGVzID4gMCAmJiBhYnNEaWZmU2Vjb25kcyA+IHRocmVzaG9sZC5zZWNvbmQpIHtcbiAgICAgICAgICByZXR1cm4gYWJzRGlmZk1pbnV0ZXMgKyAoZGlmZk1pbnV0ZXMgPiAwID8gaTE4bkNvbW1vblRleHQubWludXRlc0FnbyA6IGkxOG5Db21tb25UZXh0Lm1pbnV0ZXNMYXRlcik7XG4gICAgICAgIH0gZWxzZSBpZiAoZGlmZlNlY29uZHMgfHwgZGlmZlNlY29uZHMgPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gZGlmZlNlY29uZHMgPj0gMCA/IGkxOG5Db21tb25UZXh0Lmp1c3Rub3cgOiBpMThuQ29tbW9uVGV4dC5sYXRlcjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3llZCQpXG4gICAgKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuX2Rlc3Ryb3llZCQubmV4dCgpO1xuICAgIHRoaXMuX2Rlc3Ryb3llZCQuY29tcGxldGUoKTtcbiAgfVxufVxuIl19